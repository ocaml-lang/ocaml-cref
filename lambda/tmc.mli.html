<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/lambda/tmc.mli - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/lambda/tmc.mli - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L81">rewrite</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">(**************************************************************************)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Frédéric Bour&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Gabriel Scherer, projet Partout, INRIA Saclay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Basile Clément, projet Cambium, INRIA Paris&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; Copyright 2020 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(**************************************************************************)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(** Tail-modulo-<a href="debuginfo.ml.html#L36" title="ocaml/lambda/debuginfo.ml:36">cons</a> optimization.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; {b Warning:} this module is unstable and part of<br/></li>
<li></span><span class="Comment">&nbsp; {{!Compiler_libs}compiler-libs}.<br/></li>
<li></span><span class="Comment">*)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(** TMC (Tail Modulo Cons) is a code transformation that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; rewrites transformed functions in <a href="tmc.ml.html#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style, in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; such a way that certain calls that were not in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a> position in the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; original <a href="printlambda.ml.html#L707" title="ocaml/lambda/printlambda.ml:707">program</a> become <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-calls in the transformed <a href="printlambda.ml.html#L707" title="ocaml/lambda/printlambda.ml:707">program</a>.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; As a <a href="translcore.ml.html#L1100" title="ocaml/lambda/translcore.ml:1100">classic</a> example, the following <a href="printlambda.ml.html#L707" title="ocaml/lambda/printlambda.ml:707">program</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; {|<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; let[@tail_mod_cons] rec <a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> = function<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; | [] -&gt; []<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; | x :: xs -&gt;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; let y = <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> x in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; y :: <a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> xs<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; |}<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; becomes (expressed in almost-source-form; the translation is in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; fact at the Lambda-level)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; {|<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; let rec <a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> = function<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; | [] -&gt; []<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; | x :: xs -&gt;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; let y = <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> x in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; let dst = y :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; map_dps dst 1 <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> xs; dst<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; and map_dps dst <a href="tmc.ml.html#L48" title="ocaml/lambda/tmc.ml:48">offset</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> = function<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; | [] -&gt;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; dst.<a href="tmc.ml.html#L48" title="ocaml/lambda/tmc.ml:48">offset</a> &lt;- []<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; | x :: xs -&gt;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; let y = <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> x in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; let dst' = y :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; dst.<a href="tmc.ml.html#L48" title="ocaml/lambda/tmc.ml:48">offset</a> &lt;- dst';<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; map_dps dst 1 <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> fx<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; |}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; In this example, the expression (y :: <a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> xs) had a call in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; non-<a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-position, and it gets rewritten into <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-calls. TMC<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; handles all such cases where the continuation of the call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; (what needs to be done after the return) is a &quot;construction&quot;, the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; creation of a (possibly nested) data block.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; The code transformation generates two versions of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; input function, the &quot;<a href="tmc.ml.html#L439" title="ocaml/lambda/tmc.ml:439">direct</a>&quot; version with the same type and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; behavior as the original one (here just [<a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a>]), and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; the &quot;<a href="tmc.ml.html#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style&quot; version (here [map_dps]).<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; Any call to the original function from outside the let..rec<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; declaration gets transformed into a call into the <a href="tmc.ml.html#L439" title="ocaml/lambda/tmc.ml:439">direct</a> version,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; which will itself call the <a href="tmc.ml.html#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style versions on<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; recursive calls that may benefit from it (they are in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-position<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; modulo constructors).<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; Because of this inherent code duplication, the transformation may<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; not always improve performance. In this implementation, TMC is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; opt-in, we only transform functions that the user has annotated<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; with an attribute to request the transformation.<br/></li>
<li></span><span class="Comment">*)<br/></li>
<li></span><br/></li>
<li><span class="Statement"><a href="matching.ml.html#L419" title="ocaml/lambda/matching.ml:419">open</a></span><span class="ocamlNone"> </span><span class="PreProc">Lambda<br/></li>
<li></span><br/></li>
<li><a id="L81">&#x200c;</a><span class="Statement">val</span> <span class="ocamlLCIdentifier"><span class="linkable">rewrite</span></span> : <span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a><br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/lambda/tmc.ml - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/lambda/tmc.ml - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L66">add_dst_args</a></li>
<li><a href="#L63">add_dst_params</a></li>
<li><a href="#L89">apply</a></li>
<li><a href="#L120">apply</a></li>
<li><a href="#L69">assign_to_dst</a></li>
<li><a href="#L951">body</a></li>
<li><a href="#L573">choice</a></li>
<li><a href="#L563">declare_binding</a></li>
<li><a href="#L192">delay_constructor</a></li>
<li><a href="#L343">delay_constructor</a></li>
<li><a href="#L109">delay_impure</a></li>
<li><a href="#L143">delay_impure</a></li>
<li><a href="#L439">direct</a></li>
<li><a href="#L442">dps</a></li>
<li><a href="#L953">dps</a></li>
<li><a href="#L970">dps_var</a></li>
<li><a href="#L331">ensures_affine</a></li>
<li><a href="#L526">explicit_subterms</a></li>
<li><a href="#L501">find_nonambiguous_tmc_call</a></li>
<li><a href="#L1015">fixing</a></li>
<li><a href="#L194">lambda</a></li>
<li><a href="#L422">lambda</a></li>
<li><a href="#L478">list</a></li>
<li><a href="#L554">llets</a></li>
<li><a href="#L190">make</a></li>
<li><a href="#L340">make</a></li>
<li><a href="#L195">map</a></li>
<li><a href="#L430">map</a></li>
<li><a href="#L61">offset_code</a></li>
<li><a href="#L473">option</a></li>
<li><a href="#L196">pair</a></li>
<li><a href="#L445">pair</a></li>
<li><a href="#L986">print_msg</a></li>
<li><a href="#L1008">print_msg</a></li>
<li><a href="#L318">reify_delay</a></li>
<li><a href="#L976">rewrite</a></li>
<li><a href="#L191">run</a></li>
<li><a href="#L995">submgs</a></li>
<li><a href="#L517">tmc_call_subterms</a></li>
<li><a href="#L125">tmc_placeholder</a></li>
<li><a href="#L973">traverse_list</a></li>
<li><a href="#L197">unit</a></li>
<li><a href="#L456">unit</a></li>
<li><a href="#L93">with_placeholder</a></li>
<li><a href="#L130">with_placeholder</a></li>
<li><a href="#L279">write_to_dst</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L28">ambiguous_arguments</a></li>
<li><a href="#L545">context</a></li>
<li><a href="#L43">destination</a></li>
<li><a href="#L199">dps</a></li>
<li><a href="#L37">error</a></li>
<li><a href="#L48">offset</a></li>
<li><a href="#L548">specialized</a></li>
<li><a href="#L25">subterm_information</a></li>
<li><a href="#L111">t</a></li>
<li><a href="#L188">t</a></li>
<li><a href="#L201">t</a></li>
<li><a href="#L383">t</a></li>
<li><a href="#L21">tmc_call_information</a></li>
<li><a href="#L490">tmc_call_search</a></li>
<li><a href="#L495">zipper</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">(**************************************************************************)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Frédéric Bour&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Gabriel Scherer, projet Partout, INRIA Saclay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Basile Clément, projet Cambium, INRIA Paris&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; Copyright 2020 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(**************************************************************************)<br/></li>
<li></span><br/></li>
<li><span class="Statement"><a href="matching.ml.html#L419" title="ocaml/lambda/matching.ml:419">open</a></span><span class="ocamlNone"> </span><span class="PreProc">Lambda<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Error-reporting information for ambiguous TMC calls *)<br/></li>
<li><a id="L21">&#x200c;</a></span><span class="Statement">type</span> <span class="ocamlLCIdentifier"><span class="linkable">tmc_call_information</span></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span>: <span class="ocamlLCIdentifier"><a href="lambda.mli.html#L277" title="ocaml/lambda/lambda.mli:277">scoped_location</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">explicit</span>: <span class="Type">bool</span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="Statement">type</span> <span class="ocamlLCIdentifier"><span class="linkable">subterm_information</span></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">tmc_calls</span>: <span class="ocamlLCIdentifier"><a href="#L21" title="ocaml/lambda/tmc.ml:21">tmc_call_information</a></span> <span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li><a id="L28">&#x200c;</a></span><span class="Statement">type</span> <span class="ocamlLCIdentifier"><span class="linkable">ambiguous_arguments</span></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">explicit</span>: <span class="Type">bool</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Comment">(** When [explicit = true], we have an ambiguity between<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; arguments containing calls that have been explicitly<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; marked [@tailcall]. Otherwise we have an ambiguity<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; between un-annotated calls. *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">arguments</span>: <span class="ocamlLCIdentifier"><a href="#L25" title="ocaml/lambda/tmc.ml:25">subterm_information</a></span> <span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L37">&#x200c;</a><span class="Statement">type</span> <span class="ocamlLCIdentifier"><span class="linkable">error</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Ambiguous_constructor_arguments</span> <span class="Statement">of</span> <span class="ocamlLCIdentifier"><a href="#L28" title="ocaml/lambda/tmc.ml:28">ambiguous_arguments</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">exception</span> <span class="Constant">Error</span> <span class="Statement">of</span> <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">*</span> <span class="ocamlLCIdentifier"><a href="translprim.mli.html#L46" title="ocaml/lambda/translprim.mli:46">error</a><br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L43">&#x200c;</a><span class="Statement">type</span> '<span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span> <span class="ocamlLCIdentifier"><span class="linkable">destination</span></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>: <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span>: '<span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> : <span class="PreProc">Debuginfo</span>.<span class="PreProc">Scoped_location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li><a id="L48">&#x200c;</a></span><span class="Statement">and</span> <span class="ocamlLCIdentifier"><span class="linkable">offset</span></span> <span class="Statement">=</span> <span class="Constant">Offset</span> <span class="Statement">of</span> <span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a><br/></li>
<li></span><span class="Comment">(** In the OCaml value model, interior pointers are not allowed.&nbsp; To<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; represent the &quot;placeholder to mutate&quot; in DPS code, we thus use a <a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; of the block containing the placeholder, and the <a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a> of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; placeholder within the block.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; In the common case, this <a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a> is an arbitrary <a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> expression, typically<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; a constant integer or a variable. We define ['a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>] as parametrized<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; over the <a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a> type to represent formal <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> parameters (where<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; the <a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a> is an Ident.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>), and maybe in the future statically-known<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; offsets (where the <a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a> is an integer).<br/></li>
<li></span><span class="Comment">*)<br/></li>
<li></span><br/></li>
<li><a id="L61">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">offset_code</span></span> <span class="Statement">(</span><span class="Constant">Offset</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li></span><br/></li>
<li><a id="L63">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">add_dst_params</span></span> <span class="Statement">({</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="Statement">}</span> : <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="ocamlLCIdentifier"><a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a></span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="Constant">Pgenval</span><span class="Statement">)</span> <span class="Statement">::</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span>, <span class="Constant">Pintval</span><span class="Statement">)</span> <span class="Statement">::</span> <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a><br/></li>
<li></span><br/></li>
<li><a id="L66">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">add_dst_args</span></span> <span class="Statement">({</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="Statement">}</span> : <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span> <span class="ocamlLCIdentifier"><a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a></span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Constant">Lvar</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="Statement">::</span> <span class="ocamlLCIdentifier"><a href="#L61" title="ocaml/lambda/tmc.ml:61">offset_code</a></span> <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span> <span class="Statement">::</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a><br/></li>
<li></span><br/></li>
<li><a id="L69">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">assign_to_dst</span></span> <span class="Statement">{</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">}</span> <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Constant">Lprim</span><span class="Statement">(</span><span class="Constant">Psetfield_computed</span><span class="Statement">(</span><span class="Constant">Pointer</span>, <span class="Constant">Heap_initialization</span><span class="Statement">)</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">[</span><span class="Constant">Lvar</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L61" title="ocaml/lambda/tmc.ml:61">offset_code</a></span> <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="Statement">]</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><span class="Statement">module</span><span class="PreProc"> Constr</span><span class="ocamlPreDef"> : </span><span class="PreProc">sig<br/></li>
<li></span><span class="ocamlSig">&nbsp; </span><span class="Comment">(** The type [Constr.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] represents a reified constructor with<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; a single hole, which can be either directly applied to a [<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a>]<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; term, or be used to create a fresh [<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>] with<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; a placeholder. *)<br/></li>
<li></span><span class="ocamlSig">&nbsp; </span><span class="Statement">type</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">=</span><span class="ocamlSig"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlSig">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span><span class="ocamlSig"> : </span><span class="Type"><a href="translobj.ml.html#L84" title="ocaml/lambda/translobj.ml:84">int</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlSig">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">flag</span><span class="ocamlSig">: </span><span class="PreProc">Asttypes</span><span class="ocamlSig">.</span><span class="ocamlLCIdentifier">mutable_flag</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlSig">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L116" title="ocaml/lambda/printlambda.ml:116">block_shape</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlSig">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">before</span><span class="ocamlSig">: </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlSig">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">after</span><span class="ocamlSig">: </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlSig">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="ocamlSig"> : </span><span class="PreProc">Debuginfo</span><span class="ocamlSig">.</span><span class="PreProc">Scoped_location</span><span class="ocamlSig">.</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlSig">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="ocamlSig">&nbsp; </span><span class="Comment">(** [<a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a> constr e] plugs the expression [e] in the hole of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; constructor [const]. *)<br/></li>
<li><a id="L89">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">apply</span></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a><br/></li>
<li></span><br/></li>
<li><span class="ocamlSig">&nbsp; </span><span class="Comment">(** [<a href="#L93" title="ocaml/lambda/tmc.ml:93">with_placeholder</a> constr <a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a>] binds a placeholder<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; for the constructor [constr] within the scope of [<a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a>]. *)<br/></li>
<li><a id="L93">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">with_placeholder</span></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="Statement">)</span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a><br/></li>
<li></span><br/></li>
<li><span class="ocamlSig">&nbsp; </span><span class="Comment">(** We may want to delay the application of a constructor to a later<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; time. This may move the constructor application below some<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; effectful expressions (for example if we move into a <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; the form [foo; bar_with_tmc_inside]), and we want to preserve<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; the evaluation order of the other arguments of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; constructor. So we <a href="matching.ml.html#L2350" title="ocaml/lambda/matching.ml:2350">bind</a> them before proceeding, unless they are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; obviously side-effect free.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; [<a href="#L109" title="ocaml/lambda/tmc.ml:109">delay_impure</a> ~block_id constr <a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a>] binds all inpure arguments<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; of the constructor [constr] within the scope of [<a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a>], which is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; passed a <a href="translcore.ml.html#L592" title="ocaml/lambda/translcore.ml:592">pure</a> constructor.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; [block_id] is a counter that is used as a suffix in the generated<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; variable names, for readability purposes. *)<br/></li>
<li><a id="L109">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">delay_impure</span></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier">block_id</span><span class="ocamlSig">:</span><span class="Type"><a href="translobj.ml.html#L84" title="ocaml/lambda/translobj.ml:84">int</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="Statement">)</span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a><br/></li>
<li></span><span class="PreProc">end</span> <span class="Statement">=</span> <span class="PreProc">struct<br/></li>
<li><a id="L111">&#x200c;</a></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">type</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">t</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span><span class="ocamlFuncStruct"> : </span><span class="Type"><a href="translobj.ml.html#L84" title="ocaml/lambda/translobj.ml:84">int</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">flag</span><span class="ocamlFuncStruct">: </span><span class="PreProc">Asttypes</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">mutable_flag</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L116" title="ocaml/lambda/printlambda.ml:116">block_shape</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">before</span><span class="ocamlFuncStruct">: </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">after</span><span class="ocamlFuncStruct">: </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="ocamlFuncStruct"> : </span><span class="PreProc">Debuginfo</span><span class="ocamlFuncStruct">.</span><span class="PreProc">Scoped_location</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L120">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">apply</span></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">block_args</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">append</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">before</span><span class="ocamlFuncStruct"> @@ </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">::</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">after</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Constant">Lprim</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Pmakeblock</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">flag</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">)</span><span class="ocamlFuncStruct">,<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="ocamlLCIdentifier">block_args</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><a id="L125">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">tmc_placeholder</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Comment">(* we choose a placeholder whose tagged representation will be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; reconizable. *)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Constant">Lconst</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Const_base</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Const_int</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">0xBBBB</span><span class="ocamlFuncStruct"> / </span><span class="Constant">2</span><span class="Statement">)))<br/></li>
<li></span><br/></li>
<li><a id="L130">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">with_placeholder</span></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">k_with_placeholder</span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">{</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="Statement">with</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">flag</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Constant">Mutable</span><span class="ocamlFuncStruct"> </span><span class="Statement">}</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L125" title="ocaml/lambda/tmc.ml:125">tmc_placeholder</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">placeholder_pos</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">length</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">before</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">placeholder_pos_lam</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Constant">Lconst</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Const_base</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Const_int</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">placeholder_pos</span><span class="Statement">))</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">block_var</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">Ident</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">create_local</span><span class="ocamlFuncStruct"> </span><span class="Constant">&quot;block&quot;</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Constant">Llet</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Strict</span><span class="ocamlFuncStruct">, </span><span class="Constant">Pgenval</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">block_var</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">k_with_placeholder</span><span class="ocamlFuncStruct">,<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">block_var</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Constant">Offset</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">placeholder_pos_lam</span><span class="ocamlFuncStruct"> </span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">})<br/></li>
<li></span><br/></li>
<li><a id="L143">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">delay_impure</span></span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier">block_id</span><span class="ocamlFuncStruct">:</span><span class="Type"><a href="translobj.ml.html#L84" title="ocaml/lambda/translobj.ml:84">int</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">bind_list</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">block_id</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">arg_offset</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">lambdas</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L473" title="ocaml/lambda/translprim.ml:473">k</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">can_be_delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Note that the delayed subterms will be used<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exactly once in the linear-static subterm. So<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; we are happy to delay constants, which we would<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; not want to <a href="lambda.mli.html#L431" title="ocaml/lambda/lambda.mli:431">duplicate</a>. *)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">function<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="Constant">Lvar</span><span class="ocamlFuncStruct"> </span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="Constant">Lconst</span><span class="ocamlFuncStruct"> </span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="Constant">true<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="Constant">false</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">bindings</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">lambdas<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|&gt;</span><span class="ocamlFuncStruct"> </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">mapi</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">can_be_delayed</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="ocamlNone"> </span><span class="Statement">then</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">None</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="Statement">)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else</span><span class="ocamlFuncStruct"> </span><span class="Statement">begin<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">v</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">create_local<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">(</span><span class="PreProc">Printf</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">sprintf</span><span class="ocamlEnd"> </span><span class="Constant">&quot;block%d_arg%d&quot;</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">block_id</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">arg_offset</span><span class="ocamlEnd"> + </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a></span><span class="Statement">))</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">(</span><span class="Constant">Some</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">v</span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="Statement">)</span><span class="ocamlEnd">, </span><span class="Constant">Lvar</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">v</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">end)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|&gt;</span><span class="ocamlFuncStruct"> </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">split</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L473" title="ocaml/lambda/translprim.ml:473">k</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">fold_right</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">binding</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">match</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">binding</span><span class="ocamlFuncStruct"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="Constant">None</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a><br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="Constant">Some</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">v</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="Constant">Llet</span><span class="Statement">(</span><span class="Constant">Strict</span><span class="ocamlFuncStruct">, </span><span class="Constant">Pgenval</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">v</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">bindings</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">block_id</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">bind_list</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">block_id</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">arg_offset</span><span class="ocamlFuncStruct">:</span><span class="Constant">0</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">before</span><span class="ocamlFuncStruct"> @@ </span><span class="Statement">fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">vbefore</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">arg_offset</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">length</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">before</span><span class="ocamlFuncStruct"> + </span><span class="Constant">1</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">bind_list</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">block_id</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">arg_offset</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">after</span><span class="ocamlFuncStruct"> @@ </span><span class="Statement">fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">vafter</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">{</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="Statement">with</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">before</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">vbefore</span><span class="Statement">;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">after</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">vafter</span><span class="ocamlFuncStruct"> </span><span class="Statement">}<br/></li>
<li></span><span class="PreProc">end<br/></li>
<li></span><br/></li>
<li><span class="Comment">(** The type ['a Dps.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] (<a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style) represents a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; version of ['a] that is parametrized over a [<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>].<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; A [<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> Dps.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] is a code fragment in <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; a [(<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> * <a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a>) Dps.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] represents two subterms parametrized<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; over the same <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>. *)<br/></li>
<li></span><span class="Statement">module</span><span class="PreProc"> Dps</span><span class="ocamlPreDef"> : </span><span class="PreProc">sig<br/></li>
<li></span><span class="ocamlSig">&nbsp; </span><span class="Statement">type</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlSig"> </span><span class="Statement">=</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlSig">:</span><span class="Type">bool</span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier">dst</span><span class="ocamlSig">:</span><span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">a<br/></li>
<li></span><span class="ocamlSig">&nbsp; </span><span class="Comment">(** A term parameterized over a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>.&nbsp; The [<a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>] argument<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; is passed by the caller to indicate whether the term will be placed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-position -- this allows to generate correct @tailcall<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; annotations. *)<br/></li>
<li></span><br/></li>
<li><a id="L188">&#x200c;</a><span class="ocamlSig">&nbsp; </span><span class="Statement">type</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">t</span><br/></li>
<li></span><br/></li>
<li><a id="L190">&#x200c;</a><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">make</span></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li><a id="L191">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">run</span></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a><br/></li>
<li><a id="L192">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">delay_constructor</span></span><span class="ocamlSig"> : </span><span class="PreProc">Constr</span><span class="ocamlSig">.</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li></span><br/></li>
<li><a id="L194">&#x200c;</a><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">lambda</span></span><span class="ocamlSig"> : </span><span class="ocamlLCIdentifier"><span class="linkable">lambda</span></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">lambda</span></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li><a id="L195">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">map</span></span><span class="ocamlSig"> : </span><span class="Statement">(</span><span class="ocamlSig">'</span><span class="ocamlLCIdentifier">a</span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">b</span><span class="Statement">)</span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">b</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li><a id="L196">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><span class="linkable">pair</span></span><span class="ocamlSig"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">b</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlSig"> </span><span class="Statement">-&gt;</span><span class="ocamlSig"> </span><span class="Statement">(</span><span class="ocamlSig">'</span><span class="ocamlLCIdentifier">a</span><span class="ocamlSig"> </span><span class="Statement">*</span><span class="ocamlSig"> '</span><span class="ocamlLCIdentifier">b</span><span class="Statement">)</span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li><a id="L197">&#x200c;</a></span><span class="ocamlSig">&nbsp; </span><span class="Statement">val</span><span class="ocamlSig"> </span><span class="Type"><span class="linkable">unit</span></span><span class="ocamlSig"> : </span><span class="Type"><span class="linkable">unit</span></span><span class="ocamlSig"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li></span><span class="PreProc">end</span> <span class="Statement">=</span> <span class="PreProc">struct<br/></li>
<li><a id="L199">&#x200c;</a></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">type</span><span class="ocamlFuncStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">dps</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct">:</span><span class="Type">bool</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">dst</span><span class="ocamlFuncStruct">:</span><span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> '</span><span class="ocamlLCIdentifier">a<br/></li>
<li></span><br/></li>
<li><a id="L201">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">type</span><span class="ocamlFuncStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">t</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier">delayed</span><span class="ocamlFuncStruct">:</span><span class="PreProc">Constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> : </span><span class="Type"><a href="translobj.ml.html#L84" title="ocaml/lambda/translobj.ml:84">int</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Comment">(** We want to optimize nested constructors, for example:<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; {[<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (x () :: y () :: tmc call)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; ]}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; which would naively generate (in a DPS <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> parametrized<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; over a location dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a>):<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; {[<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let dstx = x () :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- dstx;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let dsty = y () :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; dstx.1 &lt;- dsty;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; tmc dsty.1 call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; ]}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; when we would rather hope for<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; {[<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let vx = x () in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let dsty = y () :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- vx :: dsty;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; tmc dsty.1 call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; ]}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; The idea is that the unoptimized version first creates a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> site [dstx], which is then used by the following<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; code.&nbsp; If we keep track of the current <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>:<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; {[<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Destination is [dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a>] *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let dstx = x () :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> (* Destination *) &lt;- dstx;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Destination is [dstx.1] *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let dsty = y () :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; dstx.1 (* Destination *) &lt;- dsty;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Destination is [dsty.1] *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; tmc dsty.1 call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; ]}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; Instead of binding the whole newly-created <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>, we can<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; simply let-<a href="matching.ml.html#L2350" title="ocaml/lambda/matching.ml:2350">bind</a> the non-placeholder arguments (in order to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; preserve execution order), and keep track of a <a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a> of blocks to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; be created along with the current <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>.&nbsp; Instead of seeing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; a DPS fragment as writing to a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>, we see it as a term<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; with <a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a> [dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- C .] where [C .] is a linear <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> consisting<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; only of constructor applications.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; {[<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Destination is [dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- C .] *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let vx = x () in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Destination is [dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- C (vx :: .)] *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let vy = y () in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Destination is [dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- C (vx :: vy :: .)] *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; (* Making a call: reify the <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> *)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; let dsty = vy :: Placeholder in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; dst.<a href="translclass.ml.html#L713" title="ocaml/lambda/translclass.ml:713">i</a> &lt;- vx :: dsty;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; tmc dsty.1 call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; ]}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; The [delayed] argument represents the <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> [C] as a <a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a> of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; reified constructors, to allow both to <a href="translclass.ml.html#L182" title="ocaml/lambda/translclass.ml:182">build</a> the final holey<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; block ([vy :: Placeholder]) at the recursive call site, and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; the delayed constructor applications ([vx :: dsty]).<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; In practice, it is not desirable to perform this simplification<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; when there are multiple TMC calls (e.g. in different branches of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; an [if] block), because it would cause duplication of the nested<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; constructor applications.&nbsp; The [delayed_use_count] <a href="translmod.ml.html#L1095" title="ocaml/lambda/translmod.ml:1095">field</a> keeps track<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; of this information, it counts the number of syntactic use sites<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; of the delayed constructors, if any, in the generated code.<br/></li>
<li></span><span class="Comment">&nbsp; *)<br/></li>
<li></span><br/></li>
<li><a id="L279">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">write_to_dst</span></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">dst</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L69" title="ocaml/lambda/tmc.ml:69">assign_to_dst</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">dst</span><span class="ocamlFuncStruct"> @@<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">fold_left</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="PreProc">Constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">delayed<br/></li>
<li></span><br/></li>
<li><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">v</span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct">:</span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L279" title="ocaml/lambda/tmc.ml:279">write_to_dst</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">dst</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">v<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">);<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Constant">1</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Comment">(** Create a new <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style term which is simply<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; setting the <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> with the given [v], hence &quot;returning&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; it.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; *)<br/></li>
<li></span><br/></li>
<li><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="Type"><a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a></span><span class="ocamlFuncStruct"> : </span><span class="Type"><a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct">:</span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct">:</span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct">:</span><span class="Statement">_</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Constant">()<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">);<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Constant">0</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> '</span><span class="ocamlLCIdentifier">b</span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">b</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlFuncStruct"> @@ </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="Statement">);<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">da</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">db</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">b</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : </span><span class="Statement">(</span><span class="ocamlFuncStruct">'</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="Statement">*</span><span class="ocamlFuncStruct"> '</span><span class="ocamlLCIdentifier">b</span><span class="Statement">)</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">(</span><span class="ocamlLCIdentifier">da</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct">, </span><span class="ocamlLCIdentifier">db</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="Statement">));<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">da</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> + </span><span class="ocamlLCIdentifier">db</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L191" title="ocaml/lambda/tmc.ml:191">run</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct">:</span><span class="Constant">[]<br/></li>
<li></span><br/></li>
<li><a id="L318">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">reify_delay</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">match</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="Constant">[]</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">x</span><span class="ocamlFuncStruct"> </span><span class="Statement">::</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">xs</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="PreProc">Constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="#L93" title="ocaml/lambda/tmc.ml:93">with_placeholder</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">x</span><span class="ocamlFuncStruct"> @@ </span><span class="Statement">fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">new_dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Lsequence</span><span class="ocamlFuncStruct"> </span><span class="Statement">(<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L279" title="ocaml/lambda/tmc.ml:279">write_to_dst</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">dst</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">xs</span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="Constant">Lvar</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">new_dst</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="Statement">)</span><span class="ocamlFuncStruct">,<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct">:</span><span class="ocamlLCIdentifier">new_dst</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">);<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Constant">1</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L331">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">ensures_affine</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">d</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlNone"> </span><span class="Statement">&lt;=</span><span class="ocamlNone"> </span><span class="Constant">1</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">d<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">else<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L318" title="ocaml/lambda/tmc.ml:318">reify_delay</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L191" title="ocaml/lambda/tmc.ml:191">run</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">d</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="Comment">(** Ensures that the resulting term does not <a href="lambda.mli.html#L431" title="ocaml/lambda/lambda.mli:431">duplicate</a> delayed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; constructors by reifying them now if needed.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; *)<br/></li>
<li></span><br/></li>
<li><a id="L340">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">make</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">)</span><span class="ocamlFuncStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L318" title="ocaml/lambda/tmc.ml:318">reify_delay</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a><br/></li>
<li></span><br/></li>
<li><a id="L343">&#x200c;</a><span class="ocamlFuncStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">delay_constructor</span></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="#L331" title="ocaml/lambda/tmc.ml:331">ensures_affine</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct"> </span><span class="Statement">in</span><span class="ocamlFuncStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="Statement">(fun</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">block_id</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">List</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">length</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">delayed</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="PreProc">Constr</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="#L109" title="ocaml/lambda/tmc.ml:109">delay_impure</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">block_id</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> @@ </span><span class="Statement">fun</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">code</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlFuncStruct"> </span><span class="Statement">~</span><span class="Identifier">delayed</span><span class="ocamlFuncStruct">:</span><span class="Statement">(</span><span class="ocamlLCIdentifier">constr</span><span class="ocamlFuncStruct"> </span><span class="Statement">::</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">delayed</span><span class="Statement">));<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">d</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">delayed_use_count</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="PreProc">end<br/></li>
<li></span><br/></li>
<li><span class="Comment">(** The TMC transformation requires information flows in two opposite<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; directions: the information of which callsites can be rewritten in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style flows from the leaves of the code to the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; root, and the information on whether we remain in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-position<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; flows from the root to the leaves -- and also the knowledge of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; which version of the function we currently want to generate, the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a> version or a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing-style version.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; To clarify this double flow of information, we split the TMC<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; transform in two steps:<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; 1. A function [<a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a> <a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] that takes a term and processes it from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; leaves to root; it produces a &quot;code <a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a>&quot;, a piece of data of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; type [<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> Choice.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>], that contains information on how to transform the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; input term [<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] *parameterized* over the (still missing) contextual<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; information.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; 2. Code-production operators that have contextual information<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; to transform a &quot;code <a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a>&quot; into the final code.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; The code-production choices for a single term have type [<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> Choice.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>];<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; using a parametrized type ['a Choice.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] is <a href="translprim.ml.html#L487" title="ocaml/lambda/translprim.ml:487">useful</a> to represent<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; simultaneous choices over several subterms; for example<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; [(<a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a> * <a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a>) Choice.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] makes a <a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a> for a <a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a> of terms,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; for example the [then] and [else] cases of a conditional. With<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; this parameter, ['a Choice.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] has an applicative structure, which<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; is <a href="translprim.ml.html#L487" title="ocaml/lambda/translprim.ml:487">useful</a> to write the actual code transformation in the {!<a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a>}<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; function.<br/></li>
<li></span><span class="Comment">*)<br/></li>
<li></span><span class="Statement">module</span><span class="PreProc"> Choice</span><span class="ocamlPreDef"> </span><span class="Statement">=</span> <span class="PreProc">struct<br/></li>
<li><a id="L383">&#x200c;</a></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">type</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">t</span></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="PreProc">Dps</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> : </span><span class="Type"><a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a></span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> : </span><span class="ocamlLCIdentifier"><a href="#L21" title="ocaml/lambda/tmc.ml:21">tmc_call_information</a></span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlStruct">: </span><span class="Type">bool</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct">: </span><span class="Type">bool</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Comment">(**<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; An ['a Choice.<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>] represents code that may be written<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; in <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing style if its usage <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> allows it.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; More precisely:<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; - If the surrounding <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> is already in <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>-passing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; style, it has a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> available, we should produce the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; code in [<a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a>] -- a function parametrized over the <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; - If the surrounding <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> is in <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a> style (no <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; is available), we should produce the fallback code from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; [<a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>].<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; (Note: [<a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>] is also a function (on [<a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a>]) to ensure that any<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; effects performed during code production will only happen once we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; do know that we want to produce the <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>-style code.)<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; - [tmc_calls] tracks the function calls in the subterms that are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-modulo-<a href="debuginfo.ml.html#L36" title="ocaml/lambda/debuginfo.ml:36">cons</a> position and get rewritten into tailcalls<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; in the [<a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a>] version.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; - [benefits_from_dps] is true when the [<a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a>] calls strictly more<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; TMC functions than the [<a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>] version. See the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; {!choice_makeblock} case.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; - [explicit_tailcall_request] is true when the user<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; used a [@tailcall] annotation on the optimizable callsite.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; When one of several calls could be optimized, we expect that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; exactly one of them will be annotated by the user, or fail<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; because the situation is ambiguous.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; *)<br/></li>
<li></span><br/></li>
<li><a id="L422">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">lambda</span></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">v</span><span class="ocamlStruct"> : </span><span class="ocamlLCIdentifier"><span class="linkable">lambda</span></span><span class="Statement">)</span><span class="ocamlStruct"> : </span><span class="ocamlLCIdentifier"><span class="linkable">lambda</span></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">Dps</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">v</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">(fun</span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">v</span><span class="Statement">);<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L430">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">map</span></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">Dps</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">(fun</span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="Statement">));<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">tmc_calls</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Comment">(** Apply function [<a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a>] to the transformed term. *)<br/></li>
<li></span><br/></li>
<li><a id="L439">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">direct</span></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Constant">()<br/></li>
<li></span><br/></li>
<li><a id="L442">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">dps</span></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> : </span><span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlStruct"> </span><span class="Statement">~</span><span class="Identifier">dst</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="PreProc">Dps</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L191" title="ocaml/lambda/tmc.ml:191">run</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> </span><span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlStruct"> </span><span class="Statement">~</span><span class="Identifier">dst<br/></li>
<li></span><br/></li>
<li><a id="L445">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">pair</span></span><span class="ocamlStruct"> </span><span class="Statement">((</span><span class="ocamlLCIdentifier">c1</span><span class="ocamlStruct">, </span><span class="ocamlLCIdentifier">c2</span><span class="Statement">)</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Statement">*</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">b</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span><span class="ocamlStruct"> : </span><span class="Statement">(</span><span class="ocamlStruct">'</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Statement">*</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">b</span><span class="Statement">)</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">Dps</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c1</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c2</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">(fun</span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">c1</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="ocamlStruct">, </span><span class="ocamlLCIdentifier">c2</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="Statement">));<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">c1</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> @ </span><span class="ocamlLCIdentifier">c2</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">tmc_calls</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">c1</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlStruct"> </span><span class="Statement">||</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c2</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">c1</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct"> </span><span class="Statement">||</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c2</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L456">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">unit</span></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">Dps</span><span class="ocamlStruct">.</span><span class="Type"><a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">(fun</span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="Constant">()</span><span class="Statement">);<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Comment">(* Remark: we could define [<a href="translcore.ml.html#L592" title="ocaml/lambda/translcore.ml:592">pure</a> v] as [<a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> (fun () -&gt; v) <a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a>],<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; but we prefer to have the code explicit about using [<a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a>],<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; in particular as it ignores the <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> argument. *)<br/></li>
<li></span><br/></li>
<li><span class="ocamlStruct">&nbsp; </span><span class="Statement">module</span><span class="PreProc"> Syntax</span><span class="ocamlPreDef"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">struct<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="Statement">(let</span><span class="ocamlStruct">+</span><span class="Statement">)</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">a<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="Statement">(and</span><span class="ocamlStruct">+</span><span class="Statement">)</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">a1</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">a2</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">a1</span><span class="ocamlStruct">, </span><span class="ocamlLCIdentifier">a2</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="PreProc">end<br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement"><a href="matching.ml.html#L419" title="ocaml/lambda/matching.ml:419">open</a></span><span class="ocamlNone"> </span><span class="PreProc">Syntax<br/></li>
<li></span><br/></li>
<li><a id="L473">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">option</span></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">option</span></span><span class="Statement">)</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">option</span></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">match</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">None</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="Statement">let</span><span class="ocamlStruct">+ </span><span class="Constant">()</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Type"><a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a></span><span class="ocamlStruct"> </span><span class="Statement">in</span><span class="ocamlStruct"> </span><span class="Constant">None<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">Some</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="Statement">let</span><span class="ocamlStruct">+ </span><span class="ocamlLCIdentifier">v</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">in</span><span class="ocamlStruct"> </span><span class="Constant">Some</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">v<br/></li>
<li></span><br/></li>
<li><a id="L478">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="Statement">rec</span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">list</span></span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">list</span></span><span class="Statement">)</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Type"><span class="linkable">list</span></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">match</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="Statement">let</span><span class="ocamlStruct">+ </span><span class="Constant">()</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Type"><a href="#L197" title="ocaml/lambda/tmc.ml:197">unit</a></span><span class="ocamlStruct"> </span><span class="Statement">in</span><span class="ocamlStruct"> </span><span class="Constant">[]<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">::</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">cs</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct">+ </span><span class="ocamlLCIdentifier">v</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">and</span><span class="ocamlStruct">+ </span><span class="ocamlLCIdentifier">vs</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">cs<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">in</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">v</span><span class="ocamlStruct"> </span><span class="Statement">::</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">vs<br/></li>
<li></span><br/></li>
<li><span class="ocamlStruct">&nbsp; </span><span class="Comment">(** The [find_*] machinery is used to locate a single subterm to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; optimize among a <a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a> of subterms. If there are several possible<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; choices, we require that exactly one of them be annotated with<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; [@tailcall], or we report an ambiguity. *)<br/></li>
<li><a id="L490">&#x200c;</a></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">type</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">tmc_call_search</span></span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">No_tmc_call</span><span class="ocamlStruct"> </span><span class="Statement">of</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a><br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">Nonambiguous</span><span class="ocamlStruct"> </span><span class="Statement">of</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L495" title="ocaml/lambda/tmc.ml:495">zipper</a><br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">Ambiguous</span><span class="ocamlStruct"> </span><span class="Statement">of</span><span class="ocamlStruct"> </span><span class="Statement">{</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">explicit</span><span class="ocamlStruct">: </span><span class="Type">bool</span><span class="Statement">;</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">subterms</span><span class="ocamlStruct">: '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;</span><span class="ocamlStruct"> </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L495">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">and</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">zipper</span></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">rev_before</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier">after</span><span class="ocamlStruct">: '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a><br/></li>
<li></span><span class="ocamlStruct">&nbsp; </span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L501">&#x200c;</a><span class="ocamlStruct">&nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">find_nonambiguous_tmc_call</span></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">choices</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">has_tmc_calls</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlStruct"> </span><span class="Statement">&lt;&gt;</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="ocamlStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">is_explicit</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="translclass.ml.html#L563" title="ocaml/lambda/translclass.ml:563">s</a></span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="ocamlStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">nonambiguous</span><span class="ocamlStruct"> </span><span class="Statement">~</span><span class="Identifier">only_explicit_calls</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">choices</span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="Comment">(* here is how we will compute the result once we know that there<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; is an unambiguously-determined tmc call, and whether<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; an explicit request was necessary to disambiguate *)<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="Statement">rec</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">split</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">rev_before</span><span class="ocamlStruct"> : '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="ocamlStruct"> </span><span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> '</span><span class="ocamlLCIdentifier">a</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L495" title="ocaml/lambda/tmc.ml:495">zipper</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="Statement">function<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="Statement">assert</span><span class="ocamlStruct"> </span><span class="Constant">false</span><span class="ocamlStruct"> </span><span class="Comment">(* we know there is at least one <a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a> *)<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">::</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">rest</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">has_tmc_calls</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlNone"> </span><span class="Statement">&amp;&amp;</span><span class="ocamlNone"> </span><span class="Statement">(not</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">only_explicit_calls</span><span class="ocamlNone"> </span><span class="Statement">||</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">is_explicit</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">c</span><span class="Statement">)</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">{</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">rev_before</span><span class="Statement">;</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="Statement">;</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">after</span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">List</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">rest</span><span class="ocamlStruct"> </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">split</span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">::</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">rev_before</span><span class="Statement">)</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">rest<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">in</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">split</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">choices<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">in<br/></li>
<li><a id="L517">&#x200c;</a></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">tmc_call_subterms</span></span><span class="ocamlStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; </span><span class="PreProc">List</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">filter</span><span class="ocamlStruct"> </span><span class="Statement">(fun</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">has_tmc_calls</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="Statement">)</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">choices<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">match</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L517" title="ocaml/lambda/tmc.ml:517">tmc_call_subterms</a></span><span class="ocamlStruct"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Constant">[]</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">No_tmc_call</span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="PreProc">List</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">choices</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="Statement">[</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">_one</span><span class="ocamlStruct"> </span><span class="Statement">]</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Nonambiguous</span><span class="ocamlStruct"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">nonambiguous</span><span class="ocamlStruct"> </span><span class="Statement">~</span><span class="Identifier">only_explicit_calls</span><span class="ocamlStruct">:</span><span class="Constant">false</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">choices</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">several_subterms</span><span class="ocamlStruct"> </span><span class="Statement">-&gt;<br/></li>
<li><a id="L526">&#x200c;</a></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">explicit_subterms</span></span><span class="ocamlStruct"> </span><span class="Statement">=</span><span class="ocamlStruct"> </span><span class="PreProc">List</span><span class="ocamlStruct">.</span><span class="ocamlLCIdentifier">filter</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">is_explicit</span><span class="ocamlStruct"> </span><span class="ocamlLCIdentifier">several_subterms</span><span class="ocamlStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlStruct">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">begin</span><span class="ocamlEnd"> </span><span class="Statement">match</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L526" title="ocaml/lambda/tmc.ml:526">explicit_subterms</a></span><span class="ocamlEnd"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Constant">[]</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Ambiguous</span><span class="ocamlEnd"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">subterms</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">several_subterms</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Statement">[</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">_one</span><span class="ocamlEnd"> </span><span class="Statement">]</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Nonambiguous</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">nonambiguous</span><span class="ocamlEnd"> </span><span class="Statement">~</span><span class="Identifier">only_explicit_calls</span><span class="ocamlEnd">:</span><span class="Constant">true</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">choices</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">several_explicit_subterms</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Ambiguous</span><span class="ocamlEnd"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">explicit</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Constant">true</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">subterms</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">several_explicit_subterms</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">}<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">end<br/></li>
<li></span><span class="PreProc">end<br/></li>
<li></span><br/></li>
<li><span class="Statement"><a href="matching.ml.html#L419" title="ocaml/lambda/matching.ml:419">open</a></span><span class="ocamlNone"> </span><span class="PreProc">Choice.Syntax<br/></li>
<li></span><br/></li>
<li><a id="L545">&#x200c;</a><span class="Statement">type</span> <span class="ocamlLCIdentifier"><span class="linkable">context</span></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span>: <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li><a id="L548">&#x200c;</a></span><span class="Statement">and</span> <span class="ocamlLCIdentifier"><span class="linkable">specialized</span></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">arity</span>: <span class="Type"><a href="translobj.ml.html#L84" title="ocaml/lambda/translobj.ml:84">int</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">dps_id</span>: <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">direct_kind</span>: <span class="ocamlLCIdentifier"><a href="lambda.mli.html#L248" title="ocaml/lambda/lambda.mli:248">function_kind</a></span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L554">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">llets</span></span> <span class="ocamlLCIdentifier">lk</span> <span class="ocamlLCIdentifier">vk</span> <span class="ocamlLCIdentifier">bindings</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">fold_right</span> <span class="Statement">(fun</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">Llet</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">lk</span>, <span class="ocamlLCIdentifier">vk</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; <span class="Statement">)</span> <span class="ocamlLCIdentifier">bindings</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">find_candidate</span> <span class="Statement">=</span> <span class="Statement">function<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Lfunction</span> <span class="ocamlLCIdentifier">lfun</span> <span class="Statement">when</span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="simplif.ml.html#L760" title="ocaml/lambda/simplif.ml:760">attr</a></span>.<span class="ocamlLCIdentifier">tmc_candidate</span> <span class="Statement">-&gt;</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier">lfun<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="Constant">None<br/></li>
<li></span><br/></li>
<li><a id="L563">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">declare_binding</span></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">find_candidate</span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">None</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">ctx<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier">lfun</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">arity</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">length</span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">dps_id</span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_local</span> <span class="Statement">(</span><span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L56" title="ocaml/lambda/translcore.ml:56">name</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="Statement">^</span> <span class="Constant">&quot;_dps&quot;</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">direct_kind</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L383" title="ocaml/lambda/translcore.ml:383">kind</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">cand</span> <span class="Statement">=</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">arity</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">dps_id</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">direct_kind</span><span class="Statement">;</span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L884" title="ocaml/lambda/matching.ml:884">add</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="ocamlLCIdentifier">cand</span> <span class="ocamlLCIdentifier">ctx</span>.<span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span> <span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L573">&#x200c;</a><span class="Statement">let</span> <span class="Statement">rec</span> <span class="ocamlLCIdentifier"><span class="linkable">choice</span></span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="Statement">rec</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">(</span><span class="Constant">Lvar</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Lmutvar</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Lconst</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Lfunction</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Lsend</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lassign</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Lfor</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Lwhile</span> <span class="Statement">_)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* [choice_prim] handles most primitives, but the important case<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; of construction [Lprim(Pmakeblock(...), ...)] is handled by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; [choice_makeblock] *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lprim</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L80" title="ocaml/lambda/translprim.ml:80">prim</a></span>, <span class="ocamlLCIdentifier">primargs</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">choice_prim</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L80" title="ocaml/lambda/translprim.ml:80">prim</a></span> <span class="ocamlLCIdentifier">primargs</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a><br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* [choice_apply] handles applications, in particular <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-calls which<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; generate Set choices at the leaves *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lapply</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">choice_apply</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">(* other cases use the [lift] helper that takes the sub-terms in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; position and the <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a> around them, and generates a <a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a> for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; the whole term from choices for the <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a> subterms. *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lsequence</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">l2</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">l2</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">l2</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lsequence</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">l2</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lifthenelse</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">l2</span>, <span class="ocamlLCIdentifier">l3</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="Statement">(</span><span class="ocamlLCIdentifier">l2</span>, <span class="ocamlLCIdentifier">l3</span><span class="Statement">)</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">choice_pair</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l2</span>, <span class="ocamlLCIdentifier">l3</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lifthenelse</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">l2</span>, <span class="ocamlLCIdentifier">l3</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lmutlet</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">vk</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* mutable bindings are not TMC-<a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a> *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lmutlet</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">vk</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Llet</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">lk</span>, <span class="ocamlLCIdentifier">vk</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ctx</span>, <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse_let</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L554" title="ocaml/lambda/tmc.ml:554">llets</a></span> <span class="ocamlLCIdentifier">lk</span> <span class="ocamlLCIdentifier">vk</span> <span class="ocamlLCIdentifier">bindings</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lletrec</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">bindings</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ctx</span>, <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse_letrec</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lletrec</span><span class="Statement">(</span><span class="ocamlLCIdentifier">bindings</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lswitch</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">sw</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* decompose *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">consts_lhs</span>, <span class="ocamlLCIdentifier">consts_rhs</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">split</span> <span class="ocamlLCIdentifier">sw</span>.<span class="ocamlLCIdentifier">sw_consts</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">blocks_lhs</span>, <span class="ocamlLCIdentifier">blocks_rhs</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">split</span> <span class="ocamlLCIdentifier">sw</span>.<span class="ocamlLCIdentifier">sw_blocks</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* transform *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">consts_rhs</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">choice_list</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">consts_rhs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">and</span>+ <span class="ocamlLCIdentifier">blocks_rhs</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">choice_list</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">blocks_rhs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">and</span>+ <span class="ocamlLCIdentifier">sw_failaction</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">choice_option</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">sw</span>.<span class="ocamlLCIdentifier">sw_failaction</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* rebuild *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">sw_consts</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L525" title="ocaml/lambda/matching.ml:525">combine</a></span> <span class="ocamlLCIdentifier">consts_lhs</span> <span class="ocamlLCIdentifier">consts_rhs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">sw_blocks</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L525" title="ocaml/lambda/matching.ml:525">combine</a></span> <span class="ocamlLCIdentifier">blocks_lhs</span> <span class="ocamlLCIdentifier">blocks_rhs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">sw</span> <span class="Statement">=</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">sw</span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">sw_consts</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">sw_blocks</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">sw_failaction</span><span class="Statement">;</span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lswitch</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">sw</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lstringswitch</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">cases</span>, <span class="ocamlLCIdentifier">fail</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* decompose *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">cases_lhs</span>, <span class="ocamlLCIdentifier">cases_rhs</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">split</span> <span class="ocamlLCIdentifier">cases</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* transform *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">cases_rhs</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">choice_list</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">cases_rhs<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">and</span>+ <span class="ocamlLCIdentifier">fail</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">choice_option</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">fail</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* rebuild *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">cases</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L525" title="ocaml/lambda/matching.ml:525">combine</a></span> <span class="ocamlLCIdentifier">cases_lhs</span> <span class="ocamlLCIdentifier">cases_rhs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lstringswitch</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">cases</span>, <span class="ocamlLCIdentifier">fail</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lstaticraise</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L634" title="ocaml/lambda/translmod.ml:634">id</a></span>, <span class="ocamlLCIdentifier">ls</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ls</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L973" title="ocaml/lambda/tmc.ml:973">traverse_list</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">ls</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> <span class="Statement">(</span><span class="Constant">Lstaticraise</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translmod.ml.html#L634" title="ocaml/lambda/translmod.ml:634">id</a></span>, <span class="ocamlLCIdentifier">ls</span><span class="Statement">))<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Ltrywith</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier"><a href="translmod.ml.html#L634" title="ocaml/lambda/translmod.ml:634">id</a></span>, <span class="ocamlLCIdentifier">l2</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* in [try l1 with <a href="translmod.ml.html#L634" title="ocaml/lambda/translmod.ml:634">id</a> -&gt; l2], the term [l1] is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; not in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-call position (after it returns<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; we need to <a href="matching.ml.html#L867" title="ocaml/lambda/matching.ml:867">remove</a> the exception handler),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; so it is not transformed here *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">l2</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">l2</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Ltrywith</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier"><a href="translmod.ml.html#L634" title="ocaml/lambda/translmod.ml:634">id</a></span>, <span class="ocamlLCIdentifier">l2</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lstaticcatch</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L1050" title="ocaml/lambda/translcore.ml:1050">ids</a></span>, <span class="ocamlLCIdentifier">l2</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* In [static-catch l1 with <a href="translcore.ml.html#L1050" title="ocaml/lambda/translcore.ml:1050">ids</a> -&gt; l2],<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; the term [l1] is in fact in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-position *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">l1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">and</span>+ <span class="ocamlLCIdentifier">l2</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">l2</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lstaticcatch</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L1050" title="ocaml/lambda/translcore.ml:1050">ids</a></span>, <span class="ocamlLCIdentifier">l2</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Levent</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span>, <span class="ocamlLCIdentifier">lev</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Levent</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span>, <span class="ocamlLCIdentifier">lev</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lifused</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">x</span>, <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lifused</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">x</span>, <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">and</span> <span class="ocamlLCIdentifier">choice_apply</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="Statement">exception</span> <span class="Constant">No_tmc</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">try<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">explicit_tailcall_request</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span>.<span class="ocamlLCIdentifier">ap_tailcall</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Default_tailcall</span> <span class="Statement">-&gt;</span> <span class="Constant">false<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Tailcall_expectation</span> <span class="Constant">true</span> <span class="Statement">-&gt;</span> <span class="Constant">true<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Tailcall_expectation</span> <span class="Constant">false</span> <span class="Statement">-&gt;</span> <span class="Statement">raise</span> <span class="Constant">No_tmc<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span>.<span class="ocamlLCIdentifier">ap_func</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Lvar</span> <span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">try</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier">find</span> <span class="ocamlLCIdentifier"><a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a></span> <span class="ocamlLCIdentifier">ctx</span>.<span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">with</span> <span class="Constant">Not_found</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">prerr_warning<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(</span><span class="PreProc">Debuginfo</span>.<span class="PreProc">Scoped_location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.mli.html#L34" title="ocaml/lambda/debuginfo.mli:34">to_location</a></span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span>.<span class="ocamlLCIdentifier">ap_loc</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Warnings</span>.<span class="Constant">Tmc_breaks_tailcall</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">raise</span> <span class="Constant">No_tmc</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* Support of tupled functions: the [<a href="lambda.mli.html#L248" title="ocaml/lambda/lambda.mli:248">function_kind</a>] of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>-style function is identical to the one of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; input function, which may be Tupled, but the <a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function is always Curried.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; [<a href="lambda.mli.html#L455" title="ocaml/lambda/lambda.mli:455">find_exact_application</a>] is in charge of recovering the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &quot;real&quot; argument <a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a> of a possibly-tupled call. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L383" title="ocaml/lambda/translcore.ml:383">kind</a></span>, <span class="ocamlLCIdentifier">arity</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span>.<span class="ocamlLCIdentifier">direct_kind</span>, <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span>.<span class="ocamlLCIdentifier">arity</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">match</span> <span class="PreProc">Lambda</span>.<span class="ocamlLCIdentifier"><a href="lambda.mli.html#L455" title="ocaml/lambda/lambda.mli:455">find_exact_application</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L383" title="ocaml/lambda/translcore.ml:383">kind</a></span> <span class="Statement">~</span><span class="Identifier">arity</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span>.<span class="ocamlLCIdentifier">ap_args</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">None</span> <span class="Statement">-&gt;</span> <span class="Statement">raise</span> <span class="Constant">No_tmc<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">tailcall</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* If we are calling a tmc-specializable function in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L545" title="ocaml/lambda/tmc.ml:545">context</a>, then both the <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>-style and <a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a>-style calls<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; must be tailcalls. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a><br/></li>
<li></span><span class="ocamlNone">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">then</span> <span class="Constant">Tailcall_expectation</span> <span class="Constant">true<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Constant">Default_tailcall<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span> <span class="Statement">=</span> <span class="PreProc">Dps</span>.<span class="ocamlLCIdentifier"><a href="#L190" title="ocaml/lambda/tmc.ml:190">make</a></span> <span class="Statement">(fun</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">~</span><span class="Identifier">dst</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lapply</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="ocamlLCIdentifier">ap_func</span> <span class="Statement">=</span> <span class="Constant">Lvar</span> <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span>.<span class="ocamlLCIdentifier">dps_id</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="ocamlLCIdentifier">ap_args</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L66" title="ocaml/lambda/tmc.ml:66">add_dst_args</a></span> <span class="ocamlLCIdentifier">dst</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="ocamlLCIdentifier">ap_tailcall</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">tailcall</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">});<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span> <span class="Statement">=</span> <span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lapply</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">ap_tailcall</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">tailcall</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">});<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">tmc_calls</span> <span class="Statement">=</span> <span class="Statement">[{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span>.<span class="ocamlLCIdentifier">ap_loc</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">explicit</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}];<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">benefits_from_dps</span> <span class="Statement">=</span> <span class="Constant">true</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="ocamlLCIdentifier">_nontail</span> <span class="Statement">-&gt;</span> <span class="Statement">raise</span> <span class="Constant">No_tmc<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">with</span> <span class="Constant">No_tmc</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">apply_no_bailout</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* [@tailcall false] is interpreted as a bailout annotation: &quot;we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; are (knowingly) leaving the <a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a> calling convention&quot;. It only<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; has sense in the DPS version of the generated code, not in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a> style. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ap_tailcall</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span>.<span class="ocamlLCIdentifier">ap_tailcall</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Tailcall_expectation</span> <span class="Constant">false</span> <span class="Statement">when</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">-&gt;</span> <span class="Constant">Default_tailcall<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="ocamlLCIdentifier">other</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">other<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">ap_tailcall</span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">{</span> <span class="Statement">(</span><span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> <span class="Statement">(</span><span class="Constant">Lapply</span> <span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span><span class="Statement">))</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span> <span class="Statement">=</span> <span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;</span> <span class="Constant">Lapply</span> <span class="ocamlLCIdentifier">apply_no_bailout</span><span class="Statement">);<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">}<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">and</span> <span class="ocamlLCIdentifier">choice_makeblock</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span>:<span class="Statement">_</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span>, <span class="ocamlLCIdentifier">flag</span>, <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">)</span> <span class="ocamlLCIdentifier">blockargs</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">choices</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span>:<span class="Constant">false</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">blockargs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">match</span> <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L501" title="ocaml/lambda/tmc.ml:501">find_nonambiguous_tmc_call</a></span> <span class="ocamlLCIdentifier">choices</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="PreProc">Choice</span>.<span class="Constant">No_tmc_call</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> @@ <span class="Constant">Lprim</span> <span class="Statement">(</span><span class="Constant">Pmakeblock</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span>, <span class="ocamlLCIdentifier">flag</span>, <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">)</span>, <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="PreProc">Choice</span>.<span class="Constant">Ambiguous</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">explicit</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">subterms</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">ambiguous_subterms</span> <span class="Statement">}</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* An ambiguous term should not lead to an <a href="translprim.mli.html#L46" title="ocaml/lambda/translprim.mli:46">error</a> if it not<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; used in TMC position. Consider for example:<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {[<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type <a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> = ... | K of <a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> * (<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> * <a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; let[@tail_mod_cons] rec <a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> = function<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | [...]<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | K (<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>, (u, v)) -&gt; K ((<a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a>[@tailcall]) <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> <a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>, (<a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> u, <a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a> <a href="translmod.ml.html#L1385" title="ocaml/lambda/translmod.ml:1385">f</a> v))<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ]}<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Calling [choice_makeblock] on the K constructor, we need to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; determine whether its two arguments are ambiguous, which is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; done by calling [<a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a>] on each argument to see if they<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; would be TMC-able and if they are explicitly annotated.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; These calls give the following results:<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - there is an explicitly-requested tailcall in the first<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; argument<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - the second argument is a nested <a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a> whose arguments<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; themselves are ambiguous -- with no explicit annotation.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; This determines that the arguments of K are not ambiguous,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; as only one of them is annotated. But note that the nested<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a>, in isolation, is ambiguous. This inner ambiguity is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; innocuous and should not result in an <a href="translprim.mli.html#L46" title="ocaml/lambda/translprim.mli:46">error</a>, as we never<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; use this inner <a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a> in TMC position, only in <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a> style.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; This example shows that it would be incorrect to fail with<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; an <a href="translprim.mli.html#L46" title="ocaml/lambda/translprim.mli:46">error</a> whenever [<a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a>] finds an ambiguity. Instead we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; only <a href="translprim.mli.html#L46" title="ocaml/lambda/translprim.mli:46">error</a> when generating the [<a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a>] version of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; corresponding code; requesting the [<a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>] version is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; accepted and produces the expected <a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a> code.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">term_choice</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span> <span class="Statement">=</span> <span class="PreProc">Choice</span>.<span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span> <span class="ocamlLCIdentifier">choices</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lprim</span> <span class="Statement">(</span><span class="Constant">Pmakeblock</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span>, <span class="ocamlLCIdentifier">flag</span>, <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">)</span>, <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L732" title="ocaml/lambda/simplif.ml:732">args</a></span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">term_choice</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span> <span class="Statement">=</span> <span class="PreProc">Dps</span>.<span class="ocamlLCIdentifier"><a href="#L190" title="ocaml/lambda/tmc.ml:190">make</a></span> <span class="Statement">(fun</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span>:<span class="Statement">_</span> <span class="Statement">~</span><span class="Identifier">dst</span>:<span class="Statement">_</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">arguments</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">info</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> : <span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)</span> : <span class="ocamlLCIdentifier"><a href="#L25" title="ocaml/lambda/tmc.ml:25">subterm_information</a></span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">tmc_calls</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span>.<span class="ocamlLCIdentifier">tmc_calls</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">explicit</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">arguments</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="ocamlLCIdentifier">info</span> <span class="ocamlLCIdentifier">ambiguous_subterms</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">raise</span> <span class="Statement">(</span><span class="Constant">Error</span> <span class="Statement">(</span><span class="PreProc">Debuginfo</span>.<span class="PreProc">Scoped_location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.mli.html#L34" title="ocaml/lambda/debuginfo.mli:34">to_location</a></span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Ambiguous_constructor_arguments</span> <span class="ocamlLCIdentifier">arguments</span><span class="Statement">))<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">);<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="PreProc">Choice</span>.<span class="Constant">Nonambiguous</span> <span class="Statement">{</span> <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier">rev_before</span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier">after</span> <span class="Statement">}</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">constr</span> <span class="Statement">=</span> <span class="PreProc">Constr</span>.<span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">flag</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">before</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">rev</span> <span class="ocamlLCIdentifier">rev_before</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">after</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">assert</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span>.<span class="ocamlLCIdentifier">tmc_calls</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">[]</span><span class="Statement">);<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span> <span class="Statement">=</span> <span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="Statement">not</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">benefits_from_dps</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Constr</span>.<span class="ocamlLCIdentifier"><a href="#L89" title="ocaml/lambda/tmc.ml:89">apply</a></span> <span class="ocamlLCIdentifier">constr</span> <span class="Statement">(</span><span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Constr</span>.<span class="ocamlLCIdentifier"><a href="#L93" title="ocaml/lambda/tmc.ml:93">with_placeholder</a></span> <span class="ocamlLCIdentifier">constr</span> @@ <span class="Statement">fun</span> <span class="ocamlLCIdentifier">new_dst</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lsequence</span><span class="Statement">(</span><span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span>:<span class="Constant">false</span> <span class="Statement">~</span><span class="Identifier">dst</span>:<span class="ocamlLCIdentifier">new_dst</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lvar</span> <span class="ocamlLCIdentifier">new_dst</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span><span class="Statement">));<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">benefits_from_dps</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* Whether or not the caller provides a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a>,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; we can always provide a <a href="#L43" title="ocaml/lambda/tmc.ml:43">destination</a> to our settable<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; subterm, so the number of TMC sub-calls is identical<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in the [<a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a>] and [<a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a>] versions. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span> <span class="Statement">=</span> <span class="PreProc">Dps</span>.<span class="ocamlLCIdentifier"><a href="#L192" title="ocaml/lambda/tmc.ml:192">delay_constructor</a></span> <span class="ocamlLCIdentifier">constr</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span>.<span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">tmc_calls</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span>.<span class="ocamlLCIdentifier">tmc_calls</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">explicit_tailcall_request</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span>.<span class="ocamlLCIdentifier">explicit_tailcall_request</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">}<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">and</span> <span class="ocamlLCIdentifier">choice_prim</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L80" title="ocaml/lambda/translprim.ml:80">prim</a></span> <span class="ocamlLCIdentifier">primargs</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L80" title="ocaml/lambda/translprim.ml:80">prim</a></span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">(* The important case is the construction case *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pmakeblock</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span>, <span class="ocamlLCIdentifier">flag</span>, <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">choice_makeblock</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L339" title="ocaml/lambda/translcore.ml:339">tag</a></span>, <span class="ocamlLCIdentifier">flag</span>, <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L486" title="ocaml/lambda/translprim.ml:486">shape</a></span><span class="Statement">)</span> <span class="ocamlLCIdentifier">primargs</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a><br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* Some primitives have arguments in <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-position *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Popaque</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="Statement">match</span> <span class="ocamlLCIdentifier">primargs</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span>&nbsp; <span class="Statement">[</span><span class="ocamlLCIdentifier">l1</span><span class="Statement">]</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">l1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">invalid_arg</span> <span class="Constant">&quot;choice_prim&quot;</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lprim</span> <span class="Statement">(</span><span class="Constant">Popaque</span>, <span class="Statement">[</span><span class="ocamlLCIdentifier">l1</span><span class="Statement">]</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">(</span><span class="Constant">Psequand</span> <span class="Statement">|</span> <span class="Constant">Psequor</span><span class="Statement">)</span> <span class="Statement">as</span> <span class="ocamlLCIdentifier">shortcutop</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">l2</span> <span class="Statement">=</span> <span class="Statement">match</span> <span class="ocamlLCIdentifier">primargs</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span>&nbsp; <span class="Statement">[</span><span class="ocamlLCIdentifier">l1</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">l2</span><span class="Statement">]</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">l1</span>, <span class="ocamlLCIdentifier">l2<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">invalid_arg</span> <span class="Constant">&quot;choice_prim&quot;</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">l1</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span>+ <span class="ocamlLCIdentifier">l2</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">l2</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Lprim</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">shortcutop</span>, <span class="Statement">[</span><span class="ocamlLCIdentifier">l1</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">l2</span><span class="Statement">]</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* in common cases we just return *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbytes_to_string</span> <span class="Statement">|</span> <span class="Constant">Pbytes_of_string<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pgetglobal</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Psetglobal</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pfield</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pfield_computed<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Psetfield</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Psetfield_computed</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pfloatfield</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Psetfloatfield</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pccall</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Praise</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pnot<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pnegint</span> <span class="Statement">|</span> <span class="Constant">Paddint</span> <span class="Statement">|</span> <span class="Constant">Psubint</span> <span class="Statement">|</span> <span class="Constant">Pmulint</span> <span class="Statement">|</span> <span class="Constant">Pdivint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pmodint</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pandint</span> <span class="Statement">|</span> <span class="Constant">Porint</span> <span class="Statement">|</span> <span class="Constant">Pxorint<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Plslint</span> <span class="Statement">|</span> <span class="Constant">Plsrint</span> <span class="Statement">|</span> <span class="Constant">Pasrint<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pintcomp</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Poffsetint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Poffsetref</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pintoffloat</span> <span class="Statement">|</span> <span class="Constant">Pfloatofint<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pnegfloat</span> <span class="Statement">|</span> <span class="Constant">Pabsfloat<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Paddfloat</span> <span class="Statement">|</span> <span class="Constant">Psubfloat</span> <span class="Statement">|</span> <span class="Constant">Pmulfloat</span> <span class="Statement">|</span> <span class="Constant">Pdivfloat<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pfloatcomp</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pstringlength</span> <span class="Statement">|</span> <span class="Constant">Pstringrefu</span>&nbsp; <span class="Statement">|</span> <span class="Constant">Pstringrefs<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbyteslength</span> <span class="Statement">|</span> <span class="Constant">Pbytesrefu</span> <span class="Statement">|</span> <span class="Constant">Pbytessetu</span> <span class="Statement">|</span> <span class="Constant">Pbytesrefs</span> <span class="Statement">|</span> <span class="Constant">Pbytessets<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Parraylength</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Parrayrefu</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Parraysetu</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Parrayrefs</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Parraysets</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pisint</span> <span class="Statement">|</span> <span class="Constant">Pisout<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pignore<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pcompare_ints</span> <span class="Statement">|</span> <span class="Constant">Pcompare_floats</span> <span class="Statement">|</span> <span class="Constant">Pcompare_bints</span> <span class="Statement">_<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* we don'<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> <a href="translcore.ml.html#L707" title="ocaml/lambda/translcore.ml:707">handle</a> effect or DLS primitives *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Prunstack</span> <span class="Statement">|</span> <span class="Constant">Pperform</span> <span class="Statement">|</span> <span class="Constant">Presume</span> <span class="Statement">|</span> <span class="Constant">Preperform</span> <span class="Statement">|</span> <span class="Constant">Pdls_get<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* we don'<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> <a href="translcore.ml.html#L707" title="ocaml/lambda/translcore.ml:707">handle</a> atomic primitives *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Patomic_exchange</span> <span class="Statement">|</span> <span class="Constant">Patomic_cas</span> <span class="Statement">|</span> <span class="Constant">Patomic_fetch_add</span> <span class="Statement">|</span> <span class="Constant">Patomic_load</span> <span class="Statement">_<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* we don'<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> <a href="translcore.ml.html#L707" title="ocaml/lambda/translcore.ml:707">handle</a> array indices as destinations yet *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">(</span><span class="Constant">Pmakearray</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pduparray</span> <span class="Statement">_)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* we don'<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a> <a href="translcore.ml.html#L707" title="ocaml/lambda/translcore.ml:707">handle</a> { foo with x = ...; y = recursive-call } *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pduprecord</span> <span class="Statement">_<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* operations returning boxed values could be considered<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; constructions someday *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbintofint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pintofbint</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pcvtbint</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pnegbint</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Paddbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Psubbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pmulbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pdivbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pmodbint</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pandbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Porbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pxorbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Plslbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Plsrbint</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pasrbint</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbintcomp</span> <span class="Statement">_<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">(* more common cases... *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbigarrayref</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbigarrayset</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbigarraydim</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pstring_load_16</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pstring_load_32</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pstring_load_64</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbytes_load_16</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbytes_load_32</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbytes_load_64</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbytes_set_16</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbytes_set_32</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbytes_set_64</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbigstring_load_16</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbigstring_load_32</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbigstring_load_64</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbigstring_set_16</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbigstring_set_32</span> <span class="Statement">_</span> <span class="Statement">|</span> <span class="Constant">Pbigstring_set_64</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pctconst</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbswap16<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pbbswap</span> <span class="Statement">_<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Pint_as_pointer<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">primargs</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L973" title="ocaml/lambda/tmc.ml:973">traverse_list</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">primargs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="printlambda.ml.html#L705" title="ocaml/lambda/printlambda.ml:705">lambda</a></span> <span class="Statement">(</span><span class="Constant">Lprim</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translprim.ml.html#L80" title="ocaml/lambda/translprim.ml:80">prim</a></span>, <span class="ocamlLCIdentifier">primargs</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">))<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">and</span> <span class="ocamlLCIdentifier">choice_list</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">terms</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="Type"><a href="#L478" title="ocaml/lambda/tmc.ml:478">list</a></span> <span class="Statement">(</span><span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="Statement">)</span> <span class="ocamlLCIdentifier">terms</span><span class="Statement">)<br/></li>
<li></span>&nbsp; <span class="Statement">and</span> <span class="ocamlLCIdentifier">choice_pair</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier">t1</span>, <span class="ocamlLCIdentifier">t2</span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L196" title="ocaml/lambda/tmc.ml:196">pair</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">t1</span>, <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier">t2</span><span class="Statement">)<br/></li>
<li></span>&nbsp; <span class="Statement">and</span> <span class="ocamlLCIdentifier">choice_option</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Choice</span>.<span class="Type"><a href="#L473" title="ocaml/lambda/tmc.ml:473">option</a></span> <span class="Statement">(</span><span class="PreProc">Option</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">in</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">and</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">=</span> <span class="Statement">function<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Llet</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">lk</span>, <span class="ocamlLCIdentifier">vk</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ctx</span>, <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse_let</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L554" title="ocaml/lambda/tmc.ml:554">llets</a></span> <span class="ocamlLCIdentifier">lk</span> <span class="ocamlLCIdentifier">vk</span> <span class="ocamlLCIdentifier">bindings</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a><br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Lletrec</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">bindings</span>, <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ctx</span>, <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse_letrec</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Constant">Lletrec</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">bindings</span>, <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a></span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="lambda.mli.html#L438" title="ocaml/lambda/lambda.mli:438">shallow_map</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="translobj.ml.html#L145" title="ocaml/lambda/translobj.ml:145">lam</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">and</span> <span class="ocamlLCIdentifier">traverse_let</span> <span class="ocamlLCIdentifier">outer_ctx</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">inner_ctx</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L563" title="ocaml/lambda/tmc.ml:563">declare_binding</a></span> <span class="ocamlLCIdentifier">outer_ctx</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">traverse_binding</span> <span class="ocamlLCIdentifier">outer_ctx</span> <span class="ocamlLCIdentifier">inner_ctx</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">inner_ctx</span>, <span class="ocamlLCIdentifier">bindings<br/></li>
<li></span><br/></li>
<li><span class="Statement">and</span> <span class="ocamlLCIdentifier">traverse_letrec</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">fold_left</span> <span class="ocamlLCIdentifier"><a href="#L563" title="ocaml/lambda/tmc.ml:563">declare_binding</a></span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">concat_map</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">traverse_binding</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">ctx</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">bindings</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ctx</span>, <span class="ocamlLCIdentifier">bindings<br/></li>
<li></span><br/></li>
<li><span class="Statement">and</span> <span class="ocamlLCIdentifier">traverse_binding</span> <span class="ocamlLCIdentifier">outer_ctx</span> <span class="ocamlLCIdentifier">inner_ctx</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">def</span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">find_candidate</span> <span class="ocamlLCIdentifier">def</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">None</span> <span class="Statement">-&gt;</span> <span class="Statement">[(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">outer_ctx</span> <span class="ocamlLCIdentifier">def</span><span class="Statement">)]<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier">lfun</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">special</span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier">find</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="ocamlLCIdentifier">inner_ctx</span>.<span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">fun_choice</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L573" title="ocaml/lambda/tmc.ml:573">choice</a></span> <span class="ocamlLCIdentifier">outer_ctx</span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span>:<span class="Constant">true</span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">fun_choice</span><span class="ocamlNone">.</span><span class="PreProc">Choice</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">tmc_calls</span><span class="ocamlNone"> </span><span class="Statement">=</span><span class="ocamlNone"> </span><span class="Constant">[]</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">prerr_warning<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">(</span><span class="PreProc">Debuginfo</span>.<span class="PreProc">Scoped_location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.mli.html#L34" title="ocaml/lambda/debuginfo.mli:34">to_location</a></span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">Warnings</span>.<span class="Constant">Unused_tmc_attribute</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L383" title="ocaml/lambda/translcore.ml:383">kind</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier">return</span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">=</span> <span class="Statement">_;</span> <span class="ocamlLCIdentifier"><a href="simplif.ml.html#L760" title="ocaml/lambda/simplif.ml:760">attr</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">}</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">lfun</span> <span class="Statement">in<br/></li>
<li><a id="L951">&#x200c;</a></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">body</span></span> <span class="Statement">=</span> <span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span> <span class="ocamlLCIdentifier">fun_choice</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translclass.ml.html#L30" title="ocaml/lambda/translclass.ml:30">lfunction</a></span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L383" title="ocaml/lambda/translcore.ml:383">kind</a></span> <span class="Statement">~</span><span class="Identifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a></span> <span class="Statement">~</span><span class="Identifier">return</span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L760" title="ocaml/lambda/simplif.ml:760">attr</a></span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">in<br/></li>
<li><a id="L953">&#x200c;</a></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">dps</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">dst_param</span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_local</span> <span class="Constant">&quot;dst&quot;</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_local</span> <span class="Constant">&quot;<a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a>&quot;</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">dst</span> <span class="Statement">=</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">dst_param</span> <span class="Statement">with</span> <span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span> <span class="Statement">=</span> <span class="Constant">Offset</span> <span class="Statement">(</span><span class="Constant">Lvar</span> <span class="ocamlLCIdentifier">dst_param</span>.<span class="ocamlLCIdentifier"><a href="#L48" title="ocaml/lambda/tmc.ml:48">offset</a></span><span class="Statement">)</span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Lambda</span>.<span class="ocamlLCIdentifier"><a href="lambda.mli.html#L431" title="ocaml/lambda/lambda.mli:431">duplicate</a></span> @@ <span class="ocamlLCIdentifier"><a href="translclass.ml.html#L30" title="ocaml/lambda/translclass.ml:30">lfunction</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L383" title="ocaml/lambda/translcore.ml:383">kind</a></span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(* Support of Tupled function: see [choice_apply]. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Curried<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a></span>:<span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L63" title="ocaml/lambda/tmc.ml:63">add_dst_params</a></span> <span class="ocamlLCIdentifier">dst_param</span> <span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translprim.ml.html#L784" title="ocaml/lambda/translprim.ml:784">params</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier">return</span>:<span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier">return<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L601" title="ocaml/lambda/translcore.ml:601">body</a></span>:<span class="Statement">(</span><span class="PreProc">Choice</span>.<span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span> <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a></span>:<span class="Constant">true</span> <span class="Statement">~</span><span class="Identifier">dst</span>:<span class="ocamlLCIdentifier">dst</span> <span class="ocamlLCIdentifier">fun_choice</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier"><a href="simplif.ml.html#L760" title="ocaml/lambda/simplif.ml:760">attr</a></span>:<span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="simplif.ml.html#L760" title="ocaml/lambda/simplif.ml:760">attr</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span>:<span class="ocamlLCIdentifier">lfun</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a><br/></li>
<li></span>&nbsp; <span class="Statement">in<br/></li>
<li><a id="L970">&#x200c;</a></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">dps_var</span></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">special</span>.<span class="ocamlLCIdentifier">dps_id</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">[(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L485" title="ocaml/lambda/translcore.ml:485">var</a></span>, <span class="ocamlLCIdentifier"><a href="#L439" title="ocaml/lambda/tmc.ml:439">direct</a></span><span class="Statement">);</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L970" title="ocaml/lambda/tmc.ml:970">dps_var</a></span>, <span class="ocamlLCIdentifier"><a href="#L199" title="ocaml/lambda/tmc.ml:199">dps</a></span><span class="Statement">)]<br/></li>
<li></span><br/></li>
<li><a id="L973">&#x200c;</a><span class="Statement">and</span> <span class="ocamlLCIdentifier"><span class="linkable">traverse_list</span></span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier">terms</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">terms<br/></li>
<li></span><br/></li>
<li><a id="L976">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">rewrite</span></span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ctx</span> <span class="Statement">=</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="#L548" title="ocaml/lambda/tmc.ml:548">specialized</a></span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L533" title="ocaml/lambda/matching.ml:533">empty</a></span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">traverse</span> <span class="ocamlLCIdentifier">ctx</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="Constant">()</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">register_error_of_exn<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">(function<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Error</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">Ambiguous_constructor_arguments<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">explicit</span> <span class="Statement">=</span> <span class="Constant">false</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">arguments</span> <span class="Statement">})</span> <span class="Statement">-&gt;<br/></li>
<li><a id="L986">&#x200c;</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">print_msg</span></span> <span class="ocamlLCIdentifier">ppf</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Format</span>.<span class="ocamlLCIdentifier">pp_print_text</span> <span class="ocamlLCIdentifier">ppf<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;[@tail_mod_cons]: this constructor application may be \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TMC-transformed in several different ways. Please \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; disambiguate by adding an explicit [@tailcall] \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; attribute to the call that should be made \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-recursive, or a [@tailcall false] attribute on \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; calls that should not be transformed.&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li><a id="L995">&#x200c;</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">submgs</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">sub</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">info</span> : <span class="ocamlLCIdentifier"><a href="#L21" title="ocaml/lambda/tmc.ml:21">tmc_call_information</a></span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">=</span> <span class="PreProc">Debuginfo</span>.<span class="PreProc">Scoped_location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.mli.html#L34" title="ocaml/lambda/debuginfo.mli:34">to_location</a></span> <span class="ocamlLCIdentifier">info</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier"><a href="translattribute.ml.html#L114" title="ocaml/lambda/translattribute.ml:114">msg</a></span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Constant">&quot;This call could be annotated.&quot;</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">arguments<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span>.<span class="ocamlLCIdentifier">tmc_calls</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">flatten<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="ocamlLCIdentifier">sub<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Some</span> <span class="Statement">(</span><span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">errorf</span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">~</span><span class="Identifier">sub</span>:<span class="ocamlLCIdentifier"><a href="#L995" title="ocaml/lambda/tmc.ml:995">submgs</a></span> <span class="Constant">&quot;%<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>&quot;</span> <span class="ocamlLCIdentifier"><a href="#L986" title="ocaml/lambda/tmc.ml:986">print_msg</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Error</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">Ambiguous_constructor_arguments<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">explicit</span> <span class="Statement">=</span> <span class="Constant">true</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">arguments</span> <span class="Statement">})</span> <span class="Statement">-&gt;<br/></li>
<li><a id="L1008">&#x200c;</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">print_msg</span></span> <span class="ocamlLCIdentifier">ppf</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Format</span>.<span class="ocamlLCIdentifier">pp_print_text</span> <span class="ocamlLCIdentifier">ppf<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;[@tail_mod_cons]: this constructor application may be \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TMC-transformed in several different ways. Only one of \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; the arguments may become a TMC call, but several \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; arguments contain calls that are explicitly marked as \<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="simplif.ml.html#L812" title="ocaml/lambda/simplif.ml:812">tail</a>-recursive. Please fix the conflict by reviewing \<br/></li>
<li><a id="L1015">&#x200c;</a></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; and <span class="linkable">fixing</span> the conflicting annotations.&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="#L995" title="ocaml/lambda/tmc.ml:995">submgs</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">sub</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">info</span> : <span class="ocamlLCIdentifier"><a href="#L21" title="ocaml/lambda/tmc.ml:21">tmc_call_information</a></span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">=</span> <span class="PreProc">Debuginfo</span>.<span class="PreProc">Scoped_location</span>.<span class="ocamlLCIdentifier"><a href="debuginfo.mli.html#L34" title="ocaml/lambda/debuginfo.mli:34">to_location</a></span> <span class="ocamlLCIdentifier">info</span>.<span class="ocamlLCIdentifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier"><a href="translattribute.ml.html#L114" title="ocaml/lambda/translattribute.ml:114">msg</a></span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Constant">&quot;This call is explicitly annotated.&quot;</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">arguments<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier"><a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a></span>.<span class="ocamlLCIdentifier">tmc_calls</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">flatten<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">filter</span> <span class="Statement">(fun</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">info</span>: <span class="ocamlLCIdentifier"><a href="#L21" title="ocaml/lambda/tmc.ml:21">tmc_call_information</a></span><span class="Statement">)</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">info</span>.<span class="ocamlLCIdentifier">explicit</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier"><a href="matching.ml.html#L922" title="ocaml/lambda/matching.ml:922">map</a></span> <span class="ocamlLCIdentifier">sub<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Some</span> <span class="Statement">(</span><span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">errorf</span> <span class="Statement">~</span><span class="Identifier"><a href="translcore.ml.html#L62" title="ocaml/lambda/translcore.ml:62">loc</a></span> <span class="Statement">~</span><span class="Identifier">sub</span>:<span class="ocamlLCIdentifier"><a href="#L995" title="ocaml/lambda/tmc.ml:995">submgs</a></span> <span class="Constant">&quot;%<a href="debuginfo.ml.html#L79" title="ocaml/lambda/debuginfo.ml:79">t</a>&quot;</span> <span class="ocamlLCIdentifier"><a href="#L986" title="ocaml/lambda/tmc.ml:986">print_msg</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">None<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">)<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

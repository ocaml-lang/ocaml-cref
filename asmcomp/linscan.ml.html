<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/asmcomp/linscan.ml - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/asmcomp/linscan.ml - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L45">active</a></li>
<li><a href="#L96">active</a></li>
<li><a href="#L184">allocate_blocked_register</a></li>
<li><a href="#L130">allocate_free_register</a></li>
<li><a href="#L229">allocate_registers</a></li>
<li><a href="#L109">allocate_stack_slot</a></li>
<li><a href="#L23">compare</a></li>
<li><a href="#L197">il</a></li>
<li><a href="#L90">partition_live</a></li>
<li><a href="#L85">release_expired_fixed</a></li>
<li><a href="#L100">release_expired_inactive</a></li>
<li><a href="#L75">remove_expired_ranges</a></li>
<li><a href="#L59">split_by_pos</a></li>
<li><a href="#L211">walk_interval</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L32">class_intervals</a></li>
<li><a href="#L22">t</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">(**************************************************************************)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Marcell Fischbach, University of Siegen&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Benedikt Meurer, University of Siegen&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; Copyright 2011 Lehrstuhl fü<a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a> Compilerbau und Softwareanalyse,&nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp;&nbsp; Universitä<a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">t</a> Siegen.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; All rights reserved.&nbsp; This <a href="x86_dsl.ml.html#L97" title="ocaml/asmcomp/x86_dsl.ml:97">file</a> is distributed under the terms of&nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; special exception on linking described in the <a href="x86_dsl.ml.html#L97" title="ocaml/asmcomp/x86_dsl.ml:97">file</a> LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(**************************************************************************)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Linear scan register allocation. *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">open</span><span class="ocamlNone"> </span><span class="PreProc">Interval<br/></li>
<li></span><br/></li>
<li><span class="Statement">module</span><span class="PreProc"> IntervalSet</span><span class="ocamlPreDef"> </span><span class="Statement">=</span> <span class="PreProc">Set.Make</span> <span class="ocamlFuncWith">(</span><span class="PreProc">struct<br/></li>
<li><a id="L22">&#x200c;</a></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">type</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">t</span></span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">Interval</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><span class="linkable">t</span><br/></li>
<li><a id="L23">&#x200c;</a></span><span class="ocamlFuncStruct">&nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><span class="linkable">compare</span></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L171" title="ocaml/asmcomp/x86_dsl.ml:171">j</a></span><span class="ocamlFuncStruct"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlFuncStruct"> </span><span class="Statement">=</span><span class="ocamlFuncStruct"> </span><span class="PreProc">Int</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">compare</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">iend</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L171" title="ocaml/asmcomp/x86_dsl.ml:171">j</a></span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">iend</span><span class="ocamlFuncStruct"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">c</span><span class="ocamlNone"> </span><span class="Statement">=</span><span class="ocamlNone"> </span><span class="Constant">0</span><span class="ocamlNone"> </span><span class="Statement">then</span><span class="ocamlFuncStruct"> </span><span class="PreProc">Int</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">compare</a></span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">stamp</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L171" title="ocaml/asmcomp/x86_dsl.ml:171">j</a></span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlFuncStruct">.</span><span class="ocamlLCIdentifier">stamp</span><span class="ocamlFuncStruct"> </span><span class="Statement">else</span><span class="ocamlFuncStruct"> </span><span class="ocamlLCIdentifier">c<br/></li>
<li></span><span class="ocamlFuncStruct">&nbsp; </span><span class="PreProc">end</span><span class="ocamlFuncWith">)<br/></li>
<li></span><br/></li>
<li><span class="Statement">module</span><span class="PreProc"> SlotSet</span><span class="ocamlPreDef"> </span><span class="Statement">=</span> <span class="PreProc">Set.Make</span><span class="ocamlFuncWith">(</span><span class="PreProc">Int</span><span class="ocamlFuncWith">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Live <a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a> per register class *)<br/></li>
<li></span><br/></li>
<li><a id="L32">&#x200c;</a><span class="Statement">type</span> <span class="ocamlLCIdentifier"><span class="linkable">class_intervals</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">{<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">mutable</span> <span class="ocamlLCIdentifier">ci_fixed</span>: <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">mutable</span> <span class="ocamlLCIdentifier">ci_active</span>: <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">mutable</span> <span class="ocamlLCIdentifier">ci_inactive</span>: <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">mutable</span> <span class="ocamlLCIdentifier">ci_spilled</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">(* spilled stack slots (<a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a>.<a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a> = Stack (Local n)) still in use *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">mutable</span> <span class="ocamlLCIdentifier">ci_free_slots</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">(* expired stack slots available for reuse *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">SlotSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L40" title="ocaml/asmcomp/CSEgen.ml:40">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Statement">}<br/></li>
<li></span><br/></li>
<li><a id="L45">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">active</span></span> <span class="Statement">=</span> <span class="PreProc">Array</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L357" title="ocaml/asmcomp/power/proc.ml:357">init</a></span> <span class="PreProc">Proc</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L59" title="ocaml/asmcomp/power/proc.ml:59">num_register_classes</a></span> <span class="Statement">(fun</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci_fixed</span> <span class="Statement">=</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci_active</span> <span class="Statement">=</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci_inactive</span> <span class="Statement">=</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci_spilled</span> <span class="Statement">=</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci_free_slots</span> <span class="Statement">=</span> <span class="PreProc">SlotSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span><span class="Statement">})<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">slot_of_spilled</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span> <span class="Statement">with<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Stack</span><span class="Statement">(</span><span class="Constant">Local</span> <span class="ocamlLCIdentifier">ss</span><span class="Statement">)</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">ss<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">invalid_arg</span> <span class="Constant">&quot;Linscan.slot_of_spilled&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L59">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">split_by_pos</span></span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">divider</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">(* this <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> is strictly above <a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a> [i] with [i.iend &lt; pos] and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; strictly below [i] with [i.iend &gt;= pos]. We use <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a> <a href="reg.ml.html#L63" title="ocaml/asmcomp/reg.ml:63">dummy</a> register with <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; non-existent [stamp] to make sure that it is not &quot;equal&quot; to any of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; <a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a> in the <a href="x86_dsl.ml.html#L199" title="ocaml/asmcomp/x86_dsl.ml:199">set</a> (according to the equality function of [IntervalSet]<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; above). *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">{</span><span class="PreProc">Interval</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span> <span class="Statement">=</span> <span class="Statement">{</span><span class="PreProc">Reg</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L63" title="ocaml/asmcomp/reg.ml:63">dummy</a></span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">stamp</span> <span class="Statement">=</span> -<span class="Constant">1</span><span class="Statement">};<br/></li>
<li></span>&nbsp; &nbsp;&nbsp; <span class="ocamlLCIdentifier">ibegin</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp;&nbsp; <span class="ocamlLCIdentifier">iend</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp;&nbsp; <span class="ocamlLCIdentifier">ranges</span> <span class="Statement">=</span> <span class="Constant">[]</span><span class="Statement">}<br/></li>
<li></span>&nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="spill.ml.html#L362" title="ocaml/asmcomp/spill.ml:362">before</a></span>, <span class="ocamlLCIdentifier">divider_in_set</span>, <span class="ocamlLCIdentifier"><a href="spill.ml.html#L185" title="ocaml/asmcomp/spill.ml:185">after</a></span><span class="Statement">)</span> <span class="Statement">=</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">split</span> <span class="ocamlLCIdentifier">divider</span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">assert</span> <span class="Statement">(not</span> <span class="ocamlLCIdentifier">divider_in_set</span><span class="Statement">);<br/></li>
<li></span>&nbsp; <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="spill.ml.html#L362" title="ocaml/asmcomp/spill.ml:362">before</a></span>, <span class="ocamlLCIdentifier"><a href="spill.ml.html#L185" title="ocaml/asmcomp/spill.ml:185">after</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><a id="L75">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">remove_expired_ranges</span></span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">iter</span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">-&gt;</span> <span class="PreProc">Interval</span>.<span class="ocamlLCIdentifier"><a href="interval.mli.html#L41" title="ocaml/asmcomp/interval.mli:41">remove_expired_ranges</a></span> <span class="ocamlLCIdentifier">i</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">release_expired_spilled</span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">expired</span>, <span class="ocamlLCIdentifier">rest</span><span class="Statement">)</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L59" title="ocaml/asmcomp/linscan.ml:59">split_by_pos</a></span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_spilled</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_free_slots</span> <span class="Statement">&lt;-<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">fold</span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">i</span> <span class="ocamlLCIdentifier">free</span> <span class="Statement">-&gt;</span> <span class="PreProc">SlotSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L50" title="ocaml/asmcomp/CSEgen.ml:50">add</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier">slot_of_spilled</span> <span class="ocamlLCIdentifier">i</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">free</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">expired</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_free_slots</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_spilled</span> <span class="Statement">&lt;-</span> <span class="ocamlLCIdentifier">rest<br/></li>
<li></span><br/></li>
<li><a id="L85">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">release_expired_fixed</span></span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">_expired</span>, <span class="ocamlLCIdentifier">rest</span><span class="Statement">)</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L59" title="ocaml/asmcomp/linscan.ml:59">split_by_pos</a></span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_fixed</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="interval.mli.html#L41" title="ocaml/asmcomp/interval.mli:41">remove_expired_ranges</a></span> <span class="ocamlLCIdentifier">rest</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_fixed</span> <span class="Statement">&lt;-</span> <span class="ocamlLCIdentifier">rest<br/></li>
<li></span><br/></li>
<li><a id="L90">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">partition_live</span></span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">partition</span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">-&gt;</span> <span class="PreProc">Interval</span>.<span class="ocamlLCIdentifier"><a href="interval.mli.html#L40" title="ocaml/asmcomp/interval.mli:40">is_live</a></span> <span class="ocamlLCIdentifier">i</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">release_expired_active</span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">_expired</span>, <span class="ocamlLCIdentifier">rest</span><span class="Statement">)</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L59" title="ocaml/asmcomp/linscan.ml:59">split_by_pos</a></span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="interval.mli.html#L41" title="ocaml/asmcomp/interval.mli:41">remove_expired_ranges</a></span> <span class="ocamlLCIdentifier">rest</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li><a id="L96">&#x200c;</a></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">active</span></span>, <span class="ocamlLCIdentifier">inactive</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L90" title="ocaml/asmcomp/linscan.ml:90">partition_live</a></span> <span class="ocamlLCIdentifier">rest</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active</span> <span class="Statement">&lt;-</span> <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_inactive</span> <span class="Statement">&lt;-</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="spill.ml.html#L254" title="ocaml/asmcomp/spill.ml:254">union</a></span> <span class="ocamlLCIdentifier">inactive</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_inactive<br/></li>
<li></span><br/></li>
<li><a id="L100">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">release_expired_inactive</span></span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">_expired</span>, <span class="ocamlLCIdentifier">rest</span><span class="Statement">)</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L59" title="ocaml/asmcomp/linscan.ml:59">split_by_pos</a></span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_inactive</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="interval.mli.html#L41" title="ocaml/asmcomp/interval.mli:41">remove_expired_ranges</a></span> <span class="ocamlLCIdentifier">rest</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span>, <span class="ocamlLCIdentifier">inactive</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L90" title="ocaml/asmcomp/linscan.ml:90">partition_live</a></span> <span class="ocamlLCIdentifier">rest</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_inactive</span> <span class="Statement">&lt;-</span> <span class="ocamlLCIdentifier">inactive</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active</span> <span class="Statement">&lt;-</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="spill.ml.html#L254" title="ocaml/asmcomp/spill.ml:254">union</a></span> <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Allocate <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a> new stack slot to the <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a>. *)<br/></li>
<li></span><br/></li>
<li><a id="L109">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">allocate_stack_slot</span></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span> <span class="Statement">=</span> <span class="PreProc">Proc</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L61" title="ocaml/asmcomp/power/proc.ml:61">register_class</a></span> <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ci</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span>.<span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ss</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">match</span> <span class="PreProc">SlotSet</span>.<span class="ocamlLCIdentifier">min_elt_opt</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_free_slots</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier">ss</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_free_slots</span> <span class="Statement">&lt;-</span> <span class="PreProc">SlotSet</span>.<span class="ocamlLCIdentifier">remove</span> <span class="ocamlLCIdentifier">ss</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_free_slots</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ss<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">None</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ss</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">num_stack_slots</span>.<span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">num_stack_slots</span>.<span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span> <span class="Statement">&lt;-</span> <span class="ocamlLCIdentifier">succ</span> <span class="ocamlLCIdentifier">ss</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ss<br/></li>
<li></span>&nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span> <span class="Statement">&lt;-</span> <span class="Constant">Stack</span><span class="Statement">(</span><span class="Constant">Local</span> <span class="ocamlLCIdentifier">ss</span><span class="Statement">);<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier">spill</span> <span class="Statement">&lt;-</span> <span class="Constant">true</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_spilled</span> <span class="Statement">&lt;-</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L50" title="ocaml/asmcomp/CSEgen.ml:50">add</a></span> <span class="ocamlLCIdentifier">i</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_spilled<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Find <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a> register for the given <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> and assigns this register.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; The <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> is added to <a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a>. Raises Not_found if no free registers<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; left. *)<br/></li>
<li></span><br/></li>
<li><a id="L130">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">allocate_free_register</span></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">begin</span><span class="ocamlEnd"> </span><span class="Statement">match</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier">i</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">spill</span><span class="ocamlEnd"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; </span><span class="Constant">Unknown</span><span class="ocamlEnd">, </span><span class="Constant">true</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Allocate <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a> stack slot for the already spilled <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L109" title="ocaml/asmcomp/linscan.ml:109">allocate_stack_slot</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">num_stack_slots</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">i<br/></li>
<li></span><span class="ocamlEnd">&nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Constant">Unknown</span><span class="ocamlEnd">, </span><span class="Statement">_</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Comment">(* We need to allocate <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a> register to this <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> somehow *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Proc</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L61" title="ocaml/asmcomp/power/proc.ml:61">register_class</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Statement">begin</span><span class="ocamlEnd"> </span><span class="Statement">match</span><span class="ocamlEnd"> </span><span class="PreProc">Proc</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L66" title="ocaml/asmcomp/power/proc.ml:66">num_available_registers</a></span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">with<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* There are no registers available for this class *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">raise</span><span class="ocamlEnd"> </span><span class="Constant">Not_found<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">rn</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">ci</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">r0</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Proc</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L68" title="ocaml/asmcomp/power/proc.ml:68">first_available_register</a></span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Create register <a href="strmatch.ml.html#L38" title="ocaml/asmcomp/strmatch.ml:38">mask</a> for this class<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; note: if frame pointers are enabled then some registers may have<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; indexes that are off-bounds; we hence protect write accesses<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; below (given that the assign function will not consider such<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; registers) *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">regmask</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Array</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">make</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">rn</span><span class="ocamlEnd"> </span><span class="Constant">true</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Remove all assigned registers from the register <a href="strmatch.ml.html#L38" title="ocaml/asmcomp/strmatch.ml:38">mask</a> *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="PreProc">IntervalSet</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">iter<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">(function<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">{</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Statement">{</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Constant">Reg</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="Statement">}}</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlNone"> - </span><span class="ocamlLCIdentifier">r0</span><span class="ocamlNone"> </span><span class="Statement">&lt;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">rn</span><span class="ocamlNone"> </span><span class="Statement">then</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">regmask</span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlEnd"> - </span><span class="ocamlLCIdentifier">r0</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">&lt;-</span><span class="ocamlEnd"> </span><span class="Constant">false<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Statement">_</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;</span><span class="ocamlEnd"> </span><span class="Constant">()</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">ci_active</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Remove all overlapping registers from the register <a href="strmatch.ml.html#L38" title="ocaml/asmcomp/strmatch.ml:38">mask</a> *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">remove_bound_overlapping</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Statement">function<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">{</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Statement">{</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Constant">Reg</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="Statement">}}</span><span class="ocamlEnd"> </span><span class="Statement">as</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L171" title="ocaml/asmcomp/x86_dsl.ml:171">j</a></span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlNone"> - </span><span class="ocamlLCIdentifier">r0</span><span class="ocamlNone"> </span><span class="Statement">&lt;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">rn</span><span class="Statement">)</span><span class="ocamlNone"> </span><span class="Statement">&amp;&amp;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">regmask</span><span class="ocamlNone">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlNone"> - </span><span class="ocamlLCIdentifier">r0</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlNone">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Statement">&amp;&amp;</span><span class="ocamlNone"> </span><span class="PreProc">Interval</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier"><a href="interval.mli.html#L39" title="ocaml/asmcomp/interval.mli:39">overlap</a></span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L171" title="ocaml/asmcomp/x86_dsl.ml:171">j</a></span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">regmask</span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlEnd"> - </span><span class="ocamlLCIdentifier">r0</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">&lt;-</span><span class="ocamlEnd"> </span><span class="Constant">false<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Statement">_</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;</span><span class="ocamlEnd"> </span><span class="Constant">()</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="PreProc">IntervalSet</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">iter</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">remove_bound_overlapping</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">ci</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">ci_inactive</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="PreProc">IntervalSet</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">iter</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">remove_bound_overlapping</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">ci</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">ci_fixed</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Assign the first free register (if any) *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="Statement">rec</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">assign</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlEnd"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="ocamlNone"> </span><span class="Statement">=</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">rn</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">raise</span><span class="ocamlEnd"> </span><span class="Constant">Not_found<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else</span><span class="ocamlEnd"> </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">regmask</span><span class="ocamlNone">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="Statement">)</span><span class="ocamlNone"> </span><span class="Statement">then</span><span class="ocamlEnd"> </span><span class="Statement">begin<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* Assign the free register and insert the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; current <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> into the <a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a> list *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">i</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span><span class="ocamlEnd"> </span><span class="Statement">&lt;-</span><span class="ocamlEnd"> </span><span class="Constant">Reg</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">r0</span><span class="ocamlEnd"> + </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="Statement">);<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">i</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">spill</span><span class="ocamlEnd"> </span><span class="Statement">&lt;-</span><span class="ocamlEnd"> </span><span class="Constant">false</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">ci_active</span><span class="ocamlEnd"> </span><span class="Statement">&lt;-</span><span class="ocamlEnd"> </span><span class="PreProc">IntervalSet</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L50" title="ocaml/asmcomp/CSEgen.ml:50">add</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">i</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">ci</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">ci_active<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">end</span><span class="ocamlEnd"> </span><span class="Statement">else<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">assign</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">succ</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">assign</span><span class="ocamlEnd"> </span><span class="Constant">0<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Statement">end<br/></li>
<li></span><span class="ocamlEnd">&nbsp; </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Statement">_</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;</span><span class="ocamlEnd"> </span><span class="Constant">()<br/></li>
<li></span><span class="ocamlEnd">&nbsp; </span><span class="Statement">end<br/></li>
<li></span><br/></li>
<li><a id="L184">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">allocate_blocked_register</span></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span> <span class="Statement">=</span> <span class="PreProc">Proc</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L61" title="ocaml/asmcomp/power/proc.ml:61">register_class</a></span> <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ci</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span>.<span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">match</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">max_elt_opt</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier">ilast</span> <span class="Statement">when<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ilast</span>.<span class="ocamlLCIdentifier">iend</span> <span class="Statement">&gt;</span> <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier">iend</span> <span class="Statement">&amp;&amp;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* Last <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> in <a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a> is the last <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a>, so spill it. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">chk</span> <span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">ilast</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span> <span class="Statement">&amp;&amp;</span> <span class="PreProc">Interval</span>.<span class="ocamlLCIdentifier"><a href="interval.mli.html#L39" title="ocaml/asmcomp/interval.mli:39">overlap</a></span> <span class="ocamlLCIdentifier"><a href="amd64/reload.ml.html#L90" title="ocaml/asmcomp/amd64/reload.ml:90">r</a></span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* But only if its physical register is admissible for the current<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a>. *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">not</span> <span class="Statement">(</span><span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">exists</span> <span class="ocamlLCIdentifier">chk</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_fixed</span> <span class="Statement">||<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">exists</span> <span class="ocamlLCIdentifier">chk</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_inactive</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">-&gt;<br/></li>
<li><a id="L197">&#x200c;</a></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">il</span></span> <span class="Statement">=</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier">remove</span> <span class="ocamlLCIdentifier">ilast</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">begin</span><span class="ocamlEnd"> </span><span class="Statement">match</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">ilast</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span><span class="ocamlEnd"> </span><span class="Statement">with</span><span class="ocamlEnd"> </span><span class="Constant">Reg</span><span class="ocamlEnd"> </span><span class="Statement">_</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;</span><span class="ocamlEnd"> </span><span class="Constant">()</span><span class="ocamlEnd"> </span><span class="Statement">|</span><span class="ocamlEnd"> </span><span class="Statement">_</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;</span><span class="ocamlEnd"> </span><span class="Statement">assert</span><span class="ocamlEnd"> </span><span class="Constant">false</span><span class="ocamlEnd"> </span><span class="Statement">end;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* Use register from last <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> for current <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span> <span class="Statement">&lt;-</span> <span class="ocamlLCIdentifier">ilast</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span>.<span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L101" title="ocaml/asmcomp/x86_dsl.ml:101">loc</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* Remove the last <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> from <a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a> and insert the current *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_active</span> <span class="Statement">&lt;-</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L50" title="ocaml/asmcomp/CSEgen.ml:50">add</a></span> <span class="ocamlLCIdentifier">i</span> <span class="ocamlLCIdentifier"><a href="#L197" title="ocaml/asmcomp/linscan.ml:197">il</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* Now get <a href="amd64/selection.ml.html#L43" title="ocaml/asmcomp/amd64/selection.ml:43">a</a> new stack slot for the spilled register *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L109" title="ocaml/asmcomp/linscan.ml:109">allocate_stack_slot</a></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">ilast<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* Either the current <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> is last and we have to spill it,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; or there are no registers at all in the register class (i.e.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; floating point class on i386). *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L109" title="ocaml/asmcomp/linscan.ml:109">allocate_stack_slot</a></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i<br/></li>
<li></span><br/></li>
<li><a id="L211">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">walk_interval</span></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">pos</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier">ibegin</span> <span class="Statement">land</span> <span class="Statement">(lnot</span> <span class="Constant">0x01</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Comment">(* Release all <a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a> that have been expired at the current position *)<br/></li>
<li></span>&nbsp; <span class="PreProc">Array</span>.<span class="ocamlLCIdentifier">iter<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">ci</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L85" title="ocaml/asmcomp/linscan.ml:85">release_expired_fixed</a></span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">release_expired_active</span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L100" title="ocaml/asmcomp/linscan.ml:100">release_expired_inactive</a></span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">release_expired_spilled</span> <span class="ocamlLCIdentifier">ci</span> <span class="ocamlLCIdentifier">pos</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Statement">try<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">(* Allocate free register (if any) *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L130" title="ocaml/asmcomp/linscan.ml:130">allocate_free_register</a></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i<br/></li>
<li></span>&nbsp; <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">Not_found</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Comment">(* No free register, need to decide which <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> to spill *)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L184" title="ocaml/asmcomp/linscan.ml:184">allocate_blocked_register</a></span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="ocamlLCIdentifier">i<br/></li>
<li></span><br/></li>
<li><a id="L229">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">allocate_registers</span></span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span> : <span class="PreProc">Interval</span>.<span class="ocamlLCIdentifier"><a href="interval.mli.html#L33" title="ocaml/asmcomp/interval.mli:33">result</a></span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Comment">(* Initialize the stack slots and <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> lists *)<br/></li>
<li></span>&nbsp; <span class="Statement">for</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="ocamlNone"> </span><span class="Statement">=</span><span class="ocamlNone"> </span><span class="Constant">0</span><span class="ocamlNone"> </span><span class="Statement">to</span> <span class="PreProc">Proc</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L59" title="ocaml/asmcomp/power/proc.ml:59">num_register_classes</a></span> - <span class="Constant">1</span> <span class="Statement">do<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; </span><span class="Comment">(* Start with <a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a> <a href="strmatch.ml.html#L109" title="ocaml/asmcomp/strmatch.ml:109">interval</a> lists *)<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; </span><span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span><span class="ocamlDo">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="x86_dsl.ml.html#L48" title="ocaml/asmcomp/x86_dsl.ml:48">cl</a></span><span class="Statement">)</span><span class="ocamlDo"> </span><span class="Statement">&lt;-</span><span class="ocamlDo"> </span><span class="Statement">{<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci_fixed</span><span class="ocamlDo"> </span><span class="Statement">=</span><span class="ocamlDo"> </span><span class="PreProc">IntervalSet</span><span class="ocamlDo">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci_active</span><span class="ocamlDo"> </span><span class="Statement">=</span><span class="ocamlDo"> </span><span class="PreProc">IntervalSet</span><span class="ocamlDo">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci_inactive</span><span class="ocamlDo"> </span><span class="Statement">=</span><span class="ocamlDo"> </span><span class="PreProc">IntervalSet</span><span class="ocamlDo">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci_spilled</span><span class="ocamlDo"> </span><span class="Statement">=</span><span class="ocamlDo"> </span><span class="PreProc">IntervalSet</span><span class="ocamlDo">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">ci_free_slots</span><span class="ocamlDo"> </span><span class="Statement">=</span><span class="ocamlDo"> </span><span class="PreProc">SlotSet</span><span class="ocamlDo">.</span><span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L46" title="ocaml/asmcomp/CSEgen.ml:46">empty</a></span><span class="Statement">;<br/></li>
<li></span><span class="ocamlDo">&nbsp; &nbsp; </span><span class="Statement">};<br/></li>
<li></span><span class="ocamlDo">&nbsp; </span><span class="Statement">done;<br/></li>
<li></span>&nbsp; <span class="Comment">(* Reset the stack slot counts *)<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">num_stack_slots</span> <span class="Statement">=</span> <span class="PreProc">Array</span>.<span class="ocamlLCIdentifier">make</span> <span class="PreProc">Proc</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L59" title="ocaml/asmcomp/power/proc.ml:59">num_register_classes</a></span> <span class="Constant">0</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Comment">(* Add all fixed <a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a> (sorted by end position) *)<br/></li>
<li></span>&nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">iter<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">i</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">ci</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L45" title="ocaml/asmcomp/linscan.ml:45">active</a></span>.<span class="Statement">(</span><span class="PreProc">Proc</span>.<span class="ocamlLCIdentifier"><a href="power/proc.ml.html#L61" title="ocaml/asmcomp/power/proc.ml:61">register_class</a></span> <span class="ocamlLCIdentifier">i</span>.<span class="ocamlLCIdentifier"><a href="reg.ml.html#L61" title="ocaml/asmcomp/reg.ml:61">reg</a></span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_fixed</span> <span class="Statement">&lt;-</span> <span class="PreProc">IntervalSet</span>.<span class="ocamlLCIdentifier"><a href="CSEgen.ml.html#L50" title="ocaml/asmcomp/CSEgen.ml:50">add</a></span> <span class="ocamlLCIdentifier">i</span> <span class="ocamlLCIdentifier">ci</span>.<span class="ocamlLCIdentifier">ci_fixed</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span>.<span class="ocamlLCIdentifier"><a href="interval.ml.html#L172" title="ocaml/asmcomp/interval.ml:172">fixed_intervals</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Comment">(* Walk all the <a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a> within the list *)<br/></li>
<li></span>&nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">iter</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L211" title="ocaml/asmcomp/linscan.ml:211">walk_interval</a></span> <span class="ocamlLCIdentifier">num_stack_slots</span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span>.<span class="ocamlLCIdentifier"><a href="printmach.mli.html#L30" title="ocaml/asmcomp/printmach.mli:30">intervals</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">num_stack_slots<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/debugger.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/debugger.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L38">caml_debugger_fork_mode</a></li>
<li><a href="#L36">caml_debugger_in_use</a></li>
<li><a href="#L37">caml_event_count</a></li>
<li><a href="#L108">dbg_addr</a></li>
<li><a href="#L105">dbg_in</a></li>
<li><a href="#L106">dbg_out</a></li>
<li><a href="#L104">dbg_socket</a></li>
<li><a href="#L110">event_points_table</a></li>
<li><a href="#L94">marshal_flags</a></li>
<li><a href="#L101">sock_addr</a></li>
<li><a href="#L102">sock_addr_len</a></li>
<li><a href="#L96">sock_domain</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L77">sockaddr_un</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L45">caml_debugger</a></li>
<li><a href="#L387">caml_debugger</a></li>
<li><a href="#L49">caml_debugger_cleanup_fork</a></li>
<li><a href="#L623">caml_debugger_cleanup_fork</a></li>
<li><a href="#L328">caml_debugger_code_unloaded</a></li>
<li><a href="#L41">caml_debugger_init</a></li>
<li><a href="#L172">caml_debugger_init</a></li>
<li><a href="#L319">caml_debugger_saved_instruction</a></li>
<li><a href="#L151">close_connection</a></li>
<li><a href="#L361">frame_block_address</a></li>
<li><a href="#L376">frame_block_id</a></li>
<li><a href="#L350">frame_block_number</a></li>
<li><a href="#L253">getval</a></li>
<li><a href="#L112">open_connection</a></li>
<li><a href="#L312">pc_from_pos</a></li>
<li><a href="#L261">putval</a></li>
<li><a href="#L302">restore_instruction</a></li>
<li><a href="#L266">safe_output_value</a></li>
<li><a href="#L286">save_instruction</a></li>
<li><a href="#L296">set_instruction</a></li>
<li><a href="#L166">winsock_cleanup</a></li>
<li><a href="#L159">winsock_startup</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L69">ATOM</a></li>
<li><a href="#L71">ATOM</a></li>
<li><a href="#L16">CAML_INTERNALS</a></li>
<li><a href="#L383">Env</a></li>
<li><a href="#L384">Extra_args</a></li>
<li><a href="#L385">Locals</a></li>
<li><a href="#L382">Pc</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Xavier Leroy, projet Cristal, INRIA Rocquencourt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 1996 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L16">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Interface with the byte-code debugger */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;io.h&gt;<br/></li>
<li></span><span class="PreProc">#endif</span> <span class="Comment">/* _WIN32 */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/alloc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/codefrag.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/config.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/debugger.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/misc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/osdeps.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/<a href="caml/skiplist.h.html#L32" title="ocaml/runtime/caml/skiplist.h:32">skiplist</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/sys.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L36">&#x200c;</a><span class="Type">int</span> <span class="linkable">caml_debugger_in_use</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L37">&#x200c;</a><a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_event_count</span>;<br/></li>
<li><a id="L38">&#x200c;</a><span class="Type">int</span> <span class="linkable">caml_debugger_fork_mode</span> = <span class="Constant">1</span>; <span class="Comment">/* parent by default */<br/></li>
<li></span><span class="PreProc">#if !defined(HAS_SOCKETS) || defined(NATIVE_CODE)<br/></li>
<li></span><br/></li>
<li><a id="L41">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_debugger_init</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_debugger</span>(<span class="Type">enum</span> <a href="caml/debugger.h.html#L30" title="ocaml/runtime/caml/debugger.h:30">event_kind</a> event, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> param)<br/></li>
<li>{<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L49">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_debugger_cleanup_fork</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef HAS_UNISTD<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;errno.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;<br/></li>
<li></span><span class="PreProc">#ifndef _WIN32<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/wait.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/socket.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/un.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;netinet/in.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;arpa/inet.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;netdb.h&gt;<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L69">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ATOM</span> ATOM_WS<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;winsock2.h&gt;<br/></li>
<li><a id="L71">&#x200c;</a></span><span class="PreProc">#undef <span class="linkable">ATOM</span><br/></li>
<li></span><span class="Comment">/* Code duplication with otherlibs/unix/socketaddr.h is inevitable<br/></li>
<li></span><span class="Comment"> * because pulling winsock2.h creates many naming conflicts. */<br/></li>
<li></span><span class="PreProc">#ifdef HAS_AFUNIX_H<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;afunix.h&gt;<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L77">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">sockaddr_un</span> {<br/></li>
<li>&nbsp; ADDRESS_FAMILY sun_family;<br/></li>
<li>&nbsp; <span class="Type">char</span> sun_path[<span class="Constant">108</span>];<br/></li>
<li>};<br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* HAS_AFUNIX_H */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;process.h&gt;<br/></li>
<li></span><span class="PreProc">#endif</span> <span class="Comment">/* _WIN32 */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fix_code.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/instruct.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/intext.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/io.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fiber.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/sys.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L94">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">marshal_flags</span>;<br/></li>
<li><br/></li>
<li><a id="L96">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">sock_domain</span>;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* Socket domain for the debugger */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">union</span> {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Socket address for the debugger */<br/></li>
<li></span>&nbsp; <span class="Type">struct</span> sockaddr s_gen;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L77" title="ocaml/runtime/debugger.c:77">sockaddr_un</a> s_unix;<br/></li>
<li>&nbsp; <span class="Type">struct</span> sockaddr_in s_inet;<br/></li>
<li><a id="L101">&#x200c;</a>} <span class="linkable">sock_addr</span>;<br/></li>
<li><a id="L102">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">sock_addr_len</span>;&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* Length of <a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a> */<br/></li>
<li></span><br/></li>
<li><a id="L104">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">dbg_socket</span> = -<span class="Constant">1</span>;&nbsp; &nbsp;&nbsp; <span class="Comment">/* The socket connected to the debugger */<br/></li>
<li><a id="L105">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> * <span class="linkable">dbg_in</span>; <span class="Comment">/* Input <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> on the socket */<br/></li>
<li><a id="L106">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> * <span class="linkable">dbg_out</span>;<span class="Comment">/* Output <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> on the socket */<br/></li>
<li></span><br/></li>
<li><a id="L108">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> *<span class="linkable">dbg_addr</span> = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><br/></li>
<li><a id="L110">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="caml/skiplist.h.html#L32" title="ocaml/runtime/caml/skiplist.h:32">skiplist</a> <span class="linkable">event_points_table</span> = <a href="caml/skiplist.h.html#L50" title="ocaml/runtime/caml/skiplist.h:50">SKIPLIST_STATIC_INITIALIZER</a>;<br/></li>
<li><br/></li>
<li><a id="L112">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">open_connection</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> buf[<span class="Constant">1024</span>];<br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span>&nbsp; <span class="Comment">/* Set socket to synchronous mode (= non-overlapped) so that file<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; descriptor-oriented functions (read()/write() etc.) can be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; used */<br/></li>
<li></span>&nbsp; SOCKET sock = WSASocket(<a href="#L96" title="ocaml/runtime/debugger.c:96">sock_domain</a>, SOCK_STREAM, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span> <span class="Comment">/* not WSA_FLAG_OVERLAPPED */</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (sock == INVALID_SOCKET<br/></li>
<li>&nbsp; &nbsp; &nbsp; || connect(sock, &amp;<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_gen, <a href="#L102" title="ocaml/runtime/debugger.c:102">sock_addr_len</a>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;cannot connect to debugger at </span><span class="Special">%s\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;WSA <a href="startup_byt.c.html#L77" title="ocaml/runtime/startup_byt.c:77">error</a> code: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a> ? <a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a> : <span class="Constant">&quot;(none)&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WSAGetLastError());<br/></li>
<li>&nbsp; <a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a> = _open_osfhandle(sock, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a> == -<span class="Constant">1</span>)<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a> = socket(<a href="#L96" title="ocaml/runtime/debugger.c:96">sock_domain</a>, SOCK_STREAM, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a> == -<span class="Constant">1</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; connect(<a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a>, &amp;<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_gen, <a href="#L102" title="ocaml/runtime/debugger.c:102">sock_addr_len</a>) == -<span class="Constant">1</span>)<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;cannot connect to debugger at </span><span class="Special">%s\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="startup_byt.c.html#L77" title="ocaml/runtime/startup_byt.c:77">error</a>: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a> ? <a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a> : <span class="Constant">&quot;(none)&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="sys.c.html#L69" title="ocaml/runtime/sys.c:69">caml_strerror</a>(errno, buf, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(buf)));<br/></li>
<li>&nbsp; <a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a> = <a href="io.c.html#L164" title="ocaml/runtime/io.c:164">caml_open_descriptor_in</a>(<a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a>);<br/></li>
<li>&nbsp; <a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a> = <a href="io.c.html#L184" title="ocaml/runtime/io.c:184">caml_open_descriptor_out</a>(<a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L36" title="ocaml/runtime/debugger.c:36">caml_debugger_in_use</a>) <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, -<span class="Constant">1</span>); <span class="Comment">/* first connection */<br/></li>
<li></span><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span>&nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, _getpid());<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, getpid());<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L151">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">close_connection</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="io.c.html#L193" title="ocaml/runtime/io.c:193">caml_close_channel</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; <a href="io.c.html#L193" title="ocaml/runtime/io.c:193">caml_close_channel</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; <a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a> = -<span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* was closed by <a href="io.c.html#L193" title="ocaml/runtime/io.c:193">caml_close_channel</a> */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li><a id="L159">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">winsock_startup</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; WSADATA wsaData;<br/></li>
<li>&nbsp; <span class="Type">int</span> err = WSAStartup(MAKEWORD(<span class="Constant">2</span>, <span class="Constant">0</span>), &amp;wsaData);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (err) <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;WSAStartup failed&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L166">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">winsock_cleanup</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; WSACleanup();<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L172">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_debugger_init</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> * address;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L227" title="ocaml/runtime/caml/misc.h:227">char_os</a> * a;<br/></li>
<li>&nbsp; <span class="Type">char</span> * port, * p;<br/></li>
<li>&nbsp; <span class="Type">struct</span> hostent * host;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags;<br/></li>
<li>&nbsp; <span class="Type">int</span> n;<br/></li>
<li><br/></li>
<li>&nbsp; flags = <a href="alloc.c.html#L33" title="ocaml/runtime/alloc.c:33">caml_alloc</a>(<span class="Constant">2</span>, <a href="caml/mlvalues.h.html#L435" title="ocaml/runtime/caml/mlvalues.h:435">Tag_cons</a>);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L425" title="ocaml/runtime/caml/memory.h:425">Store_field</a>(flags, <span class="Constant">0</span>, <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(<span class="Constant">1</span>)); <span class="Comment">/* Marshal.Closures */<br/></li>
<li></span>&nbsp; <a href="caml/memory.h.html#L425" title="ocaml/runtime/caml/memory.h:425">Store_field</a>(flags, <span class="Constant">1</span>, <a href="caml/mlvalues.h.html#L434" title="ocaml/runtime/caml/mlvalues.h:434">Val_emptylist</a>);<br/></li>
<li>&nbsp; <a href="#L94" title="ocaml/runtime/debugger.c:94">marshal_flags</a> = flags;<br/></li>
<li>&nbsp; <a href="globroots.c.html#L95" title="ocaml/runtime/globroots.c:95">caml_register_generational_global_root</a>(&amp;<a href="#L94" title="ocaml/runtime/debugger.c:94">marshal_flags</a>);<br/></li>
<li><br/></li>
<li>&nbsp; a = <a href="unix.c.html#L414" title="ocaml/runtime/unix.c:414">caml_secure_getenv</a>(<a href="caml/misc.h.html#L363" title="ocaml/runtime/caml/misc.h:363">T</a>(<span class="Constant">&quot;CAML_DEBUG_SOCKET&quot;</span>));<br/></li>
<li>&nbsp; address = a ? <a href="caml/misc.h.html#L397" title="ocaml/runtime/caml/misc.h:397">caml_stat_strdup_of_os</a>(a) : <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (address == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a> != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(<a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a>);<br/></li>
<li>&nbsp; <a href="#L108" title="ocaml/runtime/debugger.c:108">dbg_addr</a> = address;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* #8676: erase the CAML_DEBUG_SOCKET variable so that processes<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; created by the program being debugged do not try to connect with<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; the debugger. */<br/></li>
<li></span><span class="PreProc">#if defined(_WIN32)<br/></li>
<li></span>&nbsp; _wputenv(<span class="Constant">L&quot;CAML_DEBUG_SOCKET=&quot;</span>);<br/></li>
<li><span class="PreProc">#elif defined(HAS_SETENV_UNSETENV)<br/></li>
<li></span>&nbsp; unsetenv(<span class="Constant">&quot;CAML_DEBUG_SOCKET&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span>&nbsp; <a href="#L159" title="ocaml/runtime/debugger.c:159">winsock_startup</a>();<br/></li>
<li>&nbsp; (<span class="Type">void</span>)atexit(<a href="#L166" title="ocaml/runtime/debugger.c:166">winsock_cleanup</a>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Comment">/* Parse the address */<br/></li>
<li></span>&nbsp; port = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (p = address; *p != <span class="Constant">0</span>; p++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">':'</span>) { *p = <span class="Constant">0</span>; port = p+<span class="Constant">1</span>; <span class="Statement">break</span>; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (port == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> a_len;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Unix domain */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L96" title="ocaml/runtime/debugger.c:96">sock_domain</a> = PF_UNIX;<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_family = AF_UNIX;<br/></li>
<li>&nbsp; &nbsp; a_len = strlen(address);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (a_len &gt;= <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_path)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;debug socket path length exceeds maximum permitted length&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; );<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; strncpy(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_path, address,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_path) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_path[<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_path) - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L102" title="ocaml/runtime/debugger.c:102">sock_addr_len</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; ((<span class="Type">char</span> *)&amp;(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix.sun_path) - (<span class="Type">char</span> *)&amp;(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_unix))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + a_len;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Internet domain */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L96" title="ocaml/runtime/debugger.c:96">sock_domain</a> = PF_INET;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = (<span class="Type">char</span> *) &amp;<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet, n = <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n &gt; <span class="Constant">0</span>; n--) *p++ = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet.sin_addr.s_addr = inet_addr(address);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet.sin_addr.s_addr == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; host = gethostbyname(address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (host == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;unknown debugging host </span><span class="Special">%s</span><span class="Constant">&quot;</span>, address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; memmove(&amp;<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet.sin_addr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host-&gt;h_addr_list[<span class="Constant">0</span>], host-&gt;h_length);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet.sin_port = htons(atoi(port));<br/></li>
<li>&nbsp; &nbsp; <a href="#L102" title="ocaml/runtime/debugger.c:102">sock_addr_len</a> = <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L101" title="ocaml/runtime/debugger.c:101">sock_addr</a>.s_inet);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L112" title="ocaml/runtime/debugger.c:112">open_connection</a>();<br/></li>
<li>&nbsp; <a href="#L36" title="ocaml/runtime/debugger.c:36">caml_debugger_in_use</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Comment">/* Bigger than default caml_trap_sp_off (1) */<br/></li>
<li></span>&nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;trap_barrier_off = <span class="Constant">2</span>;<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;trap_barrier_block = -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L253">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">getval</span>(<span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> *chan)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="io.c.html#L416" title="ocaml/runtime/io.c:416">caml_really_getblock</a>(chan, (<span class="Type">char</span> *) &amp;res, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(res)) &lt; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(res))<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L168" title="ocaml/runtime/fail_nat.c:168">caml_raise_end_of_file</a>(); <span class="Comment">/* Bad, but consistent with <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a> */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L261">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">putval</span>(<span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> *chan, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> val)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="io.c.html#L309" title="ocaml/runtime/io.c:309">caml_really_putblock</a>(chan, (<span class="Type">char</span> *) &amp;val, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(val));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L266">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">safe_output_value</span>(<span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> *chan, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> val)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/fail.h.html#L46" title="ocaml/runtime/caml/fail.h:46">longjmp_buffer</a> raise_buf;<br/></li>
<li>&nbsp; <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> raise_exn_bucket;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/fail.h.html#L64" title="ocaml/runtime/caml/fail.h:64">caml_exception_context</a> exception_ctx =<br/></li>
<li>&nbsp; &nbsp; {&amp;raise_buf, <a href="caml/memory.h.html#L229" title="ocaml/runtime/caml/memory.h:229">CAML_LOCAL_ROOTS</a>, &amp;raise_exn_bucket};<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/fail.h.html#L64" title="ocaml/runtime/caml/fail.h:64">caml_exception_context</a>* saved_external_raise;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Catch exceptions raised by [<a href="extern.c.html#L1070" title="ocaml/runtime/extern.c:1070">caml_output_val</a>] */<br/></li>
<li></span>&nbsp; saved_external_raise = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;external_raise;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/fail.h.html#L54" title="ocaml/runtime/caml/fail.h:54">sigsetjmp</a>(raise_buf.buf, <span class="Constant">0</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;external_raise = &amp;exception_ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1070" title="ocaml/runtime/extern.c:1070">caml_output_val</a>(chan, val, <a href="#L94" title="ocaml/runtime/debugger.c:94">marshal_flags</a>);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Send wrong magic number, will cause [<a href="intern.c.html#L878" title="ocaml/runtime/intern.c:878">caml_input_value</a>] to fail */<br/></li>
<li></span>&nbsp; &nbsp; <a href="io.c.html#L309" title="ocaml/runtime/io.c:309">caml_really_putblock</a>(chan, <span class="Constant">&quot;</span><span class="Special">\000\000\000\000</span><span class="Constant">&quot;</span>, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;external_raise = saved_external_raise;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L286">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">save_instruction</span>(<a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a> pc)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> saved;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="skiplist.c.html#L71" title="ocaml/runtime/skiplist.c:71">caml_skiplist_find</a>(&amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) pc, &amp;saved)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Already saved. Nothing to do. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="skiplist.c.html#L115" title="ocaml/runtime/skiplist.c:115">caml_skiplist_insert</a>(&amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) pc, *pc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L296">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">set_instruction</span>(<a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a> pc, <a href="caml/mlvalues.h.html#L66" title="ocaml/runtime/caml/mlvalues.h:66">opcode_t</a> opcode)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L286" title="ocaml/runtime/debugger.c:286">save_instruction</a>(pc);<br/></li>
<li>&nbsp; <a href="fix_code.c.html#L169" title="ocaml/runtime/fix_code.c:169">caml_set_instruction</a>(pc, opcode);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L302">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">restore_instruction</span>(<a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a> pc)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L171" title="ocaml/runtime/caml/misc.h:171">CAMLunused_start</a> <span class="Type">int</span> found; <a href="caml/misc.h.html#L172" title="ocaml/runtime/caml/misc.h:172">CAMLunused_end</a><br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> saved;<br/></li>
<li>&nbsp; found = <a href="skiplist.c.html#L71" title="ocaml/runtime/skiplist.c:71">caml_skiplist_find</a>(&amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) pc, &amp;saved);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(found);<br/></li>
<li>&nbsp; *pc = saved;<br/></li>
<li>&nbsp; <a href="skiplist.c.html#L159" title="ocaml/runtime/skiplist.c:159">caml_skiplist_remove</a>(&amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) pc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L312">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a> <span class="linkable">pc_from_pos</span>(<span class="Type">int</span> frag, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> pos)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/codefrag.h.html#L33" title="ocaml/runtime/caml/codefrag.h:33">code_fragment</a> *cf = <a href="codefrag.c.html#L118" title="ocaml/runtime/codefrag.c:118">caml_find_code_fragment_by_num</a>(frag);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(cf != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a>) (cf-&gt;code_start + pos);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L319">&#x200c;</a><a href="caml/mlvalues.h.html#L66" title="ocaml/runtime/caml/mlvalues.h:66">opcode_t</a> <span class="linkable">caml_debugger_saved_instruction</span>(<a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a> pc)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L171" title="ocaml/runtime/caml/misc.h:171">CAMLunused_start</a> <span class="Type">int</span> found; <a href="caml/misc.h.html#L172" title="ocaml/runtime/caml/misc.h:172">CAMLunused_end</a><br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> saved;<br/></li>
<li>&nbsp; found = <a href="skiplist.c.html#L71" title="ocaml/runtime/skiplist.c:71">caml_skiplist_find</a>(&amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) pc, &amp;saved);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(found);<br/></li>
<li>&nbsp; <span class="Statement">return</span> saved;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L328">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_debugger_code_unloaded</span>(<span class="Type">int</span> index)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/codefrag.h.html#L33" title="ocaml/runtime/caml/codefrag.h:33">code_fragment</a> *cf;<br/></li>
<li>&nbsp; <span class="Type">char</span> * pc;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L36" title="ocaml/runtime/debugger.c:36">caml_debugger_in_use</a>) <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_CODE_UNLOADED);<br/></li>
<li>&nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, index);<br/></li>
<li><br/></li>
<li>&nbsp; cf = <a href="codefrag.c.html#L118" title="ocaml/runtime/codefrag.c:118">caml_find_code_fragment_by_num</a>(index);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(cf != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/skiplist.h.html#L94" title="ocaml/runtime/caml/skiplist.h:94">FOREACH_SKIPLIST_ELEMENT</a>(elt, &amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, <span class="Error">{<br/></li>
<li></span>&nbsp; &nbsp; pc = (<span class="Type">char</span> *) elt-&gt;key;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc &gt;= cf-&gt;code_start &amp;&amp; pc &lt; cf-&gt;code_end) <span class="Error">{<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="skiplist.c.html#L159" title="ocaml/runtime/skiplist.c:159">caml_skiplist_remove</a>(&amp;<a href="#L110" title="ocaml/runtime/debugger.c:110">event_points_table</a>, (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) pc);<br/></li>
<li>&nbsp; &nbsp; <span class="Error">}<br/></li>
<li></span>&nbsp; }<span class="Error">)<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return number of blocks between this one <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> bottom of stack. */<br/></li>
<li><a id="L350">&#x200c;</a></span><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">frame_block_number</span> (<span class="Type">struct</span> <a href="caml/fiber.h.html#L43" title="ocaml/runtime/caml/fiber.h:43">stack_info</a> *block)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (block-&gt;handler-&gt;parent != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>){<br/></li>
<li>&nbsp; &nbsp; ++ n;<br/></li>
<li>&nbsp; &nbsp; block = block-&gt;handler-&gt;parent;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Find the [n+1]th block counting from bottom of stack. */<br/></li>
<li><a id="L361">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="caml/fiber.h.html#L43" title="ocaml/runtime/caml/fiber.h:43">stack_info</a> *<span class="linkable">frame_block_address</span> (<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/fiber.h.html#L43" title="ocaml/runtime/caml/fiber.h:43">stack_info</a> *block = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;current_stack;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> i = <a href="#L350" title="ocaml/runtime/debugger.c:350">frame_block_number</a> (<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;current_stack);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span> || n &gt; i) <span class="Statement">return</span> <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; i &gt; n; i--){<br/></li>
<li>&nbsp; &nbsp; block = block-&gt;handler-&gt;parent;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (block != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> block;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return the id of the [n+1]th block counting from bottom of stack,<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> -1 if there is no such block. */<br/></li>
<li><a id="L376">&#x200c;</a></span><span class="Type">static</span> <span class="Type">inline</span> <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> <span class="linkable">frame_block_id</span> (<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/fiber.h.html#L43" title="ocaml/runtime/caml/fiber.h:43">stack_info</a> *addr = <a href="#L361" title="ocaml/runtime/debugger.c:361">frame_block_address</a> (n);<br/></li>
<li>&nbsp; <span class="Statement">return</span> addr == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> ? -<span class="Constant">1</span> : addr-&gt;id;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L382">&#x200c;</a><span class="PreProc">#define <span class="linkable">Pc</span>(sp) ((<a href="caml/mlvalues.h.html#L67" title="ocaml/runtime/caml/mlvalues.h:67">code_t</a>)((sp)[</span><span class="Constant">0</span><span class="PreProc">]))<br/></li>
<li><a id="L383">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">Env</span>(sp) ((sp)[</span><span class="Constant">1</span><span class="PreProc">])<br/></li>
<li><a id="L384">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">Extra_args</span>(sp) (<a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(((sp)[</span><span class="Constant">2</span><span class="PreProc">])))<br/></li>
<li><a id="L385">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">Locals</span>(sp) ((sp) + </span><span class="Constant">3</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L387">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_debugger</span>(<span class="Type">enum</span> <a href="caml/debugger.h.html#L30" title="ocaml/runtime/caml/debugger.h:30">event_kind</a> event, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> param)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> *frame, *newframe;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> i, pos;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> val;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/fiber.h.html#L43" title="ocaml/runtime/caml/fiber.h:43">stack_info</a> *frame_block, *new_frame_block;<br/></li>
<li>&nbsp; <span class="Type">int</span> frag;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/codefrag.h.html#L33" title="ocaml/runtime/caml/codefrag.h:33">code_fragment</a> *cf;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L104" title="ocaml/runtime/debugger.c:104">dbg_socket</a> == -<span class="Constant">1</span>) <span class="Statement">return</span>;&nbsp; <span class="Comment">/* Not connected to a debugger. */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">/* Reset current frame */<br/></li>
<li></span>&nbsp; frame_block = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;current_stack;<br/></li>
<li>&nbsp; frame = frame_block-&gt;sp + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Report the event to the debugger */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span>(event) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> PROGRAM_START:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* Nothing to report */<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (param == <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> command_loop;<br/></li>
<li>&nbsp; <span class="Statement">case</span> EVENT_COUNT:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (param == <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_EVENT);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> BREAKPOINT:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (param == <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_BREAKPOINT);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> PROGRAM_EXIT:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (param == <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_EXITED);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> TRAP_BARRIER:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (param == <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_TRAP);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> UNCAUGHT_EXC:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (param == <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_UNCAUGHT_EXC);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> DEBUG_INFO_ADDED:<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_CODE_DEBUG_INFO);<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1070" title="ocaml/runtime/extern.c:1070">caml_output_val</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Comment">/* <a href="backtrace_byt.c.html#L76" title="ocaml/runtime/backtrace_byt.c:76">debug_info</a> */</span> param, <a href="caml/mlvalues.h.html#L434" title="ocaml/runtime/caml/mlvalues.h:434">Val_emptylist</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CODE_LOADED:<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_CODE_LOADED);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Comment">/* index */</span> <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(param));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CODE_UNLOADED:<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, REP_CODE_UNLOADED);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Comment">/* index */</span> <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(param));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="#L37" title="ocaml/runtime/debugger.c:37">caml_event_count</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (event == EVENT_COUNT || event == BREAKPOINT) {<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="#L350" title="ocaml/runtime/debugger.c:350">frame_block_number</a> (frame_block));<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/fiber.h.html#L69" title="ocaml/runtime/caml/fiber.h:69">Stack_high</a>(frame_block) - frame);<br/></li>
<li>&nbsp; &nbsp; cf = <a href="codefrag.c.html#L104" title="ocaml/runtime/codefrag.c:104">caml_find_code_fragment_by_pc</a>((<span class="Type">char</span>*) <a href="#L382" title="ocaml/runtime/debugger.c:382">Pc</a>(frame));<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(cf != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, cf-&gt;fragnum);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, (<span class="Type">char</span>*) <a href="#L382" title="ocaml/runtime/debugger.c:382">Pc</a>(frame) - cf-&gt;code_start);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* No PC <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> no stack frame associated with other events */<br/></li>
<li></span>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li><br/></li>
<li> <span class="Statement">command_loop</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">/* Read <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> execute the commands sent by the debugger */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span>(<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span>(<a href="io.c.html#L368" title="ocaml/runtime/io.c:368">caml_getch</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_SET_EVENT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; frag = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; pos = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L296" title="ocaml/runtime/debugger.c:296">set_instruction</a>(<a href="#L312" title="ocaml/runtime/debugger.c:312">pc_from_pos</a>(frag, pos), EVENT);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_SET_BREAKPOINT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; frag = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; pos = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L296" title="ocaml/runtime/debugger.c:296">set_instruction</a>(<a href="#L312" title="ocaml/runtime/debugger.c:312">pc_from_pos</a>(frag, pos), BREAK);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_RESET_INSTR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; frag = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; pos = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L302" title="ocaml/runtime/debugger.c:302">restore_instruction</a>(<a href="#L312" title="ocaml/runtime/debugger.c:312">pc_from_pos</a>(frag, pos));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_CHECKPOINT:<br/></li>
<li><span class="PreProc">#ifndef _WIN32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="domain.c.html#L1699" title="ocaml/runtime/domain.c:1699">caml_release_domain_lock</a> (); <span class="Comment">/* Don't fork while holding locks. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; i = fork();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="domain.c.html#L1681" title="ocaml/runtime/domain.c:1681">caml_acquire_domain_lock</a> ();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L151" title="ocaml/runtime/debugger.c:151">close_connection</a>();&nbsp; &nbsp;&nbsp; <span class="Comment">/* Close parent connection. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L112" title="ocaml/runtime/debugger.c:112">open_connection</a>();&nbsp; &nbsp; &nbsp; <span class="Comment">/* Open new connection with debugger */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;REQ_CHECKPOINT command&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GO:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L37" title="ocaml/runtime/debugger.c:37">caml_event_count</a> = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_STOP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; exit(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_WAIT:<br/></li>
<li><span class="PreProc">#ifndef _WIN32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; wait(<span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;REQ_WAIT command&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_INITIAL_FRAME:<br/></li>
<li>&nbsp; &nbsp; &nbsp; frame_block = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;current_stack;<br/></li>
<li>&nbsp; &nbsp; &nbsp; frame = frame_block-&gt;sp + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Fall through */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_FRAME:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="#L350" title="ocaml/runtime/debugger.c:350">frame_block_number</a> (frame_block));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/fiber.h.html#L69" title="ocaml/runtime/caml/fiber.h:69">Stack_high</a>(frame_block) - frame);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame &lt; <a href="caml/fiber.h.html#L69" title="ocaml/runtime/caml/fiber.h:69">Stack_high</a>(frame_block) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (cf = <a href="codefrag.c.html#L104" title="ocaml/runtime/codefrag.c:104">caml_find_code_fragment_by_pc</a>((<span class="Type">char</span>*) <a href="#L382" title="ocaml/runtime/debugger.c:382">Pc</a>(frame))) != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, cf-&gt;fragnum);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, (<span class="Type">char</span>*) <a href="#L382" title="ocaml/runtime/debugger.c:382">Pc</a>(frame) - cf-&gt;code_start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_SET_FRAME:<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; frame_block = <a href="#L361" title="ocaml/runtime/debugger.c:361">frame_block_address</a> (i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; frame = <a href="caml/fiber.h.html#L69" title="ocaml/runtime/caml/fiber.h:69">Stack_high</a>(frame_block) - i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_UP_FRAME:<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; newframe = frame + <a href="#L384" title="ocaml/runtime/debugger.c:384">Extra_args</a>(frame) + i + <span class="Constant">3</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (newframe &gt;= <a href="caml/fiber.h.html#L69" title="ocaml/runtime/caml/fiber.h:69">Stack_high</a> (frame_block)){<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; new_frame_block = frame_block-&gt;handler-&gt;parent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (new_frame_block == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>){<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newframe = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<span class="Statement">else</span>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newframe = new_frame_block-&gt;sp + <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<span class="Statement">else</span>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; new_frame_block = frame_block;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (newframe != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>){<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cf = <a href="codefrag.c.html#L104" title="ocaml/runtime/codefrag.c:104">caml_find_code_fragment_by_pc</a>((<span class="Type">char</span> *) <a href="#L382" title="ocaml/runtime/debugger.c:382">Pc</a>(newframe));<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<span class="Statement">else</span>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cf = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cf == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = newframe;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame_block = new_frame_block;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="#L350" title="ocaml/runtime/debugger.c:350">frame_block_number</a> (frame_block));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/fiber.h.html#L69" title="ocaml/runtime/caml/fiber.h:69">Stack_high</a>(frame_block) - frame);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, cf-&gt;fragnum);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, (<span class="Type">char</span>*) <a href="#L382" title="ocaml/runtime/debugger.c:382">Pc</a>(frame) - cf-&gt;code_start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_SET_TRAP_BARRIER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;trap_barrier_block = <a href="#L376" title="ocaml/runtime/debugger.c:376">frame_block_id</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;trap_barrier_off = -i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_LOCAL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L261" title="ocaml/runtime/debugger.c:261">putval</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="#L385" title="ocaml/runtime/debugger.c:385">Locals</a>(frame)[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_ENVIRONMENT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L261" title="ocaml/runtime/debugger.c:261">putval</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(<a href="#L383" title="ocaml/runtime/debugger.c:383">Env</a>(frame), i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_GLOBAL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L261" title="ocaml/runtime/debugger.c:261">putval</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(<a href="fiber.c.html#L316" title="ocaml/runtime/fiber.c:316">caml_global_data</a>, i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_ACCU:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L261" title="ocaml/runtime/debugger.c:261">putval</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, *<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;current_stack-&gt;sp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_HEADER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; val = <a href="#L253" title="ocaml/runtime/debugger.c:253">getval</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/mlvalues.h.html#L157" title="ocaml/runtime/caml/mlvalues.h:157">Hd_val</a>(val));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_FIELD:<br/></li>
<li>&nbsp; &nbsp; &nbsp; val = <a href="#L253" title="ocaml/runtime/debugger.c:253">getval</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(val) != <a href="caml/mlvalues.h.html#L349" title="ocaml/runtime/caml/mlvalues.h:349">Double_array_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L261" title="ocaml/runtime/debugger.c:261">putval</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(val, i));<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">double</span> d = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(val, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L273" title="ocaml/runtime/io.c:273">caml_putch</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="io.c.html#L309" title="ocaml/runtime/io.c:309">caml_really_putblock</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, (<span class="Type">char</span> *) &amp;d, <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_MARSHAL_OBJ:<br/></li>
<li>&nbsp; &nbsp; &nbsp; val = <a href="#L253" title="ocaml/runtime/debugger.c:253">getval</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L266" title="ocaml/runtime/debugger.c:266">safe_output_value</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_GET_CLOSURE_CODE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; val = <a href="#L253" title="ocaml/runtime/debugger.c:253">getval</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; cf = <a href="codefrag.c.html#L104" title="ocaml/runtime/codefrag.c:104">caml_find_code_fragment_by_pc</a>((<span class="Type">char</span>*) <a href="caml/mlvalues.h.html#L276" title="ocaml/runtime/caml/mlvalues.h:276">Code_val</a>(val));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(cf != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, cf-&gt;fragnum);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L278" title="ocaml/runtime/io.c:278">caml_putword</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>, (<span class="Type">char</span>*) <a href="caml/mlvalues.h.html#L276" title="ocaml/runtime/caml/mlvalues.h:276">Code_val</a>(val) - cf-&gt;code_start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="io.c.html#L261" title="ocaml/runtime/io.c:261">caml_flush</a>(<a href="#L106" title="ocaml/runtime/debugger.c:106">dbg_out</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> REQ_SET_FORK_MODE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L38" title="ocaml/runtime/debugger.c:38">caml_debugger_fork_mode</a> = <a href="io.c.html#L373" title="ocaml/runtime/io.c:373">caml_getword</a>(<a href="#L105" title="ocaml/runtime/debugger.c:105">dbg_in</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L623">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_debugger_cleanup_fork</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Comment">/* We could remove all of the event points, but closing the connection<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; * means that they'll just be skipped anyway. */<br/></li>
<li></span>&nbsp; <a href="#L151" title="ocaml/runtime/debugger.c:151">close_connection</a>();<br/></li>
<li>&nbsp; <a href="#L36" title="ocaml/runtime/debugger.c:36">caml_debugger_in_use</a> = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

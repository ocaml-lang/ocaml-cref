<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/afl.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/afl.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L61">afl_initialised</a></li>
<li><a href="#L26">caml_afl_area_ptr</a></li>
<li><a href="#L27">caml_afl_prev_loc</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L77">afl_read</a></li>
<li><a href="#L71">afl_write</a></li>
<li><a href="#L42">caml_reset_afl_instrumentation</a></li>
<li><a href="#L176">caml_reset_afl_instrumentation</a></li>
<li><a href="#L31">caml_setup_afl</a></li>
<li><a href="#L85">caml_setup_afl</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L17">CAML_INTERNALS</a></li>
<li><a href="#L68">FORKSRV_FD_READ</a></li>
<li><a href="#L69">FORKSRV_FD_WRITE</a></li>
<li><a href="#L25">INITIAL_AFL_AREA_SIZE</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Stephen Dolan, University of Cambridge&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 2016 Stephen Dolan.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Runtime support for afl-fuzz */<br/></li>
<li></span><br/></li>
<li><a id="L17">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/config.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Values used by the instrumentation logic (see cmmgen.ml) */<br/></li>
<li></span><br/></li>
<li><a id="L25">&#x200c;</a><span class="PreProc">#define <span class="linkable">INITIAL_AFL_AREA_SIZE</span> (</span><span class="Constant">1</span><span class="PreProc"> &lt;&lt; </span><span class="Constant">16</span><span class="PreProc">)<br/></li>
<li><a id="L26">&#x200c;</a></span><span class="Type">unsigned</span> <span class="Type">char</span> * <span class="linkable">caml_afl_area_ptr</span> = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><a id="L27">&#x200c;</a><a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_afl_prev_loc</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if !defined(HAS_SYS_SHM_H) || !defined(HAS_SHMAT)<br/></li>
<li></span><br/></li>
<li><a id="L31">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_setup_afl</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> unit)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Comment">/* AFL is not supported, but we still need to allocate space for the bitmap<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; (the instrumented OCaml code will write into it). */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a> == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a> = <a href="memory.c.html#L550" title="ocaml/runtime/memory.c:550">caml_stat_alloc</a>(<a href="#L25" title="ocaml/runtime/afl.c:25">INITIAL_AFL_AREA_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; memset(<a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a>, <span class="Constant">0</span>, <a href="#L25" title="ocaml/runtime/afl.c:25">INITIAL_AFL_AREA_SIZE</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L42">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_reset_afl_instrumentation</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> full)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;signal.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/shm.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/wait.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/domain.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/misc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/osdeps.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L61">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">afl_initialised</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* afl uses abnormal termination (<a href="signals.c.html#L368" title="ocaml/runtime/signals.c:368">SIGABRT</a>) to check whether<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; to count a testcase as &quot;crashing&quot; */<br/></li>
<li></span><span class="Type">extern</span> <span class="Type">int</span> <a href="printexc.c.html#L137" title="ocaml/runtime/printexc.c:137">caml_abort_on_uncaught_exn</a>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* File descriptors used to synchronise with afl-fuzz */<br/></li>
<li><a id="L68">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">FORKSRV_FD_READ</span> </span><span class="Constant">198<br/></li>
<li><a id="L69">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">FORKSRV_FD_WRITE</span> </span><span class="Constant">199<br/></li>
<li></span><br/></li>
<li><a id="L71">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">afl_write</span>(<span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (write(<a href="#L69" title="ocaml/runtime/afl.c:69">FORKSRV_FD_WRITE</a>, &amp;msg, <span class="Constant">4</span>) != <span class="Constant">4</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;writing to afl-fuzz&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L77">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> <span class="linkable">afl_read</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> msg;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (read(<a href="#L68" title="ocaml/runtime/afl.c:68">FORKSRV_FD_READ</a>, &amp;msg, <span class="Constant">4</span>) != <span class="Constant">4</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;reading from afl-fuzz&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> msg;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L85">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_setup_afl</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> unit)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span>* shm_id_str;<br/></li>
<li>&nbsp; <span class="Type">char</span>* shm_id_end;<br/></li>
<li>&nbsp; <span class="Type">long</span> <span class="Type">int</span> shm_id;<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> startup_msg = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L61" title="ocaml/runtime/afl.c:61">afl_initialised</a>) <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>&nbsp; <a href="#L61" title="ocaml/runtime/afl.c:61">afl_initialised</a> = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; shm_id_str = <a href="unix.c.html#L414" title="ocaml/runtime/unix.c:414">caml_secure_getenv</a>(<span class="Constant">&quot;__AFL_SHM_ID&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (shm_id_str == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Not running under afl-fuzz.&nbsp; Allocate space for the bitmap<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; (the instrumented OCaml code will write into it),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> continue as normal. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a> = <a href="memory.c.html#L550" title="ocaml/runtime/memory.c:550">caml_stat_alloc</a>(<a href="#L25" title="ocaml/runtime/afl.c:25">INITIAL_AFL_AREA_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; memset(<a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a>, <span class="Constant">0</span>, <a href="#L25" title="ocaml/runtime/afl.c:25">INITIAL_AFL_AREA_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* if afl-fuzz is attached, we want it to know about uncaught exceptions */<br/></li>
<li></span>&nbsp; <a href="printexc.c.html#L137" title="ocaml/runtime/printexc.c:137">caml_abort_on_uncaught_exn</a> = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; shm_id = strtol(shm_id_str, &amp;shm_id_end, <span class="Constant">10</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!(*shm_id_str != <span class="Special">'\0'</span> &amp;&amp; *shm_id_end == <span class="Special">'\0'</span>))<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;afl-fuzz: bad shm id&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a> = shmat((<span class="Type">int</span>)shm_id, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a> == (<span class="Type">void</span>*)-<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;afl-fuzz: could not attach shm area&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* poke the bitmap so that afl-fuzz knows we exist, even if the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; application has sparse instrumentation */<br/></li>
<li></span>&nbsp; <a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a>[<span class="Constant">0</span>] = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* synchronise with afl-fuzz */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (write(<a href="#L69" title="ocaml/runtime/afl.c:69">FORKSRV_FD_WRITE</a>, &amp;startup_msg, <span class="Constant">4</span>) != <span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* initial write failed, so assume we're not meant to fork.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; afl-tmin uses this mode. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L77" title="ocaml/runtime/afl.c:77">afl_read</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* ensure that another module has not already spawned a domain */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="domain.c.html#L1675" title="ocaml/runtime/domain.c:1675">caml_domain_is_multicore</a>())<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;afl-fuzz: cannot fork with multiple domains running&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> child_pid = fork();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (child_pid &lt; <span class="Constant">0</span>) <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;afl-fuzz: could not fork&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (child_pid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/domain.h.html#L81" title="ocaml/runtime/caml/domain.h:81">caml_atfork_hook</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Run the program */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; close(<a href="#L68" title="ocaml/runtime/afl.c:68">FORKSRV_FD_READ</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; close(<a href="#L69" title="ocaml/runtime/afl.c:69">FORKSRV_FD_WRITE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* As long as the child keeps raising <a href="signals.c.html#L413" title="ocaml/runtime/signals.c:413">SIGSTOP</a>, we re-use the same process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> <a href="caml/shared_heap.h.html#L54" title="ocaml/runtime/caml/shared_heap.h:54">status</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> was_killed;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L71" title="ocaml/runtime/afl.c:71">afl_write</a>((<span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span>)child_pid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* WUNTRACED means wait until termination <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> <a href="signals.c.html#L413" title="ocaml/runtime/signals.c:413">SIGSTOP</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (waitpid(child_pid, &amp;<a href="caml/shared_heap.h.html#L54" title="ocaml/runtime/caml/shared_heap.h:54">status</a>, WUNTRACED) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;afl-fuzz: waitpid failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L71" title="ocaml/runtime/afl.c:71">afl_write</a>((<span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span>)<a href="caml/shared_heap.h.html#L54" title="ocaml/runtime/caml/shared_heap.h:54">status</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; was_killed = <a href="#L77" title="ocaml/runtime/afl.c:77">afl_read</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (WIFSTOPPED(<a href="caml/shared_heap.h.html#L54" title="ocaml/runtime/caml/shared_heap.h:54">status</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* child stopped, waiting for another test case */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (was_killed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we saw the child stop, but since then afl-fuzz killed it.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; we should wait for it before forking another child */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (waitpid(child_pid, &amp;<a href="caml/shared_heap.h.html#L54" title="ocaml/runtime/caml/shared_heap.h:54">status</a>, <span class="Constant">0</span>) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;afl-fuzz: waitpid failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kill(child_pid, <span class="Constant"><a href="signals.c.html#L410" title="ocaml/runtime/signals.c:410">SIGCONT</a></span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* child died */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L176">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_reset_afl_instrumentation</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> full)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (full == <a href="caml/mlvalues.h.html#L426" title="ocaml/runtime/caml/mlvalues.h:426">Val_true</a> &amp;&amp; <a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a> != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; memset(<a href="#L26" title="ocaml/runtime/afl.c:26">caml_afl_area_ptr</a>, <span class="Constant">0</span>, <a href="#L25" title="ocaml/runtime/afl.c:25">INITIAL_AFL_AREA_SIZE</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L27" title="ocaml/runtime/afl.c:27">caml_afl_prev_loc</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* HAS_SYS_SHM_H */<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

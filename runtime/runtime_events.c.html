<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/runtime_events.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/runtime_events.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L596">alloc_buckets</a></li>
<li><a href="#L91">current_metadata</a></li>
<li><a href="#L94">current_ring_loc</a></li>
<li><a href="#L92">current_ring_total_size</a></li>
<li><a href="#L110">preserve_ring</a></li>
<li><a href="#L97">ring_file_handle</a></li>
<li><a href="#L98">ring_handle</a></li>
<li><a href="#L103">ring_size_words</a></li>
<li><a href="#L115">runtime_custom_event_index</a></li>
<li><a href="#L112">runtime_events_enabled</a></li>
<li><a href="#L93">runtime_events_path</a></li>
<li><a href="#L113">runtime_events_paused</a></li>
<li><a href="#L119">user_events</a></li>
<li><a href="#L120">user_events_lock</a></li>
<li><a href="#L123">write_buffer</a></li>
<li><a href="#L124">write_buffer_lock</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L88">ev_category</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L599">caml_ev_alloc</a></li>
<li><a href="#L613">caml_ev_alloc_flush</a></li>
<li><a href="#L565">caml_ev_begin</a></li>
<li><a href="#L579">caml_ev_counter</a></li>
<li><a href="#L572">caml_ev_end</a></li>
<li><a href="#L589">caml_ev_lifecycle</a></li>
<li><a href="#L222">caml_runtime_events_current_location</a></li>
<li><a href="#L232">caml_runtime_events_destroy</a></li>
<li><a href="#L133">caml_runtime_events_init</a></li>
<li><a href="#L431">caml_runtime_events_pause</a></li>
<li><a href="#L201">caml_runtime_events_post_fork</a></li>
<li><a href="#L443">caml_runtime_events_resume</a></li>
<li><a href="#L423">caml_runtime_events_start</a></li>
<li><a href="#L638">caml_runtime_events_user_register</a></li>
<li><a href="#L794">caml_runtime_events_user_resolve</a></li>
<li><a href="#L695">caml_runtime_events_user_write</a></li>
<li><a href="#L629">events_register_write_buffer</a></li>
<li><a href="#L454">get_ring_buffer_by_domain_id</a></li>
<li><a href="#L559">ring_is_active</a></li>
<li><a href="#L252">runtime_events_create_raw</a></li>
<li><a href="#L163">runtime_events_teardown_raw</a></li>
<li><a href="#L410">stw_create_runtime_events</a></li>
<li><a href="#L189">stw_teardown_runtime_events</a></li>
<li><a href="#L463">write_to_ring</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L15">CAML_INTERNALS</a></li>
<li><a href="#L47">RUNTIME_EVENTS_VERSION</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sadiq Jaffer, Opsian&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 2021 Opsian Ltd&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L15">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/runtime_events.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/alloc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/callback.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/custom.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/osdeps.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/startup_aux.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;fcntl.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdatomic.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/stat.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;process.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;processthreadsapi.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;wtypes.h&gt;<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/mman.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if defined(HAS_UNISTD)<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L47">&#x200c;</a><span class="PreProc">#define <span class="linkable">RUNTIME_EVENTS_VERSION</span> </span><span class="Constant">1<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">This file contains the implementation for runtime_events's producer. The<br/></li>
<li></span><span class="Comment">consumer can be found in runtime_events_consumer.<br/></li>
<li></span><br/></li>
<li><span class="Comment">Runtime_events is a transport for tracing <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> counter events from the OCaml<br/></li>
<li></span><span class="Comment">runtime. When enabled the caml_ev_* probes emit events that get written to<br/></li>
<li></span><span class="Comment">per-domain memory-mapped ring buffers. Consumers can be written that use the<br/></li>
<li></span><span class="Comment">OCaml <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> C apis to consume these events asynchronously. This can be done both<br/></li>
<li></span><span class="Comment">inside <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> outside the process.<br/></li>
<li></span><br/></li>
<li><span class="Comment">The ring buffer is structured as a flight recorder, overwriting old data when<br/></li>
<li></span><span class="Comment">there is insufficient space to write new events. This enables users to<br/></li>
<li></span><span class="Comment">potentially only read the ring when some anomalous event occurs. No coordination<br/></li>
<li></span><span class="Comment">is needed with consumers who read the events - they detect races with the<br/></li>
<li></span><span class="Comment">producer <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> discard events when that happens.<br/></li>
<li></span><br/></li>
<li><span class="Comment">The producer code is contained here . By default a &lt;pid&gt;.events file is<br/></li>
<li></span><span class="Comment">created in the current directory (overridable by setting<br/></li>
<li></span><span class="Comment">OCAML_RUNTIME_EVENTS_DIR). This file contains a ring buffer for each possible<br/></li>
<li></span><span class="Comment">domain (<a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a>). It is laid out in a structure that enables sparsity.<br/></li>
<li></span><span class="Comment">On-disk (<a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> in-memory) footprint is proportional to the max number of concurrent<br/></li>
<li></span><span class="Comment">domains the process has ever run.<br/></li>
<li></span><br/></li>
<li><span class="Comment">On disk structure:<br/></li>
<li></span><br/></li>
<li><span class="Comment">----------------------------------------------------------------<br/></li>
<li></span><span class="Comment">| File header (version, offsets, etc..)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br/></li>
<li></span><span class="Comment">----------------------------------------------------------------<br/></li>
<li></span><span class="Comment">| Ring 0..<a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a> metadata&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<br/></li>
<li></span><span class="Comment">| (head <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> tail indexes, one per cache line)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br/></li>
<li></span><span class="Comment">----------------------------------------------------------------<br/></li>
<li></span><span class="Comment">| Ring 0..<a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a> data&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<br/></li>
<li></span><span class="Comment">| (actual ring data, default 2^16 words = 512k bytes)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br/></li>
<li></span><span class="Comment">----------------------------------------------------------------<br/></li>
<li></span><span class="Comment">| Custom event IDs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<br/></li>
<li></span><span class="Comment">| 2^13 char[128] = 1M bytes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br/></li>
<li></span><span class="Comment">----------------------------------------------------------------<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L88">&#x200c;</a><span class="Type">typedef</span> <span class="Type">enum</span> { EV_RUNTIME, EV_USER } <span class="linkable">ev_category</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* These store state for the current ring buffers open for writing */<br/></li>
<li><a id="L91">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="caml/runtime_events.h.html#L215" title="ocaml/runtime/caml/runtime_events.h:215">runtime_events_metadata_header</a> *<span class="linkable">current_metadata</span> = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><a id="L92">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">current_ring_total_size</span>;<br/></li>
<li><a id="L93">&#x200c;</a><span class="Type">static</span> <a href="caml/misc.h.html#L227" title="ocaml/runtime/caml/misc.h:227">char_os</a> *<span class="linkable">runtime_events_path</span>;<br/></li>
<li><a id="L94">&#x200c;</a><span class="Type">static</span> <a href="caml/misc.h.html#L227" title="ocaml/runtime/caml/misc.h:227">char_os</a> *<span class="linkable">current_ring_loc</span> = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li><a id="L97">&#x200c;</a></span><span class="Type">static</span> HANDLE <span class="linkable">ring_file_handle</span>;<br/></li>
<li><a id="L98">&#x200c;</a><span class="Type">static</span> HANDLE <span class="linkable">ring_handle</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* This comes from OCAMLRUNPARAMs <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> is initialised in<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; <a href="#L133" title="ocaml/runtime/runtime_events.c:133">caml_runtime_events_init</a> */<br/></li>
<li><a id="L103">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">ring_size_words</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* This is set if the OCAML_RUNTIME_EVENTS_PRESERVE environment<br/></li>
<li></span><span class="Comment">&nbsp; variable is present <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> determines whether the ring buffer is<br/></li>
<li></span><span class="Comment">&nbsp; cleaned up on program exit <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> not. It may be preserved to allow<br/></li>
<li></span><span class="Comment">&nbsp; tooling to analyse very short running programs where there would<br/></li>
<li></span><span class="Comment">&nbsp; be a race to read their ring buffers. */<br/></li>
<li><a id="L110">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">preserve_ring</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L112">&#x200c;</a><span class="Type">static</span> <a href="caml/camlatomic.h.html#L32" title="ocaml/runtime/caml/camlatomic.h:32">atomic_uintnat</a> <span class="linkable">runtime_events_enabled</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L113">&#x200c;</a><span class="Type">static</span> <a href="caml/camlatomic.h.html#L32" title="ocaml/runtime/caml/camlatomic.h:32">atomic_uintnat</a> <span class="linkable">runtime_events_paused</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L115">&#x200c;</a><span class="Type">static</span> <a href="caml/camlatomic.h.html#L32" title="ocaml/runtime/caml/camlatomic.h:32">atomic_uintnat</a> <span class="linkable">runtime_custom_event_index</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* List of globally known events. This is used to figure which event has a<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; given string ID. */<br/></li>
<li><a id="L119">&#x200c;</a></span><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">user_events</span> = <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>;<br/></li>
<li><a id="L120">&#x200c;</a><span class="Type">static</span> <a href="caml/platform.h.html#L100" title="ocaml/runtime/caml/platform.h:100">caml_plat_mutex</a> <span class="linkable">user_events_lock</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* Custom type write buffer */<br/></li>
<li><a id="L123">&#x200c;</a></span><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">write_buffer</span> = <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>;<br/></li>
<li><a id="L124">&#x200c;</a><span class="Type">static</span> <a href="caml/platform.h.html#L100" title="ocaml/runtime/caml/platform.h:100">caml_plat_mutex</a> <span class="linkable">write_buffer_lock</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(<a href="#L88" title="ocaml/runtime/runtime_events.c:88">ev_category</a> category, <a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a> type,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> event_id, <span class="Type">int</span> event_length, <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> *content,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> word_offset);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L629" title="ocaml/runtime/runtime_events.c:629">events_register_write_buffer</a>(<span class="Type">int</span> index, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_name);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L252" title="ocaml/runtime/runtime_events.c:252">runtime_events_create_raw</a>(<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><a id="L133">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_runtime_events_init</span>(<span class="Type">void</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; <a href="platform.c.html#L47" title="ocaml/runtime/platform.c:47">caml_plat_mutex_init</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li>&nbsp; <a href="globroots.c.html#L95" title="ocaml/runtime/globroots.c:95">caml_register_generational_global_root</a>(&amp;<a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="platform.c.html#L47" title="ocaml/runtime/platform.c:47">caml_plat_mutex_init</a>(&amp;<a href="#L124" title="ocaml/runtime/runtime_events.c:124">write_buffer_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L93" title="ocaml/runtime/runtime_events.c:93">runtime_events_path</a> = <a href="unix.c.html#L414" title="ocaml/runtime/unix.c:414">caml_secure_getenv</a>(<a href="caml/misc.h.html#L363" title="ocaml/runtime/caml/misc.h:363">T</a>(<span class="Constant">&quot;OCAML_RUNTIME_EVENTS_DIR&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L93" title="ocaml/runtime/runtime_events.c:93">runtime_events_path</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="unix.c.html#L414" title="ocaml/runtime/unix.c:414">caml_secure_getenv</a>'s return shouldn't be cached */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L93" title="ocaml/runtime/runtime_events.c:93">runtime_events_path</a> = <a href="caml/misc.h.html#L393" title="ocaml/runtime/caml/misc.h:393">caml_stat_strdup_os</a>(<a href="#L93" title="ocaml/runtime/runtime_events.c:93">runtime_events_path</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L103" title="ocaml/runtime/runtime_events.c:103">ring_size_words</a> = <span class="Constant">1</span> &lt;&lt; <a href="startup_aux.c.html#L41" title="ocaml/runtime/startup_aux.c:41">caml_params</a>-&gt;runtime_events_log_wsize;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L110" title="ocaml/runtime/runtime_events.c:110">preserve_ring</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="unix.c.html#L414" title="ocaml/runtime/unix.c:414">caml_secure_getenv</a>(<a href="caml/misc.h.html#L363" title="ocaml/runtime/caml/misc.h:363">T</a>(<span class="Constant">&quot;OCAML_RUNTIME_EVENTS_PRESERVE&quot;</span>)) ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="unix.c.html#L414" title="ocaml/runtime/unix.c:414">caml_secure_getenv</a>(<a href="caml/misc.h.html#L363" title="ocaml/runtime/caml/misc.h:363">T</a>(<span class="Constant">&quot;OCAML_RUNTIME_EVENTS_START&quot;</span>))) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* since [<a href="#L133" title="ocaml/runtime/runtime_events.c:133">caml_runtime_events_init</a>] can only be called from the startup code<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> we can be sure there is only a single domain running, it is safe to call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; [<a href="#L252" title="ocaml/runtime/runtime_events.c:252">runtime_events_create_raw</a>] outside of a stop-the-world section */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L252" title="ocaml/runtime/runtime_events.c:252">runtime_events_create_raw</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* teardown the ring buffers. This must be called from a stop-the-world<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; unless we are sure there is only a single domain running (e.g after a fork)<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L163">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">runtime_events_teardown_raw</span>(<span class="Type">int</span> remove_file) {<br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span>&nbsp; &nbsp; UnmapViewOfFile(<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>);<br/></li>
<li>&nbsp; &nbsp; CloseHandle(<a href="#L97" title="ocaml/runtime/runtime_events.c:97">ring_file_handle</a>);<br/></li>
<li>&nbsp; &nbsp; CloseHandle(<a href="#L98" title="ocaml/runtime/runtime_events.c:98">ring_handle</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span>( remove_file ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; DeleteFile(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* This cast is necessary for compatibility with Illumos' non-POSIX<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; mmap/munmap */<br/></li>
<li></span>&nbsp; &nbsp; munmap((<span class="Type">void</span>*)<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>, <a href="#L92" title="ocaml/runtime/runtime_events.c:92">current_ring_total_size</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span>( remove_file ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; unlink(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L58" title="ocaml/runtime/caml/platform.h:58">atomic_store_release</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Stop-the-world which calls the teardown code */<br/></li>
<li><a id="L189">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">stw_teardown_runtime_events</span>(<a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a> *domain_state,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">void</span> *remove_file_data, <span class="Type">int</span> num_participating,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a> **participating_domains) {<br/></li>
<li>&nbsp; <a href="domain.c.html#L1242" title="ocaml/runtime/domain.c:1242">caml_global_barrier</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (participating_domains[<span class="Constant">0</span>] == domain_state) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> remove_file = *(<span class="Type">int</span>*)remove_file_data;<br/></li>
<li>&nbsp; &nbsp; <a href="#L163" title="ocaml/runtime/runtime_events.c:163">runtime_events_teardown_raw</a>(remove_file);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="domain.c.html#L1242" title="ocaml/runtime/domain.c:1242">caml_global_barrier</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L201">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_runtime_events_post_fork</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Comment">/* We are here in the child process after a call to fork (which can only<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; happen when there is a single domain) <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> no mutator code that can spawn a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; new domain can have run yet. Let's be double sure. */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/domain.h.html#L93" title="ocaml/runtime/caml/domain.h:93">caml_domain_alone</a>());<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* In the child we need to tear down the various structures used for the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; existing runtime_events from the parent. In doing so we need to make sure we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; don't remove the runtime_events file itself as that may still be used by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; the parent. There is no need for a stop-the-world in this case as we are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; certain there is only a single domain running. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L163" title="ocaml/runtime/runtime_events.c:163">runtime_events_teardown_raw</a>(<span class="Constant">0</span> <span class="Comment">/* don't remove the file */</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We still have the path <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> ring size from our parent */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L423" title="ocaml/runtime/runtime_events.c:423">caml_runtime_events_start</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return the current location for the ring buffers of this process. This is<br/></li>
<li></span><span class="Comment">&nbsp; used in the consumer to read the ring buffers of the current process */<br/></li>
<li><a id="L222">&#x200c;</a></span><a href="caml/misc.h.html#L227" title="ocaml/runtime/caml/misc.h:227">char_os</a>* <span class="linkable">caml_runtime_events_current_location</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Statement">if</span>( <a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>) ) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Write a lifecycle event <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> then trigger a stop the world to tear down the<br/></li>
<li></span><span class="Comment">&nbsp; ring buffers */<br/></li>
<li><a id="L232">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">caml_runtime_events_destroy</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; EV_RUNTIME, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.runtime=EV_LIFECYCLE}, EV_RING_STOP, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* clean up runtime_events when we exit if we haven't been instructed to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; preserve the file. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> remove_file = <a href="#L110" title="ocaml/runtime/runtime_events.c:110">preserve_ring</a> ? <span class="Constant">0</span> : <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="domain.c.html#L1496" title="ocaml/runtime/domain.c:1496">caml_try_run_on_all_domains</a>(&amp;<a href="#L189" title="ocaml/runtime/runtime_events.c:189">stw_teardown_runtime_events</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;remove_file, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span>( <a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>) );<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Create the initial runtime_events ring buffers. This must be called from<br/></li>
<li></span><span class="Comment">&nbsp; within a stop-the-world section if we cannot be sure there is only a single<br/></li>
<li></span><span class="Comment">&nbsp; domain running. */<br/></li>
<li><a id="L252">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">runtime_events_create_raw</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Comment">/* Don't initialise runtime_events twice */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (!<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> ret, ring_headers_length, ring_data_length;<br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span>&nbsp; &nbsp; DWORD pid = GetCurrentProcessId();<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> ring_fd;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">long</span> <span class="Type">int</span> pid = getpid();<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a> = <a href="memory.c.html#L550" title="ocaml/runtime/memory.c:550">caml_stat_alloc</a>(<a href="caml/runtime_events.h.html#L229" title="ocaml/runtime/caml/runtime_events.h:229">RUNTIME_EVENTS_MAX_MSG_LENGTH</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L93" title="ocaml/runtime/runtime_events.c:93">runtime_events_path</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L556" title="ocaml/runtime/caml/misc.h:556">snprintf_os</a>(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>, <a href="caml/runtime_events.h.html#L229" title="ocaml/runtime/caml/runtime_events.h:229">RUNTIME_EVENTS_MAX_MSG_LENGTH</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L363" title="ocaml/runtime/caml/misc.h:363">T</a>(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%ld</span><span class="Constant">.events&quot;</span>), <a href="#L93" title="ocaml/runtime/runtime_events.c:93">runtime_events_path</a>, pid);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L556" title="ocaml/runtime/caml/misc.h:556">snprintf_os</a>(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>, <a href="caml/runtime_events.h.html#L229" title="ocaml/runtime/caml/runtime_events.h:229">RUNTIME_EVENTS_MAX_MSG_LENGTH</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L363" title="ocaml/runtime/caml/misc.h:363">T</a>(<span class="Constant">&quot;</span><span class="Special">%ld</span><span class="Constant">.events&quot;</span>), pid);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L92" title="ocaml/runtime/runtime_events.c:92">current_ring_total_size</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/runtime_events.h.html#L227" title="ocaml/runtime/caml/runtime_events.h:227">RUNTIME_EVENTS_MAX_CUSTOM_EVENTS</a> *<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L186" title="ocaml/runtime/caml/runtime_events.h:186">runtime_events_custom_event</a>) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a> * (<a href="#L103" title="ocaml/runtime/runtime_events.c:103">ring_size_words</a> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a>)) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L215" title="ocaml/runtime/caml/runtime_events.h:215">runtime_events_metadata_header</a>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef _WIN32<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L97" title="ocaml/runtime/runtime_events.c:97">ring_file_handle</a> = CreateFile(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; GENERIC_READ | GENERIC_WRITE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; FILE_SHARE_READ | FILE_SHARE_WRITE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; CREATE_ALWAYS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; FILE_ATTRIBUTE_NORMAL,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a><br/></li>
<li></span>&nbsp; &nbsp; );<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L97" title="ocaml/runtime/runtime_events.c:97">ring_file_handle</a> == INVALID_HANDLE_VALUE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span>* ring_loc_u8 = <a href="caml/misc.h.html#L397" title="ocaml/runtime/caml/misc.h:397">caml_stat_strdup_of_os</a>(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;Couldn't open ring buffer loc: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ring_loc_u8);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(ring_loc_u8);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L98" title="ocaml/runtime/runtime_events.c:98">ring_handle</a> = CreateFileMapping(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L97" title="ocaml/runtime/runtime_events.c:97">ring_file_handle</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; PAGE_READWRITE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L92" title="ocaml/runtime/runtime_events.c:92">current_ring_total_size</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a><br/></li>
<li></span>&nbsp; &nbsp; );<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L98" title="ocaml/runtime/runtime_events.c:98">ring_handle</a> == INVALID_HANDLE_VALUE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;Could not create file mapping&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> = MapViewOfFile(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L98" title="ocaml/runtime/runtime_events.c:98">ring_handle</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; FILE_MAP_ALL_ACCESS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; );<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span>( <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;failed to map view of file&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; ring_fd =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; open(<a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>, O_RDWR | O_CREAT, (S_IRUSR | S_IWUSR));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ring_fd &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;Couldn't open ring buffer loc: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L94" title="ocaml/runtime/runtime_events.c:94">current_ring_loc</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ret = ftruncate(ring_fd, <a href="#L92" title="ocaml/runtime/runtime_events.c:92">current_ring_total_size</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ret &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;Can't resize ring buffer&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* This cast is necessary for compatibility with Illumos' non-POSIX<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; mmap/munmap */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> = (<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L215" title="ocaml/runtime/caml/runtime_events.h:215">runtime_events_metadata_header</a>*)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mmap(<span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <a href="#L92" title="ocaml/runtime/runtime_events.c:92">current_ring_total_size</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROT_READ | PROT_WRITE, MAP_SHARED, ring_fd, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<span class="Constant">&quot;Unable to mmap ring buffer&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; close(ring_fd);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; ring_headers_length =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a>);<br/></li>
<li>&nbsp; &nbsp; ring_data_length =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a> * <a href="#L103" title="ocaml/runtime/runtime_events.c:103">ring_size_words</a> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;version = <a href="#L47" title="ocaml/runtime/runtime_events.c:47">RUNTIME_EVENTS_VERSION</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;max_domains = <a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_header_size_bytes =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_size_bytes =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L103" title="ocaml/runtime/runtime_events.c:103">ring_size_words</a> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_size_elements = <a href="#L103" title="ocaml/runtime/runtime_events.c:103">ring_size_words</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;headers_offset =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L215" title="ocaml/runtime/caml/runtime_events.h:215">runtime_events_metadata_header</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* strictly we can calculate this in a consumer but for simplicity we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; store it in the metadata header */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;data_offset =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;headers_offset + ring_headers_length;<br/></li>
<li>&nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;custom_events_offset =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;data_offset + ring_data_length;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> domain_num = <span class="Constant">0</span>; domain_num &lt; <a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a>; domain_num++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* we initialise each ring's metadata. We use the offset to the headers<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> then find the slot for each of domain in <a href="caml/domain.h.html#L35" title="ocaml/runtime/caml/domain.h:35">Max_domains</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a> *ring_buffer =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)((<span class="Type">char</span> *)<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;headers_offset +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; domain_num * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; ring_buffer-&gt;ring_head = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; ring_buffer-&gt;ring_tail = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// at the same instant: snapshot <a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a> list <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> set<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// <a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a> to 1<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> current_user_event = <a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L58" title="ocaml/runtime/caml/platform.h:58">atomic_store_release</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L58" title="ocaml/runtime/caml/platform.h:58">atomic_store_release</a>(&amp;<a href="#L113" title="ocaml/runtime/runtime_events.c:113">runtime_events_paused</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L589" title="ocaml/runtime/runtime_events.c:589">caml_ev_lifecycle</a>(EV_RING_START, pid);<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="caml/mlvalues.h.html#L443" title="ocaml/runtime/caml/mlvalues.h:443">Is_some</a> (current_user_event)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(current_user_event, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L629" title="ocaml/runtime/runtime_events.c:629">events_register_write_buffer</a>(<a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">0</span>)), <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; current_user_event = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(current_user_event, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Stop the world section which calls [<a href="#L252" title="ocaml/runtime/runtime_events.c:252">runtime_events_create_raw</a>], used when we<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; can't be sure there is only a single domain running. */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L410">&#x200c;</a></span><span class="linkable">stw_create_runtime_events</span>(<a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a> *domain_state, <span class="Type">void</span> *data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> num_participating,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a> **participating_domains) {<br/></li>
<li>&nbsp; <span class="Comment">/* Everyone must be stopped for starting <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> stopping runtime_events */<br/></li>
<li></span>&nbsp; <a href="domain.c.html#L1242" title="ocaml/runtime/domain.c:1242">caml_global_barrier</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Only do this on one domain */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (participating_domains[<span class="Constant">0</span>] == domain_state) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L252" title="ocaml/runtime/runtime_events.c:252">runtime_events_create_raw</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="domain.c.html#L1242" title="ocaml/runtime/domain.c:1242">caml_global_barrier</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L423">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_runtime_events_start</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Statement">while</span> (!<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="domain.c.html#L1496" title="ocaml/runtime/domain.c:1496">caml_try_run_on_all_domains</a>(&amp;<a href="#L410" title="ocaml/runtime/runtime_events.c:410">stw_create_runtime_events</a>, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L431">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_runtime_events_pause</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> not_paused = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span>( <a href="caml/camlatomic.h.html#L68" title="ocaml/runtime/caml/camlatomic.h:68">atomic_compare_exchange_strong</a>(&amp;<a href="#L113" title="ocaml/runtime/runtime_events.c:113">runtime_events_paused</a>, &amp;not_paused, <span class="Constant">1</span>) ) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L589" title="ocaml/runtime/runtime_events.c:589">caml_ev_lifecycle</a>(EV_RING_PAUSE, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L443">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_runtime_events_resume</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> paused = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span>( <a href="caml/camlatomic.h.html#L68" title="ocaml/runtime/caml/camlatomic.h:68">atomic_compare_exchange_strong</a>(&amp;<a href="#L113" title="ocaml/runtime/runtime_events.c:113">runtime_events_paused</a>, &amp;paused, <span class="Constant">0</span>) ) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L589" title="ocaml/runtime/runtime_events.c:589">caml_ev_lifecycle</a>(EV_RING_RESUME, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><a id="L454">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a> *<span class="linkable">get_ring_buffer_by_domain_id</span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">int</span> domain_id) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a> *)((<span class="Type">char</span> *)<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;headers_offset +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; domain_id *<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_header_size_bytes);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L463">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">write_to_ring</span>(<a href="#L88" title="ocaml/runtime/runtime_events.c:88">ev_category</a> category, <a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a> type,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> event_id, <span class="Type">int</span> event_length, <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> *content,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> word_offset) {<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* account for header <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> timestamp (which are both uint64) */<br/></li>
<li></span>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> length_with_header_ts = event_length + <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* there is a ring buffer (made up of header <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> data) for each domain */<br/></li>
<li></span>&nbsp; <span class="Type">struct</span> <a href="caml/runtime_events.h.html#L176" title="ocaml/runtime/caml/runtime_events.h:176">runtime_events_buffer_header</a> *domain_ring_header =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L454" title="ocaml/runtime/runtime_events.c:454">get_ring_buffer_by_domain_id</a>(<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;id);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* get the pointer to the data for this domain's ring buffer */<br/></li>
<li></span>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> *ring_ptr = (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> *)((<span class="Type">char</span>*)<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;data_offset<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;id * <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_size_bytes);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* the head <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> tail indexes for the current domain's ring buffer (out of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; the header) */<br/></li>
<li></span>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> ring_head = <a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;domain_ring_header-&gt;ring_head);<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> ring_tail = <a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;domain_ring_header-&gt;ring_tail);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* since rings can only be powers of two in size, we use this mask to cheaply<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; convert the head <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> tail indexes in to the physical offset in the ring<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; buffer's data. */<br/></li>
<li></span>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> ring_mask = <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_size_elements - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> ring_tail_offset = ring_tail &amp; ring_mask;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* we avoid writing events that straddle the end of the ring buffer */<br/></li>
<li></span>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> ring_distance_to_end =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;ring_size_elements - ring_tail_offset;<br/></li>
<li>&nbsp; <span class="Comment">/* when we might write an event that is bigger than the physical size<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; remaining we <a href="ints.c.html#L461" title="ocaml/runtime/ints.c:461">add</a> a padding event instead <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> then write the actual<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; event to the start of the ring buffer */<br/></li>
<li></span>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> padding_required = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> timestamp = <a href="unix.c.html#L433" title="ocaml/runtime/unix.c:433">caml_time_counter</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* length must be less than 2^10 */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(event_length &lt; <a href="caml/runtime_events.h.html#L229" title="ocaml/runtime/caml/runtime_events.h:229">RUNTIME_EVENTS_MAX_MSG_LENGTH</a>);<br/></li>
<li>&nbsp; <span class="Comment">/* Runtime event with type EV_INTERNAL <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> id 0 is reserved for padding */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<br/></li>
<li>&nbsp; &nbsp; !(category == EV_RUNTIME &amp;&amp; type.runtime == EV_INTERNAL &amp;&amp; event_id == <span class="Constant">0</span>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* work out if padding is required */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (ring_distance_to_end &lt; length_with_header_ts) {<br/></li>
<li>&nbsp; &nbsp; padding_required = ring_distance_to_end;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* First we check if a write would take us over the head */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> ((ring_tail + length_with_header_ts + padding_required) - ring_head &gt;=<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L103" title="ocaml/runtime/runtime_events.c:103">ring_size_words</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The write would over-write some old bit of data. Need to advance the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; head. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> head_header = ring_ptr[ring_head &amp; ring_mask];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ring_head += <a href="caml/runtime_events.h.html#L238" title="ocaml/runtime/caml/runtime_events.h:238">RUNTIME_EVENTS_ITEM_LENGTH</a>(head_header);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// advance the ring head<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/platform.h.html#L58" title="ocaml/runtime/caml/platform.h:58">atomic_store_release</a>(&amp;domain_ring_header-&gt;ring_head, ring_head);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (padding_required &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; ring_ptr[ring_tail_offset] =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (ring_distance_to_end<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt;&lt; <span class="Constant">54</span>); <span class="Comment">/* Padding header with size ring_distance_to_end<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Readers will skip the message <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> go straight<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to the beginning of the ring. */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ring_tail += ring_distance_to_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L58" title="ocaml/runtime/caml/platform.h:58">atomic_store_release</a>(&amp;domain_ring_header-&gt;ring_tail, ring_tail);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ring_tail_offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Below we write the header. See runtime_events.h for the layout structure<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; of event headers.<br/></li>
<li></span><span class="Comment">&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; ring_ptr[ring_tail_offset++] = <a href="caml/runtime_events.h.html#L245" title="ocaml/runtime/caml/runtime_events.h:245">RUNTIME_EVENTS_HEADER</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; length_with_header_ts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; category == EV_RUNTIME,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (type.runtime | type.user),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_id);<br/></li>
<li><br/></li>
<li>&nbsp; ring_ptr[ring_tail_offset++] = timestamp;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (content != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; memcpy(&amp;ring_ptr[ring_tail_offset], content + word_offset,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; event_length * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L58" title="ocaml/runtime/caml/platform.h:58">atomic_store_release</a>(&amp;domain_ring_header-&gt;ring_tail,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ring_tail + length_with_header_ts);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Functions for putting runtime data on to the runtime_events */<br/></li>
<li></span><br/></li>
<li><a id="L559">&#x200c;</a><span class="Type">static</span> <span class="Type">inline</span> <span class="Type">int</span> <span class="linkable">ring_is_active</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="caml/platform.h.html#L56" title="ocaml/runtime/caml/platform.h:56">atomic_load_relaxed</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;&amp; !<a href="caml/platform.h.html#L56" title="ocaml/runtime/caml/platform.h:56">atomic_load_relaxed</a>(&amp;<a href="#L113" title="ocaml/runtime/runtime_events.c:113">runtime_events_paused</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L565">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ev_begin</span>(<a href="caml/runtime_events.h.html#L114" title="ocaml/runtime/caml/runtime_events.h:114">ev_runtime_phase</a> phase) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> ( <a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() ) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_RUNTIME, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.runtime=EV_BEGIN}, phase, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L572">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ev_end</span>(<a href="caml/runtime_events.h.html#L114" title="ocaml/runtime/caml/runtime_events.h:114">ev_runtime_phase</a> phase) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> ( <a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() ) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_RUNTIME, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.runtime=EV_EXIT}, phase, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L579">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ev_counter</span>(<a href="caml/runtime_events.h.html#L134" title="ocaml/runtime/caml/runtime_events.h:134">ev_runtime_counter</a> counter, <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> val) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> ( <a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() ) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> buf[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; buf[<span class="Constant">0</span>] = val;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; EV_RUNTIME, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.runtime=EV_COUNTER}, counter, <span class="Constant">1</span>, buf, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L589">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ev_lifecycle</span>(<a href="caml/runtime_events.h.html#L71" title="ocaml/runtime/caml/runtime_events.h:71">ev_lifecycle</a> lifecycle, <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> data) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> ( <a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() ) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_RUNTIME, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.runtime=EV_LIFECYCLE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lifecycle, <span class="Constant">1</span>, (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> *)&amp;data, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L596">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> <span class="linkable">alloc_buckets</span>[<a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a>] = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>};<br/></li>
<li><br/></li>
<li><a id="L599">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ev_alloc</span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> sz) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> ( !<a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() )<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (sz &lt; (<a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a> / <span class="Constant">2</span>)) {<br/></li>
<li>&nbsp; &nbsp; ++<a href="#L596" title="ocaml/runtime/runtime_events.c:596">alloc_buckets</a>[sz];<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (sz &lt; (<a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a> * <span class="Constant">10</span> / <span class="Constant">2</span>)) {<br/></li>
<li>&nbsp; &nbsp; ++<a href="#L596" title="ocaml/runtime/runtime_events.c:596">alloc_buckets</a>[sz / (<a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a> / <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; + (<a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a> / <span class="Constant">2</span> - <span class="Constant">1</span>)];<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; ++<a href="#L596" title="ocaml/runtime/runtime_events.c:596">alloc_buckets</a>[<a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a> - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L613">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ev_alloc_flush</span>(<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> ( !<a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() )<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_RUNTIME, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.runtime=EV_ALLOC}, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a>, <a href="#L596" title="ocaml/runtime/runtime_events.c:596">alloc_buckets</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; <a href="caml/runtime_events.h.html#L228" title="ocaml/runtime/caml/runtime_events.h:228">RUNTIME_EVENTS_NUM_ALLOC_BUCKETS</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L596" title="ocaml/runtime/runtime_events.c:596">alloc_buckets</a>[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Registers the [index] -&gt; [event_name] mapping in the dedicated space in the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; ring buffer */<br/></li>
<li><a id="L629">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">events_register_write_buffer</span>(<span class="Type">int</span> idx, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_name) {<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/runtime_events.h.html#L186" title="ocaml/runtime/caml/runtime_events.h:186">runtime_events_custom_event</a> *custom_event =<br/></li>
<li>&nbsp; &nbsp; &amp;((<span class="Type">struct</span> <a href="caml/runtime_events.h.html#L186" title="ocaml/runtime/caml/runtime_events.h:186">runtime_events_custom_event</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; ((<span class="Type">char</span> *)<a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a> + <a href="#L91" title="ocaml/runtime/runtime_events.c:91">current_metadata</a>-&gt;custom_events_offset))[idx];<br/></li>
<li><br/></li>
<li>&nbsp; strncpy(custom_event-&gt;name, <a href="caml/mlvalues.h.html#L329" title="ocaml/runtime/caml/mlvalues.h:329">String_val</a>(event_name),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/runtime_events.h.html#L184" title="ocaml/runtime/caml/runtime_events.h:184">RUNTIME_EVENTS_CUSTOM_EVENT_ID_LENGTH</a> - <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L638">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_runtime_events_user_register</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_name,<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_tag, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_type)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L284" title="ocaml/runtime/caml/memory.h:284">CAMLparam3</a>(event_name, event_tag, event_type);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L380" title="ocaml/runtime/caml/memory.h:380">CAMLlocal2</a>(list_item, event);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">int</span> index = <a href="caml/camlatomic.h.html#L75" title="ocaml/runtime/caml/camlatomic.h:75">atomic_fetch_add</a>(&amp;<a href="#L115" title="ocaml/runtime/runtime_events.c:115">runtime_custom_event_index</a>, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (index &gt; <a href="caml/runtime_events.h.html#L227" title="ocaml/runtime/caml/runtime_events.h:227">RUNTIME_EVENTS_MAX_CUSTOM_EVENTS</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Runtime_events.User.register: maximum number of custom events exceeded&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">int</span> length = <a href="str.c.html#L31" title="ocaml/runtime/str.c:31">caml_string_length</a>(event_name);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (length &gt; <a href="caml/runtime_events.h.html#L184" title="ocaml/runtime/caml/runtime_events.h:184">RUNTIME_EVENTS_CUSTOM_EVENT_ID_LENGTH</a> - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Runtime_events.User.register: maximum length for event name exceeded&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="str.c.html#L53" title="ocaml/runtime/str.c:53">caml_string_is_c_safe</a>(event_name)) {<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Runtime_events.User.register: event name has null characters&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// type 'a t = {<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; id: int;<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; name: string;<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; typ: 'a Type.t;<br/></li>
<li></span>&nbsp; <span class="Comment">//&nbsp; tag: tag;<br/></li>
<li></span>&nbsp; <span class="Comment">//}<br/></li>
<li></span>&nbsp; event = <a href="alloc.c.html#L158" title="ocaml/runtime/alloc.c:158">caml_alloc_small</a>(<span class="Constant">4</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">0</span>) = <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(index);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">1</span>) = event_name;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">2</span>) = event_type;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">3</span>) = event_tag;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li>&nbsp; <span class="Comment">// critical section: when we update the <a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a> list we need to make sure<br/></li>
<li></span>&nbsp; <span class="Comment">// it is not updated while we construct the pointer to the next element<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/platform.h.html#L54" title="ocaml/runtime/caml/platform.h:54">atomic_load_acquire</a>(&amp;<a href="#L112" title="ocaml/runtime/runtime_events.c:112">runtime_events_enabled</a>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Ring buffer is already available, we register the name<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L629" title="ocaml/runtime/runtime_events.c:629">events_register_write_buffer</a>(index, event_name);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// event is added to the list of known events<br/></li>
<li></span>&nbsp; list_item = <a href="alloc.c.html#L158" title="ocaml/runtime/alloc.c:158">caml_alloc_small</a>(<span class="Constant">2</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(list_item, <span class="Constant">0</span>) = event;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(list_item, <span class="Constant">1</span>) = <a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a>;<br/></li>
<li>&nbsp; <a href="globroots.c.html#L129" title="ocaml/runtime/globroots.c:129">caml_modify_generational_global_root</a>(&amp;<a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a>, list_item);<br/></li>
<li>&nbsp; <span class="Comment">// end critical section<br/></li>
<li></span>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(event);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L695">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_runtime_events_user_write</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_content)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a>(event, event_content);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L384" title="ocaml/runtime/caml/memory.h:384">CAMLlocal3</a>(event_id, event_type, res);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> ( !<a href="#L559" title="ocaml/runtime/runtime_events.c:559">ring_is_active</a>() )<br/></li>
<li>&nbsp; &nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* event type:<br/></li>
<li></span><span class="Comment">&nbsp; type 'a t = {<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; id: int;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; name: string;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; typ: 'a Type.t;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; tag: 'a tag option;<br/></li>
<li></span><span class="Comment">&nbsp; }<br/></li>
<li></span><span class="Comment">&nbsp; */<br/></li>
<li></span>&nbsp; event_id = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; event_type = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* event_type type:<br/></li>
<li></span><span class="Comment">&nbsp; type 'a t =<br/></li>
<li></span><span class="Comment">&nbsp; | Unit : unit t<br/></li>
<li></span><span class="Comment">&nbsp; | Int : int t<br/></li>
<li></span><span class="Comment">&nbsp; | Span : span t<br/></li>
<li></span><span class="Comment">&nbsp; | Custom : 'a custom -&gt; 'a t<br/></li>
<li></span><span class="Comment">&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">// Check if event is custom <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> not.<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(event_type)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Custom { serialize; deserialize; id }<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> record = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event_type, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> serializer = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(record, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L124" title="ocaml/runtime/runtime_events.c:124">write_buffer_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L123" title="ocaml/runtime/runtime_events.c:123">write_buffer</a> == <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L123" title="ocaml/runtime/runtime_events.c:123">write_buffer</a> = <a href="alloc.c.html#L177" title="ocaml/runtime/alloc.c:177">caml_alloc_string</a>(<a href="caml/runtime_events.h.html#L229" title="ocaml/runtime/caml/runtime_events.h:229">RUNTIME_EVENTS_MAX_MSG_LENGTH</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="globroots.c.html#L95" title="ocaml/runtime/globroots.c:95">caml_register_generational_global_root</a>(&amp;<a href="#L123" title="ocaml/runtime/runtime_events.c:123">write_buffer</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="callback.c.html#L141" title="ocaml/runtime/callback.c:141">caml_callback2_exn</a>(serializer, <a href="#L123" title="ocaml/runtime/runtime_events.c:123">write_buffer</a>, event_content);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L90" title="ocaml/runtime/caml/mlvalues.h:90">Is_exception_result</a>(res)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L124" title="ocaml/runtime/runtime_events.c:124">write_buffer_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; res = <a href="caml/mlvalues.h.html#L91" title="ocaml/runtime/caml/mlvalues.h:91">Extract_exception</a>(res);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L59" title="ocaml/runtime/fail_nat.c:59">caml_raise</a>(res);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> len_bytes = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(res);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> len_64bit_word = (len_bytes + <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>)) / <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> offset_index = len_64bit_word * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L330" title="ocaml/runtime/caml/mlvalues.h:330">Bytes_val</a>(<a href="#L123" title="ocaml/runtime/runtime_events.c:123">write_buffer</a>)[offset_index] = offset_index - len_bytes;<br/></li>
<li>&nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_USER, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.user=EV_USER_MSG_TYPE_CUSTOM},<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_id), len_64bit_word, (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> *) <a href="caml/mlvalues.h.html#L330" title="ocaml/runtime/caml/mlvalues.h:330">Bytes_val</a>(<a href="#L123" title="ocaml/runtime/runtime_events.c:123">write_buffer</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L124" title="ocaml/runtime/runtime_events.c:124">write_buffer_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Unit | Int | Span<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> event_type_id = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Unit<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (event_type_id == EV_USER_ML_TYPE_UNIT) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_USER, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.user=EV_USER_MSG_TYPE_UNIT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_id), <span class="Constant">0</span>, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Int<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (event_type_id == EV_USER_ML_TYPE_INT) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> c_event_content = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_content);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_USER, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.user=EV_USER_MSG_TYPE_INT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_id), <span class="Constant">1</span>, &amp;c_event_content, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// Span<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (event_type_id == EV_USER_ML_TYPE_SPAN) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">// event_content type is Begin | End<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="caml/runtime_events.h.html#L198" title="ocaml/runtime/caml/runtime_events.h:198">ev_user_message_type</a> message_type;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_content) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; message_type = EV_USER_MSG_TYPE_SPAN_BEGIN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; message_type = EV_USER_MSG_TYPE_SPAN_END;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L463" title="ocaml/runtime/runtime_events.c:463">write_to_ring</a>(EV_USER, (<a href="caml/runtime_events.h.html#L203" title="ocaml/runtime/caml/runtime_events.h:203">ev_message_type</a>)<span class="Error">{</span>.user=message_type},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(event_id), <span class="Constant">0</span>, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Find which event has the given name using the list of globally known events.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; If the event is not globally known but the type is one of the known types,<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; then it can be partially reconstructed, the only missing information being<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; the associated tag. This function returns an event structure, except when the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; event is unknown <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> the event type id is EV_USER_ML_TYPE_CUSTOM. */<br/></li>
<li><a id="L794">&#x200c;</a></span><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_runtime_events_user_resolve</span>(<br/></li>
<li>&nbsp; <span class="Type">char</span>* event_name, <a href="caml/runtime_events.h.html#L211" title="ocaml/runtime/caml/runtime_events.h:211">ev_user_ml_type</a> event_type_id)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L270" title="ocaml/runtime/caml/memory.h:270">CAMLparam0</a>();<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L384" title="ocaml/runtime/caml/memory.h:384">CAMLlocal3</a>(event, cur_event_name, ml_event_name);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// </span><span class="Todo">TODO</span><span class="Comment">: it might be possible to atomic load instead<br/></li>
<li></span>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> current_user_event = <a href="#L119" title="ocaml/runtime/runtime_events.c:119">user_events</a>;<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L120" title="ocaml/runtime/runtime_events.c:120">user_events_lock</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">// which try to find an event with the matching name<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<a href="caml/mlvalues.h.html#L443" title="ocaml/runtime/caml/mlvalues.h:443">Is_some</a> (current_user_event)) {<br/></li>
<li>&nbsp; &nbsp; event = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(current_user_event, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; cur_event_name = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(event, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strncmp(<a href="caml/mlvalues.h.html#L329" title="ocaml/runtime/caml/mlvalues.h:329">String_val</a>(cur_event_name), event_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/runtime_events.h.html#L184" title="ocaml/runtime/caml/runtime_events.h:184">RUNTIME_EVENTS_CUSTOM_EVENT_ID_LENGTH</a>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; current_user_event = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(current_user_event, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (event_type_id != EV_USER_ML_TYPE_CUSTOM) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">// the event is not known, but its type is known<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">// as we know the event type the event can be reconstructed<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> event_type = <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(event_type_id);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> event_name_len = strnlen(event_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/runtime_events.h.html#L184" title="ocaml/runtime/caml/runtime_events.h:184">RUNTIME_EVENTS_CUSTOM_EVENT_ID_LENGTH</a>);<br/></li>
<li>&nbsp; &nbsp; ml_event_name = <a href="alloc.c.html#L197" title="ocaml/runtime/alloc.c:197">caml_alloc_initialized_string</a>(event_name_len, event_name);<br/></li>
<li>&nbsp; &nbsp; event = <a href="#L638" title="ocaml/runtime/runtime_events.c:638">caml_runtime_events_user_register</a>(ml_event_name, <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(event);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L404" title="ocaml/runtime/caml/memory.h:404">CAMLdrop</a>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

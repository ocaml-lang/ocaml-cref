<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/bigarray.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/bigarray.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L50">caml_ba_element_size</a></li>
<li><a href="#L70">caml_ba_ops</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L90">caml_ba_alloc</a></li>
<li><a href="#L130">caml_ba_alloc_dims</a></li>
<li><a href="#L1072">caml_ba_blit</a></li>
<li><a href="#L62">caml_ba_byte_size</a></li>
<li><a href="#L995">caml_ba_change_layout</a></li>
<li><a href="#L174">caml_ba_compare</a></li>
<li><a href="#L505">caml_ba_create</a></li>
<li><a href="#L442">caml_ba_deserialize</a></li>
<li><a href="#L423">caml_ba_deserialize_longarray</a></li>
<li><a href="#L881">caml_ba_dim</a></li>
<li><a href="#L889">caml_ba_dim_1</a></li>
<li><a href="#L894">caml_ba_dim_2</a></li>
<li><a href="#L899">caml_ba_dim_3</a></li>
<li><a href="#L1124">caml_ba_fill</a></li>
<li><a href="#L147">caml_ba_finalize</a></li>
<li><a href="#L613">caml_ba_get_1</a></li>
<li><a href="#L618">caml_ba_get_2</a></li>
<li><a href="#L625">caml_ba_get_3</a></li>
<li><a href="#L564">caml_ba_get_N</a></li>
<li><a href="#L632">caml_ba_get_generic</a></li>
<li><a href="#L257">caml_ba_hash</a></li>
<li><a href="#L906">caml_ba_kind</a></li>
<li><a href="#L913">caml_ba_layout</a></li>
<li><a href="#L873">caml_ba_num_dims</a></li>
<li><a href="#L39">caml_ba_num_elts</a></li>
<li><a href="#L528">caml_ba_offset</a></li>
<li><a href="#L1206">caml_ba_reshape</a></li>
<li><a href="#L367">caml_ba_serialize</a></li>
<li><a href="#L343">caml_ba_serialize_longarray</a></li>
<li><a href="#L757">caml_ba_set_1</a></li>
<li><a href="#L762">caml_ba_set_2</a></li>
<li><a href="#L769">caml_ba_set_3</a></li>
<li><a href="#L777">caml_ba_set_N</a></li>
<li><a href="#L705">caml_ba_set_aux</a></li>
<li><a href="#L782">caml_ba_set_generic</a></li>
<li><a href="#L948">caml_ba_slice</a></li>
<li><a href="#L1024">caml_ba_sub</a></li>
<li><a href="#L638">caml_ba_uint8_get16</a></li>
<li><a href="#L655">caml_ba_uint8_get32</a></li>
<li><a href="#L674">caml_ba_uint8_get64</a></li>
<li><a href="#L787">caml_ba_uint8_set16</a></li>
<li><a href="#L807">caml_ba_uint8_set32</a></li>
<li><a href="#L833">caml_ba_uint8_set64</a></li>
<li><a href="#L921">caml_ba_update_proxy</a></li>
<li><a href="#L554">copy_two_doubles</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L16">CAML_INTERNALS</a></li>
<li><a href="#L206">DO_FLOAT_COMPARISON</a></li>
<li><a href="#L252">DO_FLOAT_COMPARISON</a></li>
<li><a href="#L197">DO_INTEGER_COMPARISON</a></li>
<li><a href="#L251">DO_INTEGER_COMPARISON</a></li>
<li><a href="#L1120">FILL_COMPLEX_LOOP</a></li>
<li><a href="#L1109">FILL_GEN_LOOP</a></li>
<li><a href="#L1116">FILL_SCALAR_LOOP</a></li>
<li><a href="#L1069">LEAVE_RUNTIME_OP_CUTOFF</a></li>
<li><a href="#L951">b</a></li>
<li><a href="#L990">b</a></li>
<li><a href="#L999">b</a></li>
<li><a href="#L1018">b</a></li>
<li><a href="#L1028">b</a></li>
<li><a href="#L1064">b</a></li>
<li><a href="#L1210">b</a></li>
<li><a href="#L1239">b</a></li>
<li><a href="#L34">int16</a></li>
<li><a href="#L32">int8</a></li>
<li><a href="#L1070">is_mmapped</a></li>
<li><a href="#L35">uint16</a></li>
<li><a href="#L33">uint8</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Manuel Serrano <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> Xavier Leroy, INRIA Rocquencourt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 2000 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L16">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stddef.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdarg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/alloc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/bigarray.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/custom.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/intext.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/hash.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/signals.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/atomic_refcount.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L32">&#x200c;</a><span class="PreProc">#define <span class="linkable">int8</span> <a href="caml/bigarray.h.html#L22" title="ocaml/runtime/caml/bigarray.h:22">caml_ba_int8</a><br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">uint8</span> <a href="caml/bigarray.h.html#L23" title="ocaml/runtime/caml/bigarray.h:23">caml_ba_uint8</a><br/></li>
<li><a id="L34">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">int16</span> <a href="caml/bigarray.h.html#L25" title="ocaml/runtime/caml/bigarray.h:25">caml_ba_int16</a><br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">uint16</span> <a href="caml/bigarray.h.html#L26" title="ocaml/runtime/caml/bigarray.h:26">caml_ba_uint16</a><br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Compute the number of elements of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L39">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_ba_num_elts</span>(<span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> num_elts;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; num_elts = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) num_elts = num_elts * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i];<br/></li>
<li>&nbsp; <span class="Statement">return</span> num_elts;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Size in bytes of a bigarray element, indexed by bigarray kind */<br/></li>
<li></span><br/></li>
<li><a id="L50">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">int</span> <span class="linkable">caml_ba_element_size</span>[] =<br/></li>
<li>{ <span class="Constant">4</span> <span class="Comment">/*FLOAT32*/</span>, <span class="Constant">8</span> <span class="Comment">/*FLOAT64*/</span>,<br/></li>
<li>&nbsp; <span class="Constant">1</span> <span class="Comment">/*SINT8*/</span>, <span class="Constant">1</span> <span class="Comment">/*UINT8*/</span>,<br/></li>
<li>&nbsp; <span class="Constant">2</span> <span class="Comment">/*SINT16*/</span>, <span class="Constant">2</span> <span class="Comment">/*UINT16*/</span>,<br/></li>
<li>&nbsp; <span class="Constant">4</span> <span class="Comment">/*INT32*/</span>, <span class="Constant">8</span> <span class="Comment">/*INT64*/</span>,<br/></li>
<li>&nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) <span class="Comment">/*CAML_INT*/</span>, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) <span class="Comment">/*NATIVE_INT*/</span>,<br/></li>
<li>&nbsp; <span class="Constant">8</span> <span class="Comment">/*COMPLEX32*/</span>, <span class="Constant">16</span> <span class="Comment">/*COMPLEX64*/</span>,<br/></li>
<li>&nbsp; <span class="Constant">1</span> <span class="Comment">/*CHAR*/<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* Compute the number of bytes for the elements of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L62">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_ba_byte_size</span>(<span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L39" title="ocaml/runtime/bigarray.c:39">caml_ba_num_elts</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="#L50" title="ocaml/runtime/bigarray.c:50">caml_ba_element_size</a>[<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK];<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Operation table for bigarrays */<br/></li>
<li></span><br/></li>
<li><a id="L70">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">const</span> <span class="Type">struct</span> <a href="caml/custom.h.html#L27" title="ocaml/runtime/caml/custom.h:27">custom_operations</a> <span class="linkable">caml_ba_ops</span> = {<br/></li>
<li>&nbsp; <span class="Constant">&quot;_bigarr02&quot;</span>,<br/></li>
<li>&nbsp; <a href="#L147" title="ocaml/runtime/bigarray.c:147">caml_ba_finalize</a>,<br/></li>
<li>&nbsp; <a href="#L174" title="ocaml/runtime/bigarray.c:174">caml_ba_compare</a>,<br/></li>
<li>&nbsp; <a href="#L257" title="ocaml/runtime/bigarray.c:257">caml_ba_hash</a>,<br/></li>
<li>&nbsp; <a href="#L367" title="ocaml/runtime/bigarray.c:367">caml_ba_serialize</a>,<br/></li>
<li>&nbsp; <a href="#L442" title="ocaml/runtime/bigarray.c:442">caml_ba_deserialize</a>,<br/></li>
<li>&nbsp; <a href="caml/custom.h.html#L45" title="ocaml/runtime/caml/custom.h:45">custom_compare_ext_default</a>,<br/></li>
<li>&nbsp; <a href="caml/custom.h.html#L46" title="ocaml/runtime/caml/custom.h:46">custom_fixed_length_default</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocation of a big array */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* [<a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>] will allocate a new bigarray object in the heap.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; If [data] is <a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a>, the memory for the contents is also allocated<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; (with [malloc]) by [<a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>].<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; [data] cannot point into the OCaml heap.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; [dim] may point into an object in the OCaml heap.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a><br/></li>
<li><a id="L90">&#x200c;</a><span class="linkable">caml_ba_alloc</span>(<span class="Type">int</span> flags, <span class="Type">int</span> num_dims, <span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * dim)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> num_elts, asize, size;<br/></li>
<li>&nbsp; <span class="Type">int</span> i, is_managed;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> dimcopy[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(num_dims &gt;= <span class="Constant">0</span> &amp;&amp; num_dims &lt;= <a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>((flags &amp; CAML_BA_KIND_MASK) &lt;= CAML_BA_CHAR);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_dims; i++) dimcopy[i] = dim[i];<br/></li>
<li>&nbsp; num_elts = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/misc.h.html#L347" title="ocaml/runtime/caml/misc.h:347">caml_umul_overflow</a>(num_elts, dimcopy[i], &amp;num_elts))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/misc.h.html#L347" title="ocaml/runtime/caml/misc.h:347">caml_umul_overflow</a>(num_elts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L50" title="ocaml/runtime/bigarray.c:50">caml_ba_element_size</a>[flags &amp; CAML_BA_KIND_MASK],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;size))<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (data == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; data = malloc(size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> &amp;&amp; size != <span class="Constant">0</span>) <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; &nbsp; flags |= CAML_BA_MANAGED;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; asize = <a href="caml/bigarray.h.html#L96" title="ocaml/runtime/caml/bigarray.h:96">SIZEOF_BA_ARRAY</a> + num_dims * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>);<br/></li>
<li>&nbsp; is_managed = ((flags &amp; CAML_BA_MANAGED_MASK) == CAML_BA_MANAGED);<br/></li>
<li>&nbsp; res = <a href="custom.c.html#L90" title="ocaml/runtime/custom.c:90">caml_alloc_custom_mem</a>(&amp;<a href="#L70" title="ocaml/runtime/bigarray.c:70">caml_ba_ops</a>, asize, is_managed ? size : <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(res);<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data = data;<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims = num_dims;<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags = flags;<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;proxy = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_dims; i++) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i] = dimcopy[i];<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Same as <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>, but dimensions are passed as a list of<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; arguments */<br/></li>
<li></span><br/></li>
<li><a id="L130">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_alloc_dims</span>(<span class="Type">int</span> flags, <span class="Type">int</span> num_dims, <span class="Type">void</span> * data, ...)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">va_list</span> ap;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> dim[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(num_dims &lt;= <a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>);<br/></li>
<li>&nbsp; va_start(ap, data);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_dims; i++) dim[i] = va_arg(ap, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>);<br/></li>
<li>&nbsp; va_end(ap);<br/></li>
<li>&nbsp; res = <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>(flags, num_dims, data, dim);<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Finalization of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L147">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_ba_finalize</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(v);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_MANAGED_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_EXTERNAL:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_MANAGED:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;proxy == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; free(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/atomic_refcount.h.html#L27" title="ocaml/runtime/caml/atomic_refcount.h:27">caml_atomic_refcount_decr</a>(&amp;<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;proxy-&gt;refcount) == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; free(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;proxy-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; free(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;proxy);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_MAPPED_FILE:<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Bigarrays for mapped files use a different finalization method */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* fallthrough */<br/></li>
<li></span>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Comparison of two big arrays */<br/></li>
<li></span><br/></li>
<li><a id="L174">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">int</span> <span class="linkable">caml_ba_compare</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v1, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v2)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * b1 = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(v1);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * b2 = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(v2);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> n, num_elts;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> flags1, flags2;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Compare kind &amp; layout in case the arguments are of different types */<br/></li>
<li></span>&nbsp; flags1 = b1-&gt;flags &amp; (CAML_BA_KIND_MASK | CAML_BA_LAYOUT_MASK);<br/></li>
<li>&nbsp; flags2 = b2-&gt;flags &amp; (CAML_BA_KIND_MASK | CAML_BA_LAYOUT_MASK);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (flags1 != flags2) <span class="Statement">return</span> flags2 - flags1;<br/></li>
<li>&nbsp; <span class="Comment">/* Compare number of dimensions */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (b1-&gt;num_dims != b2-&gt;num_dims) <span class="Statement">return</span> b2-&gt;num_dims - b1-&gt;num_dims;<br/></li>
<li>&nbsp; <span class="Comment">/* Same number of dimensions: compare dimensions lexicographically */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; b1-&gt;num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> d1 = b1-&gt;dim[i];<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> d2 = b2-&gt;dim[i];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (d1 != d2) <span class="Statement">return</span> d1 &lt; d2 ? -<span class="Constant">1</span> : <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Same dimensions: compare contents lexicographically */<br/></li>
<li></span>&nbsp; num_elts = <a href="#L39" title="ocaml/runtime/bigarray.c:39">caml_ba_num_elts</a>(b1);<br/></li>
<li><br/></li>
<li><a id="L197">&#x200c;</a><span class="PreProc">#define <span class="linkable">DO_INTEGER_COMPARISON</span>(type) \<br/></li>
<li></span><span class="PreProc">&nbsp; { type * p1 = b1-&gt;data; type * p2 = b2-&gt;data; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">for</span><span class="PreProc"> (n = </span><span class="Constant">0</span><span class="PreProc">; n &lt; num_elts; n++) { \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; type e1 = *p1++; type e2 = *p2++; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e1 &lt; e2) </span><span class="Statement">return</span><span class="PreProc"> -</span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e1 &gt; e2) </span><span class="Statement">return</span><span class="PreProc"> </span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; } \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">return</span><span class="PreProc"> </span><span class="Constant">0</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; }<br/></li>
<li><a id="L206">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">DO_FLOAT_COMPARISON</span>(type) \<br/></li>
<li></span><span class="PreProc">&nbsp; { type * p1 = b1-&gt;data; type * p2 = b2-&gt;data; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">for</span><span class="PreProc"> (n = </span><span class="Constant">0</span><span class="PreProc">; n &lt; num_elts; n++) { \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; type e1 = *p1++; type e2 = *p2++; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e1 &lt; e2) </span><span class="Statement">return</span><span class="PreProc"> -</span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e1 &gt; e2) </span><span class="Statement">return</span><span class="PreProc"> </span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e1 != e2) { \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;compare_unordered = </span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e1 == e1) </span><span class="Statement">return</span><span class="PreProc"> </span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (e2 == e2) </span><span class="Statement">return</span><span class="PreProc"> -</span><span class="Constant">1</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; } \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; } \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">return</span><span class="PreProc"> </span><span class="Constant">0</span><span class="PreProc">; \<br/></li>
<li></span><span class="PreProc">&nbsp; }<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Statement">switch</span> (b1-&gt;flags &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32:<br/></li>
<li>&nbsp; &nbsp; num_elts *= <span class="Constant">2</span>; <span class="Comment">/*fallthrough*/<br/></li>
<li></span>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32:<br/></li>
<li>&nbsp; &nbsp; <a href="#L206" title="ocaml/runtime/bigarray.c:206">DO_FLOAT_COMPARISON</a>(<span class="Type">float</span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64:<br/></li>
<li>&nbsp; &nbsp; num_elts *= <span class="Constant">2</span>; <span class="Comment">/*fallthrough*/<br/></li>
<li></span>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64:<br/></li>
<li>&nbsp; &nbsp; <a href="#L206" title="ocaml/runtime/bigarray.c:206">DO_FLOAT_COMPARISON</a>(<span class="Type">double</span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<a href="caml/bigarray.h.html#L23" title="ocaml/runtime/caml/bigarray.h:23">caml_ba_uint8</a>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<a href="caml/bigarray.h.html#L22" title="ocaml/runtime/caml/bigarray.h:22">caml_ba_int8</a>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<a href="caml/bigarray.h.html#L23" title="ocaml/runtime/caml/bigarray.h:23">caml_ba_uint8</a>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<a href="caml/bigarray.h.html#L25" title="ocaml/runtime/caml/bigarray.h:25">caml_ba_int16</a>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<a href="caml/bigarray.h.html#L26" title="ocaml/runtime/caml/bigarray.h:26">caml_ba_uint16</a>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT:<br/></li>
<li>&nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/bigarray.c:197">DO_INTEGER_COMPARISON</a>(<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>);<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* should not happen */<br/></li>
<li></span>&nbsp; }<br/></li>
<li><a id="L251">&#x200c;</a><span class="PreProc">#undef <span class="linkable">DO_INTEGER_COMPARISON</span><br/></li>
<li><a id="L252">&#x200c;</a></span><span class="PreProc">#undef <span class="linkable">DO_FLOAT_COMPARISON</span><br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Hashing of a bigarray */<br/></li>
<li></span><br/></li>
<li><a id="L257">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">caml_ba_hash</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(v);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> num_elts, n;<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> h, w;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; num_elts = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) num_elts = num_elts * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i];<br/></li>
<li>&nbsp; h = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8: {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/bigarray.h.html#L23" title="ocaml/runtime/caml/bigarray.h:23">caml_ba_uint8</a> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">256</span>) num_elts = <span class="Constant">256</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n + <span class="Constant">4</span> &lt;= num_elts; n += <span class="Constant">4</span>, p += <span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; w = p[<span class="Constant">0</span>] | (p[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">8</span>) | (p[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">16</span>) | (p[<span class="Constant">3</span>] &lt;&lt; <span class="Constant">24</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; h = <a href="hash.c.html#L48" title="ocaml/runtime/hash.c:48">caml_hash_mix_uint32</a>(h, w);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; w = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (num_elts &amp; <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">3</span>: w&nbsp; = p[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">16</span>;&nbsp; &nbsp; <span class="Comment">/* fallthrough */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">2</span>: w |= p[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">8</span>;&nbsp; &nbsp;&nbsp; <span class="Comment">/* fallthrough */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">1</span>: w |= p[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = <a href="hash.c.html#L48" title="ocaml/runtime/hash.c:48">caml_hash_mix_uint32</a>(h, w);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16: {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/bigarray.h.html#L26" title="ocaml/runtime/caml/bigarray.h:26">caml_ba_uint16</a> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">128</span>) num_elts = <span class="Constant">128</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n + <span class="Constant">2</span> &lt;= num_elts; n += <span class="Constant">2</span>, p += <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; w = p[<span class="Constant">0</span>] | (p[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; h = <a href="hash.c.html#L48" title="ocaml/runtime/hash.c:48">caml_hash_mix_uint32</a>(h, w);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((num_elts &amp; <span class="Constant">1</span>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; h = <a href="hash.c.html#L48" title="ocaml/runtime/hash.c:48">caml_hash_mix_uint32</a>(h, p[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32:<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">64</span>) num_elts = <span class="Constant">64</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; num_elts; n++, p++) h = <a href="hash.c.html#L48" title="ocaml/runtime/hash.c:48">caml_hash_mix_uint32</a>(h, *p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT:<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">64</span>) num_elts = <span class="Constant">64</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; num_elts; n++, p++) h = <a href="hash.c.html#L56" title="ocaml/runtime/hash.c:56">caml_hash_mix_intnat</a>(h, *p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64:<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">32</span>) num_elts = <span class="Constant">32</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; num_elts; n++, p++) h = <a href="hash.c.html#L76" title="ocaml/runtime/hash.c:76">caml_hash_mix_int64</a>(h, *p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32:<br/></li>
<li>&nbsp; &nbsp; num_elts *= <span class="Constant">2</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fallthrough */<br/></li>
<li></span>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32:<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">64</span>) num_elts = <span class="Constant">64</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; num_elts; n++, p++) h = <a href="hash.c.html#L122" title="ocaml/runtime/hash.c:122">caml_hash_mix_float</a>(h, *p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64:<br/></li>
<li>&nbsp; &nbsp; num_elts *= <span class="Constant">2</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fallthrough */<br/></li>
<li></span>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64:<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> * p = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (num_elts &gt; <span class="Constant">32</span>) num_elts = <span class="Constant">32</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; num_elts; n++, p++) h = <a href="hash.c.html#L89" title="ocaml/runtime/hash.c:89">caml_hash_mix_double</a>(h, *p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> h;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L343">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">caml_ba_serialize_longarray</span>(<span class="Type">void</span> * data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> num_elts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> min_val, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> max_val)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; <span class="Type">int</span> overflow_32 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * p, n;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>, p = data; n &lt; num_elts; n++, p++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*p &lt; min_val || *p &gt; max_val) { overflow_32 = <span class="Constant">1</span>; <span class="Statement">break</span>; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (overflow_32) {<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1204" title="ocaml/runtime/extern.c:1204">caml_serialize_int_1</a>(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1292" title="ocaml/runtime/extern.c:1292">caml_serialize_block_8</a>(data, num_elts);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1204" title="ocaml/runtime/extern.c:1204">caml_serialize_int_1</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>, p = data; n &lt; num_elts; n++, p++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="extern.c.html#L1220" title="ocaml/runtime/extern.c:1220">caml_serialize_int_4</a>((<span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span>) *p);<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <a href="extern.c.html#L1204" title="ocaml/runtime/extern.c:1204">caml_serialize_int_1</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="extern.c.html#L1273" title="ocaml/runtime/extern.c:1273">caml_serialize_block_4</a>(data, num_elts);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L367">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_ba_serialize</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * wsize_32,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * wsize_64)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(v);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> num_elts;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Serialize header information */<br/></li>
<li></span>&nbsp; <a href="extern.c.html#L1220" title="ocaml/runtime/extern.c:1220">caml_serialize_int_4</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims);<br/></li>
<li>&nbsp; <a href="extern.c.html#L1220" title="ocaml/runtime/extern.c:1220">caml_serialize_int_4</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; (CAML_BA_KIND_MASK | CAML_BA_LAYOUT_MASK));<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt; <span class="Constant">0xffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="extern.c.html#L1212" title="ocaml/runtime/extern.c:1212">caml_serialize_int_2</a>(len);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="extern.c.html#L1212" title="ocaml/runtime/extern.c:1212">caml_serialize_int_2</a>(<span class="Constant">0xffff</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="extern.c.html#L1228" title="ocaml/runtime/extern.c:1228">caml_serialize_int_8</a>(len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Compute total number of elements */<br/></li>
<li></span>&nbsp; num_elts = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) num_elts = num_elts * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i];<br/></li>
<li>&nbsp; <span class="Comment">/* Serialize elements */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8:<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1246" title="ocaml/runtime/extern.c:1246">caml_serialize_block_1</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16:<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1254" title="ocaml/runtime/extern.c:1254">caml_serialize_block_2</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32:<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1273" title="ocaml/runtime/extern.c:1273">caml_serialize_block_4</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32:<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1273" title="ocaml/runtime/extern.c:1273">caml_serialize_block_4</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts * <span class="Constant">2</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64:<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1292" title="ocaml/runtime/extern.c:1292">caml_serialize_block_8</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64:<br/></li>
<li>&nbsp; &nbsp; <a href="extern.c.html#L1292" title="ocaml/runtime/extern.c:1292">caml_serialize_block_8</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts * <span class="Constant">2</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT:<br/></li>
<li>&nbsp; &nbsp; <a href="#L343" title="ocaml/runtime/bigarray.c:343">caml_ba_serialize_longarray</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts, -<span class="Constant">0x40000000</span>, <span class="Constant">0x3FFFFFFF</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT:<br/></li>
<li>&nbsp; &nbsp; <a href="#L343" title="ocaml/runtime/bigarray.c:343">caml_ba_serialize_longarray</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts, -<span class="Constant">0x80000000</span>, <span class="Constant">0x7FFFFFFF</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Compute required size in OCaml heap.&nbsp; Assumes struct <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; is exactly 4 + num_dims words */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/bigarray.h.html#L96" title="ocaml/runtime/caml/bigarray.h:96">SIZEOF_BA_ARRAY</a> == <span class="Constant">4</span> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>));<br/></li>
<li>&nbsp; *wsize_32 = (<span class="Constant">4</span> + <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims) * <span class="Constant">4</span>;<br/></li>
<li>&nbsp; *wsize_64 = (<span class="Constant">4</span> + <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims) * <span class="Constant">8</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L423">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">caml_ba_deserialize_longarray</span>(<span class="Type">void</span> * dest, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> num_elts)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">int</span> sixty = <a href="intern.c.html#L1041" title="ocaml/runtime/intern.c:1041">caml_deserialize_uint_1</a>();<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (sixty) {<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1140" title="ocaml/runtime/intern.c:1140">caml_deserialize_block_8</a>(dest, num_elts);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * p, n;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>, p = dest; n &lt; num_elts; n++, p++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; *p = <a href="intern.c.html#L1071" title="ocaml/runtime/intern.c:1071">caml_deserialize_sint_4</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (sixty)<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1173" title="ocaml/runtime/intern.c:1173">caml_deserialize_error</a>(<span class="Constant">&quot;input_value: cannot read bigarray &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with 64-bit OCaml ints&quot;</span>);<br/></li>
<li>&nbsp; <a href="intern.c.html#L1126" title="ocaml/runtime/intern.c:1126">caml_deserialize_block_4</a>(dest, num_elts);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L442">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_ba_deserialize</span>(<span class="Type">void</span> * dst)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = dst;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> num_elts, size;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Read back header information */<br/></li>
<li></span>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims = <a href="intern.c.html#L1065" title="ocaml/runtime/intern.c:1065">caml_deserialize_uint_4</a>();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims &lt; <span class="Constant">0</span> || <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims &gt; <a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1173" title="ocaml/runtime/intern.c:1173">caml_deserialize_error</a>(<span class="Constant">&quot;input_value: wrong number of bigarray dimensions&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags = <a href="intern.c.html#L1065" title="ocaml/runtime/intern.c:1065">caml_deserialize_uint_4</a>() | CAML_BA_MANAGED;<br/></li>
<li>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;proxy = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len = <a href="intern.c.html#L1053" title="ocaml/runtime/intern.c:1053">caml_deserialize_uint_2</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0xffff</span>) len = <a href="intern.c.html#L1077" title="ocaml/runtime/intern.c:1077">caml_deserialize_uint_8</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i] = len;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Compute total number of elements.&nbsp; Watch out for overflows (MPR#7765). */<br/></li>
<li></span>&nbsp; num_elts = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/misc.h.html#L347" title="ocaml/runtime/caml/misc.h:347">caml_umul_overflow</a>(num_elts, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i], &amp;num_elts))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="intern.c.html#L1173" title="ocaml/runtime/intern.c:1173">caml_deserialize_error</a>(<span class="Constant">&quot;input_value: size overflow for bigarray&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Determine array size in bytes.&nbsp; Watch out for overflows (MPR#7765). */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK) &gt; CAML_BA_CHAR)<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1173" title="ocaml/runtime/intern.c:1173">caml_deserialize_error</a>(<span class="Constant">&quot;input_value: bad bigarray kind&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/misc.h.html#L347" title="ocaml/runtime/caml/misc.h:347">caml_umul_overflow</a>(num_elts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L50" title="ocaml/runtime/bigarray.c:50">caml_ba_element_size</a>[<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;size))<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1173" title="ocaml/runtime/intern.c:1173">caml_deserialize_error</a>(<span class="Constant">&quot;input_value: size overflow for bigarray&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Allocate room for data */<br/></li>
<li></span>&nbsp; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data = malloc(size);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1173" title="ocaml/runtime/intern.c:1173">caml_deserialize_error</a>(<span class="Constant">&quot;input_value: out of memory for bigarray&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Read data */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8:<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1105" title="ocaml/runtime/intern.c:1105">caml_deserialize_block_1</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16:<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1112" title="ocaml/runtime/intern.c:1112">caml_deserialize_block_2</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32:<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1126" title="ocaml/runtime/intern.c:1126">caml_deserialize_block_4</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32:<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1126" title="ocaml/runtime/intern.c:1126">caml_deserialize_block_4</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts * <span class="Constant">2</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64:<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1140" title="ocaml/runtime/intern.c:1140">caml_deserialize_block_8</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64:<br/></li>
<li>&nbsp; &nbsp; <a href="intern.c.html#L1140" title="ocaml/runtime/intern.c:1140">caml_deserialize_block_8</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts * <span class="Constant">2</span>); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT:<br/></li>
<li>&nbsp; &nbsp; <a href="#L423" title="ocaml/runtime/bigarray.c:423">caml_ba_deserialize_longarray</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, num_elts); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* PR#5516: use C99's flexible array types if possible */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="caml/bigarray.h.html#L96" title="ocaml/runtime/caml/bigarray.h:96">SIZEOF_BA_ARRAY</a> + <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocate a bigarray from OCaml */<br/></li>
<li></span><br/></li>
<li><a id="L505">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_create</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vkind, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vlayout, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vdim)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> dim[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> num_dims;<br/></li>
<li>&nbsp; <span class="Type">int</span> i, flags;<br/></li>
<li><br/></li>
<li>&nbsp; num_dims = <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(vdim);<br/></li>
<li>&nbsp; <span class="Comment">/* here num_dims is unsigned (<a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a>) so no need to check (num_dims &gt;= 0) */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (num_dims &gt; <a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.create: bad number of dimensions&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; dim[i] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(vdim, i));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dim[i] &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.create: negative dimension&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; flags = <a href="caml/bigarray.h.html#L53" title="ocaml/runtime/caml/bigarray.h:53">Caml_ba_kind_val</a>(vkind) | <a href="caml/bigarray.h.html#L64" title="ocaml/runtime/caml/bigarray.h:64">Caml_ba_layout_val</a>(vlayout);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>(flags, num_dims, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>, dim);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Given a big array <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> a vector of indices, check that the indices<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; are within the bounds <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> return the offset of the corresponding<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; array element in the data part of the array. */<br/></li>
<li></span><br/></li>
<li><a id="L528">&#x200c;</a><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">caml_ba_offset</span>(<span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * index)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> offset;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> ((<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_LAYOUT_MASK) == CAML_BA_C_LAYOUT) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* C-style layout: row major, indices start at 0 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) index[i] &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; offset = offset * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i] + index[i];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fortran-style layout: column major, indices start at 1 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - <span class="Constant">1</span>; i &gt;= <span class="Constant">0</span>; i--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (index[i] - <span class="Constant">1</span>) &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; offset = offset * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i] + (index[i] - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> offset;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Helper function to allocate a record of two double floats */<br/></li>
<li></span><br/></li>
<li><a id="L554">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">copy_two_doubles</span>(<span class="Type">double</span> d0, <span class="Type">double</span> d1)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res = <a href="alloc.c.html#L158" title="ocaml/runtime/alloc.c:158">caml_alloc_small</a>(<span class="Constant">2</span> * <a href="caml/mlvalues.h.html#L337" title="ocaml/runtime/caml/mlvalues.h:337">Double_wosize</a>, <a href="caml/mlvalues.h.html#L349" title="ocaml/runtime/caml/mlvalues.h:349">Double_array_tag</a>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L354" title="ocaml/runtime/caml/mlvalues.h:354">Store_double_flat_field</a>(res, <span class="Constant">0</span>, d0);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L354" title="ocaml/runtime/caml/mlvalues.h:354">Store_double_flat_field</a>(res, <span class="Constant">1</span>, d1);<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Generic code to read from a big array */<br/></li>
<li></span><br/></li>
<li><a id="L564">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_get_N</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * vind, <span class="Type">int</span> nind)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> index[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> offset;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Check number of indices = number of dimensions of array<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; (maybe not necessary if ML typing guarantees this) */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (nind != <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.get: wrong number of indices&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Compute offset <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> check bounds */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) index[i] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind[i]);<br/></li>
<li>&nbsp; offset = <a href="#L528" title="ocaml/runtime/bigarray.c:528">caml_ba_offset</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, index);<br/></li>
<li>&nbsp; <span class="Comment">/* Perform read */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span> ((<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags) &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="floats.c.html#L152" title="ocaml/runtime/floats.c:152">caml_copy_double</a>((<span class="Type">double</span>) ((<span class="Type">float</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="floats.c.html#L152" title="ocaml/runtime/floats.c:152">caml_copy_double</a>(((<span class="Type">double</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(((<a href="#L32" title="ocaml/runtime/bigarray.c:32">int8</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(((<a href="#L33" title="ocaml/runtime/bigarray.c:33">uint8</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(((<a href="#L34" title="ocaml/runtime/bigarray.c:34">int16</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(((<a href="#L35" title="ocaml/runtime/bigarray.c:35">uint16</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ints.c.html#L228" title="ocaml/runtime/ints.c:228">caml_copy_int32</a>(((<span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ints.c.html#L427" title="ocaml/runtime/ints.c:427">caml_copy_int64</a>(((<span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ints.c.html#L724" title="ocaml/runtime/ints.c:724">caml_copy_nativeint</a>(((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32:<br/></li>
<li>&nbsp; &nbsp; { <span class="Type">float</span> * p = ((<span class="Type">float</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data) + offset * <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L554" title="ocaml/runtime/bigarray.c:554">copy_two_doubles</a>((<span class="Type">double</span>) p[<span class="Constant">0</span>], (<span class="Type">double</span>) p[<span class="Constant">1</span>]); }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64:<br/></li>
<li>&nbsp; &nbsp; { <span class="Type">double</span> * p = ((<span class="Type">double</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data) + offset * <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L554" title="ocaml/runtime/bigarray.c:554">copy_two_doubles</a>(p[<span class="Constant">0</span>], p[<span class="Constant">1</span>]); }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(((<span class="Type">unsigned</span> <span class="Type">char</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset]);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L613">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_get_1</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind1)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L564" title="ocaml/runtime/bigarray.c:564">caml_ba_get_N</a>(vb, &amp;vind1, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L618">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_get_2</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind1, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind2)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; vind[<span class="Constant">0</span>] = vind1; vind[<span class="Constant">1</span>] = vind2;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L564" title="ocaml/runtime/bigarray.c:564">caml_ba_get_N</a>(vb, vind, <span class="Constant">2</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L625">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_get_3</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind1, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind2, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind3)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; vind[<span class="Constant">0</span>] = vind1; vind[<span class="Constant">1</span>] = vind2; vind[<span class="Constant">2</span>] = vind3;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L564" title="ocaml/runtime/bigarray.c:564">caml_ba_get_N</a>(vb, vind, <span class="Constant">3</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L632">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_get_generic</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L564" title="ocaml/runtime/bigarray.c:564">caml_ba_get_N</a>(vb, &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(vind, <span class="Constant">0</span>), <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(vind));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L638">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_uint8_get16</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> res;<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> b1, b2;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> idx = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">0</span> || idx &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<span class="Constant">0</span>] - <span class="Constant">1</span>) <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; b1 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx];<br/></li>
<li>&nbsp; b2 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">1</span>];<br/></li>
<li><span class="PreProc">#ifdef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; res = b1 &lt;&lt; <span class="Constant">8</span> | b2;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; res = b2 &lt;&lt; <span class="Constant">8</span> | b1;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L655">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_uint8_get32</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> res;<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> b1, b2, b3, b4;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> idx = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">0</span> || idx &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<span class="Constant">0</span>] - <span class="Constant">3</span>) <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; b1 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx];<br/></li>
<li>&nbsp; b2 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">1</span>];<br/></li>
<li>&nbsp; b3 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">2</span>];<br/></li>
<li>&nbsp; b4 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">3</span>];<br/></li>
<li><span class="PreProc">#ifdef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; res = b1 &lt;&lt; <span class="Constant">24</span> | b2 &lt;&lt; <span class="Constant">16</span> | b3 &lt;&lt; <span class="Constant">8</span> | b4;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; res = b4 &lt;&lt; <span class="Constant">24</span> | b3 &lt;&lt; <span class="Constant">16</span> | b2 &lt;&lt; <span class="Constant">8</span> | b1;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="ints.c.html#L228" title="ocaml/runtime/ints.c:228">caml_copy_int32</a>(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L674">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_uint8_get64</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> res;<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> b1, b2, b3, b4, b5, b6, b7, b8;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> idx = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">0</span> || idx &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<span class="Constant">0</span>] - <span class="Constant">7</span>) <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; b1 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx];<br/></li>
<li>&nbsp; b2 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">1</span>];<br/></li>
<li>&nbsp; b3 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">2</span>];<br/></li>
<li>&nbsp; b4 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">3</span>];<br/></li>
<li>&nbsp; b5 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">4</span>];<br/></li>
<li>&nbsp; b6 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">5</span>];<br/></li>
<li>&nbsp; b7 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">6</span>];<br/></li>
<li>&nbsp; b8 = ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">7</span>];<br/></li>
<li><span class="PreProc">#ifdef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; res = (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b1 &lt;&lt; <span class="Constant">56</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b2 &lt;&lt; <span class="Constant">48<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b3 &lt;&lt; <span class="Constant">40</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b4 &lt;&lt; <span class="Constant">32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b5 &lt;&lt; <span class="Constant">24</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b6 &lt;&lt; <span class="Constant">16<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b7 &lt;&lt; <span class="Constant">8</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b8;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; res = (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b8 &lt;&lt; <span class="Constant">56</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b7 &lt;&lt; <span class="Constant">48<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b6 &lt;&lt; <span class="Constant">40</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b5 &lt;&lt; <span class="Constant">32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b4 &lt;&lt; <span class="Constant">24</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b3 &lt;&lt; <span class="Constant">16<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b2 &lt;&lt; <span class="Constant">8</span> | (<span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span>) b1;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="ints.c.html#L427" title="ocaml/runtime/ints.c:427">caml_copy_int64</a>(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Generic write to a big array */<br/></li>
<li></span><br/></li>
<li><a id="L705">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_set_aux</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * vind,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> nind, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> index[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> offset;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Check number of indices = number of dimensions of array<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; (maybe not necessary if ML typing guarantees this) */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (nind != <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.set: wrong number of indices&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Compute offset <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> check bounds */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) index[i] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind[i]);<br/></li>
<li>&nbsp; offset = <a href="#L528" title="ocaml/runtime/bigarray.c:528">caml_ba_offset</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, index);<br/></li>
<li>&nbsp; <span class="Comment">/* Perform write */<br/></li>
<li></span>&nbsp; <span class="Statement">switch</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32:<br/></li>
<li>&nbsp; &nbsp; ((<span class="Type">float</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L339" title="ocaml/runtime/caml/mlvalues.h:339">Double_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64:<br/></li>
<li>&nbsp; &nbsp; ((<span class="Type">double</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L339" title="ocaml/runtime/caml/mlvalues.h:339">Double_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8:<br/></li>
<li>&nbsp; &nbsp; ((<a href="#L32" title="ocaml/runtime/bigarray.c:32">int8</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16:<br/></li>
<li>&nbsp; &nbsp; ((<a href="#L34" title="ocaml/runtime/bigarray.c:34">int16</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32:<br/></li>
<li>&nbsp; &nbsp; ((<span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L407" title="ocaml/runtime/caml/mlvalues.h:407">Int32_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64:<br/></li>
<li>&nbsp; &nbsp; ((<span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L410" title="ocaml/runtime/caml/mlvalues.h:410">Int64_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT:<br/></li>
<li>&nbsp; &nbsp; ((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L408" title="ocaml/runtime/caml/mlvalues.h:408">Nativeint_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT:<br/></li>
<li>&nbsp; &nbsp; ((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[offset] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(newval); <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32:<br/></li>
<li>&nbsp; &nbsp; { <span class="Type">float</span> * p = ((<span class="Type">float</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data) + offset * <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; p[<span class="Constant">0</span>] = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(newval, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; p[<span class="Constant">1</span>] = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(newval, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64:<br/></li>
<li>&nbsp; &nbsp; { <span class="Type">double</span> * p = ((<span class="Type">double</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data) + offset * <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; p[<span class="Constant">0</span>] = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(newval, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; p[<span class="Constant">1</span>] = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(newval, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L757">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_set_1</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind1, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L705" title="ocaml/runtime/bigarray.c:705">caml_ba_set_aux</a>(vb, &amp;vind1, <span class="Constant">1</span>, newval);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L762">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_set_2</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind1, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind2, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; vind[<span class="Constant">0</span>] = vind1; vind[<span class="Constant">1</span>] = vind2;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L705" title="ocaml/runtime/bigarray.c:705">caml_ba_set_aux</a>(vb, vind, <span class="Constant">2</span>, newval);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L769">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_set_3</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind1, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind2, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind3,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; vind[<span class="Constant">0</span>] = vind1; vind[<span class="Constant">1</span>] = vind2; vind[<span class="Constant">2</span>] = vind3;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L705" title="ocaml/runtime/bigarray.c:705">caml_ba_set_aux</a>(vb, vind, <span class="Constant">3</span>, newval);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L777">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_set_N</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * vind, <span class="Type">int</span> nargs)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L705" title="ocaml/runtime/bigarray.c:705">caml_ba_set_aux</a>(vb, vind, nargs - <span class="Constant">1</span>, vind[nargs - <span class="Constant">1</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L782">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_set_generic</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L705" title="ocaml/runtime/bigarray.c:705">caml_ba_set_aux</a>(vb, &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(vind, <span class="Constant">0</span>), <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(vind), newval);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L787">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_uint8_set16</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> b1, b2;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> val;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> idx = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">0</span> || idx &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<span class="Constant">0</span>] - <span class="Constant">1</span>) <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; val = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(newval);<br/></li>
<li><span class="PreProc">#ifdef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; b1 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; b2 = <span class="Constant">0xFF</span> &amp; val;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; b2 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; b1 = <span class="Constant">0xFF</span> &amp; val;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx] = b1;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">1</span>] = b2;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L807">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_uint8_set32</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> b1, b2, b3, b4;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> idx = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> val;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">0</span> || idx &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<span class="Constant">0</span>] - <span class="Constant">3</span>) <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; val = <a href="caml/mlvalues.h.html#L407" title="ocaml/runtime/caml/mlvalues.h:407">Int32_val</a>(newval);<br/></li>
<li><span class="PreProc">#ifdef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; b1 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; b2 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; b3 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; b4 = <span class="Constant">0xFF</span> &amp; val;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; b4 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; b3 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; b2 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; b1 = <span class="Constant">0xFF</span> &amp; val;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx] = b1;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">1</span>] = b2;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">2</span>] = b3;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">3</span>] = b4;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L833">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_uint8_set64</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> newval)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> b1, b2, b3, b4, b5, b6, b7, b8;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> idx = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vind);<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> val;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">0</span> || idx &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<span class="Constant">0</span>] - <span class="Constant">7</span>) <a href="fail_nat.c.html#L213" title="ocaml/runtime/fail_nat.c:213">caml_array_bound_error</a>();<br/></li>
<li>&nbsp; val = <a href="caml/mlvalues.h.html#L410" title="ocaml/runtime/caml/mlvalues.h:410">Int64_val</a>(newval);<br/></li>
<li><span class="PreProc">#ifdef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; b1 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">56</span>;<br/></li>
<li>&nbsp; b2 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">48</span>;<br/></li>
<li>&nbsp; b3 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">40</span>;<br/></li>
<li>&nbsp; b4 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">32</span>;<br/></li>
<li>&nbsp; b5 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; b6 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; b7 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; b8 = <span class="Constant">0xFF</span> &amp; val;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; b8 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">56</span>;<br/></li>
<li>&nbsp; b7 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">48</span>;<br/></li>
<li>&nbsp; b6 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">40</span>;<br/></li>
<li>&nbsp; b5 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">32</span>;<br/></li>
<li>&nbsp; b4 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; b3 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; b2 = <span class="Constant">0xFF</span> &amp; val &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; b1 = <span class="Constant">0xFF</span> &amp; val;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx] = b1;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">1</span>] = b2;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">2</span>] = b3;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">3</span>] = b4;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">4</span>] = b5;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">5</span>] = b6;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">6</span>] = b7;<br/></li>
<li>&nbsp; ((<span class="Type">unsigned</span> <span class="Type">char</span>*) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data)[idx+<span class="Constant">7</span>] = b8;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return the number of dimensions of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L873">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_num_dims</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return the n-th dimension of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L881">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_dim</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vn)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vn);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span> || n &gt;= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims) <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.dim&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[n]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L889">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_dim_1</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L881" title="ocaml/runtime/bigarray.c:881">caml_ba_dim</a>(vb, <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(<span class="Constant">0</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L894">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_dim_2</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L881" title="ocaml/runtime/bigarray.c:881">caml_ba_dim</a>(vb, <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(<span class="Constant">1</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L899">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_dim_3</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L881" title="ocaml/runtime/bigarray.c:881">caml_ba_dim</a>(vb, <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(<span class="Constant">2</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return the kind of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L906">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_kind</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/bigarray.h.html#L55" title="ocaml/runtime/caml/bigarray.h:55">Val_caml_ba_kind</a>(<a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb)-&gt;flags &amp; CAML_BA_KIND_MASK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return the layout of a big array */<br/></li>
<li></span><br/></li>
<li><a id="L913">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_layout</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">int</span> layout = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb)-&gt;flags &amp; CAML_BA_LAYOUT_MASK;<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/bigarray.h.html#L66" title="ocaml/runtime/caml/bigarray.h:66">Val_caml_ba_layout</a>(layout);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Create / update proxy to indicate that b2 is a <a href="ints.c.html#L464" title="ocaml/runtime/ints.c:464">sub</a>-array of b1 */<br/></li>
<li></span><br/></li>
<li><a id="L921">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">caml_ba_update_proxy</span>(<span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * b1,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * b2)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L75" title="ocaml/runtime/caml/bigarray.h:75">caml_ba_proxy</a> * proxy;<br/></li>
<li>&nbsp; <span class="Comment">/* Nothing to do for un-managed arrays */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((b1-&gt;flags &amp; CAML_BA_MANAGED_MASK) == CAML_BA_EXTERNAL) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (b1-&gt;proxy != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If b1 is already a proxy for a larger array, increment refcount of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; proxy */<br/></li>
<li></span>&nbsp; &nbsp; b2-&gt;proxy = b1-&gt;proxy;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/atomic_refcount.h.html#L31" title="ocaml/runtime/caml/atomic_refcount.h:31">caml_atomic_refcount_incr</a>(&amp;b1-&gt;proxy-&gt;refcount);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Otherwise, create proxy <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> attach it to both b1 <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> b2 */<br/></li>
<li></span>&nbsp; &nbsp; proxy = malloc(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/bigarray.h.html#L75" title="ocaml/runtime/caml/bigarray.h:75">caml_ba_proxy</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (proxy == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="caml/atomic_refcount.h.html#L23" title="ocaml/runtime/caml/atomic_refcount.h:23">caml_atomic_refcount_init</a>(&amp;proxy-&gt;refcount, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* initial refcount: 2 = original array + <a href="ints.c.html#L464" title="ocaml/runtime/ints.c:464">sub</a> array */<br/></li>
<li></span>&nbsp; &nbsp; proxy-&gt;data = b1-&gt;data;<br/></li>
<li>&nbsp; &nbsp; proxy-&gt;size =<br/></li>
<li>&nbsp; &nbsp; &nbsp; b1-&gt;flags &amp; CAML_BA_MAPPED_FILE ? <a href="#L62" title="ocaml/runtime/bigarray.c:62">caml_ba_byte_size</a>(b1) : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; b1-&gt;proxy = proxy;<br/></li>
<li>&nbsp; &nbsp; b2-&gt;proxy = proxy;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Slicing */<br/></li>
<li></span><br/></li>
<li><a id="L948">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_slice</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vind)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a> (vb, vind);<br/></li>
<li><a id="L951">&#x200c;</a>&nbsp; <span class="PreProc">#define <span class="linkable">b</span> (<a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb))<br/></li>
<li></span>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a> (res);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> index[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> num_inds, i;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> offset;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * sub_dims;<br/></li>
<li>&nbsp; <span class="Type">char</span> * sub_data;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Check number of indices &lt;= number of dimensions of array */<br/></li>
<li></span>&nbsp; num_inds = <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(vind);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (num_inds &gt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.slice: too many indices&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Compute offset <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> check bounds */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_LAYOUT_MASK) == CAML_BA_C_LAYOUT) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We slice from the left */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_inds; i++) index[i] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(vind, i));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Comment">/*nothing*/</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) index[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; offset = <a href="#L528" title="ocaml/runtime/bigarray.c:528">caml_ba_offset</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, index);<br/></li>
<li>&nbsp; &nbsp; sub_dims = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim + num_inds;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We slice from the right */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_inds; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; index[<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - num_inds + i] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(vind, i));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - num_inds; i++) index[i] = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; offset = <a href="#L528" title="ocaml/runtime/bigarray.c:528">caml_ba_offset</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, index);<br/></li>
<li>&nbsp; &nbsp; sub_dims = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; sub_data =<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">char</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data +<br/></li>
<li>&nbsp; &nbsp; offset * <a href="#L50" title="ocaml/runtime/bigarray.c:50">caml_ba_element_size</a>[<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK];<br/></li>
<li>&nbsp; <span class="Comment">/* Allocate an OCaml bigarray to hold the result */<br/></li>
<li></span>&nbsp; res = <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - num_inds, sub_data, sub_dims);<br/></li>
<li>&nbsp; <span class="Comment">/* Copy the finalization function from the original array (PR#8568) */<br/></li>
<li></span>&nbsp; <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(res) = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Comment">/* Create <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> update proxy in case of managed bigarray */<br/></li>
<li></span>&nbsp; <a href="#L921" title="ocaml/runtime/bigarray.c:921">caml_ba_update_proxy</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(res));<br/></li>
<li>&nbsp; <span class="Comment">/* Return result */<br/></li>
<li></span>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (res);<br/></li>
<li><br/></li>
<li><a id="L990">&#x200c;</a>&nbsp; <span class="PreProc">#undef <span class="linkable">b</span><br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Changing the layout of an array (memory is shared) */<br/></li>
<li></span><br/></li>
<li><a id="L995">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_change_layout</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vlayout)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a> (vb, vlayout);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a> (res);<br/></li>
<li><a id="L999">&#x200c;</a>&nbsp; <span class="PreProc">#define <span class="linkable">b</span> (<a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb))<br/></li>
<li></span>&nbsp; <span class="Comment">/* if the layout is different, change the flags <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> reverse the dimensions */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (<a href="caml/bigarray.h.html#L64" title="ocaml/runtime/caml/bigarray.h:64">Caml_ba_layout_val</a>(vlayout) != (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_LAYOUT_MASK)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* change the flags to reflect the new layout */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span> flags = (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; (CAML_BA_KIND_MASK | CAML_BA_MANAGED_MASK))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | <a href="caml/bigarray.h.html#L64" title="ocaml/runtime/caml/bigarray.h:64">Caml_ba_layout_val</a>(vlayout);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* reverse the dimensions */<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> new_dim[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span>(i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) new_dim[i] = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - i - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; res = <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>(flags, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, new_dim);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Copy the finalization function from the original array (PR#8568) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(res) = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(vb);<br/></li>
<li>&nbsp; &nbsp; <a href="#L921" title="ocaml/runtime/bigarray.c:921">caml_ba_update_proxy</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(res));<br/></li>
<li>&nbsp; &nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(res);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* otherwise, do nothing */<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(vb);<br/></li>
<li>&nbsp; }<br/></li>
<li><a id="L1018">&#x200c;</a>&nbsp; <span class="PreProc">#undef <span class="linkable">b</span><br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* Extracting a <a href="ints.c.html#L464" title="ocaml/runtime/ints.c:464">sub</a>-array of same number of dimensions */<br/></li>
<li></span><br/></li>
<li><a id="L1024">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_sub</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vofs, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vlen)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L284" title="ocaml/runtime/caml/memory.h:284">CAMLparam3</a> (vb, vofs, vlen);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a> (res);<br/></li>
<li><a id="L1028">&#x200c;</a>&nbsp; <span class="PreProc">#define <span class="linkable">b</span> (<a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb))<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> ofs = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vofs);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vlen);<br/></li>
<li>&nbsp; <span class="Type">int</span> i, changed_dim;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <a href="ints.c.html#L467" title="ocaml/runtime/ints.c:467">mul</a>;<br/></li>
<li>&nbsp; <span class="Type">char</span> * sub_data;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Compute offset <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> check bounds */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> ((<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_LAYOUT_MASK) == CAML_BA_C_LAYOUT) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We reduce the first dimension */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ints.c.html#L467" title="ocaml/runtime/ints.c:467">mul</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims; i++) <a href="ints.c.html#L467" title="ocaml/runtime/ints.c:467">mul</a> *= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i];<br/></li>
<li>&nbsp; &nbsp; changed_dim = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We reduce the last dimension */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ints.c.html#L467" title="ocaml/runtime/ints.c:467">mul</a> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - <span class="Constant">1</span>; i++) <a href="ints.c.html#L467" title="ocaml/runtime/ints.c:467">mul</a> *= <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[i];<br/></li>
<li>&nbsp; &nbsp; changed_dim = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ofs--;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Fortran arrays start at 1 */<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ofs &lt; <span class="Constant">0</span> || len &lt; <span class="Constant">0</span> || ofs + len &gt; <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim[changed_dim])<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.<a href="ints.c.html#L464" title="ocaml/runtime/ints.c:464">sub</a>: bad <a href="ints.c.html#L464" title="ocaml/runtime/ints.c:464">sub</a>-array&quot;</span>);<br/></li>
<li>&nbsp; sub_data =<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">char</span> *) <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data +<br/></li>
<li>&nbsp; &nbsp; ofs * <a href="ints.c.html#L467" title="ocaml/runtime/ints.c:467">mul</a> * <a href="#L50" title="ocaml/runtime/bigarray.c:50">caml_ba_element_size</a>[<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK];<br/></li>
<li>&nbsp; <span class="Comment">/* Allocate an OCaml bigarray to hold the result */<br/></li>
<li></span>&nbsp; res = <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;num_dims, sub_data, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;dim);<br/></li>
<li>&nbsp; <span class="Comment">/* Copy the finalization function from the original array (PR#8568) */<br/></li>
<li></span>&nbsp; <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(res) = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Comment">/* Doctor the changed dimension */<br/></li>
<li></span>&nbsp; <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(res)-&gt;dim[changed_dim] = len;<br/></li>
<li>&nbsp; <span class="Comment">/* Create <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> update proxy in case of managed bigarray */<br/></li>
<li></span>&nbsp; <a href="#L921" title="ocaml/runtime/bigarray.c:921">caml_ba_update_proxy</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(res));<br/></li>
<li>&nbsp; <span class="Comment">/* Return result */<br/></li>
<li></span>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (res);<br/></li>
<li><br/></li>
<li><a id="L1064">&#x200c;</a>&nbsp; <span class="PreProc">#undef <span class="linkable">b</span><br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Copying a big array into another one */<br/></li>
<li></span><br/></li>
<li><a id="L1069">&#x200c;</a><span class="PreProc">#define <span class="linkable">LEAVE_RUNTIME_OP_CUTOFF</span> </span><span class="Constant">4096<br/></li>
<li><a id="L1070">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">is_mmapped</span>(ba) ((ba)-&gt;flags &amp; CAML_BA_MAPPED_FILE)<br/></li>
<li></span><br/></li>
<li><a id="L1072">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_blit</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vsrc, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vdst)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a>(vsrc, vdst);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * src = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vsrc);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * dst = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vdst);<br/></li>
<li>&nbsp; <span class="Type">void</span> *src_data = src-&gt;data;<br/></li>
<li>&nbsp; <span class="Type">void</span> *dst_data = dst-&gt;data;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> num_bytes;<br/></li>
<li>&nbsp; <span class="Type">int</span> leave_runtime;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Check same numbers of dimensions <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> same dimensions */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (src-&gt;num_dims != dst-&gt;num_dims) <span class="Statement">goto</span> blit_error;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; src-&gt;num_dims; i++)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src-&gt;dim[i] != dst-&gt;dim[i]) <span class="Statement">goto</span> blit_error;<br/></li>
<li>&nbsp; <span class="Comment">/* Compute number of bytes in array data */<br/></li>
<li></span>&nbsp; num_bytes =<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="ocaml/runtime/bigarray.c:39">caml_ba_num_elts</a>(src)<br/></li>
<li>&nbsp; &nbsp; * <a href="#L50" title="ocaml/runtime/bigarray.c:50">caml_ba_element_size</a>[src-&gt;flags &amp; CAML_BA_KIND_MASK];<br/></li>
<li>&nbsp; leave_runtime =<br/></li>
<li>&nbsp; &nbsp; (<br/></li>
<li>&nbsp; &nbsp; &nbsp; (num_bytes &gt;= <a href="#L1069" title="ocaml/runtime/bigarray.c:1069">LEAVE_RUNTIME_OP_CUTOFF</a>*<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">long</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; || <a href="#L1070" title="ocaml/runtime/bigarray.c:1070">is_mmapped</a>(src)<br/></li>
<li>&nbsp; &nbsp; &nbsp; || <a href="#L1070" title="ocaml/runtime/bigarray.c:1070">is_mmapped</a>(dst)<br/></li>
<li>&nbsp; &nbsp; );<br/></li>
<li>&nbsp; <span class="Comment">/* Do the copying */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (leave_runtime) <a href="signals.c.html#L145" title="ocaml/runtime/signals.c:145">caml_enter_blocking_section</a>();<br/></li>
<li>&nbsp; memmove (dst_data, src_data, num_bytes);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (leave_runtime) <a href="signals.c.html#L166" title="ocaml/runtime/signals.c:166">caml_leave_blocking_section</a>();<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li> <span class="Statement">blit_error</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.blit: dimension mismatch&quot;</span>);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* not reached */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Filling a big array with a given <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> */<br/></li>
<li></span><br/></li>
<li><a id="L1109">&#x200c;</a><span class="PreProc">#define <span class="linkable">FILL_GEN_LOOP</span>(n_ops, loop) </span><span class="Statement">do</span><span class="PreProc">{&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Type">int</span><span class="PreProc"> leave_runtime = ((n_ops &gt;= <a href="#L1069" title="ocaml/runtime/bigarray.c:1069">LEAVE_RUNTIME_OP_CUTOFF</a>) || <a href="#L1070" title="ocaml/runtime/bigarray.c:1070">is_mmapped</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>)); \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">if</span><span class="PreProc"> (leave_runtime) <a href="signals.c.html#L145" title="ocaml/runtime/signals.c:145">caml_enter_blocking_section</a>();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; loop;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">if</span><span class="PreProc"> (leave_runtime) <a href="signals.c.html#L166" title="ocaml/runtime/signals.c:166">caml_leave_blocking_section</a>();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">}</span><span class="Statement">while</span><span class="PreProc">(</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L1116">&#x200c;</a><span class="PreProc">#define <span class="linkable">FILL_SCALAR_LOOP</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; <a href="#L1109" title="ocaml/runtime/bigarray.c:1109">FILL_GEN_LOOP</a>(num_elts,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">for</span><span class="PreProc"> (p = data; num_elts &gt; </span><span class="Constant">0</span><span class="PreProc">; p++, num_elts--) *p = init)<br/></li>
<li></span><br/></li>
<li><a id="L1120">&#x200c;</a><span class="PreProc">#define <span class="linkable">FILL_COMPLEX_LOOP</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; <a href="#L1109" title="ocaml/runtime/bigarray.c:1109">FILL_GEN_LOOP</a>(num_elts + num_elts,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">for</span><span class="PreProc"> (p = data; num_elts &gt; </span><span class="Constant">0</span><span class="PreProc">; num_elts--) </span><span class="Error">{</span><span class="PreProc"> *p++ = init0; *p++ = init1; </span><span class="Error">}</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L1124">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_fill</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vinit)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a>(vb);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/bigarray.h.html#L81" title="ocaml/runtime/caml/bigarray.h:81">caml_ba_array</a> * <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a> = <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Type">void</span> *data = <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> num_elts = <a href="#L39" title="ocaml/runtime/bigarray.c:39">caml_ba_num_elts</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags &amp; CAML_BA_KIND_MASK) {<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT32: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span> init = <a href="caml/mlvalues.h.html#L339" title="ocaml/runtime/caml/mlvalues.h:339">Double_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_FLOAT64: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> init = <a href="caml/mlvalues.h.html#L339" title="ocaml/runtime/caml/mlvalues.h:339">Double_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CHAR:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT8:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT8: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> init = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_SINT16:<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_UINT16: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> init = <a href="caml/mlvalues.h.html#L82" title="ocaml/runtime/caml/mlvalues.h:82">Int_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <a href="#L34" title="ocaml/runtime/bigarray.c:34">int16</a> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT32: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> init = <a href="caml/mlvalues.h.html#L407" title="ocaml/runtime/caml/mlvalues.h:407">Int32_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_INT64: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> init = <a href="caml/mlvalues.h.html#L410" title="ocaml/runtime/caml/mlvalues.h:410">Int64_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_NATIVE_INT: {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> init = <a href="caml/mlvalues.h.html#L408" title="ocaml/runtime/caml/mlvalues.h:408">Nativeint_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_CAML_INT: {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> init = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(vinit);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1116" title="ocaml/runtime/bigarray.c:1116">FILL_SCALAR_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX32: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span> init0 = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(vinit, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span> init1 = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(vinit, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1120" title="ocaml/runtime/bigarray.c:1120">FILL_COMPLEX_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">case</span> CAML_BA_COMPLEX64: {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> init0 = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(vinit, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> init1 = <a href="caml/mlvalues.h.html#L353" title="ocaml/runtime/caml/mlvalues.h:353">Double_flat_field</a>(vinit, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span> * p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1120" title="ocaml/runtime/bigarray.c:1120">FILL_COMPLEX_LOOP</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Reshape an array: change dimensions <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> number of dimensions, preserving<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; array contents */<br/></li>
<li></span><br/></li>
<li><a id="L1206">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ba_reshape</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vb, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vdim)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a> (vb, vdim);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a> (res);<br/></li>
<li><a id="L1210">&#x200c;</a><span class="PreProc">#define <span class="linkable">b</span> (<a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(vb))<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> dim[<a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>];<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> num_dims;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> num_elts;<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; num_dims = <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(vdim);<br/></li>
<li>&nbsp; <span class="Comment">/* here num_dims is unsigned (<a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a>) so no need to check (num_dims &gt;= 0) */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (num_dims &gt; <a href="caml/bigarray.h.html#L34" title="ocaml/runtime/caml/bigarray.h:34">CAML_BA_MAX_NUM_DIMS</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.reshape: bad number of dimensions&quot;</span>);<br/></li>
<li>&nbsp; num_elts = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num_dims; i++) {<br/></li>
<li>&nbsp; &nbsp; dim[i] = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(vdim, i));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dim[i] &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.reshape: negative dimension&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; num_elts *= dim[i];<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Check that sizes agree */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (num_elts != <a href="#L39" title="ocaml/runtime/bigarray.c:39">caml_ba_num_elts</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>))<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;Bigarray.reshape: size mismatch&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Create bigarray with same data <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> new dimensions */<br/></li>
<li></span>&nbsp; res = <a href="#L90" title="ocaml/runtime/bigarray.c:90">caml_ba_alloc</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;flags, num_dims, <a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>-&gt;data, dim);<br/></li>
<li>&nbsp; <span class="Comment">/* Copy the finalization function from the original array (PR#8568) */<br/></li>
<li></span>&nbsp; <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(res) = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(vb);<br/></li>
<li>&nbsp; <span class="Comment">/* Create <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> update proxy in case of managed bigarray */<br/></li>
<li></span>&nbsp; <a href="#L921" title="ocaml/runtime/bigarray.c:921">caml_ba_update_proxy</a>(<a href="#L951" title="ocaml/runtime/bigarray.c:951">b</a>, <a href="caml/bigarray.h.html#L101" title="ocaml/runtime/caml/bigarray.h:101">Caml_ba_array_val</a>(res));<br/></li>
<li>&nbsp; <span class="Comment">/* Return result */<br/></li>
<li></span>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (res);<br/></li>
<li><br/></li>
<li><a id="L1239">&#x200c;</a><span class="PreProc">#undef <span class="linkable">b</span><br/></li>
<li></span>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

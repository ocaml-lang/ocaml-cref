<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/intern.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/intern.c - ocaml</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L63">caml_intern_state</a></li>
<li><a href="#L45">intern_item</a></li>
<li><a href="#L715">marshal_header</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L1105">caml_deserialize_block_1</a></li>
<li><a href="#L1112">caml_deserialize_block_2</a></li>
<li><a href="#L1126">caml_deserialize_block_4</a></li>
<li><a href="#L1140">caml_deserialize_block_8</a></li>
<li><a href="#L1154">caml_deserialize_block_float_8</a></li>
<li><a href="#L1173">caml_deserialize_error</a></li>
<li><a href="#L1091">caml_deserialize_float_4</a></li>
<li><a href="#L1098">caml_deserialize_float_8</a></li>
<li><a href="#L1047">caml_deserialize_sint_1</a></li>
<li><a href="#L1059">caml_deserialize_sint_2</a></li>
<li><a href="#L1071">caml_deserialize_sint_4</a></li>
<li><a href="#L1084">caml_deserialize_sint_8</a></li>
<li><a href="#L1041">caml_deserialize_uint_1</a></li>
<li><a href="#L1053">caml_deserialize_uint_2</a></li>
<li><a href="#L1065">caml_deserialize_uint_4</a></li>
<li><a href="#L1077">caml_deserialize_uint_8</a></li>
<li><a href="#L117">caml_free_intern_state</a></li>
<li><a href="#L825">caml_input_val</a></li>
<li><a href="#L898">caml_input_val_from_bytes</a></li>
<li><a href="#L878">caml_input_value</a></li>
<li><a href="#L949">caml_input_value_from_block</a></li>
<li><a href="#L920">caml_input_value_from_bytes</a></li>
<li><a href="#L938">caml_input_value_from_malloc</a></li>
<li><a href="#L893">caml_input_value_to_outside_heap</a></li>
<li><a href="#L977">caml_marshal_data_size</a></li>
<li><a href="#L733">caml_parse_header</a></li>
<li><a href="#L95">get_intern_state</a></li>
<li><a href="#L925">input_val_from_block</a></li>
<li><a href="#L391">intern_alloc_obj</a></li>
<li><a href="#L358">intern_alloc_storage</a></li>
<li><a href="#L1025">intern_bad_code_pointer</a></li>
<li><a href="#L231">intern_cleanup</a></li>
<li><a href="#L795">intern_decompress_input</a></li>
<li><a href="#L701">intern_end</a></li>
<li><a href="#L725">intern_failwith2</a></li>
<li><a href="#L221">intern_free_stack</a></li>
<li><a href="#L208">intern_init</a></li>
<li><a href="#L416">intern_rec</a></li>
<li><a href="#L317">intern_resize_stack</a></li>
<li><a href="#L1015">intern_resolve_code_pointer</a></li>
<li><a href="#L310">intern_stack_overflow</a></li>
<li><a href="#L144">read16s</a></li>
<li><a href="#L137">read16u</a></li>
<li><a href="#L160">read32s</a></li>
<li><a href="#L151">read32u</a></li>
<li><a href="#L170">read64u</a></li>
<li><a href="#L134">read8s</a></li>
<li><a href="#L131">read8u</a></li>
<li><a href="#L201">readblock</a></li>
<li><a href="#L246">readfloat</a></li>
<li><a href="#L271">readfloats</a></li>
<li><a href="#L186">readvlq</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L16">CAML_INTERNALS</a></li>
<li><a href="#L60">INTERN_STACK_INIT_SIZE</a></li>
<li><a href="#L61">INTERN_STACK_MAX_SIZE</a></li>
<li><a href="#L342">PushItem</a></li>
<li><a href="#L348">ReadItems</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Xavier Leroy, projet Cristal, INRIA Rocquencourt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 1996 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L16">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Structured input, compact format */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* The interface of this file is &quot;caml/intext.h&quot; */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/alloc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/callback.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/codefrag.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/config.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/custom.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/gc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/intext.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/io.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memprof.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/misc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/reverse.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/shared_heap.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/signals.h&quot;<br/></li>
<li></span><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;zstd.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Item on the stack with defined operation */<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">intern_item</span> {<br/></li>
<li>&nbsp; <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * dest;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> arg;<br/></li>
<li>&nbsp; <span class="Type">enum</span> {<br/></li>
<li>&nbsp; &nbsp; OReadItems, <span class="Comment">/* read arg items <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> store them in dest[0], dest[1], ... */<br/></li>
<li></span>&nbsp; &nbsp; OFreshOID,&nbsp; <span class="Comment">/* generate a fresh OID <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> store it in *dest */<br/></li>
<li></span>&nbsp; &nbsp; OShift&nbsp; &nbsp; &nbsp; <span class="Comment">/* offset *dest by arg */<br/></li>
<li></span>&nbsp; } op;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* </span><span class="Todo">FIXME</span><span class="Comment">: This is duplicated in two other places, with the only difference of<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; the type of elements stored in the stack. Possible solution in C would<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; be to instantiate stack these function via. C preprocessor macro.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L60">&#x200c;</a><span class="PreProc">#define <span class="linkable">INTERN_STACK_INIT_SIZE</span> </span><span class="Constant">256<br/></li>
<li><a id="L61">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">INTERN_STACK_MAX_SIZE</span> (</span><span class="Constant">1024</span><span class="PreProc">*</span><span class="Constant">1024</span><span class="PreProc">*</span><span class="Constant">100</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L63">&#x200c;</a><span class="Type">struct</span> <span class="linkable">caml_intern_state</span> {<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> * intern_src;<br/></li>
<li>&nbsp; <span class="Comment">/* Reading pointer in block holding input data. */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * intern_input;<br/></li>
<li>&nbsp; <span class="Comment">/* Pointer to beginning of block holding input data,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; if non-<a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a> this pointer will be freed by the cleanup function. */<br/></li>
<li></span><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> obj_counter;<br/></li>
<li>&nbsp; <span class="Comment">/* Count how many objects seen so far */<br/></li>
<li></span><br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * intern_obj_table;<br/></li>
<li>&nbsp; <span class="Comment">/* The pointers to objects already seen */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> intern_stack_init[<a href="#L60" title="ocaml/runtime/intern.c:60">INTERN_STACK_INIT_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Comment">/* The initial intern stack */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> * intern_stack;<br/></li>
<li>&nbsp; <span class="Comment">/* Initially points to [intern_stack_init] */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> * intern_stack_limit;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> * intern_dest;<br/></li>
<li>&nbsp; <span class="Comment">/* Writing pointer in destination block. Only used when the object fits in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; the minor heap. */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Type">char</span> compressed;<br/></li>
<li>&nbsp; <span class="Comment">/* 1 if the compressed format is in use, 0 otherwise */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocates the domain local intern state if needed */<br/></li>
<li><a id="L95">&#x200c;</a></span><span class="Type">static</span> <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* <span class="linkable">get_intern_state</span> (<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L72" title="ocaml/runtime/caml/domain_state.h:72">Caml_check_caml_state</a>();<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;intern_state != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;intern_state;<br/></li>
<li><br/></li>
<li>&nbsp; s = <a href="memory.c.html#L550" title="ocaml/runtime/memory.c:550">caml_stat_alloc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>));<br/></li>
<li><br/></li>
<li>&nbsp; s-&gt;intern_src = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; s-&gt;intern_input = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; s-&gt;obj_counter = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; s-&gt;intern_obj_table = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; s-&gt;intern_stack = s-&gt;intern_stack_init;<br/></li>
<li>&nbsp; s-&gt;intern_stack_limit = s-&gt;intern_stack + <a href="#L60" title="ocaml/runtime/intern.c:60">INTERN_STACK_INIT_SIZE</a>;<br/></li>
<li>&nbsp; s-&gt;intern_dest = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;intern_state = s;<br/></li>
<li>&nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_free_intern_state</span> (<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;intern_state != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;intern_state);<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;intern_state = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> * <a href="#L1015" title="ocaml/runtime/intern.c:1015">intern_resolve_code_pointer</a>(<span class="Type">unsigned</span> <span class="Type">char</span> digest[<span class="Constant">16</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> offset);<br/></li>
<li><br/></li>
<li><a href="caml/misc.h.html#L90" title="ocaml/runtime/caml/misc.h:90">CAMLnoreturn_start</a><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1025" title="ocaml/runtime/intern.c:1025">intern_bad_code_pointer</a>(<span class="Type">unsigned</span> <span class="Type">char</span> digest[<span class="Constant">16</span>])<br/></li>
<li><a href="caml/misc.h.html#L91" title="ocaml/runtime/caml/misc.h:91">CAMLnoreturn_end</a>;<br/></li>
<li><br/></li>
<li><a id="L131">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">unsigned</span> <span class="Type">char</span> <span class="linkable">read8u</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{ <span class="Statement">return</span> *s-&gt;intern_src++; }<br/></li>
<li><br/></li>
<li><a id="L134">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">signed</span> <span class="Type">char</span> <span class="linkable">read8s</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{ <span class="Statement">return</span> *s-&gt;intern_src++; }<br/></li>
<li><br/></li>
<li><a id="L137">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type"><a href="caml/config.h.html#L131" title="ocaml/runtime/caml/config.h:131">uint16_t</a></span> <span class="linkable">read16u</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L131" title="ocaml/runtime/caml/config.h:131">uint16_t</a></span> res = (s-&gt;intern_src[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + s-&gt;intern_src[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; s-&gt;intern_src += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L144">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type"><a href="caml/config.h.html#L130" title="ocaml/runtime/caml/config.h:130">int16_t</a></span> <span class="linkable">read16s</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L130" title="ocaml/runtime/caml/config.h:130">int16_t</a></span> res = (s-&gt;intern_src[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + s-&gt;intern_src[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; s-&gt;intern_src += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L151">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> <span class="linkable">read32u</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> res =<br/></li>
<li>&nbsp; &nbsp; ((<span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span>)(s-&gt;intern_src[<span class="Constant">0</span>]) &lt;&lt; <span class="Constant">24</span>) + (s-&gt;intern_src[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; + (s-&gt;intern_src[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + s-&gt;intern_src[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; s-&gt;intern_src += <span class="Constant">4</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L160">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> <span class="linkable">read32s</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> res =<br/></li>
<li>&nbsp; &nbsp; ((<span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span>)(s-&gt;intern_src[<span class="Constant">0</span>]) &lt;&lt; <span class="Constant">24</span>) + (s-&gt;intern_src[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; + (s-&gt;intern_src[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + s-&gt;intern_src[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; s-&gt;intern_src += <span class="Constant">4</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li><a id="L170">&#x200c;</a></span><span class="Type">static</span> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">read64u</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> res =<br/></li>
<li>&nbsp; &nbsp; ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">0</span>]) &lt;&lt; <span class="Constant">56</span>)<br/></li>
<li>&nbsp; &nbsp; + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">1</span>]) &lt;&lt; <span class="Constant">48</span>)<br/></li>
<li>&nbsp; &nbsp; + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">2</span>]) &lt;&lt; <span class="Constant">40</span>)<br/></li>
<li>&nbsp; &nbsp; + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">3</span>]) &lt;&lt; <span class="Constant">32</span>)<br/></li>
<li>&nbsp; &nbsp; + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">4</span>]) &lt;&lt; <span class="Constant">24</span>)<br/></li>
<li>&nbsp; &nbsp; + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">5</span>]) &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">6</span>]) &lt;&lt; <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; + (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) (s-&gt;intern_src[<span class="Constant">7</span>]);<br/></li>
<li>&nbsp; s-&gt;intern_src += <span class="Constant">8</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L186">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">readvlq</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s, <span class="Comment">/*out*/</span> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * res)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> c = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> n = c &amp; <span class="Constant">0x7F</span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> retcode = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> ((c &amp; <span class="Constant">0x80</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; c = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> n7 = n &lt;&lt; <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != n7 &gt;&gt; <span class="Constant">7</span>) retcode = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; n = n7 | (c &amp; <span class="Constant">0x7F</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (res) *res = n;<br/></li>
<li>&nbsp; <span class="Statement">return</span> retcode;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L201">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">readblock</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">void</span> * dest, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; memcpy(dest, s-&gt;intern_src, len);<br/></li>
<li>&nbsp; s-&gt;intern_src += len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L208">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_init</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s, <span class="Type">const</span> <span class="Type">void</span> * src,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span> * input)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (s);<br/></li>
<li>&nbsp; <span class="Comment">/* This is asserted at the beginning of demarshaling primitives.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; If it fails, it probably means that an exception was raised<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; without calling <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>() during the previous demarshaling. */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (s-&gt;intern_input == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> &amp;&amp; s-&gt;intern_obj_table == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; s-&gt;intern_src = src;<br/></li>
<li>&nbsp; s-&gt;intern_input = input;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Free the recursion stack if needed */<br/></li>
<li><a id="L221">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_free_stack</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;intern_stack != s-&gt;intern_stack_init) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;intern_stack);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Reinitialize the globals for next time around */<br/></li>
<li></span>&nbsp; &nbsp; s-&gt;intern_stack = s-&gt;intern_stack_init;<br/></li>
<li>&nbsp; &nbsp; s-&gt;intern_stack_limit = s-&gt;intern_stack + <a href="#L60" title="ocaml/runtime/intern.c:60">INTERN_STACK_INIT_SIZE</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L231">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_cleanup</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;intern_input != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp;&nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;intern_input);<br/></li>
<li>&nbsp; &nbsp;&nbsp; s-&gt;intern_input = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;intern_obj_table);<br/></li>
<li>&nbsp; &nbsp; s-&gt;intern_obj_table = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; s-&gt;intern_dest = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Comment">/* free the recursion stack */<br/></li>
<li></span>&nbsp; <a href="#L221" title="ocaml/runtime/intern.c:221">intern_free_stack</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L246">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">readfloat</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">double</span> * dest, <span class="Type">unsigned</span> <span class="Type">int</span> code)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">double</span>) != <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;input_value: non-standard floats&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L201" title="ocaml/runtime/intern.c:201">readblock</a>(s, (<span class="Type">char</span> *) dest, <span class="Constant">8</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Fix up endianness, if needed */<br/></li>
<li></span><span class="PreProc">#if <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x76543210<br/></li>
<li></span>&nbsp; <span class="Comment">/* Host is big-endian; fix up if data read is little-endian */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (code != <a href="caml/intext.h.html#L88" title="ocaml/runtime/caml/intext.h:88">CODE_DOUBLE_BIG</a>) <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(dest, dest);<br/></li>
<li><span class="PreProc">#elif <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x01234567<br/></li>
<li></span>&nbsp; <span class="Comment">/* Host is little-endian; fix up if data read is big-endian */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (code != <a href="caml/intext.h.html#L89" title="ocaml/runtime/caml/intext.h:89">CODE_DOUBLE_LITTLE</a>) <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(dest, dest);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <span class="Comment">/* Host is neither big nor little; permute as appropriate */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (code == <a href="caml/intext.h.html#L89" title="ocaml/runtime/caml/intext.h:89">CODE_DOUBLE_LITTLE</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/reverse.h.html#L54" title="ocaml/runtime/caml/reverse.h:54">Permute_64</a>(dest, <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a>, dest, <span class="Constant">0x01234567</span>)<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/reverse.h.html#L54" title="ocaml/runtime/caml/reverse.h:54">Permute_64</a>(dest, <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a>, dest, <span class="Constant">0x76543210</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* [len] is a number of floats */<br/></li>
<li><a id="L271">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">readfloats</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">double</span> * dest, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> len, <span class="Type">unsigned</span> <span class="Type">int</span> code)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> i;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">double</span>) != <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(<span class="Constant">&quot;input_value: non-standard floats&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L201" title="ocaml/runtime/intern.c:201">readblock</a>(s, (<span class="Type">char</span> *) dest, len * <span class="Constant">8</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Fix up endianness, if needed */<br/></li>
<li></span><span class="PreProc">#if <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x76543210<br/></li>
<li></span>&nbsp; <span class="Comment">/* Host is big-endian; fix up if data read is little-endian */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (code != <a href="caml/intext.h.html#L90" title="ocaml/runtime/caml/intext.h:90">CODE_DOUBLE_ARRAY8_BIG</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; code != <a href="caml/intext.h.html#L92" title="ocaml/runtime/caml/intext.h:92">CODE_DOUBLE_ARRAY32_BIG</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; len; i++) <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(dest + i, dest + i);<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#elif <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x01234567<br/></li>
<li></span>&nbsp; <span class="Comment">/* Host is little-endian; fix up if data read is big-endian */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (code != <a href="caml/intext.h.html#L91" title="ocaml/runtime/caml/intext.h:91">CODE_DOUBLE_ARRAY8_LITTLE</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; code != <a href="caml/intext.h.html#L93" title="ocaml/runtime/caml/intext.h:93">CODE_DOUBLE_ARRAY32_LITTLE</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; len; i++) <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(dest + i, dest + i);<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <span class="Comment">/* Host is neither big nor little; permute as appropriate */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (code == <a href="caml/intext.h.html#L91" title="ocaml/runtime/caml/intext.h:91">CODE_DOUBLE_ARRAY8_LITTLE</a> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; code == <a href="caml/intext.h.html#L93" title="ocaml/runtime/caml/intext.h:93">CODE_DOUBLE_ARRAY32_LITTLE</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; len; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L54" title="ocaml/runtime/caml/reverse.h:54">Permute_64</a>(dest + i, <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a>, dest + i, <span class="Constant">0x01234567</span>);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; len; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L54" title="ocaml/runtime/caml/reverse.h:54">Permute_64</a>(dest + i, <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a>, dest + i, <span class="Constant">0x76543210</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a href="caml/misc.h.html#L90" title="ocaml/runtime/caml/misc.h:90">CAMLnoreturn_start</a><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L310" title="ocaml/runtime/intern.c:310">intern_stack_overflow</a>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>*)<br/></li>
<li><a href="caml/misc.h.html#L91" title="ocaml/runtime/caml/misc.h:91">CAMLnoreturn_end</a>;<br/></li>
<li><br/></li>
<li><a id="L310">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_stack_overflow</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="misc.c.html#L95" title="ocaml/runtime/misc.c:95">caml_gc_message</a> (<span class="Constant">0x04</span>, <span class="Constant">&quot;Stack overflow in un-marshaling <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L317">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> * <span class="linkable">intern_resize_stack</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> * sp)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> newsize = <span class="Constant">2</span> * (s-&gt;intern_stack_limit - s-&gt;intern_stack);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> sp_offset = sp - s-&gt;intern_stack;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> * newstack;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (newsize &gt;= <a href="#L61" title="ocaml/runtime/intern.c:61">INTERN_STACK_MAX_SIZE</a>) <a href="#L310" title="ocaml/runtime/intern.c:310">intern_stack_overflow</a>(s);<br/></li>
<li>&nbsp; newstack = <a href="memory.c.html#L609" title="ocaml/runtime/memory.c:609">caml_stat_calloc_noexc</a>(newsize, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (newstack == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="#L310" title="ocaml/runtime/intern.c:310">intern_stack_overflow</a>(s);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Copy items from the old stack to the new stack */<br/></li>
<li></span>&nbsp; memcpy(newstack, s-&gt;intern_stack,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a>) * sp_offset);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Free to old stack if it is not the initial stack */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s-&gt;intern_stack != s-&gt;intern_stack_init)<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;intern_stack);<br/></li>
<li><br/></li>
<li>&nbsp; s-&gt;intern_stack = newstack;<br/></li>
<li>&nbsp; s-&gt;intern_stack_limit = newstack + newsize;<br/></li>
<li>&nbsp; <span class="Statement">return</span> newstack + sp_offset;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Convenience macros for requesting operation on the stack */<br/></li>
<li><a id="L342">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PushItem</span>(s)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">do</span><span class="PreProc"> {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; sp++;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (sp &gt;= s-&gt;intern_stack_limit) sp = <a href="#L317" title="ocaml/runtime/intern.c:317">intern_resize_stack</a>(s, sp);&nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; } </span><span class="Statement">while</span><span class="PreProc">(</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L348">&#x200c;</a><span class="PreProc">#define <span class="linkable">ReadItems</span>(s,_dest,_n)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">do</span><span class="PreProc"> {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; </span><span class="Statement">if</span><span class="PreProc"> (_n &gt; </span><span class="Constant">0</span><span class="PreProc">) {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; <a href="#L342" title="ocaml/runtime/intern.c:342">PushItem</a>(s);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; sp-&gt;op = OReadItems;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; sp-&gt;dest = _dest;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; sp-&gt;arg = _n;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; } </span><span class="Statement">while</span><span class="PreProc">(</span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L358">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_alloc_storage</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> whsize,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> num_objects)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wosize;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (whsize == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (s-&gt;intern_obj_table == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; wosize = <a href="caml/mlvalues.h.html#L179" title="ocaml/runtime/caml/mlvalues.h:179">Wosize_whsize</a>(whsize);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (wosize &lt;= <a href="caml/config.h.html#L221" title="ocaml/runtime/caml/config.h:221">Max_young_wosize</a> &amp;&amp; wosize != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; v = <a href="alloc.c.html#L158" title="ocaml/runtime/alloc.c:158">caml_alloc_small</a> (wosize, <a href="caml/mlvalues.h.html#L328" title="ocaml/runtime/caml/mlvalues.h:328">String_tag</a>);<br/></li>
<li>&nbsp; &nbsp; s-&gt;intern_dest = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> *) <a href="caml/mlvalues.h.html#L163" title="ocaml/runtime/caml/mlvalues.h:163">Hp_val</a>(v);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (s-&gt;intern_dest == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; s-&gt;obj_counter = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (num_objects &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; s-&gt;intern_obj_table =<br/></li>
<li>&nbsp; &nbsp; &nbsp; (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> *) <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(num_objects * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(s-&gt;intern_obj_table == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L391">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">intern_alloc_obj</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s, <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* d,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wosize, <a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">void</span>* p;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;intern_dest) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> ((<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)s-&gt;intern_dest &gt;= d-&gt;young_start &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)s-&gt;intern_dest &lt; d-&gt;young_end);<br/></li>
<li>&nbsp; &nbsp; p = s-&gt;intern_dest;<br/></li>
<li>&nbsp; &nbsp; *s-&gt;intern_dest = <a href="caml/gc.h.html#L32" title="ocaml/runtime/caml/gc.h:32">Make_header</a> (wosize, tag, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; s-&gt;intern_dest += <span class="Constant">1</span> + wosize;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; p = <a href="shared_heap.c.html#L397" title="ocaml/runtime/shared_heap.c:397">caml_shared_try_alloc</a>(d-&gt;shared_heap, wosize, tag,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span>, <span class="Comment">/* no reserved bits */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span> <span class="Comment">/* not pinned */</span>);<br/></li>
<li>&nbsp; &nbsp; d-&gt;allocated_words += <a href="caml/mlvalues.h.html#L178" title="ocaml/runtime/caml/mlvalues.h:178">Whsize_wosize</a>(wosize);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a> (s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L162" title="ocaml/runtime/caml/mlvalues.h:162">Hd_hp</a>(p) = <a href="caml/gc.h.html#L32" title="ocaml/runtime/caml/gc.h:32">Make_header</a> (wosize, tag, <a href="shared_heap.c.html#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.MARKED);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L416">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_rec</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> *dest)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> code;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> size, len, ofs_ind;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> ofs;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> header;<br/></li>
<li>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> digest[<span class="Constant">16</span>];<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/custom.h.html#L27" title="ocaml/runtime/caml/custom.h:27">custom_operations</a> * ops;<br/></li>
<li>&nbsp; <span class="Type">char</span> * codeptr;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L45" title="ocaml/runtime/intern.c:45">intern_item</a> * sp;<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a> * d = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>;<br/></li>
<li><br/></li>
<li>&nbsp; sp = s-&gt;intern_stack;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Initially let's try to read the first object from the stream */<br/></li>
<li></span>&nbsp; <a href="#L348" title="ocaml/runtime/intern.c:348">ReadItems</a>(s, dest, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* The un-marshaler loop, the recursion is unrolled */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span>(sp != s-&gt;intern_stack) {<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Interpret next item on the stack */<br/></li>
<li></span>&nbsp; dest = sp-&gt;dest;<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (sp-&gt;op) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> OFreshOID:<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Refresh the object ID */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* but do not do it for predefined exception slots */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>((<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)dest, <span class="Constant">1</span>)) &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="obj.c.html#L284" title="ocaml/runtime/obj.c:284">caml_set_oo_id</a>((<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)dest);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Pop item <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> iterate */<br/></li>
<li></span>&nbsp; &nbsp; sp--;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> OShift:<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Shift <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> by an offset */<br/></li>
<li></span>&nbsp; &nbsp; *dest += sp-&gt;arg;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Pop item <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> iterate */<br/></li>
<li></span>&nbsp; &nbsp; sp--;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> OReadItems:<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Pop item */<br/></li>
<li></span>&nbsp; &nbsp; sp-&gt;dest++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (--(sp-&gt;arg) == <span class="Constant">0</span>) sp--;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Read a <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> set v to this <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> */<br/></li>
<li></span>&nbsp; code = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (code &gt;= <a href="caml/intext.h.html#L73" title="ocaml/runtime/caml/intext.h:73">PREFIX_SMALL_INT</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code &gt;= <a href="caml/intext.h.html#L72" title="ocaml/runtime/caml/intext.h:72">PREFIX_SMALL_BLOCK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Small block */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; tag = code &amp; <span class="Constant">0xF</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; size = (code &gt;&gt; <span class="Constant">4</span>) &amp; <span class="Constant">0x7</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">read_block</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L419" title="ocaml/runtime/caml/mlvalues.h:419">Atom</a>(tag);<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="#L391" title="ocaml/runtime/intern.c:391">intern_alloc_obj</a> (s, d, size, tag);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_obj_table[s-&gt;obj_counter++] = v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* For objects, we need to freshen the oid */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tag == <a href="caml/mlvalues.h.html#L253" title="ocaml/runtime/caml/mlvalues.h:253">Object_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(size &gt;= <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Request to read rest of the elements of the block */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L348" title="ocaml/runtime/intern.c:348">ReadItems</a>(s, &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <span class="Constant">2</span>), size - <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Request freshing OID */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L342" title="ocaml/runtime/intern.c:342">PushItem</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;op = OFreshOID;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;dest = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*) v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;arg = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Finally read first two block elements: method table <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> old OID */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L348" title="ocaml/runtime/intern.c:348">ReadItems</a>(s, &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <span class="Constant">0</span>), <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* If it's not an object then read the contents of the block */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L348" title="ocaml/runtime/intern.c:348">ReadItems</a>(s, &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <span class="Constant">0</span>), size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Small integer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L81" title="ocaml/runtime/caml/mlvalues.h:81">Val_int</a>(code &amp; <span class="Constant">0x3F</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code &gt;= <a href="caml/intext.h.html#L74" title="ocaml/runtime/caml/intext.h:74">PREFIX_SMALL_STRING</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Small string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; len = (code &amp; <span class="Constant">0x1F</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">read_string</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; size = (len + <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)) / <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; v = <a href="#L391" title="ocaml/runtime/intern.c:391">intern_alloc_obj</a> (s, d, size, <a href="caml/mlvalues.h.html#L328" title="ocaml/runtime/caml/mlvalues.h:328">String_tag</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_obj_table[s-&gt;obj_counter++] = v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, size - <span class="Constant">1</span>) = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; ofs_ind = <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(size) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L315" title="ocaml/runtime/caml/mlvalues.h:315">Byte</a>(v, ofs_ind) = ofs_ind - len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L201" title="ocaml/runtime/intern.c:201">readblock</a>(s, (<span class="Type">char</span> *)<a href="caml/mlvalues.h.html#L329" title="ocaml/runtime/caml/mlvalues.h:329">String_val</a>(v), len);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span>(code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L75" title="ocaml/runtime/caml/intext.h:75">CODE_INT8</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(<a href="#L134" title="ocaml/runtime/intern.c:134">read8s</a>(s));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L76" title="ocaml/runtime/caml/intext.h:76">CODE_INT16</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(<a href="#L144" title="ocaml/runtime/intern.c:144">read16s</a>(s));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L77" title="ocaml/runtime/caml/intext.h:77">CODE_INT32</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(<a href="#L160" title="ocaml/runtime/intern.c:160">read32s</a>(s));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L78" title="ocaml/runtime/caml/intext.h:78">CODE_INT64</a>:<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>) (<a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: integer too large&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L79" title="ocaml/runtime/caml/intext.h:79">CODE_SHARED8</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ofs = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">read_shared</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!s-&gt;compressed) ofs = s-&gt;obj_counter - ofs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (ofs &lt; s-&gt;obj_counter);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = s-&gt;intern_obj_table[ofs];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L80" title="ocaml/runtime/caml/intext.h:80">CODE_SHARED16</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ofs = <a href="#L137" title="ocaml/runtime/intern.c:137">read16u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_shared;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L81" title="ocaml/runtime/caml/intext.h:81">CODE_SHARED32</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ofs = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_shared;<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L82" title="ocaml/runtime/caml/intext.h:82">CODE_SHARED64</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ofs = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_shared;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L83" title="ocaml/runtime/caml/intext.h:83">CODE_BLOCK32</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; header = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>) <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tag = <a href="caml/mlvalues.h.html#L129" title="ocaml/runtime/caml/mlvalues.h:129">Tag_hd</a>(header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="caml/mlvalues.h.html#L131" title="ocaml/runtime/caml/mlvalues.h:131">Wosize_hd</a>(header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_block;<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L84" title="ocaml/runtime/caml/intext.h:84">CODE_BLOCK64</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; header = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>) <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tag = <a href="caml/mlvalues.h.html#L129" title="ocaml/runtime/caml/mlvalues.h:129">Tag_hd</a>(header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="caml/mlvalues.h.html#L131" title="ocaml/runtime/caml/mlvalues.h:131">Wosize_hd</a>(header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_block;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L85" title="ocaml/runtime/caml/intext.h:85">CODE_STRING8</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_string;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L86" title="ocaml/runtime/caml/intext.h:86">CODE_STRING32</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_string;<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L87" title="ocaml/runtime/caml/intext.h:87">CODE_STRING64</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_string;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L89" title="ocaml/runtime/caml/intext.h:89">CODE_DOUBLE_LITTLE</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L88" title="ocaml/runtime/caml/intext.h:88">CODE_DOUBLE_BIG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="#L391" title="ocaml/runtime/intern.c:391">intern_alloc_obj</a> (s, d, <a href="caml/mlvalues.h.html#L337" title="ocaml/runtime/caml/mlvalues.h:337">Double_wosize</a>, <a href="caml/mlvalues.h.html#L336" title="ocaml/runtime/caml/mlvalues.h:336">Double_tag</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_obj_table[s-&gt;obj_counter++] = v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L246" title="ocaml/runtime/intern.c:246">readfloat</a>(s, (<span class="Type">double</span> *) v, code);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L91" title="ocaml/runtime/caml/intext.h:91">CODE_DOUBLE_ARRAY8_LITTLE</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L90" title="ocaml/runtime/caml/intext.h:90">CODE_DOUBLE_ARRAY8_BIG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">read_double_array</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; size = len * <a href="caml/mlvalues.h.html#L337" title="ocaml/runtime/caml/mlvalues.h:337">Double_wosize</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="#L391" title="ocaml/runtime/intern.c:391">intern_alloc_obj</a> (s, d, size, <a href="caml/mlvalues.h.html#L349" title="ocaml/runtime/caml/mlvalues.h:349">Double_array_tag</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_obj_table[s-&gt;obj_counter++] = v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L271" title="ocaml/runtime/intern.c:271">readfloats</a>(s, (<span class="Type">double</span> *) v, len, code);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L93" title="ocaml/runtime/caml/intext.h:93">CODE_DOUBLE_ARRAY32_LITTLE</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L92" title="ocaml/runtime/caml/intext.h:92">CODE_DOUBLE_ARRAY32_BIG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_double_array;<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L95" title="ocaml/runtime/caml/intext.h:95">CODE_DOUBLE_ARRAY64_LITTLE</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L94" title="ocaml/runtime/caml/intext.h:94">CODE_DOUBLE_ARRAY64_BIG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> read_double_array;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L96" title="ocaml/runtime/caml/intext.h:96">CODE_CODEPOINTER</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ofs = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L201" title="ocaml/runtime/intern.c:201">readblock</a>(s, digest, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; codeptr = <a href="#L1015" title="ocaml/runtime/intern.c:1015">intern_resolve_code_pointer</a>(digest, ofs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (codeptr != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) codeptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * function_placeholder =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="callback.c.html#L367" title="ocaml/runtime/callback.c:367">caml_named_value</a> (<span class="Constant">&quot;Debugger.function_placeholder&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (function_placeholder != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Use the code pointer from the &quot;placeholder&quot; function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) <a href="caml/mlvalues.h.html#L276" title="ocaml/runtime/caml/mlvalues.h:276">Code_val</a>(*function_placeholder);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1025" title="ocaml/runtime/intern.c:1025">intern_bad_code_pointer</a>(digest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L97" title="ocaml/runtime/caml/intext.h:97">CODE_INFIXPOINTER</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ofs = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Read a <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> to *dest, then offset *dest by ofs */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L342" title="ocaml/runtime/intern.c:342">PushItem</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;dest = dest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;op = OShift;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;arg = ofs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L348" title="ocaml/runtime/intern.c:348">ReadItems</a>(s, dest, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;&nbsp; <span class="Comment">/* with next iteration of main loop, skipping *dest = v */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L98" title="ocaml/runtime/caml/intext.h:98">OLD_CODE_CUSTOM</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: custom blocks serialized with &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCaml 4.08.0 (<a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> prior) are no longer supported&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L99" title="ocaml/runtime/caml/intext.h:99">CODE_CUSTOM_LEN</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L100" title="ocaml/runtime/caml/intext.h:100">CODE_CUSTOM_FIXED</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> expected_size, temp_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ops = <a href="custom.c.html#L145" title="ocaml/runtime/custom.c:145">caml_find_custom_operations</a>((<span class="Type">char</span> *) s-&gt;intern_src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ops == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: unknown custom block identifier&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (code == <a href="caml/intext.h.html#L100" title="ocaml/runtime/caml/intext.h:100">CODE_CUSTOM_FIXED</a> &amp;&amp; ops-&gt;fixed_length == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: expected a fixed-size custom block&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (*s-&gt;intern_src++ != <span class="Constant">0</span>) <span class="Comment">/*nothing*/</span>;&nbsp; <span class="Comment">/*skip identifier*/<br/></li>
<li></span><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (code == <a href="caml/intext.h.html#L100" title="ocaml/runtime/caml/intext.h:100">CODE_CUSTOM_FIXED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expected_size = ops-&gt;fixed_length-&gt;bsize_64;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_src += <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expected_size = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (code == <a href="caml/intext.h.html#L100" title="ocaml/runtime/caml/intext.h:100">CODE_CUSTOM_FIXED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expected_size = ops-&gt;fixed_length-&gt;bsize_32;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expected_size = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_src += <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; temp_size = <span class="Constant">1</span> + (expected_size + <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) - <span class="Constant">1</span>) / <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="#L391" title="ocaml/runtime/intern.c:391">intern_alloc_obj</a>(s, d, temp_size, <a href="caml/mlvalues.h.html#L401" title="ocaml/runtime/caml/mlvalues.h:401">Custom_tag</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(v) = ops;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = ops-&gt;deserialize(<a href="caml/mlvalues.h.html#L402" title="ocaml/runtime/caml/mlvalues.h:402">Data_custom_val</a>(v));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size != expected_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;input_value: incorrect length of serialized custom block&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;intern_obj_table != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;intern_obj_table[s-&gt;obj_counter++] = v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ops-&gt;finalize != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> &amp;&amp; <a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a>(v)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Remember that the block has a finalizer. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/minor_gc.h.html#L119" title="ocaml/runtime/caml/minor_gc.h:119">add_to_custom_table</a> (&amp;d-&gt;minor_tables-&gt;custom, v, <span class="Constant">0</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: ill-formed message&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* end of case OReadItems */<br/></li>
<li></span>&nbsp; <span class="Comment">/* The following direct-assignment to [*dest] rather than [<a href="memory.c.html#L149" title="ocaml/runtime/memory.c:149">caml_modify</a>] is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; safe since either it is the case that<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; 1. [dest] points within the minor heap of the current domain <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; 2. [dest] is a freshly-allocated major heap block, but not yet visible<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to the GC, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> if [v] is a block, then it is also in the major heap.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; So no major to minor heap references are created.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; Moreover, since [*dest] is uninitialised, using `<a href="memory.c.html#L149" title="ocaml/runtime/memory.c:149">caml_modify</a>` is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; incorrect; the deletion barrier will <a href="major_gc.c.html#L993" title="ocaml/runtime/major_gc.c:993">mark</a> the old uninitialised <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; may crash. */<br/></li>
<li></span>&nbsp; *dest = v;<br/></li>
<li>&nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* We are done. Cleanup the stack <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> leave the function */<br/></li>
<li></span>&nbsp; <a href="#L221" title="ocaml/runtime/intern.c:221">intern_free_stack</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L701">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">intern_end</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a>(res);<br/></li>
<li>&nbsp; <span class="Comment">/* Free everything */<br/></li>
<li></span>&nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Give gc a chance to run, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> run memprof callbacks */<br/></li>
<li></span>&nbsp; <a href="signals.c.html#L360" title="ocaml/runtime/signals.c:360">caml_process_pending_actions</a>();<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Parsing the header */<br/></li>
<li></span><br/></li>
<li><a id="L715">&#x200c;</a><span class="Type">struct</span> <span class="linkable">marshal_header</span> {<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> magic;<br/></li>
<li>&nbsp; <span class="Type">int</span> header_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> data_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> uncompressed_data_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> num_objects;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> whsize;<br/></li>
<li>&nbsp; <span class="Type">int</span> compressed;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L725">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_failwith2</span>(<span class="Type">const</span> <span class="Type">char</span> * fun_name, <span class="Type">const</span> <span class="Type">char</span> * msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> errmsg[<span class="Constant">100</span>];<br/></li>
<li>&nbsp; errmsg[<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(errmsg) - <span class="Constant">1</span>] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L550" title="ocaml/runtime/caml/misc.h:550">snprintf</a>(errmsg, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(errmsg) - <span class="Constant">1</span>, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, fun_name, msg);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(errmsg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L733">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">caml_parse_header</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * fun_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*out*/</span> <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> * h)<br/></li>
<li>{<br/></li>
<li>&nbsp; h-&gt;magic = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; <span class="Statement">switch</span>(h-&gt;magic) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L29" title="ocaml/runtime/caml/intext.h:29">Intext_magic_number_small</a>:<br/></li>
<li>&nbsp; &nbsp; h-&gt;header_len = <span class="Constant">20</span>;<br/></li>
<li>&nbsp; &nbsp; h-&gt;compressed = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; h-&gt;data_len = h-&gt;uncompressed_data_len = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; h-&gt;num_objects = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; h-&gt;whsize = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; h-&gt;whsize = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L30" title="ocaml/runtime/caml/intext.h:30">Intext_magic_number_big</a>:<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; h-&gt;header_len = <span class="Constant">32</span>;<br/></li>
<li>&nbsp; &nbsp; h-&gt;compressed = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; h-&gt;data_len = h-&gt;uncompressed_data_len = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; h-&gt;num_objects = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li>&nbsp; &nbsp; h-&gt;whsize = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L725" title="ocaml/runtime/intern.c:725">intern_failwith2</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; (fun_name, <span class="Constant">&quot;object too large to be read back on a 32-bit platform&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L31" title="ocaml/runtime/caml/intext.h:31">Intext_magic_number_compressed</a>:<br/></li>
<li>&nbsp; &nbsp; h-&gt;header_len = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s) &amp; <span class="Constant">0x3F</span>;<br/></li>
<li>&nbsp; &nbsp; h-&gt;compressed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> overflow = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; overflow |= <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, &amp;h-&gt;data_len);<br/></li>
<li>&nbsp; &nbsp; overflow |= <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, &amp;h-&gt;uncompressed_data_len);<br/></li>
<li>&nbsp; &nbsp; overflow |= <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, &amp;h-&gt;num_objects);<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; overflow |= <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, &amp;h-&gt;whsize);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; overflow |= <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, &amp;h-&gt;whsize);<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (overflow) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L725" title="ocaml/runtime/intern.c:725">intern_failwith2</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (fun_name, <span class="Constant">&quot;object too large to be read back on this platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="#L725" title="ocaml/runtime/intern.c:725">intern_failwith2</a>(fun_name, <span class="Constant">&quot;bad object&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Decompress the input if needed.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Must be called after [<a href="#L208" title="ocaml/runtime/intern.c:208">intern_init</a>].<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Should preferably be called before [<a href="#L358" title="ocaml/runtime/intern.c:358">intern_alloc_storage</a>]<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; when the memory block for the compressed input can be freed<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; before more memory is allocated. */<br/></li>
<li></span><br/></li>
<li><a id="L795">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_decompress_input</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a> * s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> * fun_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> * h)<br/></li>
<li>{<br/></li>
<li>&nbsp; s-&gt;compressed = h-&gt;compressed;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (! h-&gt;compressed) <span class="Statement">return</span>;<br/></li>
<li><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li></span>&nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * blk = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(h-&gt;uncompressed_data_len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (blk == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Type">size_t</span> res =<br/></li>
<li>&nbsp; &nbsp; ZSTD_decompress(blk, h-&gt;uncompressed_data_len, s-&gt;intern_src, h-&gt;data_len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (res != h-&gt;uncompressed_data_len) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(blk);<br/></li>
<li>&nbsp; &nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="#L725" title="ocaml/runtime/intern.c:725">intern_failwith2</a>(fun_name, <span class="Constant">&quot;decompression <a href="startup_byt.c.html#L77" title="ocaml/runtime/startup_byt.c:77">error</a>&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;intern_input != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;intern_input);<br/></li>
<li>&nbsp; s-&gt;intern_input = blk;&nbsp; <span class="Comment">/* to be freed at end of demarshaling */<br/></li>
<li></span>&nbsp; s-&gt;intern_src = blk;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; <a href="#L725" title="ocaml/runtime/intern.c:725">intern_failwith2</a>(fun_name, <span class="Constant">&quot;compressed object, cannot decompress&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Reading from a <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> */<br/></li>
<li></span><br/></li>
<li><a id="L825">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_val</span>(<span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> *chan)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> r;<br/></li>
<li>&nbsp; <span class="Type">char</span> header[<a href="caml/intext.h.html#L68" title="ocaml/runtime/caml/intext.h:68">MAX_INTEXT_HEADER_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> h;<br/></li>
<li>&nbsp; <span class="Type">char</span> * block;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (! <a href="io.c.html#L227" title="ocaml/runtime/io.c:227">caml_channel_binary_mode</a>(chan))<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: not a binary <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a>&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Read the magic number <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> determine the size of the header */<br/></li>
<li></span>&nbsp; r = <a href="io.c.html#L416" title="ocaml/runtime/io.c:416">caml_really_getblock</a>(chan, header, <span class="Constant">5</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (r == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L168" title="ocaml/runtime/fail_nat.c:168">caml_raise_end_of_file</a>();<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (r &lt; <span class="Constant">5</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: truncated object&quot;</span>);<br/></li>
<li>&nbsp; s-&gt;intern_src = (<span class="Type">unsigned</span> <span class="Type">char</span> *) header;<br/></li>
<li>&nbsp; <span class="Type">int</span> hlen;<br/></li>
<li>&nbsp; <span class="Statement">switch</span> (<a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s)) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L30" title="ocaml/runtime/caml/intext.h:30">Intext_magic_number_big</a>:<br/></li>
<li>&nbsp; &nbsp; hlen = <span class="Constant">32</span>; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L31" title="ocaml/runtime/caml/intext.h:31">Intext_magic_number_compressed</a>:<br/></li>
<li>&nbsp; &nbsp; hlen = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s) &amp; <span class="Constant">0x3F</span>; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; hlen = <span class="Constant">20</span>; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Read the remainder of the header */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (hlen &gt; <span class="Constant">5</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="io.c.html#L416" title="ocaml/runtime/io.c:416">caml_really_getblock</a>(chan, header + <span class="Constant">5</span>, hlen - <span class="Constant">5</span>) &lt; hlen - <span class="Constant">5</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: truncated object&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Parse the full header */<br/></li>
<li></span>&nbsp; s-&gt;intern_src = (<span class="Type">unsigned</span> <span class="Type">char</span> *) header;<br/></li>
<li>&nbsp; <a href="#L733" title="ocaml/runtime/intern.c:733">caml_parse_header</a>(s, <span class="Constant">&quot;input_value&quot;</span>, &amp;h);<br/></li>
<li>&nbsp; <span class="Comment">/* Read block from <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> */<br/></li>
<li></span>&nbsp; <span class="Comment">/* During <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> I/O, concurrent [<a href="#L825" title="ocaml/runtime/intern.c:825">caml_input_val</a>] operations<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; can take place (via context switching in systhreads),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> the context [s] may change.&nbsp; So, wait until all I/O is over<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; before using the context [s] again. */<br/></li>
<li></span>&nbsp; block = <a href="memory.c.html#L550" title="ocaml/runtime/memory.c:550">caml_stat_alloc</a>(h.data_len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="io.c.html#L416" title="ocaml/runtime/io.c:416">caml_really_getblock</a>(chan, block, h.data_len) &lt; h.data_len) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(block);<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_value: truncated object&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Initialize global state */<br/></li>
<li></span>&nbsp; <a href="#L208" title="ocaml/runtime/intern.c:208">intern_init</a>(s, block, block);<br/></li>
<li>&nbsp; <a href="#L795" title="ocaml/runtime/intern.c:795">intern_decompress_input</a>(s, <span class="Constant">&quot;input_value&quot;</span>, &amp;h);<br/></li>
<li>&nbsp; <a href="#L358" title="ocaml/runtime/intern.c:358">intern_alloc_storage</a>(s, h.whsize, h.num_objects);<br/></li>
<li>&nbsp; <span class="Comment">/* Fill it in */<br/></li>
<li></span>&nbsp; <a href="#L416" title="ocaml/runtime/intern.c:416">intern_rec</a>(s, &amp;res);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L701" title="ocaml/runtime/intern.c:701">intern_end</a>(s, res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L878">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_value</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vchan)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a> (vchan);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> * chan = <a href="caml/io.h.html#L98" title="ocaml/runtime/caml/io.h:98">Channel</a>(vchan);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a> (res);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/io.h.html#L109" title="ocaml/runtime/caml/io.h:109">Lock</a>(chan);<br/></li>
<li>&nbsp; res = <a href="#L825" title="ocaml/runtime/intern.c:825">caml_input_val</a>(chan);<br/></li>
<li>&nbsp; <a href="caml/io.h.html#L111" title="ocaml/runtime/caml/io.h:111">Unlock</a>(chan);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Reading from memory-resident blocks */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* </span><span class="Todo">XXX</span><span class="Comment"> KC: Unused primitive. Remove with bootstrap. */<br/></li>
<li><a id="L893">&#x200c;</a></span><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_value_to_outside_heap</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vchan)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L878" title="ocaml/runtime/intern.c:878">caml_input_value</a>(vchan);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L898">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_val_from_bytes</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> str, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> ofs)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a> (str);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a> (obj);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> h;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Initialize global state */<br/></li>
<li></span>&nbsp; <a href="#L208" title="ocaml/runtime/intern.c:208">intern_init</a>(s, &amp;<a href="caml/mlvalues.h.html#L316" title="ocaml/runtime/caml/mlvalues.h:316">Byte_u</a>(str, ofs), <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; <a href="#L733" title="ocaml/runtime/intern.c:733">caml_parse_header</a>(s, <span class="Constant">&quot;input_val_from_string&quot;</span>, &amp;h);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ofs + h.header_len + h.data_len &gt; <a href="str.c.html#L31" title="ocaml/runtime/str.c:31">caml_string_length</a>(str))<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;input_val_from_string: bad length&quot;</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Allocate result */<br/></li>
<li></span>&nbsp; <a href="#L358" title="ocaml/runtime/intern.c:358">intern_alloc_storage</a>(s, h.whsize, h.num_objects);<br/></li>
<li>&nbsp; s-&gt;intern_src = &amp;<a href="caml/mlvalues.h.html#L316" title="ocaml/runtime/caml/mlvalues.h:316">Byte_u</a>(str, ofs + h.header_len); <span class="Comment">/* If a GC occurred */<br/></li>
<li></span>&nbsp; <span class="Comment">/* Decompress if needed */<br/></li>
<li></span>&nbsp; <a href="#L795" title="ocaml/runtime/intern.c:795">intern_decompress_input</a>(s, <span class="Constant">&quot;input_val_from_string&quot;</span>, &amp;h);<br/></li>
<li>&nbsp; <span class="Comment">/* Fill it in */<br/></li>
<li></span>&nbsp; <a href="#L416" title="ocaml/runtime/intern.c:416">intern_rec</a>(s, &amp;obj);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (<a href="#L701" title="ocaml/runtime/intern.c:701">intern_end</a>(s, obj));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L920">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_value_from_bytes</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> str, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofs)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L898" title="ocaml/runtime/intern.c:898">caml_input_val_from_bytes</a>(str, <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(ofs));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L925">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">input_val_from_block</span>(<span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> * h)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> obj;<br/></li>
<li>&nbsp; <span class="Comment">/* Decompress if needed */<br/></li>
<li></span>&nbsp; <a href="#L795" title="ocaml/runtime/intern.c:795">intern_decompress_input</a>(s, <span class="Constant">&quot;<a href="#L925" title="ocaml/runtime/intern.c:925">input_val_from_block</a>&quot;</span>, h);<br/></li>
<li>&nbsp; <span class="Comment">/* Allocate result */<br/></li>
<li></span>&nbsp; <a href="#L358" title="ocaml/runtime/intern.c:358">intern_alloc_storage</a>(s, h-&gt;whsize, h-&gt;num_objects);<br/></li>
<li>&nbsp; <span class="Comment">/* Fill it in */<br/></li>
<li></span>&nbsp; <a href="#L416" title="ocaml/runtime/intern.c:416">intern_rec</a>(s, &amp;obj);<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<a href="#L701" title="ocaml/runtime/intern.c:701">intern_end</a>(s, obj));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L938">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_value_from_malloc</span>(<span class="Type">char</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> ofs)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> h;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L208" title="ocaml/runtime/intern.c:208">intern_init</a>(s, data + ofs, data);<br/></li>
<li>&nbsp; <a href="#L733" title="ocaml/runtime/intern.c:733">caml_parse_header</a>(s, <span class="Constant">&quot;input_value_from_malloc&quot;</span>, &amp;h);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L925" title="ocaml/runtime/intern.c:925">input_val_from_block</a>(s, &amp;h);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* [len] is a number of bytes */<br/></li>
<li><a id="L949">&#x200c;</a></span><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_input_value_from_block</span>(<span class="Type">const</span> <span class="Type">char</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L715" title="ocaml/runtime/intern.c:715">marshal_header</a> h;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Initialize global state */<br/></li>
<li></span>&nbsp; <a href="#L208" title="ocaml/runtime/intern.c:208">intern_init</a>(s, data, <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; <a href="#L733" title="ocaml/runtime/intern.c:733">caml_parse_header</a>(s, <span class="Constant">&quot;input_value_from_block&quot;</span>, &amp;h);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (h.header_len + h.data_len &gt; len)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;<a href="#L925" title="ocaml/runtime/intern.c:925">input_val_from_block</a>: bad length&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L925" title="ocaml/runtime/intern.c:925">input_val_from_block</a>(s, &amp;h);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* [ofs] is a [<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>] that represents a number of bytes<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; result is a [<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>] that represents a number of bytes<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; To handle all marshaling formats,<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; we assume 16 bytes are available at [buff + ofs],<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> we return the data size + the length of the part of the header<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; that remains to be read.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; 16 bytes are necessary <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> sufficient because:<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; - for the &quot;small&quot; model: the length is at positions 4 to 7<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; - for the &quot;big&quot; model: the length is at positions 8 to 15<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; - for the &quot;compressed&quot; model: the length is at positions 5 to at most 14<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; 16 bytes is not too much because the smallest marshalled object<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; is 20 bytes long (a small integer in the &quot;compressed&quot; model),<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; so we're not reading past the end of the data.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L977">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_marshal_data_size</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> buff, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofs)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> magic;<br/></li>
<li>&nbsp; <span class="Type">int</span> header_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> data_len;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a> *s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; s-&gt;intern_src = &amp;<a href="caml/mlvalues.h.html#L316" title="ocaml/runtime/caml/mlvalues.h:316">Byte_u</a>(buff, <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(ofs));<br/></li>
<li>&nbsp; magic = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; <span class="Statement">switch</span>(magic) {<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L29" title="ocaml/runtime/caml/intext.h:29">Intext_magic_number_small</a>:<br/></li>
<li>&nbsp; &nbsp; header_len = <span class="Constant">20</span>;<br/></li>
<li>&nbsp; &nbsp; data_len = <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L30" title="ocaml/runtime/caml/intext.h:30">Intext_magic_number_big</a>:<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; header_len = <span class="Constant">32</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>&nbsp; &nbsp; data_len = <a href="#L170" title="ocaml/runtime/intern.c:170">read64u</a>(s);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;Marshal.data_size: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;object too large to be read back on a 32-bit platform&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">case</span> <a href="caml/intext.h.html#L31" title="ocaml/runtime/caml/intext.h:31">Intext_magic_number_compressed</a>:<br/></li>
<li>&nbsp; &nbsp; header_len = <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s) &amp; <span class="Constant">0x3F</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L186" title="ocaml/runtime/intern.c:186">readvlq</a>(s, &amp;data_len) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;Marshal.data_size: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;object too large to be read back on this platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;Marshal.data_size: bad object&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>((header_len - <span class="Constant">16</span>) + data_len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Resolution of code pointers */<br/></li>
<li></span><br/></li>
<li><a id="L1015">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> * <span class="linkable">intern_resolve_code_pointer</span>(<span class="Type">unsigned</span> <span class="Type">char</span> digest[<span class="Constant">16</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/codefrag.h.html#L33" title="ocaml/runtime/caml/codefrag.h:33">code_fragment</a> * cf = <a href="codefrag.c.html#L152" title="ocaml/runtime/codefrag.c:152">caml_find_code_fragment_by_digest</a>(digest);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (cf != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> &amp;&amp; cf-&gt;code_start + offset &lt; cf-&gt;code_end)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cf-&gt;code_start + offset;<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1025">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">intern_bad_code_pointer</span>(<span class="Type">unsigned</span> <span class="Type">char</span> digest[<span class="Constant">16</span>])<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> msg[<span class="Constant">256</span>];<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L550" title="ocaml/runtime/caml/misc.h:550">snprintf</a>(msg, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(msg),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;input_value: unknown code module &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%02X%02X%02X%02X%02X%02X%02X%02X</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%02X%02X%02X%02X%02X%02X%02X%02X</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digest[<span class="Constant">0</span>], digest[<span class="Constant">1</span>], digest[<span class="Constant">2</span>], digest[<span class="Constant">3</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digest[<span class="Constant">4</span>], digest[<span class="Constant">5</span>], digest[<span class="Constant">6</span>], digest[<span class="Constant">7</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digest[<span class="Constant">8</span>], digest[<span class="Constant">9</span>], digest[<span class="Constant">10</span>], digest[<span class="Constant">11</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digest[<span class="Constant">12</span>], digest[<span class="Constant">13</span>], digest[<span class="Constant">14</span>], digest[<span class="Constant">15</span>]);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Functions for writing user-defined marshallers */<br/></li>
<li></span><br/></li>
<li><a id="L1041">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">int</span> <span class="linkable">caml_deserialize_uint_1</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L131" title="ocaml/runtime/intern.c:131">read8u</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1047">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">int</span> <span class="linkable">caml_deserialize_sint_1</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L134" title="ocaml/runtime/intern.c:134">read8s</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1053">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">int</span> <span class="linkable">caml_deserialize_uint_2</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L137" title="ocaml/runtime/intern.c:137">read16u</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1059">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">int</span> <span class="linkable">caml_deserialize_sint_2</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L144" title="ocaml/runtime/intern.c:144">read16s</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1065">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type"><a href="caml/config.h.html#L126" title="ocaml/runtime/caml/config.h:126">uint32_t</a></span> <span class="linkable">caml_deserialize_uint_4</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L151" title="ocaml/runtime/intern.c:151">read32u</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1071">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> <span class="linkable">caml_deserialize_sint_4</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L160" title="ocaml/runtime/intern.c:160">read32s</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1077">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> <span class="linkable">caml_deserialize_uint_8</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L128" title="ocaml/runtime/caml/config.h:128">uint64_t</a></span> i;<br/></li>
<li>&nbsp; <a href="#L1140" title="ocaml/runtime/intern.c:1140">caml_deserialize_block_8</a>(&amp;i, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> i;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1084">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> <span class="linkable">caml_deserialize_sint_8</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> i;<br/></li>
<li>&nbsp; <a href="#L1140" title="ocaml/runtime/intern.c:1140">caml_deserialize_block_8</a>(&amp;i, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> i;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1091">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">float</span> <span class="linkable">caml_deserialize_float_4</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">float</span> f;<br/></li>
<li>&nbsp; <a href="#L1126" title="ocaml/runtime/intern.c:1126">caml_deserialize_block_4</a>(&amp;f, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> f;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1098">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">double</span> <span class="linkable">caml_deserialize_float_8</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">double</span> f;<br/></li>
<li>&nbsp; <a href="#L1154" title="ocaml/runtime/intern.c:1154">caml_deserialize_block_float_8</a>(&amp;f, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> f;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1105">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_deserialize_block_1</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; memcpy(data, s-&gt;intern_src, len);<br/></li>
<li>&nbsp; s-&gt;intern_src += len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1112">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_deserialize_block_2</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><span class="PreProc">#ifndef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> * p, * q;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (p = s-&gt;intern_src, q = data; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">2</span>, q += <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/reverse.h.html#L23" title="ocaml/runtime/caml/reverse.h:23">Reverse_16</a>(q, p);<br/></li>
<li>&nbsp; s-&gt;intern_src = p;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; memcpy(data, s-&gt;intern_src, len * <span class="Constant">2</span>);<br/></li>
<li>&nbsp; s-&gt;intern_src += len * <span class="Constant">2</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1126">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_deserialize_block_4</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><span class="PreProc">#ifndef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> * p, * q;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (p = s-&gt;intern_src, q = data; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">4</span>, q += <span class="Constant">4</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/reverse.h.html#L32" title="ocaml/runtime/caml/reverse.h:32">Reverse_32</a>(q, p);<br/></li>
<li>&nbsp; s-&gt;intern_src = p;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; memcpy(data, s-&gt;intern_src, len * <span class="Constant">4</span>);<br/></li>
<li>&nbsp; s-&gt;intern_src += len * <span class="Constant">4</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1140">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_deserialize_block_8</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><span class="PreProc">#ifndef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> * p, * q;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (p = s-&gt;intern_src, q = data; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">8</span>, q += <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(q, p);<br/></li>
<li>&nbsp; s-&gt;intern_src = p;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; memcpy(data, s-&gt;intern_src, len * <span class="Constant">8</span>);<br/></li>
<li>&nbsp; s-&gt;intern_src += len * <span class="Constant">8</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1154">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_deserialize_block_float_8</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li><span class="PreProc">#if <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x01234567<br/></li>
<li></span>&nbsp; memcpy(data, s-&gt;intern_src, len * <span class="Constant">8</span>);<br/></li>
<li>&nbsp; s-&gt;intern_src += len * <span class="Constant">8</span>;<br/></li>
<li><span class="PreProc">#elif <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x76543210<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> * p, * q;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (p = s-&gt;intern_src, q = data; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">8</span>, q += <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(q, p);<br/></li>
<li>&nbsp; s-&gt;intern_src = p;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span> * p, * q;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (p = s-&gt;intern_src, q = data; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">8</span>, q += <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/reverse.h.html#L54" title="ocaml/runtime/caml/reverse.h:54">Permute_64</a>(q, <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a>, p, <span class="Constant">0x01234567</span>);<br/></li>
<li>&nbsp; s-&gt;intern_src = p;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1173">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_deserialize_error</span>(<span class="Type">char</span> * msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L63" title="ocaml/runtime/intern.c:63">caml_intern_state</a>* s = <a href="#L95" title="ocaml/runtime/intern.c:95">get_intern_state</a> ();<br/></li>
<li>&nbsp; <a href="#L231" title="ocaml/runtime/intern.c:231">intern_cleanup</a>(s);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(msg);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

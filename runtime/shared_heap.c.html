<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/shared_heap.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/shared_heap.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L51">Bsize_wsize</a></li>
<li><a href="#L656">atoms</a></li>
<li><a href="#L39">caml_global_heap_state</a></li>
<li><a href="#L70">pool_freelist</a></li>
<li><a href="#L737">verify_scanning_flags</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L80">caml_heap_state</a></li>
<li><a href="#L703">heap_verify_state</a></li>
<li><a href="#L54">large_alloc</a></li>
<li><a href="#L57">large_alloc</a></li>
<li><a href="#L789">mem_stats</a></li>
<li><a href="#L45">pool</a></li>
<li><a href="#L50">pool</a></li>
<li><a href="#L36">sizeclass</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L634">adopt_all_pool_stats_with_lock</a></li>
<li><a href="#L622">adopt_pool_stats_with_lock</a></li>
<li><a href="#L211">calc_pool_stats</a></li>
<li><a href="#L647">caml_accum_orphan_heap_stats</a></li>
<li><a href="#L689">caml_atom</a></li>
<li><a href="#L639">caml_collect_heap_stats_sample</a></li>
<li><a href="#L892">caml_cycle_heap</a></li>
<li><a href="#L882">caml_cycle_heap_stw</a></li>
<li><a href="#L591">caml_heap_blocks</a></li>
<li><a href="#L580">caml_heap_size</a></li>
<li><a href="#L693">caml_init_major_heap</a></li>
<li><a href="#L102">caml_init_shared_heap</a></li>
<li><a href="#L436">caml_pool_of_shared_block</a></li>
<li><a href="#L595">caml_redarken_pool</a></li>
<li><a href="#L397">caml_shared_try_alloc</a></li>
<li><a href="#L546">caml_sweep</a></li>
<li><a href="#L134">caml_teardown_shared_heap</a></li>
<li><a href="#L584">caml_top_heap_words</a></li>
<li><a href="#L711">caml_verify_begin</a></li>
<li><a href="#L776">caml_verify_heap</a></li>
<li><a href="#L732">caml_verify_root</a></li>
<li><a href="#L515">large_alloc_sweep</a></li>
<li><a href="#L384">large_allocate</a></li>
<li><a href="#L121">move_all_pools</a></li>
<li><a href="#L614">orphan_heap_stats_with_lock</a></li>
<li><a href="#L170">pool_acquire</a></li>
<li><a href="#L363">pool_allocate</a></li>
<li><a href="#L327">pool_find</a></li>
<li><a href="#L266">pool_global_adopt</a></li>
<li><a href="#L233">pool_initialize</a></li>
<li><a href="#L197">pool_release</a></li>
<li><a href="#L450">pool_sweep</a></li>
<li><a href="#L829">verify_large</a></li>
<li><a href="#L739">verify_object</a></li>
<li><a href="#L799">verify_pool</a></li>
<li><a href="#L719">verify_push</a></li>
<li><a href="#L839">verify_swept</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L657">A</a></li>
<li><a href="#L686">A</a></li>
<li><a href="#L16">CAML_INTERNALS</a></li>
<li><a href="#L59">LARGE_ALLOC_HEADER_SZ</a></li>
<li><a href="#L169">POOLS_PER_ALLOCATION</a></li>
<li><a href="#L52">POOL_HEADER_SZ</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; KC Sivaramakrishnan, Indian Institute of Technology, Madras&nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Stephen Dolan, University of Cambridge&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 2015 Indian Institute of Technology, Madras&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 2015 University of Cambridge&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li><a id="L16">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/<a href="caml/addrmap.h.html#L23" title="ocaml/runtime/caml/addrmap.h:23">addrmap</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/custom.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/runtime_events.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fiber.h&quot;</span> <span class="Comment">/* for verification */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/gc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/globroots.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/platform.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/roots.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/shared_heap.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/sizeclasses.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/startup_aux.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L36">&#x200c;</a><span class="Type">typedef</span> <span class="Type">unsigned</span> <span class="Type">int</span> <span class="linkable">sizeclass</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* Initial MARKED, UNMARKED, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> GARBAGE values; any permutation would work */<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="Type">struct</span> <a href="caml/shared_heap.h.html#L55" title="ocaml/runtime/caml/shared_heap.h:55">global_heap_state</a> <span class="linkable">caml_global_heap_state</span> = {<br/></li>
<li>&nbsp; <span class="Constant">0</span> &lt;&lt; <a href="caml/mlvalues.h.html#L119" title="ocaml/runtime/caml/mlvalues.h:119">HEADER_COLOR_SHIFT</a>,<br/></li>
<li>&nbsp; <span class="Constant">1</span> &lt;&lt; <a href="caml/mlvalues.h.html#L119" title="ocaml/runtime/caml/mlvalues.h:119">HEADER_COLOR_SHIFT</a>,<br/></li>
<li>&nbsp; <span class="Constant">2</span> &lt;&lt; <a href="caml/mlvalues.h.html#L119" title="ocaml/runtime/caml/mlvalues.h:119">HEADER_COLOR_SHIFT</a>,<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">pool</span> {<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* next;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* next_obj;<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* owner;<br/></li>
<li>&nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz;<br/></li>
<li><a id="L50">&#x200c;</a>} <span class="linkable">pool</span>;<br/></li>
<li><a id="L51">&#x200c;</a><a href="caml/misc.h.html#L222" title="ocaml/runtime/caml/misc.h:222">CAML_STATIC_ASSERT</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>) == <span class="linkable">Bsize_wsize</span>(<a href="caml/sizeclasses.h.html#L3" title="ocaml/runtime/caml/sizeclasses.h:3">POOL_HEADER_WSIZE</a>));<br/></li>
<li><a id="L52">&#x200c;</a><span class="PreProc">#define <span class="linkable">POOL_HEADER_SZ</span> </span><span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span><span class="PreProc">(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>)<br/></li>
<li></span><br/></li>
<li><a id="L54">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">large_alloc</span> {<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* owner;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* next;<br/></li>
<li><a id="L57">&#x200c;</a>} <span class="linkable">large_alloc</span>;<br/></li>
<li><a href="caml/misc.h.html#L222" title="ocaml/runtime/caml/misc.h:222">CAML_STATIC_ASSERT</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>) % <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) == <span class="Constant">0</span>);<br/></li>
<li><a id="L59">&#x200c;</a><span class="PreProc">#define <span class="linkable">LARGE_ALLOC_HEADER_SZ</span> </span><span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span><span class="PreProc">(<a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L100" title="ocaml/runtime/caml/platform.h:100">caml_plat_mutex</a> lock;<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* free;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* these only contain swept memory of terminated domains*/<br/></li>
<li></span>&nbsp; <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a> stats;<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* global_avail_pools[<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>];<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* global_full_pools[<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>];<br/></li>
<li>&nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* global_large;<br/></li>
<li><a id="L70">&#x200c;</a>} <span class="linkable">pool_freelist</span> = {<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L101" title="ocaml/runtime/caml/platform.h:101">CAML_PLAT_MUTEX_INITIALIZER</a>,<br/></li>
<li>&nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>,<br/></li>
<li>&nbsp; { <span class="Constant">0</span>, },<br/></li>
<li>&nbsp; { <span class="Constant">0</span>, },<br/></li>
<li>&nbsp; { <span class="Constant">0</span>, },<br/></li>
<li>&nbsp; <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a><br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* readable <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> writable only by the current thread */<br/></li>
<li><a id="L80">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">caml_heap_state</span> {<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* avail_pools[<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>];<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* full_pools[<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>];<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* unswept_avail_pools[<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>];<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* unswept_full_pools[<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>];<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* swept_large;<br/></li>
<li>&nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* unswept_large;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> next_to_sweep;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* owner;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a> stats;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* You need to hold the [<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>] lock to call these functions. */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L614" title="ocaml/runtime/shared_heap.c:614">orphan_heap_stats_with_lock</a>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a> *);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L622" title="ocaml/runtime/shared_heap.c:622">adopt_pool_stats_with_lock</a>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a> *,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> *, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a>);<br/></li>
<li><br/></li>
<li><a id="L102">&#x200c;</a><span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* <span class="linkable">caml_init_shared_heap</span> (<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* heap;<br/></li>
<li><br/></li>
<li>&nbsp; heap = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span>(heap != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i&lt;<a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; heap-&gt;avail_pools[i] = heap-&gt;full_pools[i] =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; heap-&gt;unswept_avail_pools[i] = heap-&gt;unswept_full_pools[i] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; heap-&gt;next_to_sweep = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; heap-&gt;swept_large = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; heap-&gt;unswept_large = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; heap-&gt;owner = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>;<br/></li>
<li>&nbsp; &nbsp; memset(&amp;heap-&gt;stats, <span class="Constant">0</span>, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(heap-&gt;stats));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> heap;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L121">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">move_all_pools</span>(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>** src, <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>** dst, <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* new_owner){<br/></li>
<li>&nbsp; <span class="Type">int</span> count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (*src) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* p = *src;<br/></li>
<li>&nbsp; &nbsp; *src = p-&gt;next;<br/></li>
<li>&nbsp; &nbsp; p-&gt;owner = new_owner;<br/></li>
<li>&nbsp; &nbsp; p-&gt;next = *dst;<br/></li>
<li>&nbsp; &nbsp; *dst = p;<br/></li>
<li>&nbsp; &nbsp; count++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> count;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L134">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_teardown_shared_heap</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* heap) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Type">int</span> released = <span class="Constant">0</span>, released_large = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; released +=<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L121" title="ocaml/runtime/shared_heap.c:121">move_all_pools</a>(&amp;heap-&gt;avail_pools[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_avail_pools[i], <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; released +=<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L121" title="ocaml/runtime/shared_heap.c:121">move_all_pools</a>(&amp;heap-&gt;full_pools[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_full_pools[i], <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* should be swept by now */<br/></li>
<li></span>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(!heap-&gt;unswept_avail_pools[i]);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(!heap-&gt;unswept_full_pools[i]);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(!heap-&gt;unswept_large);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (heap-&gt;swept_large) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* a = heap-&gt;swept_large;<br/></li>
<li>&nbsp; &nbsp; heap-&gt;swept_large = a-&gt;next;<br/></li>
<li>&nbsp; &nbsp; a-&gt;next = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_large;<br/></li>
<li>&nbsp; &nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_large = a;<br/></li>
<li>&nbsp; &nbsp; released_large++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L614" title="ocaml/runtime/shared_heap.c:614">orphan_heap_stats_with_lock</a>(heap);<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(heap);<br/></li>
<li>&nbsp; <a href="misc.c.html#L81" title="ocaml/runtime/misc.c:81">caml_gc_log</a>(<span class="Constant">&quot;Shutdown shared heap. Released </span><span class="Special">%d</span><span class="Constant"> active pools, </span><span class="Special">%d</span><span class="Constant"> large&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; released, released_large);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocating <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> deallocating pools from the global freelist. */<br/></li>
<li></span><br/></li>
<li><a id="L169">&#x200c;</a><span class="PreProc">#define <span class="linkable">POOLS_PER_ALLOCATION</span> </span><span class="Constant">16<br/></li>
<li><a id="L170">&#x200c;</a></span><span class="Type">static</span> <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* <span class="linkable">pool_acquire</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* r;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>* mem = <a href="platform.c.html#L158" title="ocaml/runtime/platform.c:158">caml_mem_map</a>(<a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(<a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>) * <a href="#L169" title="ocaml/runtime/shared_heap.c:169">POOLS_PER_ALLOCATION</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(<a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>), <span class="Constant">0</span> <span class="Comment">/* allocate */</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mem) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i=<span class="Constant">0</span>; i&lt;<a href="#L169" title="ocaml/runtime/shared_heap.c:169">POOLS_PER_ALLOCATION</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r = (<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>*)(((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)mem) + ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)i) * <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(<a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;next = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;owner = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; r = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (r)<br/></li>
<li>&nbsp; &nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free = r-&gt;next;<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (r) <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (r-&gt;owner == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L197">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">pool_release</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz) {<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>-&gt;owner = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>-&gt;sz == sz);<br/></li>
<li>&nbsp; local-&gt;stats.pool_words -= <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>&nbsp; local-&gt;stats.pool_frag_words -= <a href="caml/sizeclasses.h.html#L3" title="ocaml/runtime/caml/sizeclasses.h:3">POOL_HEADER_WSIZE</a> + <a href="caml/sizeclasses.h.html#L9" title="ocaml/runtime/caml/sizeclasses.h:9">wastage_sizeclass</a>[sz];<br/></li>
<li>&nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: give free pools back to the OS. Issue #698 */<br/></li>
<li></span>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>-&gt;next = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free;<br/></li>
<li>&nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.free = <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>;<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L211">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">calc_pool_stats</span>(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* a, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz, <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a>* s) {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)a + <a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* end = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)a + <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wh = <a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[sz];<br/></li>
<li>&nbsp; s-&gt;pool_frag_words += <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(<a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (p + wh &lt;= end) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>)<a href="caml/platform.h.html#L56" title="ocaml/runtime/caml/platform.h:56">atomic_load_relaxed</a>((<a href="caml/camlatomic.h.html#L32" title="ocaml/runtime/caml/camlatomic.h:32">atomic_uintnat</a>*)p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hd) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;pool_live_words += <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;pool_frag_words += wh - <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;pool_live_blocks++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += wh;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(end - p == <a href="caml/sizeclasses.h.html#L9" title="ocaml/runtime/caml/sizeclasses.h:9">wastage_sizeclass</a>[sz]);<br/></li>
<li>&nbsp; s-&gt;pool_frag_words += end - p;<br/></li>
<li>&nbsp; s-&gt;pool_words += <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Initialize a <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> its object freelist */<br/></li>
<li><a id="L233">&#x200c;</a></span><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">pool_initialize</span>(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* owner)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wh = <a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[sz];<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)r + <a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* end = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)r + <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(<a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>));<br/></li>
<li><br/></li>
<li>&nbsp; r-&gt;next = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; r-&gt;owner = owner;<br/></li>
<li>&nbsp; r-&gt;next_obj = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; r-&gt;sz = sz;<br/></li>
<li><br/></li>
<li>&nbsp; p[<span class="Constant">0</span>] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; p[<span class="Constant">1</span>] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; p += wh;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (p + wh &lt;= end) {<br/></li>
<li>&nbsp; &nbsp; p[<span class="Constant">0</span>] = <span class="Constant">0</span>; <span class="Comment">/* zero header indicates free object */<br/></li>
<li></span>&nbsp; &nbsp; p[<span class="Constant">1</span>] = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)(p - wh);<br/></li>
<li>&nbsp; &nbsp; p += wh;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; r-&gt;next_obj = p - wh;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocating an object from a <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> */<br/></li>
<li></span><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <a href="#L450" title="ocaml/runtime/shared_heap.c:450">pool_sweep</a>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>**,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz ,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> release_to_global_pool);<br/></li>
<li><br/></li>
<li><span class="Comment">/* Adopt <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> from the <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a> avail <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> full pools<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; to satisfy an allocation */<br/></li>
<li><a id="L266">&#x200c;</a></span><span class="Type">static</span> <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* <span class="linkable">pool_global_adopt</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* r = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; <span class="Type">int</span> adopted_pool = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* probably no available pools out there to be had */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span>( !<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_avail_pools[sz] &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; !<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_full_pools[sz] )<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Haven't managed to find a <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> locally, try the global ones */<br/></li>
<li></span>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <span class="Statement">if</span>( <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_avail_pools[sz] ) {<br/></li>
<li>&nbsp; &nbsp; r = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_avail_pools[sz];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span>( r ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_avail_pools[sz] = r-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; r-&gt;next = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; local-&gt;avail_pools[sz] = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L622" title="ocaml/runtime/shared_heap.c:622">adopt_pool_stats_with_lock</a>(local, r, sz);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="PreProc">#ifdef DEBUG<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* next_obj = r-&gt;next_obj;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span>( next_obj ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(next_obj[<span class="Constant">0</span>] == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next_obj = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)next_obj[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* There were no global avail pools, so let's adopt one of the full ones <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; try our luck sweeping it later on */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span>( !r ) {<br/></li>
<li>&nbsp; &nbsp; r = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_full_pools[sz];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span>( r ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_full_pools[sz] = r-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; r-&gt;next = local-&gt;full_pools[sz];<br/></li>
<li>&nbsp; &nbsp; &nbsp; local-&gt;full_pools[sz] = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L622" title="ocaml/runtime/shared_heap.c:622">adopt_pool_stats_with_lock</a>(local, r, sz);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; adopted_pool = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; r = <span class="Constant">0</span>; <span class="Comment">// this <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> is full<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span>( !r &amp;&amp; adopted_pool ) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;major_work_done_between_slices +=<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L450" title="ocaml/runtime/shared_heap.c:450">pool_sweep</a>(local, &amp;local-&gt;full_pools[sz], sz, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; r = local-&gt;avail_pools[sz];<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocating an object from a <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> */<br/></li>
<li><a id="L327">&#x200c;</a></span><span class="Type">static</span> <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* <span class="linkable">pool_find</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz) {<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* r;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Hopefully we have a <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> we can use directly */<br/></li>
<li></span>&nbsp; r = local-&gt;avail_pools[sz];<br/></li>
<li>&nbsp; <span class="Statement">if</span> (r) <span class="Statement">return</span> r;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Otherwise, try to sweep until we find one */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (!local-&gt;avail_pools[sz] &amp;&amp; local-&gt;unswept_avail_pools[sz]) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;major_work_done_between_slices +=<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L450" title="ocaml/runtime/shared_heap.c:450">pool_sweep</a>(local, &amp;local-&gt;unswept_avail_pools[sz], sz, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; r = local-&gt;avail_pools[sz];<br/></li>
<li>&nbsp; <span class="Statement">if</span> (r) <span class="Statement">return</span> r;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Haven't managed to find a <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> locally, try the global ones */<br/></li>
<li></span>&nbsp; r = <a href="#L266" title="ocaml/runtime/shared_heap.c:266">pool_global_adopt</a>(local, sz);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (r) <span class="Statement">return</span> r;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Failing that, we need to allocate a new <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> */<br/></li>
<li></span>&nbsp; r = <a href="#L170" title="ocaml/runtime/shared_heap.c:170">pool_acquire</a>(local);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!r) <span class="Statement">return</span> <span class="Constant">0</span>; <span class="Comment">/* if we can't allocate, give up */<br/></li>
<li></span><br/></li>
<li>&nbsp; local-&gt;stats.pool_words += <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (local-&gt;stats.pool_words &gt; local-&gt;stats.pool_max_words)<br/></li>
<li>&nbsp; &nbsp; local-&gt;stats.pool_max_words = local-&gt;stats.pool_words;<br/></li>
<li>&nbsp; local-&gt;stats.pool_frag_words += <a href="caml/sizeclasses.h.html#L3" title="ocaml/runtime/caml/sizeclasses.h:3">POOL_HEADER_WSIZE</a> + <a href="caml/sizeclasses.h.html#L9" title="ocaml/runtime/caml/sizeclasses.h:9">wastage_sizeclass</a>[sz];<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Having allocated a new <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>, set it up for size sz */<br/></li>
<li></span>&nbsp; local-&gt;avail_pools[sz] = r;<br/></li>
<li>&nbsp; <a href="#L233" title="ocaml/runtime/shared_heap.c:233">pool_initialize</a>(r, sz, local-&gt;owner);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L363">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span>* <span class="linkable">pool_allocate</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz) {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* next;<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* r = <a href="#L327" title="ocaml/runtime/shared_heap.c:327">pool_find</a>(local, sz);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (!r) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; p = r-&gt;next_obj;<br/></li>
<li>&nbsp; next = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)p[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; r-&gt;next_obj = next;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(p[<span class="Constant">0</span>] == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!next) {<br/></li>
<li>&nbsp; &nbsp; local-&gt;avail_pools[sz] = r-&gt;next;<br/></li>
<li>&nbsp; &nbsp; r-&gt;next = local-&gt;full_pools[sz];<br/></li>
<li>&nbsp; &nbsp; local-&gt;full_pools[sz] = r;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(r-&gt;next_obj == <span class="Constant">0</span> || *r-&gt;next_obj == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L384">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span>* <span class="linkable">large_allocate</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> sz) {<br/></li>
<li>&nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* a = malloc(sz + <a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!a) <span class="Statement">return</span> <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; local-&gt;stats.large_words += <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(sz + <a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (local-&gt;stats.large_words &gt; local-&gt;stats.large_max_words)<br/></li>
<li>&nbsp; &nbsp; local-&gt;stats.large_max_words = local-&gt;stats.large_words;<br/></li>
<li>&nbsp; local-&gt;stats.large_blocks++;<br/></li>
<li>&nbsp; a-&gt;owner = local-&gt;owner;<br/></li>
<li>&nbsp; a-&gt;next = local-&gt;swept_large;<br/></li>
<li>&nbsp; local-&gt;swept_large = a;<br/></li>
<li>&nbsp; <span class="Statement">return</span> (<span class="Type">char</span>*)a + <a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L397">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* <span class="linkable">caml_shared_try_alloc</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wosize,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag, <a href="caml/mlvalues.h.html#L59" title="ocaml/runtime/caml/mlvalues.h:59">reserved_t</a> reserved, <span class="Type">int</span> pinned)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> whsize = <a href="caml/mlvalues.h.html#L178" title="ocaml/runtime/caml/mlvalues.h:178">Whsize_wosize</a>(wosize);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> colour;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (wosize &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (tag != <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/runtime_events.h.html#L35" title="ocaml/runtime/caml/runtime_events.h:35">CAML_EV_ALLOC</a>(wosize);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (whsize &lt;= <a href="caml/sizeclasses.h.html#L4" title="ocaml/runtime/caml/sizeclasses.h:4">SIZECLASS_MAX</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a>* s;<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz = <a href="caml/sizeclasses.h.html#L12" title="ocaml/runtime/caml/sizeclasses.h:12">sizeclass_wsize</a>[whsize];<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[sz] &gt;= whsize);<br/></li>
<li>&nbsp; &nbsp; p = <a href="#L363" title="ocaml/runtime/shared_heap.c:363">pool_allocate</a>(local, sz);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!p) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; s = &amp;local-&gt;stats;<br/></li>
<li>&nbsp; &nbsp; s-&gt;pool_live_blocks++;<br/></li>
<li>&nbsp; &nbsp; s-&gt;pool_live_words += whsize;<br/></li>
<li>&nbsp; &nbsp; s-&gt;pool_frag_words += <a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[sz] - whsize;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; p = <a href="#L384" title="ocaml/runtime/shared_heap.c:384">large_allocate</a>(local, <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(whsize));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!p) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; colour = pinned ? NOT_MARKABLE : <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.MARKED;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L162" title="ocaml/runtime/caml/mlvalues.h:162">Hd_hp</a> (p) = <a href="caml/gc.h.html#L24" title="ocaml/runtime/caml/gc.h:24">Make_header_with_reserved</a>(wosize, tag, colour, reserved);<br/></li>
<li><span class="PreProc">#ifdef DEBUG<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; wosize; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(<a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p), i) = <a href="caml/misc.h.html#L530" title="ocaml/runtime/caml/misc.h:530">Debug_free_major</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L436">&#x200c;</a><span class="Type">struct</span> <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* <span class="linkable">caml_pool_of_shared_block</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> whsize;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(v) &amp;&amp; !<a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a>(v));<br/></li>
<li>&nbsp; whsize = <a href="caml/mlvalues.h.html#L178" title="ocaml/runtime/caml/mlvalues.h:178">Whsize_wosize</a>(<a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(v));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (whsize &gt; <span class="Constant">0</span> &amp;&amp; whsize &lt;= <a href="caml/sizeclasses.h.html#L4" title="ocaml/runtime/caml/sizeclasses.h:4">SIZECLASS_MAX</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>*)((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)v &amp;~(<a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) - <span class="Constant">1</span>));<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Sweeping */<br/></li>
<li></span><br/></li>
<li><a id="L450">&#x200c;</a><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">pool_sweep</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>** plist,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz, <span class="Type">int</span> release_to_global_pool) {<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> work = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* a = *plist;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!a) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; *plist = a-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)a + <a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* end = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)a + <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wh = <a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[sz];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> all_used = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a>* s = &amp;local-&gt;stats;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (p + wh &lt;= end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>)<a href="caml/platform.h.html#L56" title="ocaml/runtime/caml/platform.h:56">atomic_load_relaxed</a>((<a href="caml/camlatomic.h.html#L32" title="ocaml/runtime/caml/camlatomic.h:32">atomic_uintnat</a>*)p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hd == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* already on freelist */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; all_used = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="caml/shared_heap.h.html#L63" title="ocaml/runtime/caml/shared_heap.h:63">Has_status_hd</a>(hd, <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.GARBAGE)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd) &lt;= wh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L129" title="ocaml/runtime/caml/mlvalues.h:129">Tag_hd</a> (hd) == <a href="caml/mlvalues.h.html#L401" title="ocaml/runtime/caml/mlvalues.h:401">Custom_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">void</span> (*<a href="caml/alloc.h.html#L66" title="ocaml/runtime/caml/alloc.h:66">final_fun</a>)(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(<a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p))-&gt;finalize;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/alloc.h.html#L66" title="ocaml/runtime/caml/alloc.h:66">final_fun</a> != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="caml/alloc.h.html#L66" title="ocaml/runtime/caml/alloc.h:66">final_fun</a>(<a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="ints.c.html#L461" title="ocaml/runtime/ints.c:461">add</a> to freelist */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/platform.h.html#L60" title="ocaml/runtime/caml/platform.h:60">atomic_store_relaxed</a>((<a href="caml/camlatomic.h.html#L32" title="ocaml/runtime/caml/camlatomic.h:32">atomic_uintnat</a>*)p, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p[<span class="Constant">1</span>] = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)a-&gt;next_obj;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>((<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)p));<br/></li>
<li><span class="PreProc">#ifdef DEBUG<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wo = <a href="caml/mlvalues.h.html#L179" title="ocaml/runtime/caml/mlvalues.h:179">Wosize_whsize</a>(wh);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; wo; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(<a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p), i) = <a href="caml/misc.h.html#L530" title="ocaml/runtime/caml/misc.h:530">Debug_free_major</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; a-&gt;next_obj = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; all_used = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* update stats */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;pool_live_blocks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;pool_live_words -= <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; local-&gt;owner-&gt;swept_words += <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;pool_frag_words -= (wh - <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd));<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* still live, the <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> can't be released to the global freelist */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; release_to_global_pool = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; p += wh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; work += wh;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (release_to_global_pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L197" title="ocaml/runtime/shared_heap.c:197">pool_release</a>(local, a, sz);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>** list = all_used ? &amp;local-&gt;full_pools[sz] : &amp;local-&gt;avail_pools[sz];<br/></li>
<li>&nbsp; &nbsp; &nbsp; a-&gt;next = *list;<br/></li>
<li>&nbsp; &nbsp; &nbsp; *list = a;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> work;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L515">&#x200c;</a><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">large_alloc_sweep</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd;<br/></li>
<li>&nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* a = local-&gt;unswept_large;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!a) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; local-&gt;unswept_large = a-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; p = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)a + <a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; hd = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>)*p;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/shared_heap.h.html#L63" title="ocaml/runtime/caml/shared_heap.h:63">Has_status_hd</a>(hd, <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.GARBAGE)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L129" title="ocaml/runtime/caml/mlvalues.h:129">Tag_hd</a> (hd) == <a href="caml/mlvalues.h.html#L401" title="ocaml/runtime/caml/mlvalues.h:401">Custom_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">void</span> (*<a href="caml/alloc.h.html#L66" title="ocaml/runtime/caml/alloc.h:66">final_fun</a>)(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(<a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p))-&gt;finalize;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/alloc.h.html#L66" title="ocaml/runtime/caml/alloc.h:66">final_fun</a> != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="caml/alloc.h.html#L66" title="ocaml/runtime/caml/alloc.h:66">final_fun</a>(<a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; local-&gt;stats.large_words -=<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd) + <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(<a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; &nbsp; local-&gt;owner-&gt;swept_words +=<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd) + <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(<a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; &nbsp; local-&gt;stats.large_blocks--;<br/></li>
<li>&nbsp; &nbsp; free(a);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; a-&gt;next = local-&gt;swept_large;<br/></li>
<li>&nbsp; &nbsp; local-&gt;swept_large = a;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L839" title="ocaml/runtime/shared_heap.c:839">verify_swept</a>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>*);<br/></li>
<li><br/></li>
<li><a id="L546">&#x200c;</a><a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">caml_sweep</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> work) {<br/></li>
<li>&nbsp; <span class="Comment">/* Sweep local pools */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (work &gt; <span class="Constant">0</span> &amp;&amp; local-&gt;next_to_sweep &lt; <a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz = local-&gt;next_to_sweep;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> full_sweep_work = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> avail_sweep_work =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L450" title="ocaml/runtime/shared_heap.c:450">pool_sweep</a>(local, &amp;local-&gt;unswept_avail_pools[sz], sz, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; work -= avail_sweep_work;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (work &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; full_sweep_work = <a href="#L450" title="ocaml/runtime/shared_heap.c:450">pool_sweep</a>(local,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;local-&gt;unswept_full_pools[sz],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sz, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; work -= full_sweep_work;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span>(full_sweep_work+avail_sweep_work == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; local-&gt;next_to_sweep++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Sweep global pools */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (work &gt; <span class="Constant">0</span> &amp;&amp; local-&gt;unswept_large) {<br/></li>
<li>&nbsp; &nbsp; work -= <a href="#L515" title="ocaml/runtime/shared_heap.c:515">large_alloc_sweep</a>(local);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="startup_aux.c.html#L41" title="ocaml/runtime/startup_aux.c:41">caml_params</a>-&gt;verify_heap &amp;&amp; work &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sweeping is complete, check everything worked */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L839" title="ocaml/runtime/shared_heap.c:839">verify_swept</a>(local);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> work;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L580">&#x200c;</a><a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_heap_size</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(local-&gt;stats.pool_words + local-&gt;stats.large_words);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L584">&#x200c;</a><a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_top_heap_words</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <span class="Comment">/* </span><span class="Todo">FIXME</span><span class="Comment">: summing two maximums computed at different points in time<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; returns an incorrect result. */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> local-&gt;stats.pool_max_words + local-&gt;stats.large_max_words;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L591">&#x200c;</a><a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">caml_heap_blocks</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> local-&gt;stats.pool_live_blocks + local-&gt;stats.large_blocks;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L595">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_redarken_pool</span>(<span class="Type">struct</span> <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* r, <a href="caml/roots.h.html#L28" title="ocaml/runtime/caml/roots.h:28">scanning_action</a> f, <span class="Type">void</span>* fdata) {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wh = <a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[r-&gt;sz];<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)r + <a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* end = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)r + <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(<a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (p + wh &lt;= end) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = p[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hd != <span class="Constant">0</span> &amp;&amp; <a href="caml/shared_heap.h.html#L63" title="ocaml/runtime/caml/shared_heap.h:63">Has_status_hd</a>(hd, <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.MARKED)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; f(fdata, <a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(p), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; p += wh;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* Heap <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> freelist stats */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Move the given heap stats to the orphan pools.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; You need to hold the [<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>] lock. */<br/></li>
<li><a id="L614">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">orphan_heap_stats_with_lock</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a> *heap) {<br/></li>
<li>&nbsp; <a href="gc_stats.c.html#L26" title="ocaml/runtime/gc_stats.c:26">caml_accum_heap_stats</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.stats, &amp;heap-&gt;stats);<br/></li>
<li>&nbsp; memset(&amp;heap-&gt;stats, <span class="Constant">0</span>, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(heap-&gt;stats));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* The stats for an adopted <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> are moved from the free <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> stats to<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; the heap stats of the adopting domain.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; You need to hold the [<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>] lock. */<br/></li>
<li><a id="L622">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">adopt_pool_stats_with_lock</span>(<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* adopter, <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> *r, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a> pool_stats = { <span class="Constant">0</span>, };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L211" title="ocaml/runtime/shared_heap.c:211">calc_pool_stats</a>(r, sz, &amp;pool_stats);<br/></li>
<li>&nbsp; &nbsp; <a href="gc_stats.c.html#L26" title="ocaml/runtime/gc_stats.c:26">caml_accum_heap_stats</a>(&amp;adopter-&gt;stats, &amp;pool_stats);<br/></li>
<li>&nbsp; &nbsp; <a href="gc_stats.c.html#L40" title="ocaml/runtime/gc_stats.c:40">caml_remove_heap_stats</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.stats, &amp;pool_stats);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Move the stats of all orphan pools into the given heap.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; You need to hold the [<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>] lock. */<br/></li>
<li><a id="L634">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">adopt_all_pool_stats_with_lock</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a> *adopter) {<br/></li>
<li>&nbsp; <a href="gc_stats.c.html#L26" title="ocaml/runtime/gc_stats.c:26">caml_accum_heap_stats</a>(&amp;adopter-&gt;stats, &amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.stats);<br/></li>
<li>&nbsp; memset(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.stats, <span class="Constant">0</span>, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.stats));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L639">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_collect_heap_stats_sample</span>(<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local,<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a>* sample)<br/></li>
<li>{<br/></li>
<li>&nbsp; *sample = local-&gt;stats;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Add the orphan <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a> stats to a stats accumulator. */<br/></li>
<li><a id="L647">&#x200c;</a></span><span class="Type">void</span> <span class="linkable">caml_accum_orphan_heap_stats</span>(<span class="Type">struct</span> <a href="caml/gc_stats.h.html#L35" title="ocaml/runtime/caml/gc_stats.h:35">heap_stats</a>* acc)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <a href="gc_stats.c.html#L26" title="ocaml/runtime/gc_stats.c:26">caml_accum_heap_stats</a>(acc, &amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.stats);<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* Atoms */<br/></li>
<li><a id="L656">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> <span class="linkable">atoms</span>[<span class="Constant">256</span>] = {<br/></li>
<li><a id="L657">&#x200c;</a><span class="PreProc">#define <span class="linkable">A</span>(i) <a href="caml/gc.h.html#L32" title="ocaml/runtime/caml/gc.h:32">Make_header</a>(</span><span class="Constant">0</span><span class="PreProc">, i, NOT_MARKABLE)<br/></li>
<li></span><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">0</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">1</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">2</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">3</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">4</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">5</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">6</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">7</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">8</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">9</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">10</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">11</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">12</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">13</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">14</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">15</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">16</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">17</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">18</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">19</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">20</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">21</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">22</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">23</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">24</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">25</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">26</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">27</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">28</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">29</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">30</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">31</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">32</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">33</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">34</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">35</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">36</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">37</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">38</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">39</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">40</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">41</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">42</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">43</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">44</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">45</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">46</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">47</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">48</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">49</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">50</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">51</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">52</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">53</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">54</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">55</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">56</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">57</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">58</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">59</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">60</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">61</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">62</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">63</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">64</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">65</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">66</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">67</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">68</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">69</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">70</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">71</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">72</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">73</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">74</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">75</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">76</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">77</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">78</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">79</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">80</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">81</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">82</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">83</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">84</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">85</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">86</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">87</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">88</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">89</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">90</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">91</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">92</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">93</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">94</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">95</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">96</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">97</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">98</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">99</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">100</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">101</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">102</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">103</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">104</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">105</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">106</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">107</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">108</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">109</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">110</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">111</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">112</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">113</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">114</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">115</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">116</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">117</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">118</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">119</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">120</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">121</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">122</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">123</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">124</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">125</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">126</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">127</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">128</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">129</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">130</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">131</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">132</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">133</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">134</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">135</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">136</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">137</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">138</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">139</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">140</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">141</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">142</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">143</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">144</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">145</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">146</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">147</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">148</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">149</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">150</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">151</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">152</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">153</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">154</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">155</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">156</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">157</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">158</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">159</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">160</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">161</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">162</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">163</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">164</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">165</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">166</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">167</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">168</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">169</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">170</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">171</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">172</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">173</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">174</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">175</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">176</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">177</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">178</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">179</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">180</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">181</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">182</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">183</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">184</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">185</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">186</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">187</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">188</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">189</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">190</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">191</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">192</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">193</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">194</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">195</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">196</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">197</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">198</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">199</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">200</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">201</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">202</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">203</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">204</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">205</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">206</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">207</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">208</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">209</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">210</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">211</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">212</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">213</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">214</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">215</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">216</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">217</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">218</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">219</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">220</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">221</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">222</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">223</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">224</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">225</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">226</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">227</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">228</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">229</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">230</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">231</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">232</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">233</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">234</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">235</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">236</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">237</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">238</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">239</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">240</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">241</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">242</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">243</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">244</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">245</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">246</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">247</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">248</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">249</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">250</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">251</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">252</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">253</span>),<br/></li>
<li><a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">254</span>),<a href="#L657" title="ocaml/runtime/shared_heap.c:657">A</a>(<span class="Constant">255</span>)<br/></li>
<li><a id="L686">&#x200c;</a><span class="PreProc">#undef <span class="linkable">A</span><br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><a id="L689">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_atom</span>(<a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag) {<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L167" title="ocaml/runtime/caml/mlvalues.h:167">Val_hp</a>(&amp;<a href="#L656" title="ocaml/runtime/shared_heap.c:656">atoms</a>[tag]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L693">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_init_major_heap</span> (<a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> size) {<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* Verify heap invariants.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp;&nbsp; Verification happens just after the heap is cycled during STW, so<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; everything should be unmarked. If something reachable marked after<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; cycling the heap, it means that garbage was reachable beforehand.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li><a id="L703">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">heap_verify_state</span> {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* stack;<br/></li>
<li>&nbsp; <span class="Type">int</span> stack_len;<br/></li>
<li>&nbsp; <span class="Type">int</span> sp;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> objs;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/addrmap.h.html#L23" title="ocaml/runtime/caml/addrmap.h:23">addrmap</a> seen;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L711">&#x200c;</a><span class="Type">struct</span> <a href="#L703" title="ocaml/runtime/shared_heap.c:703">heap_verify_state</a>* <span class="linkable">caml_verify_begin</span> (<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L703" title="ocaml/runtime/shared_heap.c:703">heap_verify_state</a> init = {<span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <a href="caml/addrmap.h.html#L28" title="ocaml/runtime/caml/addrmap.h:28">ADDRMAP_INIT</a>};<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L703" title="ocaml/runtime/shared_heap.c:703">heap_verify_state</a>* st = <a href="memory.c.html#L550" title="ocaml/runtime/memory.c:550">caml_stat_alloc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span> init);<br/></li>
<li>&nbsp; *st = init;<br/></li>
<li>&nbsp; <span class="Statement">return</span> st;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L719">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">verify_push</span> (<span class="Type">void</span>* st_v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* ignored)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L703" title="ocaml/runtime/shared_heap.c:703">heap_verify_state</a>* st = st_v;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(v)) <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (st-&gt;sp == st-&gt;stack_len) {<br/></li>
<li>&nbsp; &nbsp; st-&gt;stack_len = st-&gt;stack_len * <span class="Constant">2</span> + <span class="Constant">100</span>;<br/></li>
<li>&nbsp; &nbsp; st-&gt;stack = <a href="memory.c.html#L600" title="ocaml/runtime/memory.c:600">caml_stat_resize</a>(st-&gt;stack,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*) * st-&gt;stack_len);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; st-&gt;stack[st-&gt;sp++] = v;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L732">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_verify_root</span>(<span class="Type">void</span>* state, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L719" title="ocaml/runtime/shared_heap.c:719">verify_push</a>(state, v, p);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L737">&#x200c;</a><span class="Type">static</span> <a href="caml/roots.h.html#L26" title="ocaml/runtime/caml/roots.h:26">scanning_action_flags</a> <span class="linkable">verify_scanning_flags</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L739">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">verify_object</span>(<span class="Type">struct</span> <a href="#L703" title="ocaml/runtime/shared_heap.c:703">heap_verify_state</a>* st, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v) {<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>* entry;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (!<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(v)) <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (!<a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a>(v));<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (<a href="caml/mlvalues.h.html#L157" title="ocaml/runtime/caml/mlvalues.h:157">Hd_val</a>(v));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(v) == <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; v -= <a href="caml/mlvalues.h.html#L250" title="ocaml/runtime/caml/mlvalues.h:250">Infix_offset_val</a>(v);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(v) == <a href="caml/mlvalues.h.html#L275" title="ocaml/runtime/caml/mlvalues.h:275">Closure_tag</a>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; entry = <a href="addrmap.c.html#L93" title="ocaml/runtime/addrmap.c:93">caml_addrmap_insert_pos</a>(&amp;st-&gt;seen, v);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (*entry != <a href="caml/addrmap.h.html#L33" title="ocaml/runtime/caml/addrmap.h:33">ADDRMAP_NOT_PRESENT</a>) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; *entry = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/shared_heap.h.html#L67" title="ocaml/runtime/caml/shared_heap.h:67">Has_status_val</a>(v, NOT_MARKABLE)) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; st-&gt;objs++;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/shared_heap.h.html#L67" title="ocaml/runtime/caml/shared_heap.h:67">Has_status_val</a>(v, <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.UNMARKED));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(v) == <a href="caml/mlvalues.h.html#L300" title="ocaml/runtime/caml/mlvalues.h:300">Cont_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="caml/fiber.h.html#L43" title="ocaml/runtime/caml/fiber.h:43">stack_info</a>* stk = <a href="caml/mlvalues.h.html#L268" title="ocaml/runtime/caml/mlvalues.h:268">Ptr_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stk != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fiber.c.html#L277" title="ocaml/runtime/fiber.c:277">caml_scan_stack</a>(<a href="#L719" title="ocaml/runtime/shared_heap.c:719">verify_push</a>, <a href="#L737" title="ocaml/runtime/shared_heap.c:737">verify_scanning_flags</a>, st, stk, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(v) &lt; <a href="caml/mlvalues.h.html#L219" title="ocaml/runtime/caml/mlvalues.h:219">No_scan_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(v) == <a href="caml/mlvalues.h.html#L275" title="ocaml/runtime/caml/mlvalues.h:275">Closure_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="caml/mlvalues.h.html#L285" title="ocaml/runtime/caml/mlvalues.h:285">Start_env_closinfo</a>(<a href="caml/mlvalues.h.html#L277" title="ocaml/runtime/caml/mlvalues.h:277">Closinfo_val</a>(v));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (; i &lt; <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(v); i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> f = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(f)) <a href="#L719" title="ocaml/runtime/shared_heap.c:719">verify_push</a>(st, f, <a href="caml/mlvalues.h.html#L225" title="ocaml/runtime/caml/mlvalues.h:225">Op_val</a>(v)+i);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L776">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_verify_heap</span>(<a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a> *domain) {<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L703" title="ocaml/runtime/shared_heap.c:703">heap_verify_state</a>* st = <a href="#L711" title="ocaml/runtime/shared_heap.c:711">caml_verify_begin</a>();<br/></li>
<li>&nbsp; <a href="roots.c.html#L35" title="ocaml/runtime/roots.c:35">caml_do_roots</a> (&amp;<a href="#L732" title="ocaml/runtime/shared_heap.c:732">caml_verify_root</a>, <a href="#L737" title="ocaml/runtime/shared_heap.c:737">verify_scanning_flags</a>, st, domain, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="globroots.c.html#L233" title="ocaml/runtime/globroots.c:233">caml_scan_global_roots</a>(&amp;<a href="#L732" title="ocaml/runtime/shared_heap.c:732">caml_verify_root</a>, st);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (st-&gt;sp) <a href="#L739" title="ocaml/runtime/shared_heap.c:739">verify_object</a>(st, st-&gt;stack[--st-&gt;sp]);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="addrmap.c.html#L85" title="ocaml/runtime/addrmap.c:85">caml_addrmap_clear</a>(&amp;st-&gt;seen);<br/></li>
<li>&nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(st-&gt;stack);<br/></li>
<li>&nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(st);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L789">&#x200c;</a><span class="Type">struct</span> <span class="linkable">mem_stats</span> {<br/></li>
<li>&nbsp; <span class="Comment">/* unit is words */<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> alloced;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> live;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> free;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> overhead;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> live_blocks;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L799">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">verify_pool</span>(<a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* a, <a href="#L36" title="ocaml/runtime/shared_heap.c:36">sizeclass</a> sz, <span class="Type">struct</span> <a href="#L789" title="ocaml/runtime/shared_heap.c:789">mem_stats</a>* s) {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* v;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (v = a-&gt;next_obj; v; v = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)v[<span class="Constant">1</span>]) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(*v == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* p = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)((<span class="Type">char</span>*)a + <a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>* end = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>*)a + <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> wh = <a href="caml/sizeclasses.h.html#L6" title="ocaml/runtime/caml/sizeclasses.h:6">wsize_sizeclass</a>[sz];<br/></li>
<li>&nbsp; &nbsp; s-&gt;overhead += <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(<a href="#L52" title="ocaml/runtime/shared_heap.c:52">POOL_HEADER_SZ</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (p + wh &lt;= end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = (<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>)*p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(hd == <span class="Constant">0</span> || !<a href="caml/shared_heap.h.html#L63" title="ocaml/runtime/caml/shared_heap.h:63">Has_status_hd</a>(hd, <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.GARBAGE));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hd) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;live += <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;overhead += wh - <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;live_blocks++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;free += wh;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; p += wh;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(end - p == <a href="caml/sizeclasses.h.html#L9" title="ocaml/runtime/caml/sizeclasses.h:9">wastage_sizeclass</a>[sz]);<br/></li>
<li>&nbsp; &nbsp; s-&gt;overhead += end - p;<br/></li>
<li>&nbsp; &nbsp; s-&gt;alloced += <a href="caml/sizeclasses.h.html#L2" title="ocaml/runtime/caml/sizeclasses.h:2">POOL_WSIZE</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L829">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">verify_large</span>(<a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* a, <span class="Type">struct</span> <a href="#L789" title="ocaml/runtime/shared_heap.c:789">mem_stats</a>* s) {<br/></li>
<li>&nbsp; <span class="Statement">for</span> (; a; a = a-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = *(<a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a>*)((<span class="Type">char</span>*)a + <a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (!<a href="caml/shared_heap.h.html#L63" title="ocaml/runtime/caml/shared_heap.h:63">Has_status_hd</a>(hd, <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>.GARBAGE));<br/></li>
<li>&nbsp; &nbsp; s-&gt;alloced += <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(<a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>) + <a href="caml/mlvalues.h.html#L192" title="ocaml/runtime/caml/mlvalues.h:192">Whsize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; s-&gt;overhead += <a href="caml/mlvalues.h.html#L182" title="ocaml/runtime/caml/mlvalues.h:182">Wsize_bsize</a>(<a href="#L59" title="ocaml/runtime/shared_heap.c:59">LARGE_ALLOC_HEADER_SZ</a>);<br/></li>
<li>&nbsp; &nbsp; s-&gt;live_blocks++;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L839">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">verify_swept</span> (<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L789" title="ocaml/runtime/shared_heap.c:789">mem_stats</a> pool_stats = {<span class="Constant">0</span>,}, large_stats = {<span class="Constant">0</span>,};<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* sweeping should be done by this point */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;next_to_sweep == <a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L425" title="ocaml/runtime/memory.c:425">pool</a>* p;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;unswept_avail_pools[i] == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; local-&gt;unswept_full_pools[i] == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = local-&gt;avail_pools[i]; p; p = p-&gt;next)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L799" title="ocaml/runtime/shared_heap.c:799">verify_pool</a>(p, i, &amp;pool_stats);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = local-&gt;full_pools[i]; p; p = p-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(p-&gt;next_obj == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L799" title="ocaml/runtime/shared_heap.c:799">verify_pool</a>(p, i, &amp;pool_stats);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="misc.c.html#L81" title="ocaml/runtime/misc.c:81">caml_gc_log</a>(<span class="Constant">&quot;Pooled memory: %&quot;</span> <a href="caml/config.h.html#L142" title="ocaml/runtime/caml/config.h:142">ARCH_INTNAT_PRINTF_FORMAT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;u alloced, %&quot;</span> <a href="caml/config.h.html#L142" title="ocaml/runtime/caml/config.h:142">ARCH_INTNAT_PRINTF_FORMAT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;u free, %&quot;</span> <a href="caml/config.h.html#L142" title="ocaml/runtime/caml/config.h:142">ARCH_INTNAT_PRINTF_FORMAT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;u fragmentation&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pool_stats.alloced, pool_stats.free, pool_stats.overhead);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L829" title="ocaml/runtime/shared_heap.c:829">verify_large</a>(local-&gt;swept_large, &amp;large_stats);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;unswept_large == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; <a href="misc.c.html#L81" title="ocaml/runtime/misc.c:81">caml_gc_log</a>(<span class="Constant">&quot;Large memory: %&quot;</span> <a href="caml/config.h.html#L142" title="ocaml/runtime/caml/config.h:142">ARCH_INTNAT_PRINTF_FORMAT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;u alloced, %&quot;</span> <a href="caml/config.h.html#L142" title="ocaml/runtime/caml/config.h:142">ARCH_INTNAT_PRINTF_FORMAT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;u free, %&quot;</span> <a href="caml/config.h.html#L142" title="ocaml/runtime/caml/config.h:142">ARCH_INTNAT_PRINTF_FORMAT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;u fragmentation&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; large_stats.alloced, large_stats.free, large_stats.overhead);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Check stats are being computed correctly */<br/></li>
<li></span>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.pool_words == pool_stats.alloced);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.pool_live_words == pool_stats.live);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.pool_live_blocks == pool_stats.live_blocks);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.pool_frag_words == pool_stats.overhead);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.pool_words -<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (local-&gt;stats.pool_live_words + local-&gt;stats.pool_frag_words)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == pool_stats.free);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.large_words == large_stats.alloced);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;stats.large_blocks == large_stats.live_blocks);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L882">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_cycle_heap_stw</span> (<span class="Type">void</span>) {<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/shared_heap.h.html#L55" title="ocaml/runtime/caml/shared_heap.h:55">global_heap_state</a> oldg = <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a>;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/shared_heap.h.html#L55" title="ocaml/runtime/caml/shared_heap.h:55">global_heap_state</a> newg;<br/></li>
<li>&nbsp; newg.UNMARKED&nbsp; &nbsp;&nbsp; = oldg.MARKED;<br/></li>
<li>&nbsp; newg.GARBAGE&nbsp; &nbsp; &nbsp; = oldg.UNMARKED;<br/></li>
<li>&nbsp; newg.MARKED&nbsp; &nbsp; &nbsp;&nbsp; = oldg.GARBAGE; <span class="Comment">/* should be empty because<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; garbage was swept */<br/></li>
<li></span>&nbsp; <a href="#L39" title="ocaml/runtime/shared_heap.c:39">caml_global_heap_state</a> = newg;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L892">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_cycle_heap</span>(<span class="Type">struct</span> <a href="#L80" title="ocaml/runtime/shared_heap.c:80">caml_heap_state</a>* local) {<br/></li>
<li>&nbsp; <span class="Type">int</span> i, received_p = <span class="Constant">0</span>, received_l = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="misc.c.html#L81" title="ocaml/runtime/misc.c:81">caml_gc_log</a>(<span class="Constant">&quot;Cycling heap [</span><span class="Special">%02d</span><span class="Constant">]&quot;</span>, local-&gt;owner-&gt;id);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;unswept_avail_pools[i] == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; local-&gt;unswept_avail_pools[i] = local-&gt;avail_pools[i];<br/></li>
<li>&nbsp; &nbsp; local-&gt;avail_pools[i] = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;unswept_full_pools[i] == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; &nbsp; local-&gt;unswept_full_pools[i] = local-&gt;full_pools[i];<br/></li>
<li>&nbsp; &nbsp; local-&gt;full_pools[i] = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(local-&gt;unswept_large == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>);<br/></li>
<li>&nbsp; local-&gt;unswept_large = local-&gt;swept_large;<br/></li>
<li>&nbsp; local-&gt;swept_large = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L155" title="ocaml/runtime/caml/platform.h:155">caml_plat_lock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="caml/sizeclasses.h.html#L5" title="ocaml/runtime/caml/sizeclasses.h:5">NUM_SIZECLASSES</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; received_p += <a href="#L121" title="ocaml/runtime/shared_heap.c:121">move_all_pools</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_avail_pools[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;local-&gt;unswept_avail_pools[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; local-&gt;owner);<br/></li>
<li>&nbsp; &nbsp; received_p += <a href="#L121" title="ocaml/runtime/shared_heap.c:121">move_all_pools</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_full_pools[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;local-&gt;unswept_full_pools[i],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; local-&gt;owner);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_large) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L54" title="ocaml/runtime/shared_heap.c:54">large_alloc</a>* a = <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_large;<br/></li>
<li>&nbsp; &nbsp; <a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.global_large = a-&gt;next;<br/></li>
<li>&nbsp; &nbsp; a-&gt;owner = local-&gt;owner;<br/></li>
<li>&nbsp; &nbsp; a-&gt;next = local-&gt;unswept_large;<br/></li>
<li>&nbsp; &nbsp; local-&gt;unswept_large = a;<br/></li>
<li>&nbsp; &nbsp; received_l++;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (received_p || received_l) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L634" title="ocaml/runtime/shared_heap.c:634">adopt_all_pool_stats_with_lock</a>(local);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/platform.h.html#L173" title="ocaml/runtime/caml/platform.h:173">caml_plat_unlock</a>(&amp;<a href="#L70" title="ocaml/runtime/shared_heap.c:70">pool_freelist</a>.lock);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (received_p || received_l)<br/></li>
<li>&nbsp; &nbsp; <a href="misc.c.html#L81" title="ocaml/runtime/misc.c:81">caml_gc_log</a>(<span class="Constant">&quot;Received </span><span class="Special">%d</span><span class="Constant"> new pools, </span><span class="Special">%d</span><span class="Constant"> new large allocs&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received_p, received_l);<br/></li>
<li><br/></li>
<li>&nbsp; local-&gt;next_to_sweep = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

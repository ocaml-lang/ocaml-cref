<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/weak.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/weak.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L32">caml_dummy</a></li>
<li><a href="#L35">caml_ephe_none</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L37">caml_alloc_ephe_info</a></li>
<li><a href="#L465">caml_ephe_blit_data</a></li>
<li><a href="#L449">caml_ephe_blit_key</a></li>
<li><a href="#L417">caml_ephe_check_data</a></li>
<li><a href="#L403">caml_ephe_check_key</a></li>
<li><a href="#L123">caml_ephe_clean</a></li>
<li><a href="#L47">caml_ephe_create</a></li>
<li><a href="#L383">caml_ephe_get_data</a></li>
<li><a href="#L388">caml_ephe_get_data_copy</a></li>
<li><a href="#L264">caml_ephe_get_key</a></li>
<li><a href="#L370">caml_ephe_get_key_copy</a></li>
<li><a href="#L234">caml_ephe_set_data</a></li>
<li><a href="#L205">caml_ephe_set_key</a></li>
<li><a href="#L220">caml_ephe_set_key_option</a></li>
<li><a href="#L239">caml_ephe_unset_data</a></li>
<li><a href="#L215">caml_ephe_unset_key</a></li>
<li><a href="#L475">caml_weak_blit</a></li>
<li><a href="#L412">caml_weak_check</a></li>
<li><a href="#L68">caml_weak_create</a></li>
<li><a href="#L273">caml_weak_get</a></li>
<li><a href="#L379">caml_weak_get_copy</a></li>
<li><a href="#L229">caml_weak_set</a></li>
<li><a href="#L175">clean_field</a></li>
<li><a href="#L106">do_check_key_clean</a></li>
<li><a href="#L183">do_set</a></li>
<li><a href="#L422">ephe_blit_field</a></li>
<li><a href="#L393">ephe_check_field</a></li>
<li><a href="#L282">ephe_copy_and_darken</a></li>
<li><a href="#L244">ephe_get_field</a></li>
<li><a href="#L312">ephe_get_field_copy</a></li>
<li><a href="#L196">ephe_set_field</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L16">CAML_INTERNALS</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Damien Doligez, projet Para, INRIA Rocquencourt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 1997 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L16">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Operations on weak arrays <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> ephemerons (named ephe here)*/<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;caml/alloc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/domain.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/major_gc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/shared_heap.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/signals.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/weak.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L32">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_dummy</span>[] =<br/></li>
<li>&nbsp; {(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)<a href="caml/gc.h.html#L32" title="ocaml/runtime/caml/gc.h:32">Make_header</a>(<span class="Constant">0</span>,<a href="caml/mlvalues.h.html#L324" title="ocaml/runtime/caml/mlvalues.h:324">Abstract_tag</a>, NOT_MARKABLE),<br/></li>
<li>&nbsp;&nbsp; <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>};<br/></li>
<li><a id="L35">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_none</span> = (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>)&amp;<a href="#L32" title="ocaml/runtime/weak.c:32">caml_dummy</a>[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li><a id="L37">&#x200c;</a><span class="Type">struct</span> <a href="caml/weak.h.html#L31" title="ocaml/runtime/caml/weak.h:31">caml_ephe_info</a>* <span class="linkable">caml_alloc_ephe_info</span> (<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/weak.h.html#L31" title="ocaml/runtime/caml/weak.h:31">caml_ephe_info</a>* e =<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a> (<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/weak.h.html#L31" title="ocaml/runtime/caml/weak.h:31">caml_ephe_info</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span>(e != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; memset (e, <span class="Constant">0</span>, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="caml/weak.h.html#L31" title="ocaml/runtime/caml/weak.h:31">caml_ephe_info</a>));<br/></li>
<li>&nbsp; <span class="Statement">return</span> e;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* [len] is a <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> that represents a number of words (fields) */<br/></li>
<li><a id="L47">&#x200c;</a></span><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_create</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> size, i;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res;<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* domain_state = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>;<br/></li>
<li><br/></li>
<li>&nbsp; size = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (len)<br/></li>
<li>&nbsp; &nbsp; &nbsp;&nbsp; + <span class="Constant">1</span> <span class="Comment">/* weak_list */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp;&nbsp; + <span class="Constant">1</span> <span class="Comment">/* the <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> */</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (size &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || size &gt; <a href="caml/mlvalues.h.html#L172" title="ocaml/runtime/caml/mlvalues.h:172">Max_wosize</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.create&quot;</span>);<br/></li>
<li>&nbsp; res = <a href="memory.c.html#L359" title="ocaml/runtime/memory.c:359">caml_alloc_shr</a> (size, <a href="caml/mlvalues.h.html#L324" title="ocaml/runtime/caml/mlvalues.h:324">Abstract_tag</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/weak.h.html#L74" title="ocaml/runtime/caml/weak.h:74">Ephe_link</a>(res) = domain_state-&gt;ephe_info-&gt;live;<br/></li>
<li>&nbsp; domain_state-&gt;ephe_info-&gt;live = res;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>; i &lt; size; i++)<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(res, i) = <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>;<br/></li>
<li>&nbsp; <span class="Comment">/* run memprof callbacks */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="signals.c.html#L349" title="ocaml/runtime/signals.c:349">caml_process_pending_actions_with_root</a>(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L68">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_weak_create</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L47" title="ocaml/runtime/weak.c:47">caml_ephe_create</a>(len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/**<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Specificity of the cleaning phase (Phase_clean):<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp;&nbsp; The dead keys must be removed from the ephemerons <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> data removed<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; when one the keys is dead. Here we call it cleaning the ephemerons.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; <a href="shared_heap.c.html#L657" title="ocaml/runtime/shared_heap.c:657">A</a> specific phase of the GC is dedicated to this, Phase_clean. This<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; phase is just after the <a href="major_gc.c.html#L993" title="ocaml/runtime/major_gc.c:993">mark</a> phase, so the white values are dead<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; values. It iterates the function <a href="#L123" title="ocaml/runtime/weak.c:123">caml_ephe_clean</a> through all the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; ephemerons.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp;&nbsp; However the GC is incremental <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> ocaml code can run on the middle<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; of this cleaning phase. In order to respect the semantic of the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; ephemerons concerning dead values, the getter <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> setter must work<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; as if the cleaning of all the ephemerons have been done at once.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp;&nbsp; - key getter: Even if a dead key have not yet been replaced by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>, getting it should return none.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; - key setter: If we replace a dead key we need to set the data to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a> <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> clean the ephemeron.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; This two cases are dealt by a call to <a href="#L106" title="ocaml/runtime/weak.c:106">do_check_key_clean</a> that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; trigger the cleaning of the ephemerons when the accessed key is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; dead. This test is fast.<br/></li>
<li></span><br/></li>
<li><span class="Comment">&nbsp; &nbsp;&nbsp; In the case of <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> getter <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> setter, there is no fast<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; test because the removing of the data depend of the deadliness of the keys.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; We must always try to clean the ephemerons.<br/></li>
<li></span><br/></li>
<li><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* If we are in Phase_sweep_ephe we need to check if the key<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; that is going to disappear is dead <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> so should trigger a cleaning<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L106">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">do_check_key_clean</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> elt;<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a> (offset &gt;= <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="major_gc.c.html#L106" title="ocaml/runtime/major_gc.c:106">caml_gc_phase</a> != Phase_sweep_ephe) <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; elt = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (elt != <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a> &amp;&amp; <a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a> (elt) &amp;&amp; !<a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a> (elt)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(elt) == <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>) elt -= <a href="caml/mlvalues.h.html#L250" title="ocaml/runtime/caml/mlvalues.h:250">Infix_offset_val</a>(elt);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/shared_heap.h.html#L79" title="ocaml/runtime/caml/shared_heap.h:79">is_unmarked</a>(elt)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset) = <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e,<a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>) = <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L123">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_ephe_clean</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v) {<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> child;<br/></li>
<li>&nbsp; <span class="Type">int</span> release_data = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> size, i;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="major_gc.c.html#L106" title="ocaml/runtime/major_gc.c:106">caml_gc_phase</a> != Phase_sweep_ephe) <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; hd = <a href="caml/mlvalues.h.html#L157" title="ocaml/runtime/caml/mlvalues.h:157">Hd_val</a>(v);<br/></li>
<li>&nbsp; size = <a href="caml/mlvalues.h.html#L131" title="ocaml/runtime/caml/mlvalues.h:131">Wosize_hd</a> (hd);<br/></li>
<li>&nbsp; <span class="Statement">for</span> (i = <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>; i &lt; size; i++) {<br/></li>
<li>&nbsp; &nbsp; child = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i);<br/></li>
<li>&nbsp; <span class="Statement">ephemeron_again</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (child != <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a> &amp;&amp; <a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(child)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (child) == <a href="caml/mlvalues.h.html#L239" title="ocaml/runtime/caml/mlvalues.h:239">Forward_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> f = <a href="caml/mlvalues.h.html#L240" title="ocaml/runtime/caml/mlvalues.h:240">Forward_val</a> (child);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(f)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(f) == <a href="caml/mlvalues.h.html#L239" title="ocaml/runtime/caml/mlvalues.h:239">Forward_tag</a> || <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(f) == <a href="caml/mlvalues.h.html#L297" title="ocaml/runtime/caml/mlvalues.h:297">Lazy_tag</a> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(f) == <a href="caml/mlvalues.h.html#L304" title="ocaml/runtime/caml/mlvalues.h:304">Forcing_tag</a> || <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(f) == <a href="caml/mlvalues.h.html#L336" title="ocaml/runtime/caml/mlvalues.h:336">Double_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Do not short-circuit the pointer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i) = child = f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a> (f) &amp;&amp; <a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a> (f))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/minor_gc.h.html#L105" title="ocaml/runtime/caml/minor_gc.h:105">add_to_ephe_ref_table</a>(&amp;<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;minor_tables-&gt;ephe_ref, v, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> ephemeron_again;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (child) == <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>) child -= <a href="caml/mlvalues.h.html#L250" title="ocaml/runtime/caml/mlvalues.h:250">Infix_offset_val</a> (child);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a> (child) &amp;&amp; <a href="caml/shared_heap.h.html#L79" title="ocaml/runtime/caml/shared_heap.h:79">is_unmarked</a>(child)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; release_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i) = <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; child = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (child != <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (release_data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>) = <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#ifdef DEBUG<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a> (child) &amp;&amp; !<a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a> (child)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (child) == <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>) child -= <a href="caml/mlvalues.h.html#L250" title="ocaml/runtime/caml/mlvalues.h:250">Infix_offset_val</a> (child);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* If we scanned all the keys <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> the data field remains filled,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; then the <a href="major_gc.c.html#L993" title="ocaml/runtime/major_gc.c:993">mark</a> phase must have marked it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>( <a href="caml/shared_heap.h.html#L83" title="ocaml/runtime/caml/shared_heap.h:83">is_marked</a> (child) );<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L175">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">clean_field</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset == <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>)<br/></li>
<li>&nbsp; &nbsp; <a href="#L123" title="ocaml/runtime/weak.c:123">caml_ephe_clean</a>(e);<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L106" title="ocaml/runtime/weak.c:106">do_check_key_clean</a>(e, offset);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L183">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">do_set</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(v) &amp;&amp; <a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a>(v)) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> old = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset) = v;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(old) &amp;&amp; <a href="caml/address_class.h.html#L51" title="ocaml/runtime/caml/address_class.h:51">Is_young</a>(old)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/minor_gc.h.html#L105" title="ocaml/runtime/caml/minor_gc.h:105">add_to_ephe_ref_table</a> (&amp;<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;minor_tables-&gt;ephe_ref,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; e, offset);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset) = v;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L196">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">ephe_set_field</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> el)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a>(e,el);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L175" title="ocaml/runtime/weak.c:175">clean_field</a>(e, offset);<br/></li>
<li>&nbsp; <a href="#L183" title="ocaml/runtime/weak.c:183">do_set</a>(e, offset, el);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L205">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_set_key</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> el)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (n) + <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || offset &gt;= <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a> (e)){<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.set&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L196" title="ocaml/runtime/weak.c:196">ephe_set_field</a> (e, offset, el);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L215">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_unset_key</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L205" title="ocaml/runtime/weak.c:205">caml_ephe_set_key</a> (e, n, <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L220">&#x200c;</a><a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_set_key_option</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> el)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L443" title="ocaml/runtime/caml/mlvalues.h:443">Is_some</a> (el)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L205" title="ocaml/runtime/weak.c:205">caml_ephe_set_key</a> (e, n, <a href="caml/mlvalues.h.html#L440" title="ocaml/runtime/caml/mlvalues.h:440">Some_val</a>(el));<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L215" title="ocaml/runtime/weak.c:215">caml_ephe_unset_key</a> (e, n);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L229">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_weak_set</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ar, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> el)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L220" title="ocaml/runtime/weak.c:220">caml_ephe_set_key_option</a>(ar,n,el);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L234">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_set_data</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> el)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L196" title="ocaml/runtime/weak.c:196">ephe_set_field</a> (e, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>, el);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L239">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_unset_data</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L234" title="ocaml/runtime/weak.c:234">caml_ephe_set_data</a>(e, <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L244">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">ephe_get_field</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a>(e);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L380" title="ocaml/runtime/caml/memory.h:380">CAMLlocal2</a> (res, elt);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L175" title="ocaml/runtime/weak.c:175">clean_field</a>(e, offset);<br/></li>
<li>&nbsp; elt = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (elt == <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>) {<br/></li>
<li>&nbsp; &nbsp; res = <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="major_gc.c.html#L1052" title="ocaml/runtime/major_gc.c:1052">caml_darken</a> (<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>, elt, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; res = <a href="alloc.c.html#L158" title="ocaml/runtime/alloc.c:158">caml_alloc_small</a> (<span class="Constant">1</span>, <a href="caml/mlvalues.h.html#L441" title="ocaml/runtime/caml/mlvalues.h:441">Tag_some</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(res, <span class="Constant">0</span>) = elt;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* run GC <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> memprof callbacks */<br/></li>
<li></span>&nbsp; <a href="signals.c.html#L360" title="ocaml/runtime/signals.c:360">caml_process_pending_actions</a>();<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L264">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_get_key</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (n) + <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || offset &gt;= <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a> (e)){<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.get&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L244" title="ocaml/runtime/weak.c:244">ephe_get_field</a> (e, offset);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L273">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_weak_get</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ar, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L264" title="ocaml/runtime/weak.c:264">caml_ephe_get_key</a>(ar, n);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Copy the contents of an object from `from` to `to` (which is<br/></li>
<li></span><span class="Comment"> * already allocated <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> has the necessary header word). Darken<br/></li>
<li></span><span class="Comment"> * any pointer fields. */<br/></li>
<li></span><br/></li>
<li><a id="L282">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">ephe_copy_and_darken</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> from, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> to)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> i = <span class="Constant">0</span>; <span class="Comment">/* size of non-scannable prefix */<br/></li>
<li></span><br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(from));<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(to));<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(from) == <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(to));<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(from) != <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(from) == <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(to));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(from) &gt; <a href="caml/mlvalues.h.html#L219" title="ocaml/runtime/caml/mlvalues.h:219">No_scan_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; i = <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(to);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(from) == <a href="caml/mlvalues.h.html#L275" title="ocaml/runtime/caml/mlvalues.h:275">Closure_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; i = <a href="caml/mlvalues.h.html#L285" title="ocaml/runtime/caml/mlvalues.h:285">Start_env_closinfo</a>(<a href="caml/mlvalues.h.html#L277" title="ocaml/runtime/caml/mlvalues.h:277">Closinfo_val</a>(from));<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Copy non-scannable prefix */<br/></li>
<li></span>&nbsp; memcpy (<a href="caml/mlvalues.h.html#L312" title="ocaml/runtime/caml/mlvalues.h:312">Bp_val</a>(to), <a href="caml/mlvalues.h.html#L312" title="ocaml/runtime/caml/mlvalues.h:312">Bp_val</a>(from), <a href="caml/mlvalues.h.html#L181" title="ocaml/runtime/caml/mlvalues.h:181">Bsize_wsize</a>(i));<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Copy <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> darken scannable fields */<br/></li>
<li></span>&nbsp; <a href="caml/domain_state.h.html#L34" title="ocaml/runtime/caml/domain_state.h:34">caml_domain_state</a>* domain_state = <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (i &lt; <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(to)) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> field = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(from, i);<br/></li>
<li>&nbsp; &nbsp; <a href="major_gc.c.html#L1052" title="ocaml/runtime/major_gc.c:1052">caml_darken</a> (domain_state, field, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/memory.h.html#L425" title="ocaml/runtime/caml/memory.h:425">Store_field</a>(to, i, field);<br/></li>
<li>&nbsp; &nbsp; ++ i;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L312">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">ephe_get_field_copy</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a> (e);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L384" title="ocaml/runtime/caml/memory.h:384">CAMLlocal3</a> (res, val, copy);<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> infix_offs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; copy = <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>&nbsp; <span class="Comment">/* Loop in case allocating the copy triggers a GC which modifies the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; * ephemeron <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> the <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>. In the common case, we go around this<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; * loop 1.5 times. */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L175" title="ocaml/runtime/weak.c:175">clean_field</a>(e, offset);<br/></li>
<li>&nbsp; &nbsp; val = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; res = <a href="caml/mlvalues.h.html#L439" title="ocaml/runtime/caml/mlvalues.h:439">Val_none</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> out;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; infix_offs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Don't copy immediates <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> custom blocks #7279 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a>(val) || <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(val) == <a href="caml/mlvalues.h.html#L401" title="ocaml/runtime/caml/mlvalues.h:401">Custom_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; copy = val;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> some;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(val) == <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; infix_offs = <a href="caml/mlvalues.h.html#L250" title="ocaml/runtime/caml/mlvalues.h:250">Infix_offset_val</a>(val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; val -= infix_offs;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (copy != <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(val) == <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(copy)) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(val) == <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(copy))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* The copy we allocated (on a previous iteration) is large<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; * enough <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> has the right header bits for us to copy the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; * contents of val into it. Note that we don't care whether val<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; * has changed since we allocated copy. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* This allocation could provoke a GC, which could change the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; * header <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> size of val (e.g. in a finalizer). So we go around<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; * the loop to read val again. */<br/></li>
<li></span>&nbsp; &nbsp; copy = <a href="alloc.c.html#L33" title="ocaml/runtime/alloc.c:33">caml_alloc</a> (<a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(val), <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a>(val));<br/></li>
<li>&nbsp; &nbsp; val = <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L282" title="ocaml/runtime/weak.c:282">ephe_copy_and_darken</a>(val, copy);<br/></li>
<li><br/></li>
<li><span class="Statement">some</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; res = <a href="alloc.c.html#L378" title="ocaml/runtime/alloc.c:378">caml_alloc_some</a>(copy + infix_offs);<br/></li>
<li><span class="Statement">out</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Comment">/* run GC <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> memprof callbacks */<br/></li>
<li></span>&nbsp; <a href="signals.c.html#L360" title="ocaml/runtime/signals.c:360">caml_process_pending_actions</a>();<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L370">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_get_key_copy</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (n) + <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || offset &gt;= <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a> (e)){<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.get&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L312" title="ocaml/runtime/weak.c:312">ephe_get_field_copy</a>(e, offset);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L379">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_weak_get_copy</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n){<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L370" title="ocaml/runtime/weak.c:370">caml_ephe_get_key_copy</a>(e,n);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L383">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_get_data</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L244" title="ocaml/runtime/weak.c:244">ephe_get_field</a> (e, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L388">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_get_data_copy</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L312" title="ocaml/runtime/weak.c:312">ephe_get_field_copy</a> (e, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L393">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">ephe_check_field</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L276" title="ocaml/runtime/caml/memory.h:276">CAMLparam1</a>(e);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a>(v);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L175" title="ocaml/runtime/weak.c:175">clean_field</a>(e, offset);<br/></li>
<li>&nbsp; v = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(e, offset);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(<a href="caml/mlvalues.h.html#L423" title="ocaml/runtime/caml/mlvalues.h:423">Val_bool</a>(v != <a href="#L35" title="ocaml/runtime/weak.c:35">caml_ephe_none</a>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L403">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_check_key</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (n) + <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || offset &gt;= <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a> (e)){<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.check&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L393" title="ocaml/runtime/weak.c:393">ephe_check_field</a> (e, offset);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L412">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_weak_check</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L403" title="ocaml/runtime/weak.c:403">caml_ephe_check_key</a>(e,n);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L417">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_check_data</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> e)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L393" title="ocaml/runtime/weak.c:393">ephe_check_field</a> (e, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L422">&#x200c;</a><span class="Type">static</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">ephe_blit_field</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> es, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset_s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ed, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset_d, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> length)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L280" title="ocaml/runtime/caml/memory.h:280">CAMLparam2</a>(es,ed);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L376" title="ocaml/runtime/caml/memory.h:376">CAMLlocal1</a>(ar);<br/></li>
<li>&nbsp; <span class="Type">long</span> i;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (length == <span class="Constant">0</span>) <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* We clean the source <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> destination ephemerons before performing the blit.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; * This guarantees that none of the keys <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> the data fields being accessed<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; * during a blit operation is unmarked during [Phase_sweep]. */<br/></li>
<li></span>&nbsp; <a href="#L123" title="ocaml/runtime/weak.c:123">caml_ephe_clean</a>(es);<br/></li>
<li>&nbsp; <a href="#L123" title="ocaml/runtime/weak.c:123">caml_ephe_clean</a>(ed);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset_d &lt; offset_s) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; length; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L183" title="ocaml/runtime/weak.c:183">do_set</a>(ed, offset_d + i, <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(es, (offset_s + i)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = length - <span class="Constant">1</span>; i &gt;= <span class="Constant">0</span>; i--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L183" title="ocaml/runtime/weak.c:183">do_set</a>(ed, offset_d + i, <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(es, (offset_s + i)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a>(<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L449">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_blit_key</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> es, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ed, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofd, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset_s = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (ofs) + <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> offset_d = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (ofd) + <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a>;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> length = <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a> (len);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset_s &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || offset_s + length &gt; <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a> (es)){<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.blit&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (offset_d &lt; <a href="caml/weak.h.html#L71" title="ocaml/runtime/caml/weak.h:71">CAML_EPHE_FIRST_KEY</a> || offset_d + length &gt; <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a> (ed)){<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a> (<span class="Constant">&quot;Weak.blit&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L422" title="ocaml/runtime/weak.c:422">ephe_blit_field</a> (es, offset_s, ed, offset_d, length);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L465">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_ephe_blit_data</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> es, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ed)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L422" title="ocaml/runtime/weak.c:422">ephe_blit_field</a> (es, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>, ed, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; <a href="major_gc.c.html#L1052" title="ocaml/runtime/major_gc.c:1052">caml_darken</a>(<span class="Constant">0</span>, <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(ed, <a href="caml/weak.h.html#L70" title="ocaml/runtime/caml/weak.h:70">CAML_EPHE_DATA_OFFSET</a>), <span class="Constant">0</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* [ed] may be in [<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;ephe_info-&gt;live] list. The data <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> may be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; unmarked. The ephemerons on the live list are not scanned during ephemeron<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; marking. Hence, unconditionally darken the data <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>. */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L475">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_weak_blit</span> (<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> es, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ed, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofd, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L449" title="ocaml/runtime/weak.c:449">caml_ephe_blit_key</a> (es, ofs, ed, ofd, len);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/runtime/extern.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/runtime/extern.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L982">extern_flag_values</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L95">caml_extern_state</a></li>
<li><a href="#L55">extern_item</a></li>
<li><a href="#L59">object_position</a></li>
<li><a href="#L89">output_block</a></li>
<li><a href="#L74">position_table</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L262">bitvect_set</a></li>
<li><a href="#L257">bitvect_test</a></li>
<li><a href="#L149">caml_free_extern_state</a></li>
<li><a href="#L1337">caml_obj_reachable_words</a></li>
<li><a href="#L1070">caml_output_val</a></li>
<li><a href="#L1095">caml_output_value</a></li>
<li><a href="#L1140">caml_output_value_to_block</a></li>
<li><a href="#L1165">caml_output_value_to_buffer</a></li>
<li><a href="#L1106">caml_output_value_to_bytes</a></li>
<li><a href="#L1174">caml_output_value_to_malloc</a></li>
<li><a href="#L1135">caml_output_value_to_string</a></li>
<li><a href="#L1246">caml_serialize_block_1</a></li>
<li><a href="#L1254">caml_serialize_block_2</a></li>
<li><a href="#L1273">caml_serialize_block_4</a></li>
<li><a href="#L1292">caml_serialize_block_8</a></li>
<li><a href="#L1311">caml_serialize_block_float_8</a></li>
<li><a href="#L1236">caml_serialize_float_4</a></li>
<li><a href="#L1241">caml_serialize_float_8</a></li>
<li><a href="#L1204">caml_serialize_int_1</a></li>
<li><a href="#L1212">caml_serialize_int_2</a></li>
<li><a href="#L1220">caml_serialize_int_4</a></li>
<li><a href="#L1228">caml_serialize_int_8</a></li>
<li><a href="#L375">close_extern_output</a></li>
<li><a href="#L738">extern_closure_up_to_env</a></li>
<li><a href="#L716">extern_code_pointer</a></li>
<li><a href="#L918">extern_compress_output</a></li>
<li><a href="#L679">extern_custom</a></li>
<li><a href="#L648">extern_double</a></li>
<li><a href="#L656">extern_double_array</a></li>
<li><a href="#L448">extern_failwith</a></li>
<li><a href="#L243">extern_free_position_table</a></li>
<li><a href="#L178">extern_free_stack</a></li>
<li><a href="#L600">extern_header</a></li>
<li><a href="#L228">extern_init_position_table</a></li>
<li><a href="#L560">extern_int</a></li>
<li><a href="#L442">extern_invalid_argument</a></li>
<li><a href="#L329">extern_lookup_position</a></li>
<li><a href="#L436">extern_out_of_memory</a></li>
<li><a href="#L420">extern_output_length</a></li>
<li><a href="#L765">extern_rec</a></li>
<li><a href="#L350">extern_record_location</a></li>
<li><a href="#L269">extern_resize_position_table</a></li>
<li><a href="#L189">extern_resize_stack</a></li>
<li><a href="#L582">extern_shared_reference</a></li>
<li><a href="#L454">extern_stack_overflow</a></li>
<li><a href="#L623">extern_string</a></li>
<li><a href="#L986">extern_value</a></li>
<li><a href="#L382">free_extern_output</a></li>
<li><a href="#L123">get_extern_state</a></li>
<li><a href="#L397">grow_extern_output</a></li>
<li><a href="#L364">init_extern_output</a></li>
<li><a href="#L463">store16</a></li>
<li><a href="#L468">store32</a></li>
<li><a href="#L473">store64</a></li>
<li><a href="#L480">storevlq</a></li>
<li><a href="#L502">writeblock</a></li>
<li><a href="#L510">writeblock_float8</a></li>
<li><a href="#L496">writebyte</a></li>
<li><a href="#L529">writecode16</a></li>
<li><a href="#L538">writecode32</a></li>
<li><a href="#L548">writecode64</a></li>
<li><a href="#L520">writecode8</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L83">Bits_word</a></li>
<li><a href="#L84">Bitvect_size</a></li>
<li><a href="#L16">CAML_INTERNALS</a></li>
<li><a href="#L52">EXTERN_STACK_INIT_SIZE</a></li>
<li><a href="#L53">EXTERN_STACK_MAX_SIZE</a></li>
<li><a href="#L217">HASH_FACTOR</a></li>
<li><a href="#L219">HASH_FACTOR</a></li>
<li><a href="#L221">Hash</a></li>
<li><a href="#L87">POS_TABLE_INIT_SIZE</a></li>
<li><a href="#L86">POS_TABLE_INIT_SIZE_LOG2</a></li>
<li><a href="#L224">Threshold</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Xavier Leroy, projet Cristal, INRIA Rocquencourt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 1996 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L16">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Structured output */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* The interface of this file is &quot;caml/intext.h&quot; */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/alloc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/codefrag.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/config.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/custom.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/fail.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/gc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/intext.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/io.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/memory.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/misc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/mlvalues.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/reverse.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;caml/shared_heap.h&quot;<br/></li>
<li></span><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;zstd.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Flags affecting marshaling */<br/></li>
<li></span><br/></li>
<li><span class="Type">enum</span> {<br/></li>
<li>&nbsp; NO_SHARING = <span class="Constant">1</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* Flag to ignore sharing */<br/></li>
<li></span>&nbsp; CLOSURES = <span class="Constant">2</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* Flag to allow marshaling code pointers */<br/></li>
<li></span>&nbsp; COMPAT_32 = <span class="Constant">4</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Flag to ensure that output can safely<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; be read back on a 32-bit platform */<br/></li>
<li></span>&nbsp; COMPRESSED = <span class="Constant">8</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Flag to request compression if available */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* Stack for pending values to marshal */<br/></li>
<li></span><br/></li>
<li><a id="L52">&#x200c;</a><span class="PreProc">#define <span class="linkable">EXTERN_STACK_INIT_SIZE</span> </span><span class="Constant">256<br/></li>
<li><a id="L53">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">EXTERN_STACK_MAX_SIZE</span> (</span><span class="Constant">1024</span><span class="PreProc">*</span><span class="Constant">1024</span><span class="PreProc">*</span><span class="Constant">100</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L55">&#x200c;</a><span class="Type">struct</span> <span class="linkable">extern_item</span> { <span class="Type">volatile</span> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> * v; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> count; };<br/></li>
<li><br/></li>
<li><span class="Comment">/* <a href="#L221" title="ocaml/runtime/extern.c:221">Hash</a> table to record already-marshaled objects <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> their positions */<br/></li>
<li></span><br/></li>
<li><a id="L59">&#x200c;</a><span class="Type">struct</span> <span class="linkable">object_position</span> { <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> obj; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> pos; };<br/></li>
<li><br/></li>
<li><span class="Comment">/* The hash table uses open addressing, linear probing, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> a redundant<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; representation:<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; - a bitvector [present] records which entries of the table are occupied;<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; - an array [entries] records (object, position) pairs for the entries<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; that are occupied.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; The bitvector is much smaller than the array (1/128th on 64-bit<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; platforms, 1/64th on 32-bit platforms), so it has better locality,<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; making it faster to determine that an object is not in the table.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Also, it makes it faster to empty <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> initialize a table: only the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; [present] bitvector needs to be filled with zeros, the [entries]<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; array can be left uninitialized.<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L74">&#x200c;</a><span class="Type">struct</span> <span class="linkable">position_table</span> {<br/></li>
<li>&nbsp; <span class="Type">int</span> shift;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> size;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* size == 1 &lt;&lt; (wordsize - shift) */<br/></li>
<li></span>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> mask;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* mask == size - 1 */<br/></li>
<li></span>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> threshold;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* threshold == a fixed fraction of size */<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * present;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* [<a href="#L84" title="ocaml/runtime/extern.c:84">Bitvect_size</a>(size)] */<br/></li>
<li></span>&nbsp; <span class="Type">struct</span> <a href="#L59" title="ocaml/runtime/extern.c:59">object_position</a> * entries; <span class="Comment">/* [size]&nbsp; */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><a id="L83">&#x200c;</a><span class="PreProc">#define <span class="linkable">Bits_word</span> (</span><span class="Constant">8</span><span class="PreProc"> * </span><span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span><span class="PreProc">(<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>))<br/></li>
<li><a id="L84">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">Bitvect_size</span>(n) (((n) + <a href="#L83" title="ocaml/runtime/extern.c:83">Bits_word</a> - </span><span class="Constant">1</span><span class="PreProc">) / <a href="#L83" title="ocaml/runtime/extern.c:83">Bits_word</a>)<br/></li>
<li></span><br/></li>
<li><a id="L86">&#x200c;</a><span class="PreProc">#define <span class="linkable">POS_TABLE_INIT_SIZE_LOG2</span> </span><span class="Constant">8<br/></li>
<li><a id="L87">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">POS_TABLE_INIT_SIZE</span> (</span><span class="Constant">1</span><span class="PreProc"> &lt;&lt; <a href="#L86" title="ocaml/runtime/extern.c:86">POS_TABLE_INIT_SIZE_LOG2</a>)<br/></li>
<li></span><br/></li>
<li><a id="L89">&#x200c;</a><span class="Type">struct</span> <span class="linkable">output_block</span> {<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * next;<br/></li>
<li>&nbsp; <span class="Type">char</span> * end;<br/></li>
<li>&nbsp; <span class="Type">char</span> data[<a href="caml/intext.h.html#L119" title="ocaml/runtime/caml/intext.h:119">SIZE_EXTERN_OUTPUT_BLOCK</a>];<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L95">&#x200c;</a><span class="Type">struct</span> <span class="linkable">caml_extern_state</span> {<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">int</span> extern_flags;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* logical <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> of some of the flags */<br/></li>
<li></span><br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> obj_counter;&nbsp; &nbsp; <span class="Comment">/* Number of objects emitted so far */<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> size_32;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Size in words of 32-bit block for struct. */<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> size_64;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Size in words of 64-bit block for struct. */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Comment">/* Stack for pending <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> to marshal */<br/></li>
<li></span>&nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> extern_stack_init[<a href="#L52" title="ocaml/runtime/extern.c:52">EXTERN_STACK_INIT_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * extern_stack;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * extern_stack_limit;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* <a href="#L221" title="ocaml/runtime/extern.c:221">Hash</a> table to record already marshalled objects */<br/></li>
<li></span>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> pos_table_present_init[<a href="#L84" title="ocaml/runtime/extern.c:84">Bitvect_size</a>(<a href="#L87" title="ocaml/runtime/extern.c:87">POS_TABLE_INIT_SIZE</a>)];<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L59" title="ocaml/runtime/extern.c:59">object_position</a> pos_table_entries_init[<a href="#L87" title="ocaml/runtime/extern.c:87">POS_TABLE_INIT_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L74" title="ocaml/runtime/extern.c:74">position_table</a> pos_table;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* To buffer the output */<br/></li>
<li></span><br/></li>
<li>&nbsp; <span class="Type">char</span> * extern_userprovided_output;<br/></li>
<li>&nbsp; <span class="Type">char</span> * extern_ptr;<br/></li>
<li>&nbsp; <span class="Type">char</span> * extern_limit;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * extern_output_first;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * extern_output_block;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L123">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* <span class="linkable">get_extern_state</span> (<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L72" title="ocaml/runtime/caml/domain_state.h:72">Caml_check_caml_state</a>();<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* extern_state;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;extern_state != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;extern_state;<br/></li>
<li><br/></li>
<li>&nbsp; extern_state =<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (extern_state == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; extern_state-&gt;extern_flags = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; extern_state-&gt;obj_counter = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; extern_state-&gt;size_32 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; extern_state-&gt;size_64 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; extern_state-&gt;extern_stack = extern_state-&gt;extern_stack_init;<br/></li>
<li>&nbsp; extern_state-&gt;extern_stack_limit =<br/></li>
<li>&nbsp; &nbsp; extern_state-&gt;extern_stack + <a href="#L52" title="ocaml/runtime/extern.c:52">EXTERN_STACK_INIT_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;extern_state = extern_state;<br/></li>
<li>&nbsp; <span class="Statement">return</span> extern_state;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L149">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_free_extern_state</span> (<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;extern_state != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(<a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;extern_state);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/domain_state.h.html#L62" title="ocaml/runtime/caml/domain_state.h:62">Caml_state</a>-&gt;extern_state = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Forward declarations */<br/></li>
<li></span><br/></li>
<li><a href="caml/misc.h.html#L90" title="ocaml/runtime/caml/misc.h:90">CAMLnoreturn_start</a><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li><a href="caml/misc.h.html#L91" title="ocaml/runtime/caml/misc.h:91">CAMLnoreturn_end</a>;<br/></li>
<li><br/></li>
<li><a href="caml/misc.h.html#L90" title="ocaml/runtime/caml/misc.h:90">CAMLnoreturn_start</a><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <span class="Type">char</span> *msg)<br/></li>
<li><a href="caml/misc.h.html#L91" title="ocaml/runtime/caml/misc.h:91">CAMLnoreturn_end</a>;<br/></li>
<li><br/></li>
<li><a href="caml/misc.h.html#L90" title="ocaml/runtime/caml/misc.h:90">CAMLnoreturn_start</a><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L448" title="ocaml/runtime/extern.c:448">extern_failwith</a>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <span class="Type">char</span> *msg)<br/></li>
<li><a href="caml/misc.h.html#L91" title="ocaml/runtime/caml/misc.h:91">CAMLnoreturn_end</a>;<br/></li>
<li><br/></li>
<li><a href="caml/misc.h.html#L90" title="ocaml/runtime/caml/misc.h:90">CAMLnoreturn_start</a><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L454" title="ocaml/runtime/extern.c:454">extern_stack_overflow</a>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li><a href="caml/misc.h.html#L91" title="ocaml/runtime/caml/misc.h:91">CAMLnoreturn_end</a>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s);<br/></li>
<li><br/></li>
<li><span class="Comment">/* Free the extern stack if needed */<br/></li>
<li><a id="L178">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_free_stack</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_stack != s-&gt;extern_stack_init) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;extern_stack);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Reinitialize the globals for next time around */<br/></li>
<li></span>&nbsp; &nbsp; s-&gt;extern_stack = s-&gt;extern_stack_init;<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_stack_limit = s-&gt;extern_stack + <a href="#L52" title="ocaml/runtime/extern.c:52">EXTERN_STACK_INIT_SIZE</a>;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L189">&#x200c;</a><span class="Type">static</span> <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * <span class="linkable">extern_resize_stack</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * sp)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> newsize = <span class="Constant">2</span> * (s-&gt;extern_stack_limit - s-&gt;extern_stack);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L68" title="ocaml/runtime/caml/misc.h:68">asize_t</a> sp_offset = sp - s-&gt;extern_stack;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * newstack;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (newsize &gt;= <a href="#L53" title="ocaml/runtime/extern.c:53">EXTERN_STACK_MAX_SIZE</a>) <a href="#L454" title="ocaml/runtime/extern.c:454">extern_stack_overflow</a>(s);<br/></li>
<li>&nbsp; newstack = <a href="memory.c.html#L609" title="ocaml/runtime/memory.c:609">caml_stat_calloc_noexc</a>(newsize, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (newstack == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="#L454" title="ocaml/runtime/extern.c:454">extern_stack_overflow</a>(s);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Copy items from the old stack to the new stack */<br/></li>
<li></span>&nbsp; memcpy (newstack, s-&gt;extern_stack,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a>) * sp_offset);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Free the old stack if it is not the initial stack */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s-&gt;extern_stack != s-&gt;extern_stack_init)<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;extern_stack);<br/></li>
<li><br/></li>
<li>&nbsp; s-&gt;extern_stack = newstack;<br/></li>
<li>&nbsp; s-&gt;extern_stack_limit = newstack + newsize;<br/></li>
<li>&nbsp; <span class="Statement">return</span> newstack + sp_offset;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Multiplicative Fibonacci hashing<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; (Knuth, TAOCP vol 3, section 6.4, page 518).<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; <a href="#L217" title="ocaml/runtime/extern.c:217">HASH_FACTOR</a> is (sqrt(5) - 1) / 2 * 2^wordsize. */<br/></li>
<li></span><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li><a id="L217">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">HASH_FACTOR</span> </span><span class="Constant">11400714819323198486UL<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L219">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">HASH_FACTOR</span> </span><span class="Constant">2654435769UL<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li><a id="L221">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">Hash</span>(v,shift) (((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)(v) * <a href="#L217" title="ocaml/runtime/extern.c:217">HASH_FACTOR</a>) &gt;&gt; (shift))<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* When the table becomes 2/3 full, its size is increased. */<br/></li>
<li><a id="L224">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">Threshold</span>(sz) (((sz) * </span><span class="Constant">2</span><span class="PreProc">) / </span><span class="Constant">3</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Initialize the position table */<br/></li>
<li></span><br/></li>
<li><a id="L228">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_init_position_table</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; NO_SHARING) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; s-&gt;pos_table.size = <a href="#L87" title="ocaml/runtime/extern.c:87">POS_TABLE_INIT_SIZE</a>;<br/></li>
<li>&nbsp; s-&gt;pos_table.shift = <span class="Constant">8</span> * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>) - <a href="#L86" title="ocaml/runtime/extern.c:86">POS_TABLE_INIT_SIZE_LOG2</a>;<br/></li>
<li>&nbsp; s-&gt;pos_table.mask = <a href="#L87" title="ocaml/runtime/extern.c:87">POS_TABLE_INIT_SIZE</a> - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; s-&gt;pos_table.threshold = <a href="#L224" title="ocaml/runtime/extern.c:224">Threshold</a>(<a href="#L87" title="ocaml/runtime/extern.c:87">POS_TABLE_INIT_SIZE</a>);<br/></li>
<li>&nbsp; s-&gt;pos_table.present = s-&gt;pos_table_present_init;<br/></li>
<li>&nbsp; s-&gt;pos_table.entries = s-&gt;pos_table_entries_init;<br/></li>
<li>&nbsp; memset(s-&gt;pos_table_present_init, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L84" title="ocaml/runtime/extern.c:84">Bitvect_size</a>(<a href="#L87" title="ocaml/runtime/extern.c:87">POS_TABLE_INIT_SIZE</a>) * <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Free the position table */<br/></li>
<li></span><br/></li>
<li><a id="L243">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_free_position_table</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; NO_SHARING) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;pos_table.present != s-&gt;pos_table_present_init) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;pos_table.present);<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(s-&gt;pos_table.entries);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Protect against repeated calls to <a href="#L243" title="ocaml/runtime/extern.c:243">extern_free_position_table</a> */<br/></li>
<li></span>&nbsp; &nbsp; s-&gt;pos_table.present = s-&gt;pos_table_present_init;<br/></li>
<li>&nbsp; &nbsp; s-&gt;pos_table.entries = s-&gt;pos_table_entries_init;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Accessing bitvectors */<br/></li>
<li></span><br/></li>
<li><a id="L257">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> <span class="linkable">bitvect_test</span>(<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * bv, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> i)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> bv[i / <a href="#L83" title="ocaml/runtime/extern.c:83">Bits_word</a>] &amp; ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) <span class="Constant">1</span> &lt;&lt; (i &amp; (<a href="#L83" title="ocaml/runtime/extern.c:83">Bits_word</a> - <span class="Constant">1</span>)));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L262">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">bitvect_set</span>(<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * bv, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> i)<br/></li>
<li>{<br/></li>
<li>&nbsp; bv[i / <a href="#L83" title="ocaml/runtime/extern.c:83">Bits_word</a>] |= ((<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) <span class="Constant">1</span> &lt;&lt; (i &amp; (<a href="#L83" title="ocaml/runtime/extern.c:83">Bits_word</a> - <span class="Constant">1</span>)));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Grow the position table */<br/></li>
<li></span><br/></li>
<li><a id="L269">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_resize_position_table</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> new_size, new_byte_size;<br/></li>
<li>&nbsp; <span class="Type">int</span> new_shift;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * new_present;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L59" title="ocaml/runtime/extern.c:59">object_position</a> * new_entries;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> i, h;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L74" title="ocaml/runtime/extern.c:74">position_table</a> old = s-&gt;pos_table;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Grow the table quickly (x 8) up to 10^6 entries,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; more slowly (x 2) afterwards. */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (old.size &lt; <span class="Constant">1000000</span>) {<br/></li>
<li>&nbsp; &nbsp; new_size = <span class="Constant">8</span> * old.size;<br/></li>
<li>&nbsp; &nbsp; new_shift = old.shift - <span class="Constant">3</span>;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; new_size = <span class="Constant">2</span> * old.size;<br/></li>
<li>&nbsp; &nbsp; new_shift = old.shift - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">if</span> (new_size == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; || <a href="caml/misc.h.html#L347" title="ocaml/runtime/caml/misc.h:347">caml_umul_overflow</a>(new_size, <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L59" title="ocaml/runtime/extern.c:59">object_position</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;new_byte_size))<br/></li>
<li>&nbsp; &nbsp; <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>&nbsp; new_entries = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(new_byte_size);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (new_entries == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>&nbsp; new_present =<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L609" title="ocaml/runtime/memory.c:609">caml_stat_calloc_noexc</a>(<a href="#L84" title="ocaml/runtime/extern.c:84">Bitvect_size</a>(new_size), <span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (new_present == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(new_entries);<br/></li>
<li>&nbsp; &nbsp; <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; s-&gt;pos_table.size = new_size;<br/></li>
<li>&nbsp; s-&gt;pos_table.shift = new_shift;<br/></li>
<li>&nbsp; s-&gt;pos_table.mask = new_size - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; s-&gt;pos_table.threshold = <a href="#L224" title="ocaml/runtime/extern.c:224">Threshold</a>(new_size);<br/></li>
<li>&nbsp; s-&gt;pos_table.present = new_present;<br/></li>
<li>&nbsp; s-&gt;pos_table.entries = new_entries;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Insert every entry of the old table in the new table */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; old.size; i++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (! <a href="#L257" title="ocaml/runtime/extern.c:257">bitvect_test</a>(old.present, i)) <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; h = <a href="#L221" title="ocaml/runtime/extern.c:221">Hash</a>(old.entries[i].obj, s-&gt;pos_table.shift);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="#L257" title="ocaml/runtime/extern.c:257">bitvect_test</a>(new_present, h)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; h = (h + <span class="Constant">1</span>) &amp; s-&gt;pos_table.mask;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="#L262" title="ocaml/runtime/extern.c:262">bitvect_set</a>(new_present, h);<br/></li>
<li>&nbsp; &nbsp; new_entries[h] = old.entries[i];<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* Free the old tables if they are not the initial ones */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (old.present != s-&gt;pos_table_present_init) {<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(old.present);<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(old.entries);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Determine whether the given object [obj] is in the hash table.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; If so, set [*pos_out] to its position in the output <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> return 1.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; If not, set [*h_out] to the hash <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> appropriate for<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; [<a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>] <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> return 0. */<br/></li>
<li></span><br/></li>
<li><a id="L329">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">int</span> <span class="linkable">extern_lookup_position</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a> *s, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> obj,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * pos_out, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * h_out)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> h = <a href="#L221" title="ocaml/runtime/extern.c:221">Hash</a>(obj, s-&gt;pos_table.shift);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (! <a href="#L257" title="ocaml/runtime/extern.c:257">bitvect_test</a>(s-&gt;pos_table.present, h)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; *h_out = h;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;pos_table.entries[h].obj == obj) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; *pos_out = s-&gt;pos_table.entries[h].pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; h = (h + <span class="Constant">1</span>) &amp; s-&gt;pos_table.mask;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Record the output position for the given object [obj]. */<br/></li>
<li></span><span class="Comment">/* The [h] parameter is the index in the hash table where the object<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; must be inserted.&nbsp; It was determined during lookup. */<br/></li>
<li></span><br/></li>
<li><a id="L350">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_record_location</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> obj, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> h)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; NO_SHARING) <span class="Statement">return</span>;<br/></li>
<li>&nbsp; <a href="#L262" title="ocaml/runtime/extern.c:262">bitvect_set</a>(s-&gt;pos_table.present, h);<br/></li>
<li>&nbsp; s-&gt;pos_table.entries[h].obj = obj;<br/></li>
<li>&nbsp; s-&gt;pos_table.entries[h].pos = s-&gt;obj_counter;<br/></li>
<li>&nbsp; s-&gt;obj_counter++;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;obj_counter &gt;= s-&gt;pos_table.threshold)<br/></li>
<li>&nbsp; &nbsp; <a href="#L269" title="ocaml/runtime/extern.c:269">extern_resize_position_table</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* To buffer the output */<br/></li>
<li></span><br/></li>
<li><a id="L364">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">init_extern_output</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; s-&gt;extern_userprovided_output = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; s-&gt;extern_output_first = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_output_first == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>&nbsp; s-&gt;extern_output_block = s-&gt;extern_output_first;<br/></li>
<li>&nbsp; s-&gt;extern_output_block-&gt;next = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; s-&gt;extern_ptr = s-&gt;extern_output_block-&gt;data;<br/></li>
<li>&nbsp; s-&gt;extern_limit = s-&gt;extern_output_block-&gt;data + <a href="caml/intext.h.html#L119" title="ocaml/runtime/caml/intext.h:119">SIZE_EXTERN_OUTPUT_BLOCK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L375">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">close_extern_output</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_userprovided_output == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>){<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_output_block-&gt;end = s-&gt;extern_ptr;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L382">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">free_extern_output</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * blk, * nextblk;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_userprovided_output == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (blk = s-&gt;extern_output_first; blk != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>; blk = nextblk) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; nextblk = blk-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(blk);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_output_first = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L178" title="ocaml/runtime/extern.c:178">extern_free_stack</a>(s);<br/></li>
<li>&nbsp; <a href="#L243" title="ocaml/runtime/extern.c:243">extern_free_position_table</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L397">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">grow_extern_output</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a> *s, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> required)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * blk;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> extra;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_userprovided_output != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L448" title="ocaml/runtime/extern.c:448">extern_failwith</a>(s, <span class="Constant">&quot;Marshal.to_buffer: buffer overflow&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; s-&gt;extern_output_block-&gt;end = s-&gt;extern_ptr;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (required &lt;= <a href="caml/intext.h.html#L119" title="ocaml/runtime/caml/intext.h:119">SIZE_EXTERN_OUTPUT_BLOCK</a> / <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; extra = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; extra = required;<br/></li>
<li>&nbsp; blk = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a>) + extra);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (blk == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>&nbsp; s-&gt;extern_output_block-&gt;next = blk;<br/></li>
<li>&nbsp; s-&gt;extern_output_block = blk;<br/></li>
<li>&nbsp; s-&gt;extern_output_block-&gt;next = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; s-&gt;extern_ptr = s-&gt;extern_output_block-&gt;data;<br/></li>
<li>&nbsp; s-&gt;extern_limit =<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_output_block-&gt;data + <a href="caml/intext.h.html#L119" title="ocaml/runtime/caml/intext.h:119">SIZE_EXTERN_OUTPUT_BLOCK</a> + extra;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L420">&#x200c;</a><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">extern_output_length</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * blk;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_userprovided_output != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s-&gt;extern_ptr - s-&gt;extern_userprovided_output;<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (len = <span class="Constant">0</span>, blk = s-&gt;extern_output_first; blk != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>; blk = blk-&gt;next)<br/></li>
<li>&nbsp; &nbsp; &nbsp; len += blk-&gt;end - blk-&gt;data;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> len;<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Exception raising, with cleanup */<br/></li>
<li></span><br/></li>
<li><a id="L436">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_out_of_memory</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(s);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L442">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_invalid_argument</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a> *s, <span class="Type">char</span> *msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(s);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L140" title="ocaml/runtime/fail_nat.c:140">caml_invalid_argument</a>(msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L448">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_failwith</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <span class="Type">char</span> *msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(s);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L454">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_stack_overflow</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="misc.c.html#L95" title="ocaml/runtime/misc.c:95">caml_gc_message</a> (<span class="Constant">0x04</span>, <span class="Constant">&quot;Stack overflow in marshaling <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a></span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(s);<br/></li>
<li>&nbsp; <a href="fail_nat.c.html#L150" title="ocaml/runtime/fail_nat.c:150">caml_raise_out_of_memory</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Conversion to big-endian */<br/></li>
<li></span><br/></li>
<li><a id="L463">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">store16</span>(<span class="Type">char</span> * dst, <span class="Type">int</span> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; dst[<span class="Constant">0</span>] = n &gt;&gt; <span class="Constant">8</span>;&nbsp; dst[<span class="Constant">1</span>] = n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L468">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">store32</span>(<span class="Type">char</span> * dst, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; dst[<span class="Constant">0</span>] = n &gt;&gt; <span class="Constant">24</span>;&nbsp; dst[<span class="Constant">1</span>] = n &gt;&gt; <span class="Constant">16</span>;&nbsp; dst[<span class="Constant">2</span>] = n &gt;&gt; <span class="Constant">8</span>;&nbsp; dst[<span class="Constant">3</span>] = n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L473">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">store64</span>(<span class="Type">char</span> * dst, <span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; dst[<span class="Constant">0</span>] = n &gt;&gt; <span class="Constant">56</span>;&nbsp; dst[<span class="Constant">1</span>] = n &gt;&gt; <span class="Constant">48</span>;&nbsp; dst[<span class="Constant">2</span>] = n &gt;&gt; <span class="Constant">40</span>;&nbsp; dst[<span class="Constant">3</span>] = n &gt;&gt; <span class="Constant">32</span>;<br/></li>
<li>&nbsp; dst[<span class="Constant">4</span>] = n &gt;&gt; <span class="Constant">24</span>;&nbsp; dst[<span class="Constant">5</span>] = n &gt;&gt; <span class="Constant">16</span>;&nbsp; dst[<span class="Constant">6</span>] = n &gt;&gt; <span class="Constant">8</span>;&nbsp;&nbsp; dst[<span class="Constant">7</span>] = n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li><a id="L480">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">storevlq</span>(<span class="Type">char</span> * dst, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Comment">/* Find number of base-128 digits (always at least one) */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> ndigits = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> m = n &gt;&gt; <span class="Constant">7</span>; m != <span class="Constant">0</span>; m &gt;&gt;= <span class="Constant">7</span>) ndigits++;<br/></li>
<li>&nbsp; <span class="Comment">/* Convert number */<br/></li>
<li></span>&nbsp; dst += ndigits - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; *dst = n &amp; <span class="Constant">0x7F</span>;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (n &gt;&gt;= <span class="Constant">7</span>; n != <span class="Constant">0</span>; n &gt;&gt;= <span class="Constant">7</span>) *--dst = <span class="Constant">0x80</span> | (n &amp; <span class="Constant">0x7F</span>);<br/></li>
<li>&nbsp; <span class="Comment">/* Return length of number */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> ndigits;<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Write characters, integers, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> blocks in the output buffer */<br/></li>
<li></span><br/></li>
<li><a id="L496">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">writebyte</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <span class="Type">int</span> c)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr &gt;= s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; *s-&gt;extern_ptr++ = c;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L502">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">writeblock</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <span class="Type">const</span> <span class="Type">char</span> * data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + len &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, len);<br/></li>
<li>&nbsp; memcpy(s-&gt;extern_ptr, data, len);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L510">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">writeblock_float8</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">double</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> ndoubles)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x01234567</span><span class="PreProc"> || <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x76543210<br/></li>
<li></span>&nbsp; <a href="#L502" title="ocaml/runtime/extern.c:502">writeblock</a>(s, (<span class="Type">const</span> <span class="Type">char</span> *) data, ndoubles * <span class="Constant">8</span>);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <a href="#L1311" title="ocaml/runtime/extern.c:1311">caml_serialize_block_float_8</a>(data, ndoubles);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L520">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">writecode8</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> code, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> val)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">2</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr[<span class="Constant">0</span>] = code;<br/></li>
<li>&nbsp; s-&gt;extern_ptr[<span class="Constant">1</span>] = val;<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">2</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L529">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">writecode16</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> code, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> val)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">3</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">3</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr[<span class="Constant">0</span>] = code;<br/></li>
<li>&nbsp; <a href="#L463" title="ocaml/runtime/extern.c:463">store16</a>(s-&gt;extern_ptr + <span class="Constant">1</span>, (<span class="Type">int</span>) val);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">3</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L538">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">writecode32</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> code, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> val)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">5</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">5</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr[<span class="Constant">0</span>] = code;<br/></li>
<li>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(s-&gt;extern_ptr + <span class="Constant">1</span>, val);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">5</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li><a id="L548">&#x200c;</a></span><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">writecode64</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> code, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> val)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">9</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">9</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr[<span class="Constant">0</span>] = code;<br/></li>
<li>&nbsp; <a href="#L473" title="ocaml/runtime/extern.c:473">store64</a>(s-&gt;extern_ptr + <span class="Constant">1</span>, val);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">9</span>;<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Marshaling integers */<br/></li>
<li></span><br/></li>
<li><a id="L560">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_int</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (n &gt;= <span class="Constant">0</span> &amp;&amp; n &lt; <span class="Constant">0x40</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L496" title="ocaml/runtime/extern.c:496">writebyte</a>(s, <a href="caml/intext.h.html#L73" title="ocaml/runtime/caml/intext.h:73">PREFIX_SMALL_INT</a> + n);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n &gt;= -(<span class="Constant">1</span> &lt;&lt; <span class="Constant">7</span>) &amp;&amp; n &lt; (<span class="Constant">1</span> &lt;&lt; <span class="Constant">7</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L520" title="ocaml/runtime/extern.c:520">writecode8</a>(s, <a href="caml/intext.h.html#L75" title="ocaml/runtime/caml/intext.h:75">CODE_INT8</a>, n);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n &gt;= -(<span class="Constant">1</span> &lt;&lt; <span class="Constant">15</span>) &amp;&amp; n &lt; (<span class="Constant">1</span> &lt;&lt; <span class="Constant">15</span>)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L529" title="ocaml/runtime/extern.c:529">writecode16</a>(s, <a href="caml/intext.h.html#L76" title="ocaml/runtime/caml/intext.h:76">CODE_INT16</a>, n);<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n &lt; -((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">30</span>) || n &gt;= ((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">30</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; COMPAT_32)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L448" title="ocaml/runtime/extern.c:448">extern_failwith</a>(s, <span class="Constant">&quot;output_value: integer cannot be read back on &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;32-bit platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L548" title="ocaml/runtime/extern.c:548">writecode64</a>(s, <a href="caml/intext.h.html#L78" title="ocaml/runtime/caml/intext.h:78">CODE_INT64</a>, n);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L77" title="ocaml/runtime/caml/intext.h:77">CODE_INT32</a>, n);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling references to previously-marshaled blocks */<br/></li>
<li></span><br/></li>
<li><a id="L582">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_shared_reference</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> d)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (d &lt; <span class="Constant">0x100</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L520" title="ocaml/runtime/extern.c:520">writecode8</a>(s, <a href="caml/intext.h.html#L79" title="ocaml/runtime/caml/intext.h:79">CODE_SHARED8</a>, d);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (d &lt; <span class="Constant">0x10000</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L529" title="ocaml/runtime/extern.c:529">writecode16</a>(s, <a href="caml/intext.h.html#L80" title="ocaml/runtime/caml/intext.h:80">CODE_SHARED16</a>, d);<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (d &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L548" title="ocaml/runtime/extern.c:548">writecode64</a>(s, <a href="caml/intext.h.html#L82" title="ocaml/runtime/caml/intext.h:82">CODE_SHARED64</a>, d);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L81" title="ocaml/runtime/caml/intext.h:81">CODE_SHARED32</a>, d);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling block headers */<br/></li>
<li></span><br/></li>
<li><a id="L600">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_header</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> sz, <a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (tag &lt; <span class="Constant">16</span> &amp;&amp; sz &lt; <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L496" title="ocaml/runtime/extern.c:496">writebyte</a>(s, <a href="caml/intext.h.html#L72" title="ocaml/runtime/caml/intext.h:72">PREFIX_SMALL_BLOCK</a> + tag + (sz &lt;&lt; <span class="Constant">4</span>));<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = <a href="caml/gc.h.html#L32" title="ocaml/runtime/caml/gc.h:32">Make_header</a>(sz, tag, NOT_MARKABLE);<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (sz &gt; <span class="Constant">0x3FFFFF</span> &amp;&amp; (s-&gt;extern_flags &amp; COMPAT_32))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L448" title="ocaml/runtime/extern.c:448">extern_failwith</a>(s, <span class="Constant">&quot;output_value: array cannot be read back on &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;32-bit platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hd &lt; (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L83" title="ocaml/runtime/caml/intext.h:83">CODE_BLOCK32</a>, hd);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L548" title="ocaml/runtime/extern.c:548">writecode64</a>(s, <a href="caml/intext.h.html#L84" title="ocaml/runtime/caml/intext.h:84">CODE_BLOCK64</a>, hd);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L83" title="ocaml/runtime/caml/intext.h:83">CODE_BLOCK32</a>, hd);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling strings */<br/></li>
<li></span><br/></li>
<li><a id="L623">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_string</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a> *s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (len &lt; <span class="Constant">0x20</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L496" title="ocaml/runtime/extern.c:496">writebyte</a>(s, <a href="caml/intext.h.html#L74" title="ocaml/runtime/caml/intext.h:74">PREFIX_SMALL_STRING</a> + len);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (len &lt; <span class="Constant">0x100</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L520" title="ocaml/runtime/extern.c:520">writecode8</a>(s, <a href="caml/intext.h.html#L85" title="ocaml/runtime/caml/intext.h:85">CODE_STRING8</a>, len);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <span class="Constant">0xFFFFFB</span> &amp;&amp; (s-&gt;extern_flags &amp; COMPAT_32))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L448" title="ocaml/runtime/extern.c:448">extern_failwith</a>(s, <span class="Constant">&quot;output_value: string cannot be read back on &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;32-bit platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt; (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L86" title="ocaml/runtime/caml/intext.h:86">CODE_STRING32</a>, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L548" title="ocaml/runtime/extern.c:548">writecode64</a>(s, <a href="caml/intext.h.html#L87" title="ocaml/runtime/caml/intext.h:87">CODE_STRING64</a>, len);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L86" title="ocaml/runtime/caml/intext.h:86">CODE_STRING32</a>, len);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L502" title="ocaml/runtime/extern.c:502">writeblock</a>(s, <a href="caml/mlvalues.h.html#L329" title="ocaml/runtime/caml/mlvalues.h:329">String_val</a>(v), len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling FP numbers */<br/></li>
<li></span><br/></li>
<li><a id="L648">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_double</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L496" title="ocaml/runtime/extern.c:496">writebyte</a>(s, <a href="caml/intext.h.html#L103" title="ocaml/runtime/caml/intext.h:103">CODE_DOUBLE_NATIVE</a>);<br/></li>
<li>&nbsp; <a href="#L510" title="ocaml/runtime/extern.c:510">writeblock_float8</a>(s, (<span class="Type">double</span> *) v, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling FP arrays */<br/></li>
<li></span><br/></li>
<li><a id="L656">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_double_array</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> nfloats)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">if</span> (nfloats &lt; <span class="Constant">0x100</span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L520" title="ocaml/runtime/extern.c:520">writecode8</a>(s, <a href="caml/intext.h.html#L104" title="ocaml/runtime/caml/intext.h:104">CODE_DOUBLE_ARRAY8_NATIVE</a>, nfloats);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (nfloats &gt; <span class="Constant">0x1FFFFF</span> &amp;&amp; (s-&gt;extern_flags &amp; COMPAT_32))<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L448" title="ocaml/runtime/extern.c:448">extern_failwith</a>(s, <span class="Constant">&quot;output_value: float array cannot be read back on &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;32-bit platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nfloats &lt; (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>) <span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L105" title="ocaml/runtime/caml/intext.h:105">CODE_DOUBLE_ARRAY32_NATIVE</a>, nfloats);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L548" title="ocaml/runtime/extern.c:548">writecode64</a>(s, <a href="caml/intext.h.html#L106" title="ocaml/runtime/caml/intext.h:106">CODE_DOUBLE_ARRAY64_NATIVE</a>, nfloats);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L105" title="ocaml/runtime/caml/intext.h:105">CODE_DOUBLE_ARRAY32_NATIVE</a>, nfloats);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L510" title="ocaml/runtime/extern.c:510">writeblock_float8</a>(s, (<span class="Type">double</span> *) v, nfloats);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling custom blocks */<br/></li>
<li></span><br/></li>
<li><a id="L679">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <span class="Type">void</span> <span class="linkable">extern_custom</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*out*/</span> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * sz_32,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*out*/</span> <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * sz_64)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> * size_header;<br/></li>
<li>&nbsp; <span class="Type">char</span> <span class="Type">const</span> * ident = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(v)-&gt;identifier;<br/></li>
<li>&nbsp; <span class="Type">void</span> (*serialize)(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * bsize_32, <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> * bsize_64)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(v)-&gt;serialize;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">struct</span> <a href="caml/custom.h.html#L22" title="ocaml/runtime/caml/custom.h:22">custom_fixed_length</a>* fixed_length<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; = <a href="caml/custom.h.html#L48" title="ocaml/runtime/caml/custom.h:48">Custom_ops_val</a>(v)-&gt;fixed_length;<br/></li>
<li>&nbsp; <span class="Statement">if</span> (serialize == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(s, <span class="Constant">&quot;output_value: abstract <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> (Custom)&quot;</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (fixed_length == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L496" title="ocaml/runtime/extern.c:496">writebyte</a>(s, <a href="caml/intext.h.html#L99" title="ocaml/runtime/caml/intext.h:99">CODE_CUSTOM_LEN</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L502" title="ocaml/runtime/extern.c:502">writeblock</a>(s, ident, strlen(ident) + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Reserve 12 bytes for the lengths (sz_32 <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> sz_64). */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">12</span> &gt;= s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">12</span>);<br/></li>
<li>&nbsp; &nbsp; size_header = s-&gt;extern_ptr;<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_ptr += <span class="Constant">12</span>;<br/></li>
<li>&nbsp; &nbsp; serialize(v, sz_32, sz_64);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Store length before serialized block */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(size_header, *sz_32);<br/></li>
<li>&nbsp; &nbsp; <a href="#L473" title="ocaml/runtime/extern.c:473">store64</a>(size_header + <span class="Constant">4</span>, *sz_64);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L496" title="ocaml/runtime/extern.c:496">writebyte</a>(s, <a href="caml/intext.h.html#L100" title="ocaml/runtime/caml/intext.h:100">CODE_CUSTOM_FIXED</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L502" title="ocaml/runtime/extern.c:502">writeblock</a>(s, ident, strlen(ident) + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; serialize(v, sz_32, sz_64);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*sz_32 != fixed_length-&gt;bsize_32 ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *sz_64 != fixed_length-&gt;bsize_64)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="misc.c.html#L108" title="ocaml/runtime/misc.c:108">caml_fatal_error</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;output_value: incorrect fixed sizes specified by </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling code pointers */<br/></li>
<li></span><br/></li>
<li><a id="L716">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_code_pointer</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <span class="Type">char</span> * codeptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/codefrag.h.html#L33" title="ocaml/runtime/caml/codefrag.h:33">code_fragment</a> * cf;<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> * digest;<br/></li>
<li><br/></li>
<li>&nbsp; cf = <a href="codefrag.c.html#L104" title="ocaml/runtime/codefrag.c:104">caml_find_code_fragment_by_pc</a>(codeptr);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (cf != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((s-&gt;extern_flags &amp; CLOSURES) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(s, <span class="Constant">&quot;output_value: functional <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; digest = (<span class="Type">const</span> <span class="Type">char</span> *) <a href="codefrag.c.html#L127" title="ocaml/runtime/codefrag.c:127">caml_digest_of_code_fragment</a>(cf);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (digest == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(s, <span class="Constant">&quot;output_value: private function&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(cf == <a href="codefrag.c.html#L152" title="ocaml/runtime/codefrag.c:152">caml_find_code_fragment_by_digest</a>((<span class="Type">unsigned</span> <span class="Type">char</span>*)digest));<br/></li>
<li>&nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L96" title="ocaml/runtime/caml/intext.h:96">CODE_CODEPOINTER</a>, codeptr - cf-&gt;code_start);<br/></li>
<li>&nbsp; &nbsp; <a href="#L502" title="ocaml/runtime/extern.c:502">writeblock</a>(s, digest, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(s, <span class="Constant">&quot;output_value: abstract <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> (outside heap)&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshaling the non-environment part of closures */<br/></li>
<li></span><br/></li>
<li><a id="L738">&#x200c;</a><a href="caml/config.h.html#L42" title="ocaml/runtime/caml/config.h:42">Caml_inline</a> <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> <span class="linkable">extern_closure_up_to_env</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> startenv, i;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> info;<br/></li>
<li><br/></li>
<li>&nbsp; startenv = <a href="caml/mlvalues.h.html#L285" title="ocaml/runtime/caml/mlvalues.h:285">Start_env_closinfo</a>(<a href="caml/mlvalues.h.html#L277" title="ocaml/runtime/caml/mlvalues.h:277">Closinfo_val</a>(v));<br/></li>
<li>&nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The infix header */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (i &gt; <span class="Constant">0</span>) <a href="#L560" title="ocaml/runtime/extern.c:560">extern_int</a>(s, <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i++)));<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The default entry point */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L716" title="ocaml/runtime/extern.c:716">extern_code_pointer</a>(s, (<span class="Type">char</span> *) <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i++));<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The closure info. */<br/></li>
<li></span>&nbsp; &nbsp; info = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i++);<br/></li>
<li>&nbsp; &nbsp; <a href="#L560" title="ocaml/runtime/extern.c:560">extern_int</a>(s, <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(info));<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The direct entry point if arity is neither 0 nor 1 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L284" title="ocaml/runtime/caml/mlvalues.h:284">Arity_closinfo</a>(info) != <span class="Constant">0</span> &amp;&amp; <a href="caml/mlvalues.h.html#L284" title="ocaml/runtime/caml/mlvalues.h:284">Arity_closinfo</a>(info) != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L716" title="ocaml/runtime/extern.c:716">extern_code_pointer</a>(s, (<span class="Type">char</span> *) <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i++));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (i &lt; startenv);<br/></li>
<li>&nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(i == startenv);<br/></li>
<li>&nbsp; <span class="Statement">return</span> startenv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Marshal the given <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> in the output buffer */<br/></li>
<li></span><br/></li>
<li><a id="L765">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_rec</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * sp;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> h = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> pos = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L228" title="ocaml/runtime/extern.c:228">extern_init_position_table</a>(s);<br/></li>
<li>&nbsp; sp = s-&gt;extern_stack;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span>(<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L72" title="ocaml/runtime/caml/mlvalues.h:72">Is_long</a>(v)) {<br/></li>
<li>&nbsp; &nbsp; <a href="#L560" title="ocaml/runtime/extern.c:560">extern_int</a>(s, <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(v));<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = <a href="caml/mlvalues.h.html#L157" title="ocaml/runtime/caml/mlvalues.h:157">Hd_val</a>(v);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag = <a href="caml/mlvalues.h.html#L129" title="ocaml/runtime/caml/mlvalues.h:129">Tag_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> sz = <a href="caml/mlvalues.h.html#L131" title="ocaml/runtime/caml/mlvalues.h:131">Wosize_hd</a>(hd);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tag == <a href="caml/mlvalues.h.html#L239" title="ocaml/runtime/caml/mlvalues.h:239">Forward_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> f = <a href="caml/mlvalues.h.html#L240" title="ocaml/runtime/caml/mlvalues.h:240">Forward_val</a> (v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L73" title="ocaml/runtime/caml/mlvalues.h:73">Is_block</a> (f)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (&nbsp;&nbsp; <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (f) == <a href="caml/mlvalues.h.html#L239" title="ocaml/runtime/caml/mlvalues.h:239">Forward_tag</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (f) == <a href="caml/mlvalues.h.html#L297" title="ocaml/runtime/caml/mlvalues.h:297">Lazy_tag</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (f) == <a href="caml/mlvalues.h.html#L304" title="ocaml/runtime/caml/mlvalues.h:304">Forcing_tag</a><br/></li>
<li><span class="PreProc">#ifdef FLAT_FLOAT_ARRAY<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="caml/mlvalues.h.html#L199" title="ocaml/runtime/caml/mlvalues.h:199">Tag_val</a> (f) == <a href="caml/mlvalues.h.html#L336" title="ocaml/runtime/caml/mlvalues.h:336">Double_tag</a><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )){<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Do not short-circuit the pointer. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; }<span class="Statement">else</span>{<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Atoms are treated specially for two reasons: they are not allocated<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; in the externed block, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> they are automatically shared. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (sz == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L600" title="ocaml/runtime/extern.c:600">extern_header</a>(s, <span class="Constant">0</span>, tag);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next_item;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check if object already seen */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (! (s-&gt;extern_flags &amp; NO_SHARING)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L329" title="ocaml/runtime/extern.c:329">extern_lookup_position</a>(s, v, &amp;pos, &amp;h)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* #4056: using absolute references for shared objects improves<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; compressibility. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> d = s-&gt;extern_flags &amp; COMPRESSED ? pos : s-&gt;obj_counter - pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L582" title="ocaml/runtime/extern.c:582">extern_shared_reference</a>(s, d);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next_item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Output the contents of the object */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">switch</span>(tag) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L328" title="ocaml/runtime/caml/mlvalues.h:328">String_tag</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> len = <a href="str.c.html#L31" title="ocaml/runtime/str.c:31">caml_string_length</a>(v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L623" title="ocaml/runtime/extern.c:623">extern_string</a>(s, v, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 += <span class="Constant">1</span> + (len + <span class="Constant">4</span>) / <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_64 += <span class="Constant">1</span> + (len + <span class="Constant">8</span>) / <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L336" title="ocaml/runtime/caml/mlvalues.h:336">Double_tag</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">double</span>) == <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L648" title="ocaml/runtime/extern.c:648">extern_double</a>(s, v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 += <span class="Constant">1</span> + <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_64 += <span class="Constant">1</span> + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L349" title="ocaml/runtime/caml/mlvalues.h:349">Double_array_tag</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> nfloats;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/misc.h.html#L247" title="ocaml/runtime/caml/misc.h:247">CAMLassert</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">double</span>) == <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; nfloats = <a href="caml/mlvalues.h.html#L174" title="ocaml/runtime/caml/mlvalues.h:174">Wosize_val</a>(v) / <a href="caml/mlvalues.h.html#L337" title="ocaml/runtime/caml/mlvalues.h:337">Double_wosize</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L656" title="ocaml/runtime/extern.c:656">extern_double_array</a>(s, v, nfloats);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 += <span class="Constant">1</span> + nfloats * <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_64 += <span class="Constant">1</span> + nfloats;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L324" title="ocaml/runtime/caml/mlvalues.h:324">Abstract_tag</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(s, <span class="Constant">&quot;output_value: abstract <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> (Abstract)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L538" title="ocaml/runtime/extern.c:538">writecode32</a>(s, <a href="caml/intext.h.html#L97" title="ocaml/runtime/caml/intext.h:97">CODE_INFIXPOINTER</a>, <a href="caml/mlvalues.h.html#L249" title="ocaml/runtime/caml/mlvalues.h:249">Infix_offset_hd</a>(hd));<br/></li>
<li>&nbsp; &nbsp; &nbsp; v = v - <a href="caml/mlvalues.h.html#L249" title="ocaml/runtime/caml/mlvalues.h:249">Infix_offset_hd</a>(hd); <span class="Comment">/* PR#5772 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L401" title="ocaml/runtime/caml/mlvalues.h:401">Custom_tag</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> sz_32, sz_64;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L679" title="ocaml/runtime/extern.c:679">extern_custom</a>(s, v, &amp;sz_32, &amp;sz_64);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 += <span class="Constant">2</span> + ((sz_32 + <span class="Constant">3</span>) &gt;&gt; <span class="Constant">2</span>);&nbsp; <span class="Comment">/* header + ops + data */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; s-&gt;size_64 += <span class="Constant">2</span> + ((sz_64 + <span class="Constant">7</span>) &gt;&gt; <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L275" title="ocaml/runtime/caml/mlvalues.h:275">Closure_tag</a>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L600" title="ocaml/runtime/extern.c:600">extern_header</a>(s, sz, tag);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 += <span class="Constant">1</span> + sz;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_64 += <span class="Constant">1</span> + sz;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; i = <a href="#L738" title="ocaml/runtime/extern.c:738">extern_closure_up_to_env</a>(s, v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= sz) <span class="Statement">goto</span> next_item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Remember that we still have to serialize fields i + 1 ... sz - 1 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &lt; sz - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sp &gt;= s-&gt;extern_stack_limit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp = <a href="#L189" title="ocaml/runtime/extern.c:189">extern_resize_stack</a>(s, sp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;v = &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;count = sz - i - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Continue serialization with the first environment field */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="caml/mlvalues.h.html#L300" title="ocaml/runtime/caml/mlvalues.h:300">Cont_tag</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L442" title="ocaml/runtime/extern.c:442">extern_invalid_argument</a>(s, <span class="Constant">&quot;output_value: continuation <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">default</span>: {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L600" title="ocaml/runtime/extern.c:600">extern_header</a>(s, sz, tag);<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 += <span class="Constant">1</span> + sz;<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_64 += <span class="Constant">1</span> + sz;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Remember that we still have to serialize fields 1 ... sz - 1 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sz &gt; <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sp &gt;= s-&gt;extern_stack_limit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp = <a href="#L189" title="ocaml/runtime/extern.c:189">extern_resize_stack</a>(s, sp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;v = &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;count = sz - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Continue serialization with the first field */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">next_item</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Pop one more item to marshal, if any */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (sp == s-&gt;extern_stack) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* We are done.&nbsp;&nbsp; Cleanup the stack <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> leave the function */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L178" title="ocaml/runtime/extern.c:178">extern_free_stack</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L243" title="ocaml/runtime/extern.c:243">extern_free_position_table</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; v = *((sp-&gt;v)++);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (--(sp-&gt;count) == <span class="Constant">0</span>) sp--;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Comment">/* Never reached as function leaves with return */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Compress the output */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li></span><br/></li>
<li><a id="L918">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">extern_compress_output</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s)<br/></li>
<li>{<br/></li>
<li>&nbsp; ZSTD_CCtx * ctx;<br/></li>
<li>&nbsp; ZSTD_inBuffer in;<br/></li>
<li>&nbsp; ZSTD_outBuffer out;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * input, * output, * output_head;<br/></li>
<li>&nbsp; <span class="Type">int</span> rc;<br/></li>
<li><br/></li>
<li>&nbsp; ctx = ZSTD_createCCtx();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (ctx == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>&nbsp; input = s-&gt;extern_output_first;<br/></li>
<li>&nbsp; output_head = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a>));<br/></li>
<li>&nbsp; <span class="Statement">if</span> (output_head == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <span class="Statement">goto</span> oom1;<br/></li>
<li>&nbsp; output = output_head;<br/></li>
<li>&nbsp; output-&gt;next = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; in.src = input-&gt;data; in.size = input-&gt;end - input-&gt;data; in.pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; out.dst = output-&gt;data; out.size = <a href="caml/intext.h.html#L119" title="ocaml/runtime/caml/intext.h:119">SIZE_EXTERN_OUTPUT_BLOCK</a>; out.pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (out.pos == out.size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; output-&gt;end = output-&gt;data + out.pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Allocate fresh output block */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * next =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(<span class="Statement"><a href="caml/fiber.h.html#L65" title="ocaml/runtime/caml/fiber.h:65">sizeof</a></span>(<span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (next == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <span class="Statement">goto</span> oom2;<br/></li>
<li>&nbsp; &nbsp; &nbsp; output-&gt;next = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; output = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; output-&gt;next = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; out.dst = output-&gt;data; out.size = <a href="caml/intext.h.html#L119" title="ocaml/runtime/caml/intext.h:119">SIZE_EXTERN_OUTPUT_BLOCK</a>; out.pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in.pos == in.size &amp;&amp; input != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Move to next input block <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> free current input block */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * next = input-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(input);<br/></li>
<li>&nbsp; &nbsp; &nbsp; input = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (input != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in.src = input-&gt;data; in.size = input-&gt;end - input-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in.src = <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>; in.size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; in.pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; rc = ZSTD_compressStream2(ctx, &amp;out, &amp;in,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; input == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> ? ZSTD_e_end : ZSTD_e_continue);<br/></li>
<li>&nbsp; } <span class="Statement">while</span> (! (input == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span> &amp;&amp; rc == <span class="Constant">0</span>));<br/></li>
<li>&nbsp; output-&gt;end = output-&gt;data + out.pos;<br/></li>
<li>&nbsp; s-&gt;extern_output_first = output_head;<br/></li>
<li>&nbsp; ZSTD_freeCCtx(ctx);<br/></li>
<li>&nbsp; <span class="Statement">return</span>;<br/></li>
<li><span class="Statement">oom2</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Comment">/* The old output blocks that remain to be freed */<br/></li>
<li></span>&nbsp; s-&gt;extern_output_first = input;<br/></li>
<li>&nbsp; <span class="Comment">/* Free the new output blocks */<br/></li>
<li></span>&nbsp; <span class="Statement">for</span> (output = output_head; output != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>; ) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * next = output-&gt;next;<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(output);<br/></li>
<li>&nbsp; &nbsp; output = next;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="Statement">oom1</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; ZSTD_freeCCtx(ctx);<br/></li>
<li>&nbsp; <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L982">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">extern_flag_values</span>[] = {<br/></li>
<li>&nbsp; NO_SHARING, CLOSURES, COMPAT_32, COMPRESSED<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L986">&#x200c;</a><span class="Type">static</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">extern_value</span>(<span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*out*/</span> <span class="Type">char</span> header[<a href="caml/intext.h.html#L68" title="ocaml/runtime/caml/intext.h:68">MAX_INTEXT_HEADER_SIZE</a>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/*out*/</span> <span class="Type">int</span> * header_len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> res_len;<br/></li>
<li>&nbsp; <span class="Comment">/* Parse flag list */<br/></li>
<li></span>&nbsp; s-&gt;extern_flags = <a href="alloc.c.html#L275" title="ocaml/runtime/alloc.c:275">caml_convert_flag_list</a>(flags, <a href="#L982" title="ocaml/runtime/extern.c:982">extern_flag_values</a>);<br/></li>
<li>&nbsp; <span class="Comment">/* Turn compression off if Zlib missing <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> if called from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; <a href="#L1140" title="ocaml/runtime/extern.c:1140">caml_output_value_to_block</a> */<br/></li>
<li></span><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s-&gt;extern_userprovided_output) s-&gt;extern_flags &amp;= ~COMPRESSED;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; s-&gt;extern_flags &amp;= ~COMPRESSED;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Comment">/* Initializations */<br/></li>
<li></span>&nbsp; s-&gt;obj_counter = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; s-&gt;size_32 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; s-&gt;size_64 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Comment">/* Marshal the object */<br/></li>
<li></span>&nbsp; <a href="#L765" title="ocaml/runtime/extern.c:765">extern_rec</a>(s, v);<br/></li>
<li>&nbsp; <span class="Comment">/* Record end of output */<br/></li>
<li></span>&nbsp; <a href="#L375" title="ocaml/runtime/extern.c:375">close_extern_output</a>(s);<br/></li>
<li>&nbsp; <span class="Comment">/* Compress if requested */<br/></li>
<li></span><span class="PreProc">#ifdef HAS_ZSTD<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; COMPRESSED) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> uncompressed_len = <a href="#L420" title="ocaml/runtime/extern.c:420">extern_output_length</a>(s);<br/></li>
<li>&nbsp; &nbsp; <a href="#L918" title="ocaml/runtime/extern.c:918">extern_compress_output</a>(s);<br/></li>
<li>&nbsp; &nbsp; res_len = <a href="#L420" title="ocaml/runtime/extern.c:420">extern_output_length</a>(s);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check lengths if compat32 mode is requested */<br/></li>
<li></span><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; COMPAT_32<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (uncompressed_len &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || res_len &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || s-&gt;size_32 &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || s-&gt;size_64 &gt;= (<a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;output_value: object too big to be read back on &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;32-bit platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Write the header in compressed format */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header, <a href="caml/intext.h.html#L31" title="ocaml/runtime/caml/intext.h:31">Intext_magic_number_compressed</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> pos = <span class="Constant">5</span>, len;<br/></li>
<li>&nbsp; &nbsp; len = <a href="#L480" title="ocaml/runtime/extern.c:480">storevlq</a>(header + pos, res_len); pos += len;<br/></li>
<li>&nbsp; &nbsp; len = <a href="#L480" title="ocaml/runtime/extern.c:480">storevlq</a>(header + pos, uncompressed_len); pos += len;<br/></li>
<li>&nbsp; &nbsp; len = <a href="#L480" title="ocaml/runtime/extern.c:480">storevlq</a>(header + pos, s-&gt;obj_counter); pos += len;<br/></li>
<li>&nbsp; &nbsp; len = <a href="#L480" title="ocaml/runtime/extern.c:480">storevlq</a>(header + pos, s-&gt;size_32); pos += len;<br/></li>
<li>&nbsp; &nbsp; len = <a href="#L480" title="ocaml/runtime/extern.c:480">storevlq</a>(header + pos, s-&gt;size_64); pos += len;<br/></li>
<li>&nbsp; &nbsp; header[<span class="Constant">4</span>] = pos;<br/></li>
<li>&nbsp; &nbsp; *header_len = pos;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res_len;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Comment">/* Write the header */<br/></li>
<li></span>&nbsp; res_len = <a href="#L420" title="ocaml/runtime/extern.c:420">extern_output_length</a>(s);<br/></li>
<li><span class="PreProc">#ifdef ARCH_SIXTYFOUR<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (res_len &gt;= ((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; s-&gt;size_32 &gt;= ((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>) || s-&gt;size_64 &gt;= ((<a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a>)<span class="Constant">1</span> &lt;&lt; <span class="Constant">32</span>)) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The object is too big for the small header format.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; Fail if we are in compat32 mode, <a href="ints.c.html#L491" title="ocaml/runtime/ints.c:491">or</a> use big header. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;extern_flags &amp; COMPAT_32) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L382" title="ocaml/runtime/extern.c:382">free_extern_output</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;output_value: object too big to be read back on &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;32-bit platform&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header, <a href="caml/intext.h.html#L30" title="ocaml/runtime/caml/intext.h:30">Intext_magic_number_big</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header + <span class="Constant">4</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L473" title="ocaml/runtime/extern.c:473">store64</a>(header + <span class="Constant">8</span>, res_len);<br/></li>
<li>&nbsp; &nbsp; <a href="#L473" title="ocaml/runtime/extern.c:473">store64</a>(header + <span class="Constant">16</span>, s-&gt;obj_counter);<br/></li>
<li>&nbsp; &nbsp; <a href="#L473" title="ocaml/runtime/extern.c:473">store64</a>(header + <span class="Constant">24</span>, s-&gt;size_64);<br/></li>
<li>&nbsp; &nbsp; *header_len = <span class="Constant">32</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res_len;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; <span class="Comment">/* Use the small header format */<br/></li>
<li></span>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header, <a href="caml/intext.h.html#L29" title="ocaml/runtime/caml/intext.h:29">Intext_magic_number_small</a>);<br/></li>
<li>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header + <span class="Constant">4</span>, res_len);<br/></li>
<li>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header + <span class="Constant">8</span>, s-&gt;obj_counter);<br/></li>
<li>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header + <span class="Constant">12</span>, s-&gt;size_32);<br/></li>
<li>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(header + <span class="Constant">16</span>, s-&gt;size_64);<br/></li>
<li>&nbsp; *header_len = <span class="Constant">20</span>;<br/></li>
<li>&nbsp; <span class="Statement">return</span> res_len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1070">&#x200c;</a><span class="Type">void</span> <span class="linkable">caml_output_val</span>(<span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> *chan, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> header[<a href="caml/intext.h.html#L68" title="ocaml/runtime/caml/intext.h:68">MAX_INTEXT_HEADER_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> header_len;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * blk, * nextblk;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (! <a href="io.c.html#L227" title="ocaml/runtime/io.c:227">caml_channel_binary_mode</a>(chan))<br/></li>
<li>&nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;output_value: not a binary <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a>&quot;</span>);<br/></li>
<li>&nbsp; <a href="#L364" title="ocaml/runtime/extern.c:364">init_extern_output</a>(s);<br/></li>
<li>&nbsp; <a href="#L986" title="ocaml/runtime/extern.c:986">extern_value</a>(s, v, flags, header, &amp;header_len);<br/></li>
<li>&nbsp; <span class="Comment">/* During [<a href="io.c.html#L309" title="ocaml/runtime/io.c:309">caml_really_putblock</a>], concurrent [<a href="#L1070" title="ocaml/runtime/extern.c:1070">caml_output_val</a>] operations<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; can take place (via context switching in systhreads),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> [extern_output_first] may change. So, save it in a local variable. */<br/></li>
<li></span>&nbsp; blk = s-&gt;extern_output_first;<br/></li>
<li>&nbsp; <a href="io.c.html#L309" title="ocaml/runtime/io.c:309">caml_really_putblock</a>(chan, header, header_len);<br/></li>
<li>&nbsp; <span class="Statement">while</span> (blk != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="io.c.html#L309" title="ocaml/runtime/io.c:309">caml_really_putblock</a>(chan, blk-&gt;data, blk-&gt;end - blk-&gt;data);<br/></li>
<li>&nbsp; &nbsp; nextblk = blk-&gt;next;<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(blk);<br/></li>
<li>&nbsp; &nbsp; blk = nextblk;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="caml/io.h.html#L115" title="ocaml/runtime/caml/io.h:115">Flush_if_unbuffered</a>(chan);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1095">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_output_value</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> vchan, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L284" title="ocaml/runtime/caml/memory.h:284">CAMLparam3</a> (vchan, v, flags);<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> * <a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a> = <a href="caml/io.h.html#L98" title="ocaml/runtime/caml/io.h:98">Channel</a>(vchan);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="caml/io.h.html#L109" title="ocaml/runtime/caml/io.h:109">Lock</a>(<a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a>);<br/></li>
<li>&nbsp; <a href="#L1070" title="ocaml/runtime/extern.c:1070">caml_output_val</a>(<a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a>, v, flags);<br/></li>
<li>&nbsp; <a href="caml/io.h.html#L111" title="ocaml/runtime/caml/io.h:111">Unlock</a>(<a href="caml/io.h.html#L39" title="ocaml/runtime/caml/io.h:39">channel</a>);<br/></li>
<li>&nbsp; <a href="caml/memory.h.html#L419" title="ocaml/runtime/caml/memory.h:419">CAMLreturn</a> (<a href="caml/mlvalues.h.html#L431" title="ocaml/runtime/caml/mlvalues.h:431">Val_unit</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1106">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_output_value_to_bytes</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> header[<a href="caml/intext.h.html#L68" title="ocaml/runtime/caml/intext.h:68">MAX_INTEXT_HEADER_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> header_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> data_len, ofs;<br/></li>
<li>&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> res;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * blk, * nextblk;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L364" title="ocaml/runtime/extern.c:364">init_extern_output</a>(s);<br/></li>
<li>&nbsp; data_len = <a href="#L986" title="ocaml/runtime/extern.c:986">extern_value</a>(s, v, flags, header, &amp;header_len);<br/></li>
<li>&nbsp; <span class="Comment">/* PR#4030: it is prudent to save extern_output_first before allocating<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; the result, as in <a href="#L1070" title="ocaml/runtime/extern.c:1070">caml_output_val</a> */<br/></li>
<li></span>&nbsp; blk = s-&gt;extern_output_first;<br/></li>
<li>&nbsp; res = <a href="alloc.c.html#L177" title="ocaml/runtime/alloc.c:177">caml_alloc_string</a>(header_len + data_len);<br/></li>
<li>&nbsp; ofs = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; memcpy(&amp;<a href="caml/mlvalues.h.html#L315" title="ocaml/runtime/caml/mlvalues.h:315">Byte</a>(res, ofs), header, header_len);<br/></li>
<li>&nbsp; ofs += header_len;<br/></li>
<li>&nbsp; <span class="Statement">while</span> (blk != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n = blk-&gt;end - blk-&gt;data;<br/></li>
<li>&nbsp; &nbsp; memcpy(&amp;<a href="caml/mlvalues.h.html#L315" title="ocaml/runtime/caml/mlvalues.h:315">Byte</a>(res, ofs), blk-&gt;data, n);<br/></li>
<li>&nbsp; &nbsp; ofs += n;<br/></li>
<li>&nbsp; &nbsp; nextblk = blk-&gt;next;<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(blk);<br/></li>
<li>&nbsp; &nbsp; blk = nextblk;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1135">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_output_value_to_string</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="#L1106" title="ocaml/runtime/extern.c:1106">caml_output_value_to_bytes</a>(v,flags);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1140">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> <span class="linkable">caml_output_value_to_block</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">char</span> * buf, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> header[<a href="caml/intext.h.html#L68" title="ocaml/runtime/caml/intext.h:68">MAX_INTEXT_HEADER_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> header_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> data_len;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* At this point we don't know the size of the header.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; Guess that it is small, <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> fix up later if not. */<br/></li>
<li></span>&nbsp; s-&gt;extern_userprovided_output = buf + <span class="Constant">20</span>;<br/></li>
<li>&nbsp; s-&gt;extern_ptr = s-&gt;extern_userprovided_output;<br/></li>
<li>&nbsp; s-&gt;extern_limit = buf + len;<br/></li>
<li>&nbsp; data_len = <a href="#L986" title="ocaml/runtime/extern.c:986">extern_value</a>(s, v, flags, header, &amp;header_len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (header_len != <span class="Constant">20</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Bad guess!&nbsp; Need to shift the output to make room for big header.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp;&nbsp; Make sure there is room. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (header_len + data_len &gt; len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="fail_nat.c.html#L130" title="ocaml/runtime/fail_nat.c:130">caml_failwith</a>(<span class="Constant">&quot;Marshal.to_buffer: buffer overflow&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; memmove(buf + header_len, buf + <span class="Constant">20</span>, data_len);<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; memcpy(buf, header, header_len);<br/></li>
<li>&nbsp; <span class="Statement">return</span> header_len + data_len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1165">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_output_value_to_buffer</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> buf, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> ofs, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> l =<br/></li>
<li>&nbsp; &nbsp; <a href="#L1140" title="ocaml/runtime/extern.c:1140">caml_output_value_to_block</a>(v, flags,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="caml/mlvalues.h.html#L315" title="ocaml/runtime/caml/mlvalues.h:315">Byte</a>(buf, <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(ofs)), <a href="caml/mlvalues.h.html#L78" title="ocaml/runtime/caml/mlvalues.h:78">Long_val</a>(len));<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(l);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1174">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_output_value_to_malloc</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v, <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> flags,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*out*/</span> <span class="Type">char</span> ** buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*out*/</span> <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> * len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">char</span> header[<a href="caml/intext.h.html#L68" title="ocaml/runtime/caml/intext.h:68">MAX_INTEXT_HEADER_SIZE</a>];<br/></li>
<li>&nbsp; <span class="Type">int</span> header_len;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> data_len;<br/></li>
<li>&nbsp; <span class="Type">char</span> * res;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L89" title="ocaml/runtime/extern.c:89">output_block</a> * blk, * nextblk;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L364" title="ocaml/runtime/extern.c:364">init_extern_output</a>(s);<br/></li>
<li>&nbsp; data_len = <a href="#L986" title="ocaml/runtime/extern.c:986">extern_value</a>(s, v, flags, header, &amp;header_len);<br/></li>
<li>&nbsp; res = <a href="memory.c.html#L494" title="ocaml/runtime/memory.c:494">caml_stat_alloc_noexc</a>(header_len + data_len);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (res == <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>) <a href="#L436" title="ocaml/runtime/extern.c:436">extern_out_of_memory</a>(s);<br/></li>
<li>&nbsp; *buf = res;<br/></li>
<li>&nbsp; *len = header_len + data_len;<br/></li>
<li>&nbsp; memcpy(res, header, header_len);<br/></li>
<li>&nbsp; res += header_len;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (blk = s-&gt;extern_output_first; blk != <span class="Constant"><a href="caml/misc.h.html#L71" title="ocaml/runtime/caml/misc.h:71">NULL</a></span>; blk = nextblk) {<br/></li>
<li>&nbsp; &nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> n = blk-&gt;end - blk-&gt;data;<br/></li>
<li>&nbsp; &nbsp; memcpy(res, blk-&gt;data, n);<br/></li>
<li>&nbsp; &nbsp; res += n;<br/></li>
<li>&nbsp; &nbsp; nextblk = blk-&gt;next;<br/></li>
<li>&nbsp; &nbsp; <a href="memory.c.html#L559" title="ocaml/runtime/memory.c:559">caml_stat_free</a>(blk);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Functions for writing user-defined marshallers */<br/></li>
<li></span><br/></li>
<li><a id="L1204">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_int_1</span>(<span class="Type">int</span> i)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">1</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr[<span class="Constant">0</span>] = i;<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1212">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_int_2</span>(<span class="Type">int</span> i)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">2</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; <a href="#L463" title="ocaml/runtime/extern.c:463">store16</a>(s-&gt;extern_ptr, i);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">2</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1220">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_int_4</span>(<span class="Type"><a href="caml/config.h.html#L125" title="ocaml/runtime/caml/config.h:125">int32_t</a></span> i)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">4</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; <a href="#L468" title="ocaml/runtime/extern.c:468">store32</a>(s-&gt;extern_ptr, i);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">4</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1228">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_int_8</span>(<span class="Type"><a href="caml/config.h.html#L127" title="ocaml/runtime/caml/config.h:127">int64_t</a></span> i)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">8</span> &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">8</span>);<br/></li>
<li>&nbsp; <a href="#L473" title="ocaml/runtime/extern.c:473">store64</a>(s-&gt;extern_ptr, i);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += <span class="Constant">8</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1236">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_float_4</span>(<span class="Type">float</span> f)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L1273" title="ocaml/runtime/extern.c:1273">caml_serialize_block_4</a>(&amp;f, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1241">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_float_8</span>(<span class="Type">double</span> f)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L1311" title="ocaml/runtime/extern.c:1311">caml_serialize_block_float_8</a>(&amp;f, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1246">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_block_1</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + len &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, len);<br/></li>
<li>&nbsp; memcpy(s-&gt;extern_ptr, data, len);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1254">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_block_2</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">2</span> * len &gt; s-&gt;extern_limit)<br/></li>
<li>&nbsp; &nbsp; <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">2</span> * len);<br/></li>
<li><span class="PreProc">#ifndef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> * q;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = data, q = s-&gt;extern_ptr; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">2</span>, q += <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L23" title="ocaml/runtime/caml/reverse.h:23">Reverse_16</a>(q, p);<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_ptr = q;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; memcpy(s-&gt;extern_ptr, data, len * <span class="Constant">2</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += len * <span class="Constant">2</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1273">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_block_4</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">4</span> * len &gt; s-&gt;extern_limit)<br/></li>
<li>&nbsp; &nbsp; <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">4</span> * len);<br/></li>
<li><span class="PreProc">#ifndef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> * q;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = data, q = s-&gt;extern_ptr; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">4</span>, q += <span class="Constant">4</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L32" title="ocaml/runtime/caml/reverse.h:32">Reverse_32</a>(q, p);<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_ptr = q;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; memcpy(s-&gt;extern_ptr, data, len * <span class="Constant">4</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += len * <span class="Constant">4</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1292">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_block_8</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">8</span> * len &gt; s-&gt;extern_limit)<br/></li>
<li>&nbsp; &nbsp; <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">8</span> * len);<br/></li>
<li><span class="PreProc">#ifndef ARCH_BIG_ENDIAN<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> * q;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = data, q = s-&gt;extern_ptr; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">8</span>, q += <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(q, p);<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_ptr = q;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; memcpy(s-&gt;extern_ptr, data, len * <span class="Constant">8</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += len * <span class="Constant">8</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1311">&#x200c;</a><a href="caml/misc.h.html#L123" title="ocaml/runtime/caml/misc.h:123">CAMLexport</a> <span class="Type">void</span> <span class="linkable">caml_serialize_block_float_8</span>(<span class="Type">void</span> * data, <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a>* s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li>&nbsp; <span class="Statement">if</span> (s-&gt;extern_ptr + <span class="Constant">8</span> * len &gt; s-&gt;extern_limit) <a href="#L397" title="ocaml/runtime/extern.c:397">grow_extern_output</a>(s, <span class="Constant">8</span> * len);<br/></li>
<li><span class="PreProc">#if <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x01234567<br/></li>
<li></span>&nbsp; memcpy(s-&gt;extern_ptr, data, len * <span class="Constant">8</span>);<br/></li>
<li>&nbsp; s-&gt;extern_ptr += len * <span class="Constant">8</span>;<br/></li>
<li><span class="PreProc">#elif <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a> == </span><span class="Constant">0x76543210<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> * q;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = data, q = s-&gt;extern_ptr; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">8</span>, q += <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L41" title="ocaml/runtime/caml/reverse.h:41">Reverse_64</a>(q, p);<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_ptr = q;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> * p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> * q;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = data, q = s-&gt;extern_ptr; len &gt; <span class="Constant">0</span>; len--, p += <span class="Constant">8</span>, q += <span class="Constant">8</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/reverse.h.html#L54" title="ocaml/runtime/caml/reverse.h:54">Permute_64</a>(q, <span class="Constant">0x01234567</span>, p, <a href="caml/config.h.html#L169" title="ocaml/runtime/caml/config.h:169">ARCH_FLOAT_ENDIANNESS</a>);<br/></li>
<li>&nbsp; &nbsp; s-&gt;extern_ptr = q;<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1337">&#x200c;</a><a href="caml/misc.h.html#L124" title="ocaml/runtime/caml/misc.h:124">CAMLprim</a> <a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> <span class="linkable">caml_obj_reachable_words</span>(<a href="caml/mlvalues.h.html#L57" title="ocaml/runtime/caml/mlvalues.h:57">value</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L140" title="ocaml/runtime/caml/config.h:140">intnat</a> size;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L55" title="ocaml/runtime/extern.c:55">extern_item</a> * sp;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> h = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> pos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">struct</span> <a href="#L95" title="ocaml/runtime/extern.c:95">caml_extern_state</a> *s = <a href="#L123" title="ocaml/runtime/extern.c:123">get_extern_state</a> ();<br/></li>
<li><br/></li>
<li>&nbsp; s-&gt;obj_counter = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; s-&gt;extern_flags = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <a href="#L228" title="ocaml/runtime/extern.c:228">extern_init_position_table</a>(s);<br/></li>
<li>&nbsp; sp = s-&gt;extern_stack;<br/></li>
<li>&nbsp; size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* In Multicore OCaml, we don't distinguish between major heap blocks <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a><br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; * out-of-heap blocks, so we end up counting out-of-heap blocks too. */<br/></li>
<li></span>&nbsp; <span class="Statement">while</span> (<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="caml/mlvalues.h.html#L72" title="ocaml/runtime/caml/mlvalues.h:72">Is_long</a>(v)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Tagged integers contribute 0 to the size, nothing to do */<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L329" title="ocaml/runtime/extern.c:329">extern_lookup_position</a>(s, v, &amp;pos, &amp;h)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Already seen <a href="ints.c.html#L488" title="ocaml/runtime/ints.c:488">and</a> counted, nothing to do */<br/></li>
<li></span>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L58" title="ocaml/runtime/caml/mlvalues.h:58">header_t</a> hd = <a href="caml/mlvalues.h.html#L157" title="ocaml/runtime/caml/mlvalues.h:157">Hd_val</a>(v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L61" title="ocaml/runtime/caml/mlvalues.h:61">tag_t</a> tag = <a href="caml/mlvalues.h.html#L129" title="ocaml/runtime/caml/mlvalues.h:129">Tag_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="caml/mlvalues.h.html#L60" title="ocaml/runtime/caml/mlvalues.h:60">mlsize_t</a> sz = <a href="caml/mlvalues.h.html#L131" title="ocaml/runtime/caml/mlvalues.h:131">Wosize_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Infix pointer: go back to containing closure */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tag == <a href="caml/mlvalues.h.html#L248" title="ocaml/runtime/caml/mlvalues.h:248">Infix_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = v - <a href="caml/mlvalues.h.html#L249" title="ocaml/runtime/caml/mlvalues.h:249">Infix_offset_hd</a>(hd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* Remember that we've visited this block */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <a href="#L350" title="ocaml/runtime/extern.c:350">extern_record_location</a>(s, v, h);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Comment">/* The block contributes to the total size */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; size += <span class="Constant">1</span> + sz;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* header word included */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tag &lt; <a href="caml/mlvalues.h.html#L219" title="ocaml/runtime/caml/mlvalues.h:219">No_scan_tag</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* i is the position of the first field to traverse recursively */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="caml/config.h.html#L141" title="ocaml/runtime/caml/config.h:141">uintnat</a> i =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag == <a href="caml/mlvalues.h.html#L275" title="ocaml/runtime/caml/mlvalues.h:275">Closure_tag</a> ? <a href="caml/mlvalues.h.html#L285" title="ocaml/runtime/caml/mlvalues.h:285">Start_env_closinfo</a>(<a href="caml/mlvalues.h.html#L277" title="ocaml/runtime/caml/mlvalues.h:277">Closinfo_val</a>(v)) : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &lt; sz) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &lt; sz - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Remember that we need to count fields i + 1 ... sz - 1 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sp &gt;= s-&gt;extern_stack_limit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp = <a href="#L189" title="ocaml/runtime/extern.c:189">extern_resize_stack</a>(s, sp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;v = &amp;<a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sp-&gt;count = sz - i - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Continue with field i */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = <a href="caml/mlvalues.h.html#L228" title="ocaml/runtime/caml/mlvalues.h:228">Field</a>(v, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Pop one more item to traverse, if any */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (sp == s-&gt;extern_stack) <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; v = *((sp-&gt;v)++);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (--(sp-&gt;count) == <span class="Constant">0</span>) sp--;<br/></li>
<li>&nbsp; }<br/></li>
<li>&nbsp; <a href="#L178" title="ocaml/runtime/extern.c:178">extern_free_stack</a>(s);<br/></li>
<li>&nbsp; <a href="#L243" title="ocaml/runtime/extern.c:243">extern_free_position_table</a>(s);<br/></li>
<li>&nbsp; <span class="Statement">return</span> <a href="caml/mlvalues.h.html#L77" title="ocaml/runtime/caml/mlvalues.h:77">Val_long</a>(size);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/bytecomp/bytepackager.ml - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/bytecomp/bytepackager.ml - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L290">compunit</a></li>
<li><a href="#L279">force_link</a></li>
<li><a href="#L85">id'</a></li>
<li><a href="#L284">imports</a></li>
<li><a href="#L91">name</a></li>
<li><a href="#L140">pm_ident</a></li>
<li><a href="#L141">pm_packed_ident</a></li>
<li><a href="#L283">pos_final</a></li>
<li><a href="#L103">relocate_debug</a></li>
<li><a href="#L150">rename_append_bytecode</a></li>
<li><a href="#L191">rename_append_pack_member</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">(**************************************************************************)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Xavier Leroy, projet Cristal, INRIA Rocquencourt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; Copyright 2002 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *)<br/></li>
<li></span><span class="Comment">(**************************************************************************)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* &quot;Package&quot; a set of .cmo files into one .cmo file having the<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; original compilation units as sub-modules. *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">open</span><span class="ocamlNone"> </span><span class="PreProc">Misc<br/></li>
<li></span><span class="Statement">open</span><span class="ocamlNone"> </span><span class="PreProc">Instruct<br/></li>
<li></span><span class="Statement">open</span><span class="ocamlNone"> </span><span class="PreProc">Cmo_format<br/></li>
<li></span><span class="Statement">module</span><span class="PreProc"> String</span><span class="ocamlPreDef"> </span><span class="Statement">=</span> <span class="PreProc">Misc.Stdlib.String<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="Statement">rec</span> <span class="ocamlLCIdentifier">rev_append_map</span> <span class="ocamlLCIdentifier">f</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L906" title="ocaml/bytecomp/bytegen.ml:906">l</a></span> <span class="ocamlLCIdentifier">rest</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L906" title="ocaml/bytecomp/bytegen.ml:906">l</a></span> <span class="Statement">with<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">[]</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">rest<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="ocamlLCIdentifier">x</span> <span class="Statement">::</span> <span class="ocamlLCIdentifier">xs</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">rev_append_map</span> <span class="ocamlLCIdentifier">f</span> <span class="ocamlLCIdentifier">xs</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">f</span> <span class="ocamlLCIdentifier">x</span> <span class="Statement">::</span> <span class="ocamlLCIdentifier">rest</span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><span class="Statement">type</span> <span class="ocamlLCIdentifier"><a href="bytelibrarian.mli.html#L27" title="ocaml/bytecomp/bytelibrarian.mli:27">error</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">Forward_reference</span> <span class="Statement">of</span> <span class="Type">string</span> <span class="Statement">*</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a><br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Multiple_definition</span> <span class="Statement">of</span> <span class="Type">string</span> <span class="Statement">*</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a><br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Not_an_object_file</span> <span class="Statement">of</span> <span class="Type">string<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Illegal_renaming</span> <span class="Statement">of</span> <span class="Type">string</span> <span class="Statement">*</span> <span class="Type">string</span> <span class="Statement">*</span> <span class="Type">string<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">File_not_found</span> <span class="Statement">of</span> <span class="Type">string<br/></li>
<li></span><br/></li>
<li><span class="Statement">exception</span> <span class="Constant">Error</span> <span class="Statement">of</span> <span class="ocamlLCIdentifier"><a href="bytelibrarian.mli.html#L27" title="ocaml/bytecomp/bytelibrarian.mli:27">error</a><br/></li>
<li></span><br/></li>
<li><span class="Statement">type</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">relocs</span> : <span class="Statement">(</span><span class="ocamlLCIdentifier">reloc_info</span> <span class="Statement">*</span> <span class="Type">int</span><span class="Statement">)</span> <span class="Type">list</span><span class="Statement">;</span> <span class="Comment">(** accumulated reloc <a href="bytegen.ml.html#L1040" title="ocaml/bytecomp/bytegen.ml:1040">info</a> *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">events</span> : <span class="ocamlLCIdentifier"><a href="instruct.ml.html#L23" title="ocaml/bytecomp/instruct.ml:23">debug_event</a></span> <span class="Type">list</span><span class="Statement">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(** accumulated debug events *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">debug_dirs</span> : <span class="PreProc">String</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a></span><span class="Statement">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(** accumulated debug_dirs *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">primitives</span> : <span class="Type">string</span> <span class="Type">list</span><span class="Statement">;</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">(** accumulated primitives *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> : <span class="Type">int</span><span class="Statement">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">(** <a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a> of the current unit *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">subst</span> : <span class="PreProc">Subst</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a></span><span class="Statement">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">(** Substitution for debug <a href="bytegen.ml.html#L992" title="ocaml/bytecomp/bytegen.ml:992">event</a> *)<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">mapping</span> : <span class="Statement">(</span><span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a></span> <span class="Statement">*</span> <span class="Type">bool</span><span class="Statement">)</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Comment">(** Mapping from module to packed-module idents.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; The boolean tells whether we've processed the compilation unit already. *)<br/></li>
<li></span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">empty_state</span> <span class="Statement">=</span> <span class="Statement">{<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">relocs</span> <span class="Statement">=</span> <span class="Constant">[]</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">events</span> <span class="Statement">=</span> <span class="Constant">[]</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">debug_dirs</span> <span class="Statement">=</span> <span class="PreProc">String</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier"><a href="symtable.ml.html#L44" title="ocaml/bytecomp/symtable.ml:44">empty</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">primitives</span> <span class="Statement">=</span> <span class="Constant">[]</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> <span class="Statement">=</span> <span class="Constant">0</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">mapping</span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier"><a href="symtable.ml.html#L44" title="ocaml/bytecomp/symtable.ml:44">empty</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="ocamlLCIdentifier">subst</span> <span class="Statement">=</span> <span class="PreProc">Subst</span>.<span class="ocamlLCIdentifier">identity</span><span class="Statement">;<br/></li>
<li></span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Update a relocation.&nbsp; adjust its <a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a>, and rename GETGLOBAL and<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; SETGLOBAL relocations that correspond to one of the units being<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; consolidated. *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">rename_relocation</span> <span class="ocamlLCIdentifier">packagename</span> <span class="ocamlLCIdentifier">objfile</span> <span class="ocamlLCIdentifier">mapping</span> <span class="ocamlLCIdentifier">base</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">rel</span>, <span class="ocamlLCIdentifier">ofs</span><span class="Statement">)</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">rel</span>' <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">rel</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Constant">Reloc_getglobal</span> <span class="ocamlLCIdentifier">id</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">begin</span><span class="ocamlEnd"> </span><span class="Statement">try<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd">', </span><span class="ocamlLCIdentifier">defined</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="PreProc">Map</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L46" title="ocaml/bytecomp/symtable.ml:46">find</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">mapping</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">defined<br/></li>
<li></span><span class="ocamlNone">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">then</span><span class="ocamlEnd"> </span><span class="Constant">Reloc_getglobal</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd">'<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else</span><span class="ocamlEnd"> </span><span class="Statement">raise(</span><span class="Constant">Error</span><span class="Statement">(</span><span class="Constant">Forward_reference</span><span class="Statement">(</span><span class="ocamlLCIdentifier">objfile</span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier">id</span><span class="Statement">)))<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">with</span><span class="ocamlEnd"> </span><span class="Constant">Not_found</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* PR#5276: unique-ize dotted global names, which appear<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if one of the units being consolidated is itself a packed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module. *)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="PreProc">String</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">contains</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="ocamlNone"> </span><span class="Constant">'.'</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Reloc_getglobal</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">create_persistent</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">packagename</span><span class="ocamlEnd"> </span><span class="Statement">^</span><span class="ocamlEnd"> </span><span class="Constant">&quot;.&quot;</span><span class="ocamlEnd"> </span><span class="Statement">^</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="Statement">))<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">rel<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">end<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Reloc_setglobal</span> <span class="ocamlLCIdentifier">id</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">begin</span><span class="ocamlEnd"> </span><span class="Statement">try<br/></li>
<li><a id="L85">&#x200c;</a></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd">', </span><span class="ocamlLCIdentifier">defined</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="PreProc">Map</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L46" title="ocaml/bytecomp/symtable.ml:46">find</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">mapping</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">defined<br/></li>
<li></span><span class="ocamlNone">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">then</span><span class="ocamlEnd"> </span><span class="Statement">raise(</span><span class="Constant">Error</span><span class="Statement">(</span><span class="Constant">Multiple_definition</span><span class="Statement">(</span><span class="ocamlLCIdentifier">objfile</span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier">id</span><span class="Statement">)))<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else</span><span class="ocamlEnd"> </span><span class="Constant">Reloc_setglobal</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd">'<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">with</span><span class="ocamlEnd"> </span><span class="Constant">Not_found</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">(* PR#5276, as above *)<br/></li>
<li><a id="L91">&#x200c;</a></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><span class="linkable">name</span></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><span class="linkable">name</span></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">id</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="PreProc">String</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">contains</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="ocamlNone"> </span><span class="Constant">'.'</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">Reloc_setglobal</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="PreProc">Ident</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">create_persistent</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">packagename</span><span class="ocamlEnd"> </span><span class="Statement">^</span><span class="ocamlEnd"> </span><span class="Constant">&quot;.&quot;</span><span class="ocamlEnd"> </span><span class="Statement">^</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="Statement">))<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">else<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">rel<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">end<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">rel</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">(</span><span class="ocamlLCIdentifier">rel</span>', <span class="ocamlLCIdentifier">base</span> + <span class="ocamlLCIdentifier">ofs</span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* relocate a debugging <a href="bytegen.ml.html#L992" title="ocaml/bytecomp/bytegen.ml:992">event</a> *)<br/></li>
<li></span><br/></li>
<li><a id="L103">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">relocate_debug</span></span> <span class="ocamlLCIdentifier">base</span> <span class="ocamlLCIdentifier">prefix</span> <span class="ocamlLCIdentifier">subst</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L1020" title="ocaml/bytecomp/bytegen.ml:1020">ev</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L1020" title="ocaml/bytecomp/bytegen.ml:1020">ev</a></span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">ev_pos</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">base</span> + <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L1020" title="ocaml/bytecomp/bytegen.ml:1020">ev</a></span>.<span class="ocamlLCIdentifier">ev_pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ev_module</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">prefix</span> <span class="Statement">^</span> <span class="Constant">&quot;.&quot;</span> <span class="Statement">^</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L1020" title="ocaml/bytecomp/bytegen.ml:1020">ev</a></span>.<span class="ocamlLCIdentifier">ev_module</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">ev_typsubst</span> <span class="Statement">=</span> <span class="PreProc">Subst</span>.<span class="ocamlLCIdentifier">compose</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L1020" title="ocaml/bytecomp/bytegen.ml:1020">ev</a></span>.<span class="ocamlLCIdentifier">ev_typsubst</span> <span class="ocamlLCIdentifier">subst</span> <span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Read the unit information from a .cmo file. *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">type</span> <span class="ocamlLCIdentifier">pack_member_kind</span> <span class="Statement">=</span> <span class="Constant">PM_intf</span> <span class="Statement">|</span> <span class="Constant">PM_impl</span> <span class="Statement">of</span> <span class="ocamlLCIdentifier">compilation_unit<br/></li>
<li></span><br/></li>
<li><span class="Statement">type</span> <span class="ocamlLCIdentifier">pack_member</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">pm_file</span>: <span class="Type">string</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">pm_name</span>: <span class="Type">string</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L140" title="ocaml/bytecomp/bytepackager.ml:140">pm_ident</a></span>: <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L141" title="ocaml/bytecomp/bytepackager.ml:141">pm_packed_ident</a></span>: <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="bytesections.mli.html#L23" title="ocaml/bytecomp/bytesections.mli:23">t</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">pm_kind</span>: <span class="ocamlLCIdentifier">pack_member_kind</span> <span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">read_member_info</span> <span class="ocamlLCIdentifier">targetname</span> <span class="ocamlLCIdentifier">file</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="Statement">=</span> <span class="PreProc">String</span>.<span class="ocamlLCIdentifier">capitalize_ascii</span><span class="Statement">(</span><span class="PreProc">Filename</span>.<span class="ocamlLCIdentifier"><a href="bytelink.ml.html#L704" title="ocaml/bytecomp/bytelink.ml:704">basename</a></span><span class="Statement">(</span><span class="ocamlLCIdentifier">chop_extensions</span> <span class="ocamlLCIdentifier">file</span><span class="Statement">))</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">kind</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">(* PR#7479: make sure it is either a .cmi or a .cmo *)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="PreProc">Filename</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">check_suffix</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">file</span><span class="ocamlNone"> </span><span class="Constant">&quot;.cmi&quot;</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Constant">PM_intf<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">begin<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">open_in_bin</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">file</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="PreProc">Fun</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">protect</span><span class="ocamlEnd"> </span><span class="Statement">~</span><span class="Identifier">finally</span><span class="ocamlEnd">:</span><span class="Statement">(fun</span><span class="ocamlEnd"> </span><span class="Constant">()</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">close_in</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">(fun</span><span class="ocamlEnd"> </span><span class="Constant">()</span><span class="ocamlEnd"> </span><span class="Statement">-&gt;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">buffer</span><span class="ocamlEnd"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">really_input_string</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="PreProc">String</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">length</span><span class="ocamlEnd"> </span><span class="PreProc">Config</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">cmo_magic_number</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">buffer</span><span class="ocamlNone"> </span><span class="Statement">&lt;&gt;</span><span class="ocamlNone"> </span><span class="PreProc">Config</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">cmo_magic_number</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">raise(</span><span class="Constant">Error</span><span class="Statement">(</span><span class="Constant">Not_an_object_file</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">file</span><span class="Statement">));<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">compunit_pos</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">input_binary_int</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">seek_in</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">compunit_pos</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">input_value</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> : </span><span class="ocamlLCIdentifier">compilation_unit</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">cu_name</span><span class="ocamlNone"> </span><span class="Statement">&lt;&gt;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a><br/></li>
<li></span><span class="ocamlNone">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">then</span><span class="ocamlEnd"> </span><span class="Statement">raise(</span><span class="Constant">Error</span><span class="Statement">(</span><span class="Constant">Illegal_renaming</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier">file</span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">cu_name</span><span class="Statement">)));<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">PM_impl</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; </span><span class="Statement">end</span> <span class="Statement">in<br/></li>
<li><a id="L140">&#x200c;</a></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">pm_ident</span></span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_persistent</span> <span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="Statement">in<br/></li>
<li><a id="L141">&#x200c;</a></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">pm_packed_ident</span></span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_persistent</span><span class="Statement">(</span><span class="ocamlLCIdentifier">targetname</span> <span class="Statement">^</span> <span class="Constant">&quot;.&quot;</span> <span class="Statement">^</span> <span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">pm_file</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">file</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">pm_name</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier">pm_kind</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">kind</span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L140" title="ocaml/bytecomp/bytepackager.ml:140">pm_ident</a></span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="#L141" title="ocaml/bytecomp/bytepackager.ml:141">pm_packed_ident</a></span> <span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Read the <a href="meta.ml.html#L19" title="ocaml/bytecomp/meta.ml:19">bytecode</a> from a .cmo file.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Write <a href="meta.ml.html#L19" title="ocaml/bytecomp/meta.ml:19">bytecode</a> to channel [oc].<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Rename globals as indicated by [mapping] in reloc <a href="bytegen.ml.html#L1040" title="ocaml/bytecomp/bytegen.ml:1040">info</a>.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Accumulate relocs, debug <a href="bytegen.ml.html#L1040" title="ocaml/bytecomp/bytegen.ml:1040">info</a>, etc.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Return the accumulated state. *)<br/></li>
<li></span><br/></li>
<li><a id="L150">&#x200c;</a><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">rename_append_bytecode</span></span> <span class="ocamlLCIdentifier">packagename</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">state</span> <span class="ocamlLCIdentifier">objfile</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">open_in_bin</span> <span class="ocamlLCIdentifier">objfile</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">try<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Bytelink</span>.<span class="ocamlLCIdentifier"><a href="bytelink.ml.html#L187" title="ocaml/bytecomp/bytelink.ml:187">check_consistency</a></span> <span class="ocamlLCIdentifier">objfile</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">relocs</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">rev_append_map<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(</span><span class="ocamlLCIdentifier">rename_relocation</span> <span class="ocamlLCIdentifier">packagename</span> <span class="ocamlLCIdentifier">objfile</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">mapping</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span>.<span class="ocamlLCIdentifier">cu_reloc<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">relocs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">primitives</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">rev_append</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span>.<span class="ocamlLCIdentifier">cu_primitives</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">primitives</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">seek_in</span> <span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span>.<span class="ocamlLCIdentifier">cu_pos</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Misc</span>.<span class="ocamlLCIdentifier">copy_file_chunk</span> <span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span>.<span class="ocamlLCIdentifier">cu_codesize</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">events</span>, <span class="ocamlLCIdentifier">debug_dirs</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="Statement">!</span><span class="PreProc">Clflags</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">debug</span><span class="ocamlNone"> </span><span class="Statement">&amp;&amp;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">cu_debug</span><span class="ocamlNone"> </span><span class="Statement">&gt;</span><span class="ocamlNone"> </span><span class="Constant">0</span><span class="ocamlNone"> </span><span class="Statement">then</span> <span class="Statement">begin<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">seek_in</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">cu_debug</span><span class="Statement">;<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">unit_events</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">input_value</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> : </span><span class="ocamlLCIdentifier"><a href="instruct.ml.html#L23" title="ocaml/bytecomp/instruct.ml:23">debug_event</a></span><span class="ocamlEnd"> </span><span class="Type">list</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">events</span><span class="ocamlEnd"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">rev_append_map<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L103" title="ocaml/bytecomp/bytepackager.ml:103">relocate_debug</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">state</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">packagename</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">state</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">subst</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">unit_events<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">state</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">events</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">unit_debug_dirs</span><span class="ocamlEnd"> </span><span class="Statement">=</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="ocamlLCIdentifier">input_value</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="ocamlEnd"> : </span><span class="Type">string</span><span class="ocamlEnd"> </span><span class="Type">list</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">let</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">debug_dirs</span><span class="ocamlEnd"> </span><span class="Statement">=<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="PreProc">String</span><span class="ocamlEnd">.</span><span class="PreProc">Set</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">union<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">state</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">debug_dirs<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">(</span><span class="PreProc">String</span><span class="ocamlEnd">.</span><span class="PreProc">Set</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">of_list</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">unit_debug_dirs</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">in<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ocamlLCIdentifier">events</span><span class="ocamlEnd">, </span><span class="ocamlLCIdentifier">debug_dirs<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="Statement">end<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">events</span>, <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">debug_dirs<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">close_in</span> <span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">relocs</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">primitives</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">events</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">debug_dirs</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> + <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span>.<span class="ocamlLCIdentifier">cu_codesize</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">}<br/></li>
<li></span>&nbsp; <span class="Statement">with</span> <span class="ocamlLCIdentifier">x</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">close_in</span> <span class="ocamlLCIdentifier"><a href="symtable.ml.html#L298" title="ocaml/bytecomp/symtable.ml:298">ic</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">raise</span> <span class="ocamlLCIdentifier">x<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Same, for a list of .cmo and .cmi files.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; Return the accumulated state. *)<br/></li>
<li><a id="L191">&#x200c;</a></span><span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">rename_append_pack_member</span></span> <span class="ocamlLCIdentifier">packagename</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">state</span> <span class="ocamlLCIdentifier">m</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier">pm_kind</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">PM_intf</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">state<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">PM_impl</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="#L150" title="ocaml/bytecomp/bytepackager.ml:150">rename_append_bytecode</a></span> <span class="ocamlLCIdentifier">packagename</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">state</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier">pm_file</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">id</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier"><a href="#L140" title="ocaml/bytecomp/bytepackager.ml:140">pm_ident</a></span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">root</span> <span class="Statement">=</span> <span class="PreProc">Path</span>.<span class="Constant">Pident</span> <span class="Statement">(</span><span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_persistent</span> <span class="ocamlLCIdentifier">packagename</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">mapping</span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier">update</span> <span class="ocamlLCIdentifier">id</span> <span class="Statement">(function<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L819" title="ocaml/bytecomp/bytegen.ml:819">p</a></span>,<span class="Constant">false</span><span class="Statement">)</span> <span class="Statement">-&gt;</span> <span class="Constant">Some</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L819" title="ocaml/bytecomp/bytegen.ml:819">p</a></span>,<span class="Constant">true</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Some</span> <span class="Statement">(_</span>, <span class="Constant">true</span><span class="Statement">)</span> <span class="Statement">|</span> <span class="Constant">None</span> <span class="Statement">-&gt;</span> <span class="Statement">assert</span> <span class="Constant">false</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">mapping</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">subst</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Subst</span>.<span class="ocamlLCIdentifier">add_module</span> <span class="ocamlLCIdentifier">id</span> <span class="Statement">(</span><span class="PreProc">Path</span>.<span class="Constant">Pdot</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">root</span>, <span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="ocamlLCIdentifier">id</span><span class="Statement">))</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">subst</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">subst</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">mapping</span> <span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Generate the code that builds the tuple representing the package module *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">build_global_target</span> <span class="Statement">~</span><span class="Identifier">ppf_dump</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">target_name</span> <span class="ocamlLCIdentifier">state</span> <span class="ocamlLCIdentifier">components</span> <span class="ocamlLCIdentifier">coercion</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">lam</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Translmod</span>.<span class="ocamlLCIdentifier">transl_package<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">components</span> <span class="Statement">(</span><span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier">create_persistent</span> <span class="ocamlLCIdentifier">target_name</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">coercion</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">lam</span> <span class="Statement">=</span> <span class="PreProc">Simplif</span>.<span class="ocamlLCIdentifier">simplify_lambda</span> <span class="ocamlLCIdentifier">lam</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="Statement">!</span><span class="PreProc">Clflags</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">dump_lambda</span><span class="ocamlNone"> </span><span class="Statement">then<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Format</span>.<span class="ocamlLCIdentifier">fprintf</span> <span class="ocamlLCIdentifier">ppf_dump</span> <span class="Constant">&quot;%a@.&quot;</span> <span class="PreProc">Printlambda</span>.<span class="ocamlLCIdentifier">lambda</span> <span class="ocamlLCIdentifier">lam</span><span class="Statement">;<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">instrs</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Bytegen</span>.<span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L1154" title="ocaml/bytecomp/bytegen.ml:1154">compile_implementation</a></span> <span class="ocamlLCIdentifier">target_name</span> <span class="ocamlLCIdentifier">lam</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">size</span>, <span class="ocamlLCIdentifier">pack_relocs</span>, <span class="ocamlLCIdentifier">pack_events</span>, <span class="ocamlLCIdentifier">pack_debug_dirs</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Emitcode</span>.<span class="ocamlLCIdentifier"><a href="emitcode.mli.html#L40" title="ocaml/bytecomp/emitcode.mli:40">to_packed_file</a></span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">instrs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">events</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">rev_append</span> <span class="ocamlLCIdentifier">pack_events</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">events</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">debug_dirs</span> <span class="Statement">=</span> <span class="PreProc">String</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier">union</span> <span class="ocamlLCIdentifier">pack_debug_dirs</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">debug_dirs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">relocs</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">rev_append_map<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">(fun</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L854" title="ocaml/bytecomp/bytegen.ml:854">r</a></span>, <span class="ocamlLCIdentifier">ofs</span><span class="Statement">)</span> <span class="Statement">-&gt;</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L854" title="ocaml/bytecomp/bytegen.ml:854">r</a></span>, <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> + <span class="ocamlLCIdentifier">ofs</span><span class="Statement">))<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">pack_relocs</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">relocs</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">events</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">debug_dirs</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">relocs</span><span class="Statement">;</span> <span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier"><a href="bytegen.ml.html#L923" title="ocaml/bytecomp/bytegen.ml:923">offset</a></span> + <span class="ocamlLCIdentifier">size</span><span class="Statement">}<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Build the .cmo file obtained by packaging the given .cmo files. *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier">package_object_files</span> <span class="Statement">~</span><span class="Identifier">ppf_dump</span> <span class="ocamlLCIdentifier">files</span> <span class="ocamlLCIdentifier">targetfile</span> <span class="ocamlLCIdentifier">targetname</span> <span class="ocamlLCIdentifier">coercion</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">members</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">map_left_right</span> <span class="Statement">(</span><span class="ocamlLCIdentifier">read_member_info</span> <span class="ocamlLCIdentifier">targetname</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">files</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">fold_right</span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a></span> <span class="Statement">-&gt;</span> <span class="Statement">match</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">pm_kind</span> <span class="Statement">=</span> <span class="Constant">PM_intf</span> <span class="Statement">}</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">pm_kind</span> <span class="Statement">=</span> <span class="Constant">PM_impl</span> <span class="Statement">{</span> <span class="ocamlLCIdentifier">cu_required_globals</span><span class="Statement">;</span> <span class="ocamlLCIdentifier">cu_reloc</span> <span class="Statement">}</span> <span class="Statement">}</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="bytelink.ml.html#L121" title="ocaml/bytecomp/bytelink.ml:121">remove_required</a></span> <span class="Statement">(</span><span class="ocamlLCIdentifier">rel</span>, <span class="ocamlLCIdentifier">_pos</span><span class="Statement">)</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">rel</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">Reloc_setglobal</span> <span class="ocamlLCIdentifier">id</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Ident</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier">remove</span> <span class="ocamlLCIdentifier">id</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">fold_right</span> <span class="ocamlLCIdentifier"><a href="bytelink.ml.html#L121" title="ocaml/bytecomp/bytelink.ml:121">remove_required</a></span> <span class="ocamlLCIdentifier">cu_reloc</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">fold_right</span> <span class="PreProc">Ident</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier">add</span> <span class="ocamlLCIdentifier">cu_required_globals</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">members</span> <span class="PreProc">Ident</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier"><a href="symtable.ml.html#L44" title="ocaml/bytecomp/symtable.ml:44">empty</a><br/></li>
<li></span>&nbsp; <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">oc</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">open_out_bin</span> <span class="ocamlLCIdentifier">targetfile</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="PreProc">Fun</span>.<span class="ocamlLCIdentifier">protect</span> <span class="Statement">~</span><span class="Identifier">finally</span>:<span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">close_out</span> <span class="ocamlLCIdentifier">oc</span><span class="Statement">)</span> <span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">output_string</span> <span class="ocamlLCIdentifier">oc</span> <span class="PreProc">Config</span>.<span class="ocamlLCIdentifier">cmo_magic_number</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">pos_depl</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos_out</span> <span class="ocamlLCIdentifier">oc</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">output_binary_int</span> <span class="ocamlLCIdentifier">oc</span> <span class="Constant">0</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">pos_code</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos_out</span> <span class="ocamlLCIdentifier">oc</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">mapping</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">map<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">m</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier"><a href="#L140" title="ocaml/bytecomp/bytepackager.ml:140">pm_ident</a></span>, <span class="Statement">(</span><span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier"><a href="#L141" title="ocaml/bytecomp/bytepackager.ml:141">pm_packed_ident</a></span>, <span class="Constant">false</span><span class="Statement">))<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">members<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|&gt;</span> <span class="PreProc">Ident</span>.<span class="PreProc">Map</span>.<span class="ocamlLCIdentifier">of_list</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">empty_state</span> <span class="Statement">with</span> <span class="ocamlLCIdentifier">mapping</span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">fold_left</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L191" title="ocaml/bytecomp/bytepackager.ml:191">rename_append_pack_member</a></span> <span class="ocamlLCIdentifier">targetname</span> <span class="ocamlLCIdentifier">oc</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">state</span> <span class="ocamlLCIdentifier">members</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">components</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">map<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">m</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">match</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier">pm_kind</span> <span class="Statement">with<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">PM_intf</span> <span class="Statement">-&gt;</span> <span class="Constant">None<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">PM_impl</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="Constant">Some</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier"><a href="#L141" title="ocaml/bytecomp/bytepackager.ml:141">pm_packed_ident</a></span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">members</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">state</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">build_global_target</span> <span class="Statement">~</span><span class="Identifier">ppf_dump</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">targetname</span> <span class="ocamlLCIdentifier">state</span> <span class="ocamlLCIdentifier">components</span> <span class="ocamlLCIdentifier">coercion</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">pos_debug</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos_out</span> <span class="ocamlLCIdentifier">oc</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span><span class="ocamlNone"> </span><span class="Statement">!</span><span class="PreProc">Clflags</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">debug</span><span class="ocamlNone"> </span><span class="Statement">&amp;&amp;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">state</span><span class="ocamlNone">.</span><span class="ocamlLCIdentifier">events</span><span class="ocamlNone"> </span><span class="Statement">&lt;&gt;</span><span class="ocamlNone"> </span><span class="Constant">[]</span><span class="ocamlNone"> </span><span class="Statement">then</span> <span class="Statement">begin<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="PreProc">Marshal</span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier">to_channel</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">oc</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="PreProc">List</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">rev</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">state</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">events</span><span class="Statement">)</span><span class="ocamlEnd"> </span><span class="Statement">[</span><span class="Constant">Compression</span><span class="Statement">]);<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; </span><span class="PreProc">Marshal</span><span class="ocamlEnd">.</span><span class="Statement">(</span><span class="ocamlLCIdentifier">to_channel</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">oc</span><span class="ocamlEnd"> </span><span class="Statement">(</span><span class="PreProc">String</span><span class="ocamlEnd">.</span><span class="PreProc">Set</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">elements</span><span class="ocamlEnd"> </span><span class="ocamlLCIdentifier">state</span><span class="ocamlEnd">.</span><span class="ocamlLCIdentifier">debug_dirs</span><span class="Statement">)<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Statement">[</span><span class="Constant">Compression</span><span class="Statement">]);<br/></li>
<li></span><span class="ocamlEnd">&nbsp; &nbsp; </span><span class="Statement">end;<br/></li>
<li><a id="L279">&#x200c;</a></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">force_link</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">exists</span> <span class="Statement">(function<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">{</span><span class="ocamlLCIdentifier">pm_kind</span> <span class="Statement">=</span> <span class="Constant">PM_impl</span> <span class="Statement">{</span><span class="ocamlLCIdentifier">cu_force_link</span><span class="Statement">}}</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">cu_force_link<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="Constant">false</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">members</span> <span class="Statement">in<br/></li>
<li><a id="L283">&#x200c;</a></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">pos_final</span></span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos_out</span> <span class="ocamlLCIdentifier">oc</span> <span class="Statement">in<br/></li>
<li><a id="L284">&#x200c;</a></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">imports</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">unit_names</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">map</span> <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">m</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">m</span>.<span class="ocamlLCIdentifier">pm_name</span><span class="Statement">)</span> <span class="ocamlLCIdentifier">members</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">filter<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(fun</span> <span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span>, <span class="ocamlLCIdentifier">_crc</span><span class="Statement">)</span> <span class="Statement">-&gt;</span> <span class="Statement">not</span> <span class="Statement">(</span><span class="PreProc">List</span>.<span class="ocamlLCIdentifier">mem</span> <span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="ocamlLCIdentifier">unit_names</span><span class="Statement">))<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(</span><span class="PreProc">Bytelink</span>.<span class="ocamlLCIdentifier"><a href="bytelink.ml.html#L211" title="ocaml/bytecomp/bytelink.ml:211">extract_crc_interfaces</a></span><span class="Constant">()</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li><a id="L290">&#x200c;</a></span>&nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier"><span class="linkable">compunit</span></span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">{</span> <span class="ocamlLCIdentifier">cu_name</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">targetname</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_pos</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos_code</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_codesize</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">pos_debug</span> - <span class="ocamlLCIdentifier">pos_code</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_reloc</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">rev</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">relocs</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_imports</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(</span><span class="ocamlLCIdentifier">targetname</span>, <span class="Constant">Some</span> <span class="Statement">(</span><span class="PreProc">Env</span>.<span class="ocamlLCIdentifier">crc_of_unit</span> <span class="ocamlLCIdentifier">targetname</span><span class="Statement">))</span> <span class="Statement">::</span> <span class="ocamlLCIdentifier"><a href="#L284" title="ocaml/bytecomp/bytepackager.ml:284">imports</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_primitives</span> <span class="Statement">=</span> <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">rev</span> <span class="ocamlLCIdentifier">state</span>.<span class="ocamlLCIdentifier">primitives</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_required_globals</span> <span class="Statement">=</span> <span class="PreProc">Ident</span>.<span class="PreProc">Set</span>.<span class="ocamlLCIdentifier">elements</span> <span class="ocamlLCIdentifier"><a href="symtable.mli.html#L43" title="ocaml/bytecomp/symtable.mli:43">required_globals</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_force_link</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L279" title="ocaml/bytecomp/bytepackager.ml:279">force_link</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_debug</span> <span class="Statement">=</span> <span class="Statement">if</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier"><a href="#L283" title="ocaml/bytecomp/bytepackager.ml:283">pos_final</a></span><span class="ocamlNone"> </span><span class="Statement">&gt;</span><span class="ocamlNone"> </span><span class="ocamlLCIdentifier">pos_debug</span><span class="ocamlNone"> </span><span class="Statement">then</span> <span class="ocamlLCIdentifier">pos_debug</span> <span class="Statement">else</span> <span class="Constant">0</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">cu_debugsize</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier"><a href="#L283" title="ocaml/bytecomp/bytepackager.ml:283">pos_final</a></span> - <span class="ocamlLCIdentifier">pos_debug</span> <span class="Statement">}</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">Emitcode</span>.<span class="ocamlLCIdentifier"><a href="emitcode.mli.html#L53" title="ocaml/bytecomp/emitcode.mli:53">marshal_to_channel_with_possibly_32bit_compat</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier">filename</span>:<span class="ocamlLCIdentifier">targetfile</span> <span class="Statement">~</span><span class="Identifier">kind</span>:<span class="Constant">&quot;<a href="meta.ml.html#L19" title="ocaml/bytecomp/meta.ml:19">bytecode</a> unit&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier"><a href="#L290" title="ocaml/bytecomp/bytepackager.ml:290">compunit</a></span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">seek_out</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier">pos_depl</span><span class="Statement">;<br/></li>
<li></span>&nbsp; &nbsp; <span class="ocamlLCIdentifier">output_binary_int</span> <span class="ocamlLCIdentifier">oc</span> <span class="ocamlLCIdentifier"><a href="#L283" title="ocaml/bytecomp/bytepackager.ml:283">pos_final</a></span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* The entry point *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="bytepackager.mli.html#L19" title="ocaml/bytecomp/bytepackager.mli:19">package_files</a></span> <span class="Statement">~</span><span class="Identifier">ppf_dump</span> <span class="ocamlLCIdentifier">initial_env</span> <span class="ocamlLCIdentifier">files</span> <span class="ocamlLCIdentifier">targetfile</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">files</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; <span class="PreProc">List</span>.<span class="ocamlLCIdentifier">map<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">(fun</span> <span class="ocamlLCIdentifier">f</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">try</span> <span class="PreProc">Load_path</span>.<span class="ocamlLCIdentifier"><a href="symtable.ml.html#L46" title="ocaml/bytecomp/symtable.ml:46">find</a></span> <span class="ocamlLCIdentifier">f<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">with</span> <span class="Constant">Not_found</span> <span class="Statement">-&gt;</span> <span class="Statement">raise(</span><span class="Constant">Error</span><span class="Statement">(</span><span class="Constant">File_not_found</span> <span class="ocamlLCIdentifier">f</span><span class="Statement">)))<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">files</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">prefix</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">chop_extensions</span> <span class="ocamlLCIdentifier">targetfile</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">targetcmi</span> <span class="Statement">=</span> <span class="ocamlLCIdentifier">prefix</span> <span class="Statement">^</span> <span class="Constant">&quot;.cmi&quot;</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">targetname</span> <span class="Statement">=</span> <span class="PreProc">String</span>.<span class="ocamlLCIdentifier">capitalize_ascii</span><span class="Statement">(</span><span class="PreProc">Filename</span>.<span class="ocamlLCIdentifier"><a href="bytelink.ml.html#L704" title="ocaml/bytecomp/bytelink.ml:704">basename</a></span> <span class="ocamlLCIdentifier">prefix</span><span class="Statement">)</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; <span class="PreProc">Misc</span>.<span class="ocamlLCIdentifier">try_finally</span> <span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">let</span> <span class="ocamlLCIdentifier">coercion</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Typemod</span>.<span class="ocamlLCIdentifier">package_units</span> <span class="ocamlLCIdentifier">initial_env</span> <span class="ocamlLCIdentifier">files</span> <span class="ocamlLCIdentifier">targetcmi</span> <span class="ocamlLCIdentifier">targetname</span> <span class="Statement">in<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">package_object_files</span> <span class="Statement">~</span><span class="Identifier">ppf_dump</span> <span class="ocamlLCIdentifier">files</span> <span class="ocamlLCIdentifier">targetfile</span> <span class="ocamlLCIdentifier">targetname</span> <span class="ocamlLCIdentifier">coercion<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">~</span><span class="Identifier">exceptionally</span>:<span class="Statement">(fun</span> <span class="Constant">()</span> <span class="Statement">-&gt;</span> <span class="ocamlLCIdentifier">remove_file</span> <span class="ocamlLCIdentifier">targetfile</span><span class="Statement">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">(* Error report *)<br/></li>
<li></span><br/></li>
<li><span class="Statement">open</span><span class="ocamlNone"> </span><span class="PreProc">Format<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="ocamlLCIdentifier"><a href="bytelibrarian.mli.html#L35" title="ocaml/bytecomp/bytelibrarian.mli:35">report_error</a></span> <span class="ocamlLCIdentifier">ppf</span> <span class="Statement">=</span> <span class="Statement">function<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">Forward_reference</span><span class="Statement">(</span><span class="ocamlLCIdentifier">file</span>, <span class="ocamlLCIdentifier">ident</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">fprintf</span> <span class="ocamlLCIdentifier">ppf</span> <span class="Constant">&quot;Forward reference to %s in file %a&quot;</span> <span class="Statement">(</span><span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="ocamlLCIdentifier">ident</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">print_filename</span> <span class="ocamlLCIdentifier">file<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Multiple_definition</span><span class="Statement">(</span><span class="ocamlLCIdentifier">file</span>, <span class="ocamlLCIdentifier">ident</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">fprintf</span> <span class="ocamlLCIdentifier">ppf</span> <span class="Constant">&quot;File %a redefines %s&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">print_filename</span> <span class="ocamlLCIdentifier">file<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">(</span><span class="PreProc">Ident</span>.<span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="ocamlLCIdentifier">ident</span><span class="Statement">)<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Not_an_object_file</span> <span class="ocamlLCIdentifier">file</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">fprintf</span> <span class="ocamlLCIdentifier">ppf</span> <span class="Constant">&quot;%a is not a <a href="meta.ml.html#L19" title="ocaml/bytecomp/meta.ml:19">bytecode</a> object file&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">print_filename</span> <span class="ocamlLCIdentifier">file<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">Illegal_renaming</span><span class="Statement">(</span><span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span>, <span class="ocamlLCIdentifier">file</span>, <span class="ocamlLCIdentifier">id</span><span class="Statement">)</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">fprintf</span> <span class="ocamlLCIdentifier">ppf</span> <span class="Constant">&quot;Wrong file naming: %a@ contains the code for\<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; @ %s when %s was expected&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">print_filename</span> <span class="ocamlLCIdentifier">file</span> <span class="ocamlLCIdentifier"><a href="#L91" title="ocaml/bytecomp/bytepackager.ml:91">name</a></span> <span class="ocamlLCIdentifier">id<br/></li>
<li></span>&nbsp; <span class="Statement">|</span> <span class="Constant">File_not_found</span> <span class="ocamlLCIdentifier">file</span> <span class="Statement">-&gt;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="ocamlLCIdentifier">fprintf</span> <span class="ocamlLCIdentifier">ppf</span> <span class="Constant">&quot;File %s not found&quot;</span> <span class="ocamlLCIdentifier">file<br/></li>
<li></span><br/></li>
<li><span class="Statement">let</span> <span class="Constant">()</span> <span class="Statement">=<br/></li>
<li></span>&nbsp; <span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">register_error_of_exn<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">(function<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Constant">Error</span> <span class="ocamlLCIdentifier">err</span> <span class="Statement">-&gt;</span> <span class="Constant">Some</span> <span class="Statement">(</span><span class="PreProc">Location</span>.<span class="ocamlLCIdentifier">error_of_printer_file</span> <span class="ocamlLCIdentifier"><a href="bytelibrarian.mli.html#L35" title="ocaml/bytecomp/bytelibrarian.mli:35">report_error</a></span> <span class="ocamlLCIdentifier">err</span><span class="Statement">)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">|</span> <span class="Statement">_</span> <span class="Statement">-&gt;</span> <span class="Constant">None<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">)<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>

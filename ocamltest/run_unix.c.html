<!-- generated by the vscode.pl tool from vscoded.-->

<html>
 <head>
  <title>ocaml/ocamltest/run_unix.c - ocaml</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

  <h1>ocaml/ocamltest/run_unix.c - ocaml</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L38">timeout_expired</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L96">handle_alarm</a></li>
<li><a href="#L248">handle_process_termination</a></li>
<li><a href="#L49">myperror_with_location</a></li>
<li><a href="#L74">open_error_with_location</a></li>
<li><a href="#L101">paths_same_file</a></li>
<li><a href="#L85">realpath_error_with_location</a></li>
<li><a href="#L342">run_command</a></li>
<li><a href="#L167">run_command_child</a></li>
<li><a href="#L296">run_command_parent</a></li>
<li><a href="#L136">update_environment</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L18">CAML_INTERNALS</a></li>
<li><a href="#L36">COREFILENAME</a></li>
<li><a href="#L70">child_error</a></li>
<li><a href="#L40">error</a></li>
<li><a href="#L65">myperror</a></li>
<li><a href="#L82">open_error</a></li>
<li><a href="#L93">realpath_error</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/**************************************************************************/<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Sebastien Hinderer, projet Gallium, INRIA Paris&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; Copyright 2016 Institut National de Recherche en Informatique et&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp;&nbsp; en Automatique.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; All rights reserved.&nbsp; This file is distributed under the terms of&nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; the GNU Lesser General Public License version 2.1, with the&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp;&nbsp; special exception on linking described in the file LICENSE.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */<br/></li>
<li></span><span class="Comment">/**************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Run programs with rediretions and timeouts under Unix */<br/></li>
<li></span><br/></li>
<li><a id="L18">&#x200c;</a><span class="PreProc">#define <span class="linkable">CAML_INTERNALS</span><br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;stdio.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;limits.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdlib.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/wait.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;fcntl.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;string.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;errno.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;stdarg.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;signal.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;run.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;run_common.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;caml/domain.h&gt;<br/></li>
<li></span><br/></li>
<li><a id="L36">&#x200c;</a><span class="PreProc">#define <span class="linkable">COREFILENAME</span> </span><span class="Constant">&quot;core&quot;<br/></li>
<li></span><br/></li>
<li><a id="L38">&#x200c;</a><span class="Type">static</span> <span class="Type">volatile</span> <span class="Type">int</span> <span class="linkable">timeout_expired</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a><span class="PreProc">#define <span class="linkable">error</span>(msg, ...) \<br/></li>
<li></span><span class="PreProc"><a href="run_common.h.html#L41" title="ocaml/ocamltest/run_common.h:41">error_with_location</a>(</span><span class="Constant">__FILE__</span><span class="PreProc">, </span><span class="Constant">__LINE__</span><span class="PreProc">, settings, msg, ## </span><span class="Constant">__VA_ARGS__</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; Note: the ## __VA_ARGS__ construct is gcc specific.<br/></li>
<li></span><span class="Comment">&nbsp; For a more portable (but also more complex) solution, see<br/></li>
<li></span><span class="Comment">&nbsp; http://stackoverflow.com/questions/20818800/variadic-macro-and-trailing-comma<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><br/></li>
<li><a id="L49">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">myperror_with_location</span>(<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *file, <span class="Type">int</span> line,<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings,<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg, ...)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">va_list</span> ap;<br/></li>
<li>&nbsp; <a href="run.h.html#L27" title="ocaml/ocamltest/run.h:27">Logger</a> *logger = (settings-&gt;logger != <span class="Constant">NULL</span>) ? settings-&gt;logger<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <a href="run_common.h.html#L28" title="ocaml/ocamltest/run_common.h:28">defaultLogger</a>;<br/></li>
<li>&nbsp; <span class="Type">void</span> *loggerData = settings-&gt;loggerData;<br/></li>
<li>&nbsp; va_start(ap, msg);<br/></li>
<li>&nbsp; <a href="run_common.h.html#L33" title="ocaml/ocamltest/run_common.h:33">mylog</a>(logger, loggerData, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">:</span><span class="Special">%d</span><span class="Constant">: &quot;</span>, file, line);<br/></li>
<li>&nbsp; logger(loggerData, msg, ap);<br/></li>
<li>&nbsp; <a href="run_common.h.html#L33" title="ocaml/ocamltest/run_common.h:33">mylog</a>(logger, loggerData, <span class="Constant">&quot;: </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, strerror(errno));<br/></li>
<li>&nbsp; va_end(ap);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L65">&#x200c;</a><span class="PreProc">#define <span class="linkable">myperror</span>(msg, ...) \<br/></li>
<li></span><span class="PreProc"><a href="#L49" title="ocaml/ocamltest/run_unix.c:49">myperror_with_location</a>(</span><span class="Constant">__FILE__</span><span class="PreProc">, </span><span class="Constant">__LINE__</span><span class="PreProc">, settings, msg, ## </span><span class="Constant">__VA_ARGS__</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Same remark as for the <a href="#L40" title="ocaml/ocamltest/run_unix.c:40">error</a> macro. */<br/></li>
<li></span><br/></li>
<li><a id="L70">&#x200c;</a><span class="PreProc">#define <span class="linkable">child_error</span>(msg, ...) \<br/></li>
<li></span><span class="PreProc">&nbsp; <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(msg, ## </span><span class="Constant">__VA_ARGS__</span><span class="PreProc">); \<br/></li>
<li></span><span class="PreProc">&nbsp; </span><span class="Statement">goto</span><span class="PreProc"> child_failed;<br/></li>
<li></span><br/></li>
<li><a id="L74">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">open_error_with_location</span>(<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *file, <span class="Type">int</span> line,<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings,<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L49" title="ocaml/ocamltest/run_unix.c:49">myperror_with_location</a>(file, line, settings, <span class="Constant">&quot;Can not open </span><span class="Special">%s</span><span class="Constant">&quot;</span>, msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L82">&#x200c;</a><span class="PreProc">#define <span class="linkable">open_error</span>(filename) \<br/></li>
<li></span><span class="PreProc"><a href="#L74" title="ocaml/ocamltest/run_unix.c:74">open_error_with_location</a>(</span><span class="Constant">__FILE__</span><span class="PreProc">, </span><span class="Constant">__LINE__</span><span class="PreProc">, settings, filename)<br/></li>
<li></span><br/></li>
<li><a id="L85">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">realpath_error_with_location</span>(<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *file, <span class="Type">int</span> line,<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings,<br/></li>
<li>&nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L49" title="ocaml/ocamltest/run_unix.c:49">myperror_with_location</a>(file, line, settings, <span class="Constant">&quot;realpath(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, msg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L93">&#x200c;</a><span class="PreProc">#define <span class="linkable">realpath_error</span>(filename) \<br/></li>
<li></span><span class="PreProc"><a href="#L85" title="ocaml/ocamltest/run_unix.c:85">realpath_error_with_location</a>(</span><span class="Constant">__FILE__</span><span class="PreProc">, </span><span class="Constant">__LINE__</span><span class="PreProc">, settings, filename)<br/></li>
<li></span><br/></li>
<li><a id="L96">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">handle_alarm</span>(<span class="Type">int</span> sig)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="#L38" title="ocaml/ocamltest/run_unix.c:38">timeout_expired</a> = <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L101">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">paths_same_file</span>(<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings, <span class="Type">const</span> <span class="Type">char</span> * path1, <span class="Type">const</span> <span class="Type">char</span> * path2)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">int</span> same_file = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#ifdef __GLIBC__<br/></li>
<li></span>&nbsp; <span class="Type">char</span> *realpath1, *realpath2;<br/></li>
<li>&nbsp; realpath1 = realpath(path1, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (realpath1 == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="#L93" title="ocaml/ocamltest/run_unix.c:93">realpath_error</a>(path1);<br/></li>
<li>&nbsp; realpath2 = realpath(path2, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (realpath2 == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; free(realpath1);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (errno == <span class="Constant">ENOENT</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <a href="#L93" title="ocaml/ocamltest/run_unix.c:93">realpath_error</a>(path2);<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; <span class="Type">char</span> realpath1[PATH_MAX], realpath2[PATH_MAX];<br/></li>
<li>&nbsp; <span class="Statement">if</span> (realpath(path1, realpath1) == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; <a href="#L93" title="ocaml/ocamltest/run_unix.c:93">realpath_error</a>(path1);<br/></li>
<li>&nbsp; <span class="Statement">if</span> (realpath(path2, realpath2) == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (errno == <span class="Constant">ENOENT</span>) <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <a href="#L93" title="ocaml/ocamltest/run_unix.c:93">realpath_error</a>(path2);<br/></li>
<li>&nbsp; }<br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* __GLIBC__ */<br/></li>
<li></span>&nbsp; <span class="Statement">if</span> (strcmp(realpath1, realpath2) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; same_file = <span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#ifdef __GLIBC__<br/></li>
<li></span>&nbsp; free(realpath1);<br/></li>
<li>&nbsp; free(realpath2);<br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* __GLIBC__ */<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> same_file;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L136">&#x200c;</a><span class="Type">static</span> <span class="Type">void</span> <span class="linkable">update_environment</span>(<a href="run.h.html#L25" title="ocaml/ocamltest/run.h:25">array</a> local_env)<br/></li>
<li>{<br/></li>
<li>&nbsp; <a href="run.h.html#L25" title="ocaml/ocamltest/run.h:25">array</a> envp;<br/></li>
<li>&nbsp; <span class="Statement">for</span> (envp = local_env; *envp != <span class="Constant">NULL</span>; envp++) {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span> *pos_eq = strchr(*envp, <span class="Constant">'='</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pos_eq != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> *name, *value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> name_length = pos_eq - *envp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> l = strlen(*envp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">int</span> value_length = l - (name_length +<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; name = malloc(name_length+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; value = malloc(value_length+<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; memcpy(name, *envp, name_length);<br/></li>
<li>&nbsp; &nbsp; &nbsp; name[name_length] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; memcpy(value, pos_eq + <span class="Constant">1</span>, value_length);<br/></li>
<li>&nbsp; &nbsp; &nbsp; value[value_length] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; setenv(name, value, <span class="Constant">1</span>); <span class="Comment">/* 1 means overwrite */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; free(name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; free(value);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; unsetenv(*envp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; This function should return an exitcode that can itself be returned<br/></li>
<li></span><span class="Comment">&nbsp; to its father through the exit system call.<br/></li>
<li></span><span class="Comment">&nbsp; So it returns 0 to report success and 1 to report an <a href="#L40" title="ocaml/ocamltest/run_unix.c:40">error</a><br/></li>
<li></span><br/></li>
<li><span class="Comment"> */<br/></li>
<li><a id="L167">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">run_command_child</span>(<span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">int</span> stdin_fd = -<span class="Constant">1</span>, stdout_fd = -<span class="Constant">1</span>, stderr_fd = -<span class="Constant">1</span>; <span class="Comment">/* -1 = no redir */<br/></li>
<li></span>&nbsp; <span class="Type">int</span> inputFlags = O_RDONLY;<br/></li>
<li>&nbsp; <span class="Type">int</span> outputFlags =<br/></li>
<li>&nbsp; &nbsp; O_CREAT | O_WRONLY | (settings-&gt;append ? O_APPEND : O_TRUNC);<br/></li>
<li>&nbsp; <span class="Type">int</span> inputMode = <span class="PreProc">0</span><span class="Constant">400</span>, outputMode = <span class="PreProc">0</span><span class="Constant">666</span>;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (setpgid(<span class="Constant">0</span>, <span class="Constant">0</span>) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="#L70" title="ocaml/ocamltest/run_unix.c:70">child_error</a>(<span class="Constant">&quot;setpgid&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="run_common.h.html#L23" title="ocaml/ocamltest/run_common.h:23">is_defined</a>(settings-&gt;stdin_filename))<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; stdin_fd = open(settings-&gt;stdin_filename, inputFlags, inputMode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stdin_fd &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L82" title="ocaml/ocamltest/run_unix.c:82">open_error</a>(settings-&gt;stdin_filename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> child_failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dup2(stdin_fd, STDIN_FILENO) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L70" title="ocaml/ocamltest/run_unix.c:70">child_error</a>(<span class="Constant">&quot;dup2 for stdin&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="run_common.h.html#L23" title="ocaml/ocamltest/run_common.h:23">is_defined</a>(settings-&gt;stdout_filename))<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; stdout_fd = open(settings-&gt;stdout_filename, outputFlags, outputMode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stdout_fd &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L82" title="ocaml/ocamltest/run_unix.c:82">open_error</a>(settings-&gt;stdout_filename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> child_failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dup2(stdout_fd, STDOUT_FILENO) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L70" title="ocaml/ocamltest/run_unix.c:70">child_error</a>(<span class="Constant">&quot;dup2 for stdout&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (<a href="run_common.h.html#L23" title="ocaml/ocamltest/run_common.h:23">is_defined</a>(settings-&gt;stderr_filename))<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stdout_fd != -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L101" title="ocaml/ocamltest/run_unix.c:101">paths_same_file</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; settings, settings-&gt;stdout_filename,settings-&gt;stderr_filename))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stderr_fd = stdout_fd;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stderr_fd == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; stderr_fd = open(settings-&gt;stderr_filename, outputFlags, outputMode);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stderr_fd == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L82" title="ocaml/ocamltest/run_unix.c:82">open_error</a>(settings-&gt;stderr_filename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> child_failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dup2(stderr_fd, STDERR_FILENO) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L70" title="ocaml/ocamltest/run_unix.c:70">child_error</a>(<span class="Constant">&quot;dup2 for stderr&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L136" title="ocaml/ocamltest/run_unix.c:136">update_environment</a>(settings-&gt;envp);<br/></li>
<li><br/></li>
<li>&nbsp; execvp(settings-&gt;program, settings-&gt;argv);<br/></li>
<li><br/></li>
<li>&nbsp; <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(<span class="Constant">&quot;Cannot execute </span><span class="Special">%s</span><span class="Constant">&quot;</span>, settings-&gt;program);<br/></li>
<li><br/></li>
<li><span class="Statement">child_failed</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Handles the termination of a process. Arguments:<br/></li>
<li></span><span class="Comment"> * The pid of the terminated process<br/></li>
<li></span><span class="Comment"> * Its termination status as returned by wait(2)<br/></li>
<li></span><span class="Comment"> * A string giving a prefix for the core file name.<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; (the file will be called prefix.pid.core but may come from a<br/></li>
<li></span><span class="Comment">&nbsp;&nbsp; different process)<br/></li>
<li></span><span class="Comment"> * Returns the code to return if this is the child process<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L248">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">handle_process_termination</span>(<br/></li>
<li>&nbsp; <span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings,<br/></li>
<li>&nbsp; pid_t pid, <span class="Type">int</span> status, <span class="Type">const</span> <span class="Type">char</span> *corefilename_prefix)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">int</span> signal, core = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; <span class="Type">char</span> *corestr;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (WIFEXITED(status)) <span class="Statement">return</span> WEXITSTATUS(status);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> ( !WIFSIGNALED(status) )<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="ocaml/ocamltest/run_unix.c:40">error</a>(<span class="Constant">&quot;Process </span><span class="Special">%lld</span><span class="Constant"> neither terminated normally nor received a&quot;</span> \<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;signal!?&quot;</span>, (<span class="Type">long</span> <span class="Type">long</span>) pid);<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Comment">/* From here we know that the process terminated due to a signal */<br/></li>
<li></span>&nbsp; signal = WTERMSIG(status);<br/></li>
<li><span class="PreProc">#ifdef WCOREDUMP<br/></li>
<li></span>&nbsp; core = WCOREDUMP(status);<br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* WCOREDUMP */<br/></li>
<li></span>&nbsp; corestr = core ? <span class="Constant">&quot;&quot;</span> : <span class="Constant">&quot;no &quot;</span>;<br/></li>
<li>&nbsp; fprintf(<span class="Constant">stderr</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">&quot;Process </span><span class="Special">%lld</span><span class="Constant"> got signal </span><span class="Special">%d</span><span class="Constant">(</span><span class="Special">%s</span><span class="Constant">), </span><span class="Special">%s</span><span class="Constant">core dumped</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">long</span> <span class="Type">long</span>) pid, signal, strsignal(signal), corestr<br/></li>
<li>&nbsp; );<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (core)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ( access(<a href="#L36" title="ocaml/ocamltest/run_unix.c:36">COREFILENAME</a>, F_OK) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;Could not find core file.</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">size_t</span> corefile_len = strlen(corefilename_prefix) + <span class="Constant">128</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Type">char</span> * corefile = malloc(corefile_len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (corefile == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;Out of memory while processing core file.</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(corefile, corefile_len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">.</span><span class="Special">%lld</span><span class="Constant">.core&quot;</span>, corefilename_prefix, (<span class="Type">long</span> <span class="Type">long</span>) pid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ( rename(<a href="#L36" title="ocaml/ocamltest/run_unix.c:36">COREFILENAME</a>, corefile) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;The core file exists but could not be renamed.</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>,<span class="Constant">&quot;The core file has been renamed to </span><span class="Special">%s\n</span><span class="Constant">&quot;</span>, corefile);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; free(corefile);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> -signal;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L296">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span> <span class="linkable">run_command_parent</span>(<span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings, pid_t child_pid)<br/></li>
<li>{<br/></li>
<li>&nbsp; <span class="Type">int</span> waiting = <span class="Constant">1</span>, status, code, child_code = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; pid_t pid;<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">if</span> (settings-&gt;timeout&gt;<span class="Constant">0</span>)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sigaction action;<br/></li>
<li>&nbsp; &nbsp; action.sa_handler = <a href="#L96" title="ocaml/ocamltest/run_unix.c:96">handle_alarm</a>;<br/></li>
<li>&nbsp; &nbsp; sigemptyset(&amp;action.sa_mask);<br/></li>
<li>&nbsp; &nbsp; action.sa_flags = SA_RESETHAND;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sigaction(<span class="Constant">SIGALRM</span>, &amp;action, <span class="Constant">NULL</span>) == -<span class="Constant">1</span>) <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(<span class="Constant">&quot;sigaction&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (alarm(settings-&gt;timeout) == -<span class="Constant">1</span>) <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(<span class="Constant">&quot;alarm&quot;</span>);<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">while</span> (waiting)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; pid = wait(&amp;status);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pid == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (errno)<br/></li>
<li>&nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">EINTR</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((settings-&gt;timeout &gt; <span class="Constant">0</span>) &amp;&amp; (<a href="#L38" title="ocaml/ocamltest/run_unix.c:38">timeout_expired</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L38" title="ocaml/ocamltest/run_unix.c:38">timeout_expired</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(<span class="Constant">stderr</span>, <span class="Constant">&quot;Timeout expired, killing all child processes</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kill(-child_pid, <span class="Constant">SIGKILL</span>) == -<span class="Constant">1</span>) <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(<span class="Constant">&quot;kill&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">ECHILD</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waiting = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(<span class="Constant">&quot;wait&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* Got a pid */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; code = <a href="#L248" title="ocaml/ocamltest/run_unix.c:248">handle_process_termination</a>(<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; settings, pid, status, settings-&gt;program);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pid == child_pid) child_code = code;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">return</span> child_code;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L342">&#x200c;</a><span class="Type">int</span> <span class="linkable">run_command</span>(<span class="Type">const</span> <a href="run.h.html#L40" title="ocaml/ocamltest/run.h:40">command_settings</a> *settings)<br/></li>
<li>{<br/></li>
<li>&nbsp; pid_t child_pid = fork();<br/></li>
<li><br/></li>
<li>&nbsp; <span class="Statement">switch</span> (child_pid)<br/></li>
<li>&nbsp; {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> -<span class="Constant">1</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L65" title="ocaml/ocamltest/run_unix.c:65">myperror</a>(<span class="Constant">&quot;fork&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>: <span class="Comment">/* child process */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; caml_atfork_hook();<br/></li>
<li>&nbsp; &nbsp; &nbsp; exit( <a href="#L167" title="ocaml/ocamltest/run_unix.c:167">run_command_child</a>(settings) );<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L296" title="ocaml/ocamltest/run_unix.c:296">run_command_parent</a>(settings, child_pid);<br/></li>
<li>&nbsp; }<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="index.html">Top Level</a></span>
 </p>

 </body>
</html>
